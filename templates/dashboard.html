<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员仪表板 - 数据分析系统</title>
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #4285f4;
            --background-color: #ffffff;
            --text-color: #202124;
            --border-color: #dadce0;
            --error-color: #d93025;
            --error-rgb: 217, 48, 37;
            --success-color: #188038;
            --hover-color: #174ea6;
            --card-background: #f8f9fa;
            --shadow-color: rgba(60, 64, 67, 0.15);
        }

        [data-theme="dark"] {
            --background-color: #202124;
            --text-color: #e8eaed;
            --border-color: #5f6368;
            --error-color: #f28b82;
            --error-rgb: 242, 139, 130;
            --success-color: #81c995;
            --card-background: #2c2c2e;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 280px;
            background: var(--card-background);
            padding: 2rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            transition: all 0.3s ease;
            overflow-y: auto; /* 添加垂直滚动条 */
        }

        .sidebar-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 500;
        }

        .nav-items {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem; /* 底部留出一些间距 */
        }

        .nav-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-item:hover {
            background: var(--primary-color);
            color: white;
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-item i {
            font-size: 1.25rem;
        }

        /* 主内容区域样式 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            background: var(--background-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-color);
            font-size: 1.75rem;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* 卡片样式 */
        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 6px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-color);
        }

        /* 统计卡片网格 */
        /* .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        } */

        .stat-card {
            background: var(--card-background);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 6px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--text-color);
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* 按钮样式 */
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .button-primary {
            background: var(--primary-color);
            color: white;
        }

        .button-primary:hover {
            background: var(--hover-color);
            transform: translateY(-1px);
        }

        .button-secondary {
            background: var(--card-background);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .button-secondary:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 500;
            color: var(--text-color);
            background: var(--card-background);
        }

        tr:hover {
            background: var(--card-background);
        }

        /* 状态标签 */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(24, 128, 56, 0.1);
            color: var(--success-color);
        }

        .status-inactive {
            background: rgba(217, 48, 37, 0.1);
            color: var(--error-color);
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 1rem;
            }

            .sidebar-header h2,
            .nav-item span {
                display: none;
            }

            .main-content {
                margin-left: 80px;
            }

            .nav-item {
                justify-content: center;
                padding: 0.75rem;
            }

            .nav-item i {
                margin: 0;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .button {
                padding: 0.5rem 1rem;
            }
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .settings-form {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-background);
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group,
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label,
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .card h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 16px;
        }

        .card h3 i {
            font-size: 18px;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
                padding: 10px;
            }
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 8vh auto;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        [data-theme="dark"] .modal-content {
            background-color: var(--card-background);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            background: var(--card-background);
            color: var(--text-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: var(--success-color);
            color: white;
        }

        .notification.error {
            background: var(--error-color);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(52, 199, 89, 0.1);
            color: #34c759;
        }

        .status-inactive {
            background-color: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
        }

        /* 表格样式优化 */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1rem 0;
        }

        .data-table th {
            background: var(--background-color);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .data-table tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        /* 按钮样式优化 */
        .button {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            margin-right: 8px;
        }

        .button:last-child {
            margin-right: 0;
        }

        .button-primary {
            background: var(--primary-color);
            color: white;
        }

        .button-warning {
            background: rgba(255, 149, 0, 0.1);
            color: #ff9500;
        }

        .button-success {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
        }

        .button-danger {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
        }

        .button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* 搜索框样式 */
        .search-box {
            position: relative;
            margin-right: 1rem;
            display: inline-block;
        }
        
        .search-input {
            padding: 0.5rem 2rem 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--background-secondary);
            color: var(--text-color);
            width: 250px;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
        }
        
        .search-box i {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        /* 搜索结果高亮样式 */
        .search-highlight {
            background-color: rgba(var(--primary-rgb), 0.1);
            border-left: 3px solid var(--primary-color);
        }

        /* 登录历史记录样式 */
        #login-history-section .table-container {
            margin-top: 1rem;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--background-secondary);
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: var(--hover-color);
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-admin {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-error {
            background-color: var(--error-color);
            color: white;
        }

        .modal-content input:focus, .modal-content select:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
        }

        .button:hover {
            opacity: 0.9;
        }

        .button-primary:hover {
            background: #0b5ed7;
        }

        .form-group input:hover, .form-group select:hover {
            border-color: #0d6efd;
        }

        /* 管理员验证模态框的输入框焦点和悬停效果 */
        #adminVerifyModal input:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
        }

        #adminVerifyModal input:hover {
            border-color: #0d6efd;
        }

        #adminVerifyModal .button:hover {
            opacity: 0.9;
        }

        #adminVerifyModal .button-primary:hover {
            background: #0b5ed7;
        }

        /* 删除用户模态框的输入框焦点和悬停效果 */
        #deleteUserModal input:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220,53,69,0.1);
        }

        #deleteUserModal input:hover {
            border-color: #dc3545;
        }

        #deleteUserModal .button:hover {
            opacity: 0.9;
        }

        #deleteUserModal .button-danger:hover {
            background: #c82333;
        }

        /* 添加动画效果 */
        #deleteUserModal .modal-content {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* 添加管理员验证模态框样式 */
        .admin-verify-content {
            max-width: 450px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        [data-theme="dark"] .admin-verify-content {
            background-color: #2d2d30;
            border: 1px solid #444;
        }
        
        #adminVerifyModal .modal-header {
            background: var(--card-background);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #adminVerifyModal .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        #adminVerifyModal .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        #adminVerifyModal .close-button:hover {
            opacity: 1;
        }
        
        #adminVerifyModal .modal-body {
            padding: 20px;
        }
        
        #adminVerifyModal #admin-verify-message {
            margin: 0 0 20px 0;
            color: var(--text-color);
            opacity: 0.8;
            font-size: 14px;
        }
        
        #adminVerifyModal .form-group {
            margin-bottom: 20px;
        }
        
        #adminVerifyModal label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 14px;
        }
        
        #adminVerifyModal input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.3s;
        }
        
        #adminVerifyModal input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }
        
        #adminVerifyModal .modal-footer {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        #adminVerifyModal .button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        #adminVerifyModal .cancel-button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        #adminVerifyModal .cancel-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] #adminVerifyModal .cancel-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #adminVerifyModal .confirm-button {
            background: var(--primary-color);
            border: none;
            color: white;
        }
        
        #adminVerifyModal .confirm-button:hover {
            background: var(--hover-color);
            transform: translateY(-1px);
        }

        /* 添加创建用户模态框样式 */
        .create-user-content {
            max-width: 450px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        [data-theme="dark"] .create-user-content {
            background-color: #2d2d30;
            border: 1px solid #444;
        }

        #createUserModal .modal-header {
            background: var(--card-background);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        #createUserModal .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        #createUserModal .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #createUserModal .close-button:hover {
            opacity: 1;
        }

        #createUserModal .modal-body {
            padding: 20px;
        }

        #createUserModal .form-group {
            margin-bottom: 20px;
        }

        #createUserModal label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 14px;
        }

        #createUserModal input, 
        #createUserModal select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        #createUserModal input:focus,
        #createUserModal select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        #createUserModal .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        #createUserModal .button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        #createUserModal .cancel-button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #createUserModal .cancel-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] #createUserModal .cancel-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #createUserModal .confirm-button {
            background: var(--primary-color);
            border: none;
            color: white;
        }

        #createUserModal .confirm-button:hover {
            background: var(--hover-color);
            transform: translateY(-1px);
        }

        #createUserModal input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* 添加删除用户模态框样式 */
        .delete-user-content {
            max-width: 450px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        [data-theme="dark"] .delete-user-content {
            background-color: #2d2d30;
            border: 1px solid #444;
        }

        #deleteUserModal .modal-header {
            background: var(--card-background);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        #deleteUserModal .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        #deleteUserModal .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #deleteUserModal .close-button:hover {
            opacity: 1;
        }

        #deleteUserModal .modal-body {
            padding: 20px;
        }

        #deleteUserModal .modal-body p {
            margin: 0 0 20px 0;
            color: var(--text-color);
            opacity: 0.8;
            font-size: 14px;
        }

        #deleteUserModal .form-group {
            margin-bottom: 20px;
        }

        #deleteUserModal label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 14px;
        }

        #deleteUserModal input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        #deleteUserModal input:focus {
            border-color: var(--error-color);
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
            outline: none;
        }

        #deleteUserModal .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        #deleteUserModal .button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        #deleteUserModal .cancel-button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #deleteUserModal .cancel-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] #deleteUserModal .cancel-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #deleteUserModal .delete-button {
            background: var(--error-color);
            border: none;
            color: white;
        }

        #deleteUserModal .delete-button:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* 管理员验证锁定信息样式 */
        .admin-verify-lock {
            margin: 10px 0 15px;
            padding: 12px;
            border-radius: 8px;
            background-color: rgba(var(--error-rgb), 0.1);
            color: var(--error-color);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* 添加管理员等级选择模态框样式 */
        .admin-level-select-content {
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        [data-theme="dark"] .admin-level-select-content {
            background-color: #2d2d30;
            border: 1px solid #444;
        }

        #levelSelectModal .modal-header {
            background: var(--card-background);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        #levelSelectModal .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        #levelSelectModal .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #levelSelectModal .close-button:hover {
            opacity: 1;
        }

        #levelSelectModal .modal-body {
            padding: 20px;
        }

        #levelSelectModal .level-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #levelSelectModal .level-button {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            border: none;
        }

        #levelSelectModal .remove-admin-button {
            background-color: rgba(var(--error-rgb), 0.1);
            color: var(--error-color);
            border: 1px solid rgba(var(--error-rgb), 0.3);
        }

        #levelSelectModal .level-1-button {
            background-color: var(--primary-color);
            color: white;
        }

        #levelSelectModal .level-2-button {
            background-color: var(--secondary-color);
            color: white;
        }

        #levelSelectModal .level-3-button {
            background-color: #5c6bc0;
            color: white;
        }

        [data-theme="dark"] #levelSelectModal .remove-admin-button {
            background-color: rgba(var(--error-rgb), 0.2);
        }

        #levelSelectModal .level-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        #levelSelectModal .level-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #levelSelectModal .remove-admin-button:hover {
            background-color: rgba(var(--error-rgb), 0.2);
        }

        #levelSelectModal .level-1-button:hover {
            background-color: #1557b0;
        }

        #levelSelectModal .level-2-button:hover {
            background-color: #3367d6;
        }

        #levelSelectModal .level-3-button:hover {
            background-color: #3f51b5;
        }

        /* 热图样式 */
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
            table-layout: fixed;
        }

        .heatmap-table th, .heatmap-table td {
            border: 1px solid rgba(var(--border-color-rgb), 0.6);
            padding: 3px 2px;
            text-align: center;
            overflow: hidden;
        }

        .heatmap-table th {
            background-color: rgba(var(--header-bg-rgb), 0.8);
            color: var(--header-text-color);
            font-weight: 600;
        }

        .heat-normal {
            font-size: 10px;
            color: #004080;
            line-height: 1.2;
        }

        .heat-ai {
            font-size: 10px;
            color: #400040;
            margin-top: 1px;
            line-height: 1.2;
        }

        .heat-sales {
            font-size: 10px;
            color: #000000;
            margin-top: 1px;
            line-height: 1.2;
        }

        .heat-normal, .heat-ai, .heat-sales {
            line-height: 1.2;    /* 调整行高 */
            margin: 1px 0;       /* 上下间距 */
            display: block;      /* 块级显示确保垂直排列 */
            text-align: center;  /* 文本居中 */
        }

        .legend-container {
            display: flex;
            margin-top: 10px;
            justify-content: flex-end;
            align-items: center;
            font-size: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-left: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }

        /* 表单网格 */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        /* 表单组件 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-background);
            color: var(--text-color);
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* 风险等级标签 */
        .risk-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .risk-high {
            background-color: #ff4c4c;
            color: white;
        }
        
        .risk-medium {
            background-color: #ffa64c;
            color: white;
        }
        
        .risk-low {
            background-color: #ffeb4c;
            color: black;
        }

        /* 异常检测表格样式优化 */
        .table-container.scrollable {
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .table-container.scrollable table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .table-container.scrollable thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .table-container.scrollable thead tr th {
            background-color: var(--card-background);
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .table-container.scrollable thead tr th {
            background-color: #2d2d30;
            box-shadow: 0 1px 0 rgba(255,255,255,0.05);
        }

        /* 添加通知详情模态框的深色模式适配 */
        .notification-detail-content {
            max-width: 800px;
            border-radius: 16px;
            overflow: hidden;
        }

        .notification-detail-content .modal-header {
            background-color: var(--primary-color);
            padding: 18px 24px;
            margin-bottom: 0;
            border-bottom: none;
        }

        .notification-detail-content .modal-header h3 {
            color: #fff;
            font-weight: 500;
        }

        .notification-detail-content .modal-header .close-button {
            color: #fff;
            opacity: 0.8;
            transition: all 0.2s;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .notification-detail-content .modal-header .close-button:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .notification-detail-content .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .notification-detail-content .notification-info {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .notification-detail-content .notification-info h4 {
            color: var(--text-color);
            margin-bottom: 16px;
            font-size: 20px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-detail-content .notification-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
            margin-bottom: 20px;
            color: var(--text-color);
            line-height: 1.8;
        }

        .notification-detail-content .notification-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notification-detail-content .notification-meta span::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }

        .notification-detail-content .notification-stats {
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .notification-detail-content .notification-stats span {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
        }

        .notification-detail-content .notification-stats span::before {
            content: attr(data-value);
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .notification-detail-content .notification-content {
            margin-bottom: 24px;
        }

        .notification-detail-content .notification-content h5 {
            margin-bottom: 12px;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-detail-content .notification-content h5::before {
            content: '';
            width: 4px;
            height: 16px;
            background-color: var(--primary-color);
            border-radius: 2px;
            display: inline-block;
        }

        .notification-detail-content .notification-content pre {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid var(--border-color);
            max-height: 220px;
            overflow-y: auto;
        }

        .notification-detail-content .recipients-list {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .notification-detail-content .recipients-list h5 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-detail-content .recipients-list h5::before {
            content: '';
            width: 4px;
            height: 16px;
            background-color: var(--primary-color);
            border-radius: 2px;
            display: inline-block;
        }

        .notification-detail-content .table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            scrollbar-width: thin;
        }

        .notification-detail-content .table-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .notification-detail-content .table-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .notification-detail-content .table-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .notification-detail-content table {
            width: 100%;
            border-collapse: collapse;
        }

        .notification-detail-content table th {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            color: var(--text-color);
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 14px;
        }

        .notification-detail-content table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .notification-detail-content table tr:last-child td {
            border-bottom: none;
        }

        .notification-detail-content table tr:hover {
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }

        .notification-detail-content .badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .notification-detail-content .badge.success {
            background-color: rgba(var(--success-color-rgb), 0.1);
            color: var(--success-color);
        }

        .notification-detail-content .badge.error {
            background-color: rgba(var(--error-rgb), 0.1);
            color: var(--error-color);
        }

        .notification-detail-content .badge.info {
            background-color: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color);
        }

        .notification-detail-content .badge.warning {
            background-color: rgba(255, 149, 0, 0.1);
            color: #ff9500;
        }

        .notification-detail-content .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-background);
        }

        .notification-detail-content .modal-footer .button {
            padding: 8px 24px;
            font-size: 14px;
            border-radius: 8px;
        }

        [data-theme="dark"] .notification-detail-content .notification-info,
        [data-theme="dark"] .notification-detail-content .recipients-list {
            background-color: rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .notification-detail-content .notification-stats,
        [data-theme="dark"] .notification-detail-content .notification-content pre,
        [data-theme="dark"] .notification-detail-content .table-container {
            border-color: var(--border-color);
            background-color: rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] .notification-detail-content table th {
            background-color: rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .notification-detail-content table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .notification-detail-content .modal-header {
            background-color: rgba(var(--primary-color-rgb), 0.8);
        }

        .notification-detail-content .time-info {
            font-size: 12px;
            color: var(--secondary-text);
            margin-left: 6px;
        }

        .notification-detail-content .no-data {
            text-align: center;
            padding: 30px;
            color: var(--secondary-text);
            font-style: italic;
        }

        [data-theme="dark"] .notification-detail-content .time-info {
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
    <link href="{{ url_for('static', filename='fonts/remixicon/remixicon.css') }}" rel="stylesheet">
    <link href="/static/css/notifications.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>管理控制台</h2>
            </div>
            <div class="nav-items">
                <a class="nav-item active" onclick="showSection('dashboard')">
                    <i class="ri-dashboard-line"></i>
                    <span>仪表板</span>
                </a>
                <a class="nav-item" onclick="showSection('users')">
                    <i class="ri-user-line"></i>
                    <span>用户管理</span>
                </a>
                <a class="nav-item" onclick="showSection('logs')">
                    <i class="ri-file-list-line"></i>
                    <span>系统日志</span>
                </a>
                <a class="nav-item" onclick="showSection('visualization')">
                    <i class="ri-line-chart-line"></i>
                    <span>数据可视化</span>
                </a>
                <a class="nav-item" onclick="showSection('health')">
                    <i class="ri-heart-pulse-line"></i>
                    <span>系统健康</span>
                </a>
                <a class="nav-item" onclick="showSection('anomaly')">
                    <i class="ri-error-warning-line"></i>
                    <span>异常检测</span>
                </a>
                <a class="nav-item" onclick="showSection('notifications')">
                    <i class="ri-notification-line"></i>
                    <span>通知系统</span>
                </a>
                <a class="nav-item" onclick="showSection('settings')">
                    <i class="ri-settings-line"></i>
                    <span>系统设置</span>
                </a>
                <a class="nav-item" onclick="logout()">
                    <i class="ri-logout-box-line"></i>
                    <span>退出登录</span>
                </a>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 仪表板部分 -->
            <div id="dashboard-section">
                <div class="header">
                    <h1>系统概览</h1>
                    <div class="header-actions">
                        <span id="current-time" class="button button-secondary">
                            <i class="ri-time-line"></i>
                            加载中...
                        </span>
                        <button class="button button-primary" onclick="toggleTheme()">
                            <i class="ri-contrast-line"></i>
                            切换主题
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">最近多/单文件分析记录</h3>
                        <button class="button button-secondary" onclick="refreshAnalysisRecords()">
                            <i class="ri-refresh-line"></i>
                            刷新
                        </button>
                    </div>
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px;">
                        <div class="stat-card">
                            <i class="ri-file-search-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="today-analysis">0</div>
                            <div class="stat-label">今日分析次数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-bar-chart-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="total-analysis">0</div>
                            <div class="stat-label">总分析次数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-user-heart-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="active-users">0</div>
                            <div class="stat-label">活跃用户数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-timer-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="uptime">0天</div>
                            <div class="stat-label">系统运行时间</div>
                        </div>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>用户</th>
                                    <th>文件数</th>
                                    <th>分析模式</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="recent-analysis">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- AI分析统计区域 -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">AI智能分析统计</h3>
                        <button class="button button-secondary" onclick="refreshAiStats()">
                            <i class="ri-refresh-line"></i>
                            刷新
                        </button>
                    </div>
                    <div class="ai-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px;">
                        <div class="stat-card">
                            <i class="ri-robot-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="today-ai-analysis">0</div>
                            <div class="stat-label">今日AI分析次数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-brain-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="total-ai-analysis">0</div>
                            <div class="stat-label">总AI分析次数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-user-voice-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="ai-users">0</div>
                            <div class="stat-label">AI分析用户数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-time-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="avg-response-time">0秒</div>
                            <div class="stat-label">平均响应时间</div>
                        </div>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>用户</th>
                                    <th>文件数</th>
                                    <th>响应时间</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="recent-ai-analysis">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 销售分析模式统计区域 -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">销售分析模式统计</h3>
                        <button class="button button-secondary" onclick="refreshSalesStats()">
                            <i class="ri-refresh-line"></i>
                            刷新
                        </button>
                    </div>
                    <div class="sales-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px;">
                        <div class="stat-card">
                            <i class="ri-line-chart-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="today-sales-analysis">0</div>
                            <div class="stat-label">今日销售分析次数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-bar-chart-grouped-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="total-sales-analysis">0</div>
                            <div class="stat-label">总销售分析次数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-user-settings-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="sales-analysis-users">0</div>
                            <div class="stat-label">销售分析用户数</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-pie-chart-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="avg-processing-time">0秒</div>
                            <div class="stat-label">平均处理时间</div>
                        </div>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>用户</th>
                                    <th>文件数</th>
                                    <th>分析类型</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sales-analysis">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 用户管理部分 -->
            <div class="content-section" id="users-section" style="display: none;">
                <div class="section-header">
                    <h2>用户管理</h2>
                    <div class="section-actions">
                        <div class="search-box">
                            <div class="user-search-container">
                                
                                <input type="text" class="user-search-input" placeholder="搜索用户..." id="user-search" oninput="filterUsers(this.value)">
                            </div>
                        </div>
                        <button onclick="showCreateUserModal()" class="btn btn-primary">
                            <i class="ri-user-add-line"></i> 创建用户
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                            <!-- 用户列表将通过JavaScript动态插入 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 系统日志部分 -->
            <div id="logs-section" style="display: none;">
                <div class="header">
                    <h1>系统日志</h1>
                    <div class="header-actions">
                        <button class="button button-primary" onclick="refreshLogs()">
                            <i class="ri-refresh-line"></i>
                            刷新日志
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>级别</th>
                                    <th>消息</th>
                                </tr>
                            </thead>
                            <tbody id="logs-list">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 系统设置部分 -->
            <div id="settings-section" style="display: none;">
                <div class="header">
                    <h1>系统设置</h1>
                    <div class="header-actions">
                        <button class="button button-secondary" onclick="resetSettings()">
                            <i class="ri-restart-line"></i>
                            重置
                        </button>
                        <button class="button button-primary" onclick="saveSettings()">
                            <i class="ri-save-line"></i>
                            保存
                        </button>
                    </div>
                </div>

                <div class="settings-grid">
                    <!-- 基本设置 -->
                    <div class="card">
                        <h3><i class="ri-settings-4-line"></i> 基本设置</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>系统名称</label>
                                <input type="text" id="system-name" placeholder="数据分析系统">
                            </div>
                            <div class="form-group">
                                <label>系统描述</label>
                                <textarea id="system-description" rows="3" placeholder="系统简介..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>管理员邮箱</label>
                                <input type="email" id="admin-email" placeholder="admin@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- 安全设置 -->
                    <div class="card">
                        <h3><i class="ri-shield-line"></i> 安全设置</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>登录尝试限制</label>
                                <input type="number" id="login-attempts" min="1" max="10" value="5">
                            </div>
                            <div class="form-group">
                                <label>密码最小长度</label>
                                <input type="number" id="min-password-length" min="6" max="20" value="8">
                            </div>
                            <div class="form-group">
                                <label>会话超时时间（分钟）</label>
                                <input type="number" id="session-timeout" min="5" max="1440" value="30">
                            </div>
                            <div class="form-group">
                                <label>强制密码复杂度</label>
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" id="require-uppercase" checked>
                                        必须包含大写字母
                                    </label>
                                    <label>
                                        <input type="checkbox" id="require-numbers" checked>
                                        必须包含数字
                                    </label>
                                    <label>
                                        <input type="checkbox" id="require-special" checked>
                                        必须包含特殊字符
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 日志设置 -->
                    <div class="card">
                        <h3><i class="ri-file-list-line"></i> 日志设置</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>日志级别</label>
                                <select id="log-level">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>日志保留时间（天）</label>
                                <input type="number" id="log-retention" min="1" max="365" value="30">
                            </div>
                            <div class="form-group">
                                <label>日志文件大小限制（MB）</label>
                                <input type="number" id="log-size-limit" min="1" max="1000" value="100">
                            </div>
                        </div>
                    </div>

                    <!-- 界面设置 -->
                    <div class="card">
                        <h3><i class="ri-palette-line"></i> 界面设置</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>默认主题</label>
                                <select id="default-theme">
                                    <option value="light">浅色</option>
                                    <option value="dark">深色</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>动画效果</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="animation" value="on" checked>
                                        开启
                                    </label>
                                    <label>
                                        <input type="radio" name="animation" value="off">
                                        关闭
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>显示用户头像</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="show-avatar" value="on" checked>
                                        开启
                                    </label>
                                    <label>
                                        <input type="radio" name="show-avatar" value="off">
                                        关闭
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI分析界面设置 -->
                    <div class="card">
                        <h3><i class="ri-robot-line"></i> AI分析界面设置</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>打字机效果</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="typewriter-effect" value="on" checked>
                                        开启
                                    </label>
                                    <label>
                                        <input type="radio" name="typewriter-effect" value="off">
                                        关闭
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>打字机速度</label>
                                <select id="typewriter-speed">
                                    <option value="slow">慢速</option>
                                    <option value="medium" selected>中速</option>
                                    <option value="fast">快速</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>默认字体样式</label>
                                <select id="default-font">
                                    <option value="system" selected>系统默认</option>
                                    <option value="serif">衬线字体</option>
                                    <option value="sans-serif">无衬线字体</option>
                                    <option value="rounded">圆润字体</option>
                                    <option value="tech">科技感</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>默认消息气泡样式</label>
                                <select id="bubble-style">
                                    <option value="square" selected>方角</option>
                                    <option value="rounded">圆角</option>
                                    <option value="pill">圆边</option>
                                    <option value="flat">扁平</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 登录历史记录部分 -->
            <div class="section" id="login-history-section">
                <div class="section-header">
                    <h2>登录历史记录</h2>
                    <div class="section-actions">
                        <button onclick="refreshLoginHistory()" class="btn btn-primary">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="table-container scrollable" >
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>登录时间</th>
                                <th>IP地址</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="login-history-list">
                            <!-- 登录历史记录将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 数据可视化部分 -->
            <div id="visualization-section" style="display: none;">
                <div class="header">
                    <h1>数据可视化</h1>
                    <div class="header-actions">
                        <button class="button button-primary" onclick="refreshVisualization()">
                            <i class="ri-refresh-line"></i>
                            刷新图表
                        </button>
                    </div>
                </div>
                
                <div class="visualization-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- 每日分析次数趋势图 -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">每日分析次数趋势</h3>
                        </div>
                        <div class="card-body" style="padding: 20px;">
                            <canvas id="daily-trend-chart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <!-- 分析模式使用比例图 -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">分析模式使用比例</h3>
                        </div>
                        
                        <div class="card-body" style="padding: 20px;">
                            <canvas id="mode-usage-chart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <!-- 用户活跃度热图 -->
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <h3 class="card-title">用户活跃度热图</h3>
                        </div>
                        <div class="card-body" style="padding: 20px;">
                            <div id="user-heatmap" style="min-height: 380px;">
                                <div class="heat-legend" style="margin-bottom: 8px; font-size: 12px; color: var(--text-color-secondary);">
                                    <span><i class="ri-information-line"></i> 数据：上方数据表示普通分析活跃度，中间数据表示AI分析活跃度，下方数据表示销售分析活跃度。颜色深浅代表总活跃度。横排表示一天中的不同时间段（单位/h），纵排表示星期。</span>
                                </div>
                                <table class="heatmap-table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>00-02</th>
                                            <th>02-04</th>
                                            <th>04-06</th>
                                            <th>06-08</th>
                                            <th>08-10</th>
                                            <th>10-12</th>
                                            <th>12-14</th>
                                            <th>14-16</th>
                                            <th>16-18</th>
                                            <th>18-20</th>
                                            <th>20-22</th>
                                            <th>22-24</th>
                                        </tr>
                                    </thead>
                                    <tbody id="heatmap-body">
                                        <!-- 这里将通过JavaScript动态填充数据 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 系统健康状况部分 -->
            <div id="health-section" style="display: none;">
                <div class="header">
                    <h1>系统健康状况</h1>
                    <div class="header-actions">
                        <button class="button button-primary" onclick="refreshHealthStats()">
                            <i class="ri-refresh-line"></i>
                            刷新状态
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">数据库性能指标</h3>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 50px;">
                            <div class="stat-card">
                                <i class="ri-database-2-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                                <div class="stat-value" id="db-query-count">245</div>
                                <div class="stat-label">查询次数/小时</div>
                            </div>
                            <div class="stat-card">
                                <i class="ri-time-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                                <div class="stat-value" id="db-response-time">32ms</div>
                                <div class="stat-label">平均响应时间</div>
                            </div>
                            <div class="stat-card">
                                <i class="ri-hard-drive-2-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                                <div class="stat-value" id="db-size">128MB</div>
                                <div class="stat-label">数据库大小</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">系统响应时间监控</h3>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        <canvas id="response-time-chart" height="250"></canvas>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">最近系统事件</h3>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>类型</th>
                                    <th>事件</th>
                                    <th>响应时间</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="system-events">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 异常检测部分 -->
            <div id="anomaly-section" style="display: none;">
                <div class="header">
                    <h1>智能异常检测</h1>
                    <div class="header-actions">
                        <button class="button button-primary" onclick="refreshAnomalies()">
                            <i class="ri-refresh-line"></i>
                            刷新数据
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">系统异常行为</h3>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>异常类型</th>
                                    <th>风险等级</th>
                                    <th>描述</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="system-anomalies">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">可疑用户活动</h3>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>用户</th>
                                    <th>活动</th>
                                    <th>异常原因</th>
                                    <th>风险等级</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-anomalies">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">异常检测规则</h3>
                        <div>
                            <button class="button button-secondary" onclick="refreshAllRules()">
                                <i class="ri-refresh-line"></i> 刷新规则
                            </button>
                            <button class="button button-secondary" onclick="showAddRuleModal()">
                                <i class="ri-add-line"></i> 添加规则
                            </button>
                        </div>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>规则名称</th>
                                    <th>检测目标</th>
                                    <th>条件</th>
                                    <th>风险等级</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="anomaly-rules">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 通知系统部分 -->
            <div id="notifications-section" style="display: none;">
                <div class="header">
                    <h1>通知系统</h1>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">发送系统通知</h3>
                    </div>
                    <div class="card-body">
                        <form id="notification-form" class="form-grid">
                            <div class="form-group">
                                <label>接收对象</label>
                                <select id="notification-target" class="form-control">
                                    <option value="all">所有用户</option>
                                    <option value="active">活跃用户</option>
                                    <option value="specific">特定用户</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="specific-users-group" style="display: none;">
                                <label>选择用户</label>
                                <div class="user-selection-panel">
                                    <div class="user-search-container">
                                        
                                        <input type="text" class="user-search-input" placeholder="搜索用户..." id="user-search" oninput="filterUsers(this.value)">
                                    </div>
                                    <div class="user-select-list" id="user-select-list"></div>
                                    <div class="user-select-actions">
                                        <button type="button" id="select-all-users">
                                            <i class="ri-checkbox-multiple-line"></i> 全选
                                        </button>
                                        <button type="button" id="deselect-all-users">
                                            <i class="ri-checkbox-multiple-blank-line"></i> 取消全选
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="notification-users" name="notification-users" value="">
                            </div>
                            
                            <div class="form-group">
                                <label>通知标题</label>
                                <input type="text" id="notification-title" class="form-control" placeholder="输入通知标题">
                            </div>
                            
                            <div class="form-group">
                                <label>通知内容</label>
                                <textarea id="notification-content" class="form-control" rows="5" placeholder="输入通知内容..." style="display:none;"></textarea>
                                <div id="rich-editor-container">
                                    <div id="rich-editor-toolbar">
                                        <button type="button" class="editor-btn" data-command="bold" title="粗体"><i class="ri-bold"></i></button>
                                        <button type="button" class="editor-btn" data-command="italic" title="斜体"><i class="ri-italic"></i></button>
                                        <button type="button" class="editor-btn" data-command="underline" title="下划线"><i class="ri-underline"></i></button>
                                        <button type="button" class="editor-btn" data-command="strikeThrough" title="删除线"><i class="ri-strikethrough"></i></button>
                                        <span class="editor-separator"></span>
                                        <select class="editor-select" data-command="fontName" title="字体">
                                            <option value="宋体">宋体</option>
                                            <option value="黑体">黑体</option>
                                            <option value="微软雅黑" selected>微软雅黑</option>
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Courier New">Courier New</option>
                                        </select>
                                        <select class="editor-select" data-command="fontSize" title="字号">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3" selected>3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                        </select>
                                        <span class="editor-separator"></span>
                                        <input type="color" class="editor-color" data-command="foreColor" title="文字颜色" value="#000000">
                                        <input type="color" class="editor-color" data-command="hiliteColor" title="背景颜色" value="#ffffff">
                                        <span class="editor-separator"></span>
                                        <button type="button" class="editor-btn" data-command="justifyLeft" title="左对齐"><i class="ri-align-left"></i></button>
                                        <button type="button" class="editor-btn" data-command="justifyCenter" title="居中对齐"><i class="ri-align-center"></i></button>
                                        <button type="button" class="editor-btn" data-command="justifyRight" title="右对齐"><i class="ri-align-right"></i></button>
                                        <span class="editor-separator"></span>
                                        <button type="button" class="editor-btn" data-command="insertUnorderedList" title="无序列表"><i class="ri-list-unordered"></i></button>
                                        <button type="button" class="editor-btn" data-command="insertOrderedList" title="有序列表"><i class="ri-list-ordered"></i></button>
                                        <span class="editor-separator"></span>
                                        <button type="button" class="editor-btn" id="upload-image-btn" title="插入图片"><i class="ri-image-add-line"></i></button>
                                        <input type="file" id="image-upload" accept="image/*" style="display:none;">
                                        <span class="editor-separator"></span>
                                        <button type="button" class="editor-btn" data-command="undo" title="撤销"><i class="ri-arrow-go-back-line"></i></button>
                                        <button type="button" class="editor-btn" data-command="redo" title="重做"><i class="ri-arrow-go-forward-line"></i></button>
                                        <span class="editor-separator"></span>
                                        <button type="button" class="editor-btn" id="template-btn" title="插入模板"><i class="ri-file-list-3-line"></i></button>
                                        <button type="button" class="editor-btn" id="animation-btn" title="插入动态效果"><i class="ri-magic-line"></i></button>
                                    </div>
                                    <div id="rich-editor-content" contenteditable="true" class="form-control rich-editor"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>通知类型</label>
                                <select id="notification-type" class="form-control">
                                    <option value="info">信息</option>
                                    <option value="update">更新</option>
                                    <option value="maintenance">维护</option>
                                    <option value="warning">警告</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>通知方式</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="notification-web" checked> 网站通知</label>
                                    <label><input type="checkbox" id="notification-email"> 邮件通知</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="button button-secondary" onclick="previewNotification()">
                                    <i class="ri-eye-line"></i> 预览通知
                                </button>
                                <button type="button" class="button button-primary" onclick="sendNotification()">
                                    <i class="ri-send-plane-line"></i> 发送通知
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">系统维护计划</h3>
                        <button class="button button-secondary" onclick="showAddMaintenanceModal()">
                            <i class="ri-add-line"></i> 添加计划
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>计划时间</th>
                                    <th>维护类型</th>
                                    <th>预计时长</th>
                                    <th>影响范围</th>
                                    <th>通知状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="maintenance-plans">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">历史通知</h3>
                        <button class="button button-secondary" onclick="refreshNotificationsList()">
                            <i class="ri-refresh-line"></i> 刷新
                        </button>
                    </div>
                    <div class="table-container scrollable">
                        <table>
                            <thead>
                                <tr>
                                    <th>发送时间</th>
                                    <th>标题</th>
                                    <th>类型</th>
                                    <th>接收对象</th>
                                    <th>通知方式</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="notifications-list">
                                <!-- 这里将通过JavaScript动态填充数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建用户模态框 -->
    <div id="createUserModal" class="modal">
        <div class="modal-content create-user-content">
            <div class="modal-header">
                <h3>创建新用户</h3>
                <button class="close-button" onclick="hideCreateUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm" onsubmit="handleCreateUser(event)">
                    <div id="create-user-lock-message" class="admin-verify-lock" style="display: none;"></div>
                    <div class="form-group">
                        <label for="new_username">用户名</label>
                        <input type="text" id="new_username" name="new_username" required>
                    </div>
                    <div class="form-group">
                        <label for="new_email">邮箱</label>
                        <input type="email" id="new_email" name="new_email" required>
                    </div>
                    <div class="form-group">
                        <label for="new_password">密码</label>
                        <input type="password" id="new_password" name="new_password" required>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="is_admin" onchange="toggleAdminLevelSelect()">
                            设为管理员
                        </label>
                    </div>
                    <div class="form-group" id="adminLevelGroup" style="display: none;">
                        <label for="admin_level">管理员级别</label>
                        <select id="admin_level" name="admin_level">
                            <option value="3" selected>三级管理员</option>
                            <option value="2">二级管理员</option>
                            <option value="1">一级管理员(级别最大)</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button cancel-button" onclick="hideCreateUserModal()">
                            取消
                        </button>
                        <button type="submit" class="button button-primary confirm-button">
                            创建
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 删除用户确认模态框 -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content delete-user-content">
            <div class="modal-header">
                <h3>删除用户</h3>
                <button class="close-button" onclick="hideDeleteUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>请输入管理员账号和密码以确认删除用户</p>
                <div id="delete-user-lock-message" class="admin-verify-lock" style="display: none; color: var(--error-color); margin-bottom: 15px; padding: 10px; background: rgba(var(--error-rgb), 0.1); border-radius: 6px; text-align: center;"></div>
                <form id="deleteUserForm" onsubmit="confirmDeleteUser(event)">
                    <div class="form-group">
                        <label for="admin_username">管理员账号</label>
                        <input type="text" id="admin_username" name="admin_username" required>
                    </div>
                    <div class="form-group">
                        <label for="admin_password">管理员密码</label>
                        <input type="password" id="admin_password" name="admin_password" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button cancel-button" onclick="hideDeleteUserModal()">
                            取消
                        </button>
                        <button type="submit" class="button button-danger delete-button">
                            确认删除
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 管理员验证模态框 -->
    <div id="adminVerifyModal" class="modal">
        <div class="modal-content admin-verify-content">
            <div class="modal-header">
                <h3>管理员验证</h3>
                <button class="close-button" onclick="hideAdminVerifyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="admin-verify-message">请输入管理员账号和密码以确认操作</p>
                <div id="admin-verify-lock-message" class="admin-verify-lock" style="display: none; color: var(--error-color); margin-bottom: 15px; padding: 10px; background: rgba(var(--error-rgb), 0.1); border-radius: 6px; text-align: center;"></div>
                <form id="adminVerifyForm" onsubmit="return handleAdminVerification(event)">
                    <div class="form-group">
                        <label for="verify_admin_username">管理员账号</label>
                        <input type="text" id="verify_admin_username" name="verify_admin_username" required>
                    </div>
                    <div class="form-group">
                        <label for="verify_admin_password">管理员密码</label>
                        <input type="password" id="verify_admin_password" name="verify_admin_password" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button cancel-button" onclick="hideAdminVerifyModal()">
                            取消
                        </button>
                        <button type="submit" class="button button-primary confirm-button">
                            确认
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 模板选择模态框 -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择通知模板</h3>
                <button class="close-button" onclick="hideTemplateModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body">
                <div class="templates-container">
                    <div class="template-card" onclick="applyTemplate('welcome')">
                        <div class="template-preview">
                            <h4>欢迎模板</h4>
                            <p>欢迎新用户加入平台的温馨模板，包含友好的问候语和平台功能介绍</p>
                        </div>
                        <div class="template-title">欢迎模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('update')">
                        <div class="template-preview">
                            <h4>系统更新</h4>
                            <p>通知用户系统更新的专业模板，包含更新内容、改进功能和重要提示</p>
                        </div>
                        <div class="template-title">更新模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('promotion')">
                        <div class="template-preview">
                            <h4>促销活动</h4>
                            <p>推广特别优惠和活动的吸引人模板，突出显示优惠信息和截止日期</p>
                        </div>
                        <div class="template-title">促销模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('maintenance')">
                        <div class="template-preview">
                            <h4>系统维护</h4>
                            <p>系统维护通知的专业模板，清晰说明维护时间、影响范围和注意事项</p>
                        </div>
                        <div class="template-title">维护模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('warning')">
                        <div class="template-preview">
                            <h4>警告提示</h4>
                            <p>重要警告提示的醒目模板，强调安全信息和必要操作，引起用户高度重视</p>
                        </div>
                        <div class="template-title">警告模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('ai_analysis')">
                        <div class="template-preview">
                            <h4>AI分析模式</h4>
                            <p>通知用户AI分析模式更新和新功能的专业模板，突出智能分析的优势</p>
                        </div>
                        <div class="template-title">AI分析模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('multi_file')">
                        <div class="template-preview">
                            <h4>多文件比较</h4>
                            <p>介绍多文件比较功能的专业模板，强调效率提升和数据对比的便捷性</p>
                        </div>
                        <div class="template-title">多文件比较模板</div>
                    </div>
                    
                    <div class="template-card" onclick="applyTemplate('single_file')">
                        <div class="template-preview">
                            <h4>单文件分析</h4>
                            <p>展示单文件分析模式优化的专业模板，突出性能提升和用户体验改进</p>
                        </div>
                        <div class="template-title">单文件分析模板</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 动态效果选择模态框 -->
    <div id="animationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择动态效果</h3>
                <button class="close-button" onclick="hideAnimationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="animations-container">
                    <div class="animation-card" onclick="applyAnimation('fade-in')">
                        <div class="animation-preview">
                            <div class="animation-demo fade-in-demo">淡入效果</div>
                        </div>
                        <div class="animation-title">淡入效果</div>
                    </div>
                    
                    <div class="animation-card" onclick="applyAnimation('slide-in')">
                        <div class="animation-preview">
                            <div class="animation-demo slide-in-demo">滑入效果</div>
                        </div>
                        <div class="animation-title">滑入效果</div>
                    </div>
                    
                    <div class="animation-card" onclick="applyAnimation('bounce')">
                        <div class="animation-preview">
                            <div class="animation-demo bounce-demo">弹跳效果</div>
                        </div>
                        <div class="animation-title">弹跳效果</div>
                    </div>
                    
                    <div class="animation-card" onclick="applyAnimation('pulse')">
                        <div class="animation-preview">
                            <div class="animation-demo pulse-demo">脉冲效果</div>
                        </div>
                        <div class="animation-title">脉冲效果</div>
                    </div>
                    
                    <div class="animation-card" onclick="applyAnimation('flip')">
                        <div class="animation-preview">
                            <div class="animation-demo flip-demo">翻转效果</div>
                        </div>
                        <div class="animation-title">翻转效果</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 切换主题
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // 切换主题后刷新数据可视化
            if (document.getElementById('visualization-section').style.display === 'block') {
                refreshVisualization();
            }
        }

        // 管理员验证失败计数和锁定功能
        let adminVerifyFailCount = 0;
        let adminVerifyLockUntil = 0;
        let adminVerifyLockCountdown = null;
        
        // 当前操作相关变量
        let currentAction = null;
        let currentUserId = null;
        let currentAdminLevel = 0;
        let currentUserData = null;
        let currentAdminAction = null; // 添加缺少的变量定义

        // 检查管理员验证是否被锁定
        function isAdminVerifyLocked() {
            const now = Date.now();
            if (adminVerifyLockUntil > now) {
                return true;
            }
            // 如果锁定时间已过，仅重置锁定时间，但保留失败计数
            if (adminVerifyLockUntil > 0 && adminVerifyLockUntil <= now) {
                adminVerifyLockUntil = 0;
                clearInterval(adminVerifyLockCountdown);
                adminVerifyLockCountdown = null;
                // 不再重置失败计数：adminVerifyFailCount = 0;
            }
            return false;
        }

        // 增加验证失败计数并在必要时锁定功能
        function incrementVerifyFailCount() {
            adminVerifyFailCount++;
            // 每3次失败增加一级锁定时间
            if (adminVerifyFailCount % 3 === 0) {
                // 计算锁定等级：第一个3次是1级，第二个3次是2级，以此类推
                const lockLevel = Math.floor(adminVerifyFailCount / 3);
                // 根据锁定等级计算锁定时间：3分钟、6分钟、12分钟...
                const lockMinutes = Math.pow(2, lockLevel - 1) * 3;
                adminVerifyLockUntil = Date.now() + (lockMinutes * 60 * 1000);
                
                startLockCountdown();
                
                showNotification(`验证失败次数过多，功能已锁定${lockMinutes}分钟`, 'error');
                return true;
            }
            return false;
        }

        // 开始锁定倒计时
        function startLockCountdown() {
            // 清除之前可能存在的倒计时
            if (adminVerifyLockCountdown) {
                clearInterval(adminVerifyLockCountdown);
            }
            
            // 更新锁定状态显示
            updateLockDisplay();
            
            // 设置倒计时，每秒更新一次
            adminVerifyLockCountdown = setInterval(() => {
                if (!isAdminVerifyLocked()) {
                    clearInterval(adminVerifyLockCountdown);
                    adminVerifyLockCountdown = null;
                    updateLockDisplay();
                    return;
                }
                updateLockDisplay();
            }, 1000);
        }

        // 更新锁定状态显示
        function updateLockDisplay() {
            const lockMessages = [
                document.getElementById('admin-verify-lock-message'),
                document.getElementById('delete-user-lock-message'),
                document.getElementById('create-user-lock-message')
            ];
            
            if (isAdminVerifyLocked()) {
                const remainingSeconds = Math.ceil((adminVerifyLockUntil - Date.now()) / 1000);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                const lockText = `验证功能已锁定，剩余时间: ${minutes}分${seconds}秒`;
                
                // 更新所有锁定信息显示区域
                lockMessages.forEach(el => {
                    if (el) {
                        el.textContent = lockText;
                        el.style.display = 'block';
                    }
                });
                
                // 禁用表单
                const forms = [
                    document.getElementById('adminVerifyForm'),
                    document.getElementById('deleteUserForm'),
                    document.getElementById('createUserForm')
                ];
                
                forms.forEach(form => {
                    if (form) {
                        const inputs = form.querySelectorAll('input, button[type="submit"]');
                        inputs.forEach(input => input.disabled = true);
                    }
                });
            } else {
                // 清除所有锁定信息显示
                lockMessages.forEach(el => {
                    if (el) {
                        el.textContent = '';
                        el.style.display = 'none';
                    }
                });
                
                // 启用表单
                const forms = [
                    document.getElementById('adminVerifyForm'),
                    document.getElementById('deleteUserForm'),
                    document.getElementById('createUserForm')
                ];
                
                forms.forEach(form => {
                    if (form) {
                        const inputs = form.querySelectorAll('input, button[type="submit"]');
                        inputs.forEach(input => input.disabled = false);
                    }
                });
            }
        }

        // 显示/隐藏不同部分
        function showSection(sectionName) {
            // 隐藏所有section
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });
            // 显示选中的section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // 特殊处理：如果显示的是仪表盘，也显示登录历史记录部分
            if (sectionName === 'dashboard') {
                const loginHistorySection = document.getElementById('login-history-section');
                if (loginHistorySection) {
                    loginHistorySection.style.display = 'block';
                }
            }

            // 更新导航项的激活状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // 根据选中的部分更新数据
            switch(sectionName) {
                case 'dashboard':
                    updateStats();
                    updateCurrentTime();
                    updateAiStats();
                    updateSalesStats();
                    refreshLoginHistory();
                    break;
                case 'users':
                    updateUsersList();
                    break;
                case 'logs':
                    refreshLogs();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'visualization':
                    refreshVisualization();
                    break;
                case 'health':
                    refreshHealthStats();
                    break;
                case 'reports':
                    refreshReportsList();
                    break;
                case 'anomaly':
                    refreshAnomalies();
                    break;
                case 'notifications':
                    loadNotificationUsers();
                    refreshNotificationsList();
                    break;
            }
        }

        // 登出
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // 直接通过window.location导航到GET方法的登出路由
                window.location.replace('/admin/logout');
            }
        }

        // 更新统计数据
        function updateStats() {
            fetch('/admin/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('today-analysis').textContent = data.today_analysis;
                document.getElementById('total-analysis').textContent = data.total_analysis;
                document.getElementById('active-users').textContent = data.active_users;
                document.getElementById('uptime').textContent = data.uptime + '天';
                
                // 更新最近分析记录
                const tbody = document.getElementById('recent-analysis');
                tbody.innerHTML = '';
                
                if (data.recent_analysis && data.recent_analysis.length > 0) {
                    data.recent_analysis.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(record.created_at)}</td>
                            <td>${escapeHtml(record.username)}</td>
                            <td>${escapeHtml(String(record.file_count))} 个文件</td>
                            <td>${record.analysis_mode === 'single' ? '单文件分析' : '多文件分析'}</td>
                            <td>
                                <span class="status-badge ${record.status === '完成' ? 'status-active' : 'status-inactive'}">
                                    ${escapeHtml(record.status)}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="5" style="text-align: center;">暂无分析记录</td>`;
                    tbody.appendChild(tr);
                }
            })
            .catch(error => {
                console.error('获取统计数据失败:', error);
            });
        }

        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleDateString('zh-CN') + ' ' + 
                             now.toLocaleTimeString('zh-CN');
            document.getElementById('current-time').innerHTML = `
                <i class="ri-time-line"></i>
                ${timeString}
            `;
        }

        // 获取用户列表
        function updateUsersList() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const users = data.data;
                        const tbody = document.getElementById('users-list');
                        tbody.innerHTML = '';
                        
                        users.forEach(user => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${user.id}</td>
                                <td>
                                    ${escapeHtml(user.username)}
                                    ${user.is_admin ? `<span class="badge badge-primary">
                                        ${user.admin_level}级管理员
                                    </span>` : ''}
                                </td>
                                <td>${escapeHtml(user.email)}</td>
                                <td>
                                    <span class="status-badge ${user.status === '活跃' ? 'status-active' : 'status-inactive'}">
                                        ${escapeHtml(user.status)}
                                    </span>
                                </td>
                                <td>
                                    ${user.username !== 'admin' ? `
                                        <button class="button button-warning" onclick="toggleAdmin(${user.id}, ${user.admin_level || 0})">
                                            ${user.is_admin ? '修改管理员等级' : '设置管理员'}
                                        </button>
                                        ${!user.is_admin ? `
                                            <button class="button button-${user.status === '活跃' ? 'danger' : 'success'}" onclick="toggleStatus(${user.id})">
                                                ${user.status === '活跃' ? '禁用账号' : '启用账号'}
                                            </button>
                                            <button class="button button-danger" onclick="showDeleteUserModal(${user.id})">
                                                删除用户
                                            </button>
                                        ` : ''}
                                    ` : ''}
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        showNotification(data.message || '获取用户列表失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('获取用户列表失败，请刷新页面重试', 'error');
                });
        }

        // 刷新日志
        function refreshLogs() {
            fetch('/admin/logs')
            .then(response => response.json())
            .then(logs => {
                const tbody = document.getElementById('logs-list');
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${escapeHtml(log.timestamp)}</td>
                        <td>
                            <span class="status-badge ${getLogLevelClass(log.level)}">
                                ${escapeHtml(log.level)}
                            </span>
                        </td>
                        <td>${escapeHtml(log.message)}</td>
                    </tr>
                `).join('');
                
                // 滚动到最新日志
                const logsContainer = tbody.parentElement.parentElement;
                logsContainer.scrollTop = logsContainer.scrollHeight;
            });
        }

        // 获取日志级别对应的样式类
        function getLogLevelClass(level) {
            const classes = {
                'INFO': 'status-active',
                'WARNING': 'status-warning',
                'ERROR': 'status-inactive',
                'DEBUG': 'status-info'
            };
            return classes[level] || 'status-info';
        }

        // 防止XSS攻击的辅助函数
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 设置主题
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // 初始化数据
            updateStats();
            updateCurrentTime();
            updateUsersList();
            refreshLogs();
            loadSettings();
            updateAiStats(); // 加载AI分析统计数据
            updateSalesStats(); // 加载销售分析统计数据
            refreshVisualization(); // 加载数据可视化
            
            // 定时更新
            setInterval(updateStats, 60000); // 每分钟更新统计数据
            setInterval(updateCurrentTime, 1000); // 每秒更新时间
            setInterval(refreshLogs, 30000); // 每30秒更新日志
            setInterval(updateAiStats, 60000); // 每分钟更新AI分析统计数据
            setInterval(updateSalesStats, 60000); // 每分钟更新销售分析统计数据
            setInterval(refreshVisualization, 60000); // 每分钟刷新数据可视化
            
            // 检查会话状态
            setInterval(checkSession, 60000); // 每分钟检查会话状态

            // 添加通知样式
            const style = document.createElement('style');
            style.textContent = `
                .notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    border-radius: 8px;
                    background: var(--card-background);
                    color: var(--text-color);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 1000;
                    animation: slideIn 0.3s ease-out;
                }

                .notification.success {
                    background: var(--success-color);
                    color: white;
                }

                .notification.error {
                    background: var(--error-color);
                    color: white;
                }

                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        });

        // 检查会话状态
        function checkSession() {
            fetch('/admin/stats')
            .then(response => {
                if (response.status === 401) {
                    // 会话过期，重定向到登录页面
                    window.location.href = '/admin';
                }
            });
        }

        // 加载设置
        function loadSettings() {
            fetch('/admin/settings')
                .then(response => response.json())
                .then(data => {
                    // 基本设置
                    document.getElementById('system-name').value = data.systemName || '数据分析系统';
                    document.getElementById('system-description').value = data.systemDescription || '';
                    document.getElementById('admin-email').value = data.adminEmail || '';

                    // 安全设置
                    document.getElementById('login-attempts').value = data.loginAttempts || 5;
                    document.getElementById('min-password-length').value = data.minPasswordLength || 8;
                    document.getElementById('session-timeout').value = data.sessionTimeout || 30;
                    document.getElementById('require-uppercase').checked = data.requireUppercase !== false;
                    document.getElementById('require-numbers').checked = data.requireNumbers !== false;
                    document.getElementById('require-special').checked = data.requireSpecial !== false;

                    // 日志设置
                    document.getElementById('log-level').value = data.logLevel || 'INFO';
                    document.getElementById('log-retention').value = data.logRetention || 30;
                    document.getElementById('log-size-limit').value = data.logSizeLimit || 100;

                    // 界面设置
                    document.getElementById('default-theme').value = data.defaultTheme || 'light';
                    document.querySelector(`input[name="animation"][value="${data.animation || 'on'}"]`).checked = true;
                    document.querySelector(`input[name="show-avatar"][value="${data.showAvatar || 'on'}"]`).checked = true;
                    
                    // AI分析界面设置
                    document.querySelector(`input[name="typewriter-effect"][value="${data.typewriterEffect || 'on'}"]`).checked = true;
                    document.getElementById('typewriter-speed').value = data.typewriterSpeed || 'medium';
                    document.getElementById('default-font').value = data.defaultFont || 'system';
                    document.getElementById('bubble-style').value = data.bubbleStyle || 'square';
                })
                .catch(error => {
                    console.error('加载设置失败:', error);
                    showNotification('加载设置失败，请刷新页面重试', 'error');
                });
        }

        // 保存设置
        function saveSettings() {
            const settings = {
                // 基本设置
                systemName: document.getElementById('system-name').value,
                systemDescription: document.getElementById('system-description').value,
                adminEmail: document.getElementById('admin-email').value,

                // 安全设置
                loginAttempts: parseInt(document.getElementById('login-attempts').value),
                minPasswordLength: parseInt(document.getElementById('min-password-length').value),
                sessionTimeout: parseInt(document.getElementById('session-timeout').value),
                requireUppercase: document.getElementById('require-uppercase').checked,
                requireNumbers: document.getElementById('require-numbers').checked,
                requireSpecial: document.getElementById('require-special').checked,

                // 日志设置
                logLevel: document.getElementById('log-level').value,
                logRetention: parseInt(document.getElementById('log-retention').value),
                logSizeLimit: parseInt(document.getElementById('log-size-limit').value),

                // 界面设置
                defaultTheme: document.getElementById('default-theme').value,
                animation: document.querySelector('input[name="animation"]:checked').value,
                showAvatar: document.querySelector('input[name="show-avatar"]:checked').value,
                
                // AI分析界面设置
                typewriterEffect: document.querySelector('input[name="typewriter-effect"]:checked').value,
                typewriterSpeed: document.getElementById('typewriter-speed').value,
                defaultFont: document.getElementById('default-font').value,
                bubbleStyle: document.getElementById('bubble-style').value
            };

            fetch('/admin/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('设置保存成功', 'success');
                    // 保存成功后立即重新加载设置
                    loadSettings();
                    // 更新页面标题
                    document.title = settings.systemName + ' - 管理员仪表板';
                } else {
                    showNotification(data.message || '保存设置失败', 'error');
                }
            })
            .catch(error => {
                console.error('保存设置失败:', error);
                showNotification('保存设置失败，请稍后重试', 'error');
            });
        }

        // 重置设置
        function resetSettings() {
            if (confirm('确定要重置所有设置吗？这将恢复系统默认设置。')) {
                fetch('/admin/settings/reset', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('设置已重置', 'success');
                        loadSettings();  // 重新加载设置
                    } else {
                        showNotification(data.message || '重置设置失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('重置设置失败:', error);
                    showNotification('重置设置失败，请稍后重试', 'error');
                });
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // 添加到页面
            document.body.appendChild(notification);

            // 3秒后自动移除
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 刷新分析记录
        function refreshAnalysisRecords() {
            fetch('/admin/stats')
            .then(response => response.json())
            .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'error');
                        return;
                    }
                    
                    // 更新最近分析记录
                    const recentAnalysis = document.getElementById('recent-analysis');
                    recentAnalysis.innerHTML = '';
                
                    if (data.recent_analysis && data.recent_analysis.length > 0) {
                        data.recent_analysis.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${record.created_at}</td>
                                <td>${record.username}</td>
                                <td>${record.file_count} 个文件</td>
                                <td>${record.analysis_mode === 'single' ? '单文件分析' : '多文件比较'}</td>
                                <td><span class="status-badge ${record.status === '完成' ? 'success' : 'error'}">${record.status}</span></td>
                            `;
                            recentAnalysis.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="5" class="text-center">暂无分析记录</td>';
                        recentAnalysis.appendChild(row);
                    }
                    
                    // 更新统计数据
                    document.getElementById('today-analysis').textContent = data.today_analysis || 0;
                    document.getElementById('total-analysis').textContent = data.total_analysis || 0;
                    document.getElementById('active-users').textContent = data.active_users || 0;
                    
                    showNotification('数据已更新', 'success');
            })
            .catch(error => {
                    console.error('刷新分析记录失败:', error);
                    showNotification('刷新失败，请稍后重试', 'error');
            });
        }

        // 更新AI分析统计数据
        function updateAiStats() {
            fetch('/admin/ai_stats')
            .then(response => response.json())
            .then(data => {
                // 更新AI分析统计卡片
                document.getElementById('today-ai-analysis').textContent = data.today_ai_analysis;
                document.getElementById('total-ai-analysis').textContent = data.total_ai_analysis;
                document.getElementById('ai-users').textContent = data.ai_users;
                document.getElementById('avg-response-time').textContent = data.avg_response_time + '秒';
                
                // 更新最近AI分析记录
                const tbody = document.getElementById('recent-ai-analysis');
                tbody.innerHTML = '';
                
                if (data.recent_ai_analysis && data.recent_ai_analysis.length > 0) {
                    data.recent_ai_analysis.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(record.created_at)}</td>
                            <td>${escapeHtml(record.username)}</td>
                            <td>${escapeHtml(String(record.file_count))}</td>
                            <td>${escapeHtml(String(record.response_time))}秒</td>
                            <td>
                                <span class="status-badge ${record.status === '完成' ? 'status-active' : 'status-inactive'}">
                                    ${escapeHtml(record.status)}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="5" style="text-align: center;">暂无AI分析记录</td>`;
                    tbody.appendChild(tr);
                }
            })
            .catch(error => {
                console.error('获取AI分析统计数据失败:', error);
                showNotification('获取AI分析统计数据失败，请稍后重试', 'error');
            });
        }

        // 刷新AI分析记录
        function refreshAiStats() {
            updateAiStats();
            showNotification('AI分析统计数据已更新', 'success');
        }

        // 更新销售分析统计数据
        function updateSalesStats() {
            fetch('/admin/sales_stats')
            .then(response => response.json())
            .then(data => {
                // 更新销售分析统计卡片
                document.getElementById('today-sales-analysis').textContent = data.today_sales_analysis;
                document.getElementById('total-sales-analysis').textContent = data.total_sales_analysis;
                document.getElementById('sales-analysis-users').textContent = data.sales_analysis_users;
                document.getElementById('avg-processing-time').textContent = data.avg_processing_time + '秒';
                
                // 更新最近销售分析记录
                const tbody = document.getElementById('recent-sales-analysis');
                tbody.innerHTML = '';
                
                if (data.recent_sales_analysis && data.recent_sales_analysis.length > 0) {
                    data.recent_sales_analysis.forEach(record => {

                        let analysisTypeChinese = record.analysis_type;
                        if (record.analysis_type === 'trend') {
                            analysisTypeChinese = '销售趋势分析';
                        } else if (record.analysis_type === 'year_over_year') {
                            analysisTypeChinese = '销售同比分析';
                        } else if (record.analysis_type === 'month_over_month') {
                            analysisTypeChinese = '销售环比分析';
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(record.created_at)}</td>
                            <td>${escapeHtml(record.username)}</td>
                            <td>${escapeHtml(String(record.file_count))}</td>
                            <td>${escapeHtml(analysisTypeChinese)}</td>
                            <td>
                                <span class="status-badge ${record.status === '完成' ? 'status-active' : 'status-inactive'}">
                                    ${escapeHtml(record.status)}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="5" style="text-align: center;">暂无销售分析记录</td>`;
                    tbody.appendChild(tr);
                }
            })
            .catch(error => {
                console.error('获取销售分析统计数据失败:', error);
                showNotification('获取销售分析统计数据失败，请稍后重试', 'error');
            });
        }

        // 刷新销售分析记录
        function refreshSalesStats() {
            updateSalesStats();
            showNotification('销售分析统计数据已更新', 'success');
        }

        // 显示管理员验证模态框
        function showAdminVerifyModal(action, userId, message, level) {
            const modal = document.getElementById('adminVerifyModal');
            modal.style.display = 'block';
            
            document.getElementById('admin-verify-message').textContent = message || '请输入管理员账号和密码';
            
            // 清空输入框
            document.getElementById('verify_admin_username').value = '';
            document.getElementById('verify_admin_password').value = '';
            
            // 更新锁定显示
            updateLockDisplay();

            // 记录当前操作和用户ID
            if (action === 'send_notification') {
                currentAdminAction = action;
            } else {
                currentAction = action; 
                currentUserId = userId;
                currentAdminLevel = level;
            }
        }
        
        // 管理员验证确认操作 - 用于通知发送
        async function confirmNotificationAdminAction(event) {
            event.preventDefault();
            
            // 检查是否处于锁定状态
            if (isAdminVerifyLocked()) {
                showNotification('验证功能已被锁定，请稍后再试', 'error');
                return;
            }
            
            const adminUsername = document.getElementById('verify_admin_username').value;
            const adminPassword = document.getElementById('verify_admin_password').value;
            
            if (!adminUsername || !adminPassword) {
                showNotification('请输入管理员账号和密码', 'error');
                return;
            }
            
            if (currentAdminAction === 'send_notification') {
                // 验证管理员身份
                try {
                    const response = await fetch('/api/admin/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            admin_username: adminUsername,
                            admin_password: adminPassword
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        adminVerifyFailCount = 0;
                        // 验证成功，执行发送通知操作
                        hideAdminVerifyModal();
                        executeSendNotification(adminUsername);
                    } else {
                        // 验证失败，增加失败计数
                        const isLocked = incrementVerifyFailCount();
                        if (!isLocked) {
                            showNotification(data.message + ` (剩余尝试次数: ${3 - adminVerifyFailCount % 3})`, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('验证失败，请稍后重试', 'error');
                }
            }
            // 这里可以添加其他管理员操作的处理分支
        }

        // 隐藏管理员验证模态框
        function hideAdminVerifyModal() {
            const modal = document.getElementById('adminVerifyModal');
            modal.style.display = 'none';
            currentAdminAction = null;
        }

        // 修改toggleAdmin函数
        function toggleAdmin(userId, currentLevel) {
            // 创建一个模态框来显示管理员等级选项
            const levelSelectModal = document.createElement('div');
            levelSelectModal.className = 'modal';
            levelSelectModal.id = 'levelSelectModal';
            levelSelectModal.innerHTML = `
                <div class="modal-content admin-level-select-content">
                    <div class="modal-header">
                        <h3>选择管理员等级</h3>
                        <button class="close-button" onclick="document.getElementById('levelSelectModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="level-buttons">
                            <button onclick="selectAdminLevel(${userId}, 0)" class="level-button remove-admin-button">
                                取消管理员
                            </button>
                            <button onclick="selectAdminLevel(${userId}, 1)" class="level-button level-1-button">
                                设为一级管理员
                            </button>
                            <button onclick="selectAdminLevel(${userId}, 2)" class="level-button level-2-button">
                                设为二级管理员
                            </button>
                            <button onclick="selectAdminLevel(${userId}, 3)" class="level-button level-3-button">
                                设为三级管理员
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(levelSelectModal);
            levelSelectModal.style.display = 'block';
        }

        // 添加选择管理员等级的函数
        function selectAdminLevel(userId, level) {
            // 移除等级选择模态框
            document.getElementById('levelSelectModal').remove();
            // 显示管理员验证模态框
            showAdminVerifyModal('toggleAdmin', userId, '请输入管理员账号和密码以确认修改用户权限', level);
        }

        // 切换用户状态
        function toggleStatus(userId) {
            showAdminVerifyModal('toggleStatus', userId, '请输入管理员账号和密码以确认修改用户状态');
        }

        // 确认管理员操作
        async function confirmAdminAction(event) {
            event.preventDefault();
            
            // 检查是否处于锁定状态
            if (isAdminVerifyLocked()) {
                showNotification('验证功能已被锁定，请稍后再试', 'error');
                return;
            }
            
            const adminUsername = document.getElementById('verify_admin_username').value;
            const adminPassword = document.getElementById('verify_admin_password').value;
            
            if (!adminUsername || !adminPassword) {
                showNotification('请输入管理员账号和密码', 'error');
                return;
            }
            
            try {
                let endpoint = '';
                let body = {
                    admin_username: adminUsername,
                    admin_password: adminPassword
                };
                
                if (currentAction === 'toggleAdmin') {
                    endpoint = `/api/users/${currentUserId}/toggle-admin`;
                    body.new_admin_level = currentAdminLevel;
                } else if (currentAction === 'toggleStatus') {
                    endpoint = `/api/users/${currentUserId}/toggle-status`;
                } else if (currentAction === 'createUser') {
                    endpoint = '/api/users/create';
                    body = { ...currentUserData, admin_username: adminUsername, admin_password: adminPassword };
                } else if (currentAction === 'blockAnomalyUser') {
                    // 处理封禁异常用户的请求
                    endpoint = `/admin/anomaly/user/${currentUserId}/action`;
                    body = {
                        action: 'block',
                        admin_username: adminUsername,
                        admin_password: adminPassword
                    };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adminVerifyFailCount = 0;

                    showNotification(data.message, 'success');
                    hideAdminVerifyModal();
                    if (currentAction === 'createUser') {
                        hideCreateUserModal();
                    }
                    if (currentAction === 'blockAnomalyUser') {
                        refreshAnomalies();
                    } else {
                        updateUsersList();
                    }
                } else {
                    // 验证失败，增加失败计数
                    const isLocked = incrementVerifyFailCount();
                    
                    // 错误消息处理
                    let errorMessage = data.message;
                    
                    // 检查是否是权限相关错误（不增加失败计数）
                    if (data.message.includes('无权封禁同级') || data.message.includes('无权修改同级') 
                        || data.message.includes('无权删除同级') || data.message.includes('权限不足')) {
                        // 权限错误不增加失败计数
                        adminVerifyFailCount = Math.max(0, adminVerifyFailCount - 1);
                        showNotification(errorMessage, 'error');
                    } else if (!isLocked) {
                        // 其他错误显示剩余尝试次数
                        showNotification(errorMessage + ` (剩余尝试次数: ${3 - adminVerifyFailCount % 3})`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('操作失败，请稍后重试', 'error');
            }
        }

        // 显示/隐藏管理员级别选择
        function toggleAdminLevelSelect() {
            const isAdmin = document.getElementById('is_admin').checked;
            const adminLevelGroup = document.getElementById('adminLevelGroup');
            adminLevelGroup.style.display = isAdmin ? 'block' : 'none';
        }

        // 处理创建用户
        async function handleCreateUser(event) {
            event.preventDefault();
            
            // 检查是否处于锁定状态
            if (isAdminVerifyLocked()) {
                showNotification('验证功能已被锁定，请稍后再试', 'error');
                return;
            }
            
            const username = document.getElementById('new_username').value;
            const email = document.getElementById('new_email').value;
            const password = document.getElementById('new_password').value;
            const isAdmin = document.getElementById('is_admin').checked;
            const adminLevel = isAdmin ? parseInt(document.getElementById('admin_level').value) : 0;
            
            // 如果是创建管理员用户，需要验证当前管理员的权限
            if (isAdmin) {
                // 保存创建用户的信息到全局变量
                currentAction = 'createUser';
                currentUserData = {
                    username: username,
                    email: email,
                    password: password,
                    is_admin: isAdmin,
                    admin_level: adminLevel
                };
                
                // 显示管理员验证模态框
                showAdminVerifyModal('createUser', null, '请输入管理员账号和密码以确认创建管理员用户');
                return;
            }
            
            // 如果是创建普通用户，直接发送请求
            try {
                const response = await fetch('/api/users/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        is_admin: false,
                        admin_level: 0
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 不再重置失败计数
                    adminVerifyFailCount = 0;
                    
                    showNotification(data.message, 'success');
                    hideCreateUserModal();
                    updateUsersList();
                } else {
                    // 创建失败，增加失败计数
                    const isLocked = incrementVerifyFailCount();
                    if (!isLocked) {
                        showNotification(data.message + ` (剩余尝试次数: ${3 - adminVerifyFailCount % 3})`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('创建用户失败，请稍后重试', 'error');
            }
        }

        // 显示创建用户模态框
        function showCreateUserModal() {
            const modal = document.getElementById('createUserModal');
            modal.style.display = 'block';
            // 重置表单
            document.getElementById('createUserForm').reset();
            document.getElementById('adminLevelGroup').style.display = 'none';
            
            // 检查锁定状态并更新显示
            updateLockDisplay();
        }

        // 隐藏创建用户模态框
        function hideCreateUserModal() {
            const modal = document.getElementById('createUserModal');
            modal.style.display = 'none';
        }

        // 获取登录历史记录
        async function getLoginHistory() {
            try {
                const response = await fetch('/api/login-history');
                if (!response.ok) {
                    throw new Error('获取登录历史记录失败');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取登录历史记录失败:', error);
                showToast('获取登录历史记录失败，请刷新页面重试', 'error');
                return [];
            }
        }

        // 刷新登录历史记录
        async function refreshLoginHistory() {
            const historyList = document.getElementById('login-history-list');
            historyList.innerHTML = '<tr><td colspan="5" class="text-center">加载中...</td></tr>';
            
            const records = await getLoginHistory();
            
            if (records.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" class="text-center">暂无登录记录</td></tr>';
                return;
            }
            
            historyList.innerHTML = records.map(record => {
                // 调整时区：为时间添加8小时
                let loginTime = record.loginTime;
                try {
                    // 解析时间字符串为Date对象
                    const dateObj = new Date(record.loginTime);
                    // 添加8小时
                    dateObj.setHours(dateObj.getHours() + 8);
                    // 格式化为本地时间字符串
                    loginTime = dateObj.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (error) {
                    console.error('时间格式转换出错:', error);
                }
                
                return `
                    <tr>
                        <td>${record.id}</td>
                        <td>
                            ${record.username}
                            ${record.isAdmin ? '<span class="badge badge-admin">管理员</span>' : ''}
                        </td>
                        <td>${loginTime}</td>
                        <td>${record.ipAddress}</td>
                        <td>
                            <span class="badge ${record.status.includes('失败') ? 'badge-error' : 'badge-success'}">
                                ${record.status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        //页面加载完成后自动加载登录历史
        document.addEventListener('DOMContentLoaded', function() {
            refreshLoginHistory();
        });

        // 搜索用户
        function searchUser(event) {
            const searchTerm = event.target.value.toLowerCase();
            const userRows = document.querySelectorAll('#users-list tr');
            
            userRows.forEach(row => {
                const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (searchTerm === '' || username.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        let userToDelete = null;

        // 显示删除用户模态框
        function showDeleteUserModal(userId) {
            userToDelete = userId;
            const modal = document.getElementById('deleteUserModal');
            modal.style.display = 'block';
            document.getElementById('admin_username').value = '';
            document.getElementById('admin_password').value = '';
            
            // 检查锁定状态并更新显示
            updateLockDisplay();
        }

        // 隐藏删除用户模态框
        function hideDeleteUserModal() {
            const modal = document.getElementById('deleteUserModal');
            modal.style.display = 'none';
            userToDelete = null;
        }

        // 确认删除用户
        async function confirmDeleteUser(event) {
            event.preventDefault();
            
            // 检查是否处于锁定状态
            if (isAdminVerifyLocked()) {
                showNotification('验证功能已被锁定，请稍后再试', 'error');
                return;
            }
            
            const adminUsername = document.getElementById('admin_username').value;
            const adminPassword = document.getElementById('admin_password').value;
            
            if (!adminUsername || !adminPassword) {
                showNotification('请输入管理员账号和密码', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userToDelete}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_username: adminUsername,
                        admin_password: adminPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 不再重置失败计数
                    adminVerifyFailCount = 0;
                    
                    showNotification(data.message, 'success');
                    hideDeleteUserModal();
                    updateUsersList();
                } else {
                    // 验证失败，增加失败计数
                    const isLocked = incrementVerifyFailCount();
                    if (!isLocked) {
                        showNotification(data.message + ` (剩余尝试次数: ${3 - adminVerifyFailCount % 3})`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('删除失败，请稍后重试', 'error');
            }
        }

        // 添加CSS样式
        const style = document.createElement('style');
        style.innerHTML = `
            /* 热图样式 */
            .heatmap-table {
                width: 100%;
                border-collapse: collapse;
            }
            .heatmap-table th, .heatmap-table td {
                padding: 8px;
                text-align: center;
                border: 1px solid #ddd;
            }
            .heatmap-table th {
                background-color: var(--header-background);
                color: var(--header-text-color);
            }
            
            /* 热度单元格 */
             .heat-cell {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
            }

            .heat-normal, .heat-ai, .heat-sales {
                font-size: 0.8rem;
            }
                            
            /* 表单网格 */
            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .form-actions {
                grid-column: span 2;
                display: flex;
                justify-content: flex-end;
                margin-top: 10px;
            }
            
            /* 表单组件 */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-control {
                width: 100%;
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                background-color: var(--input-background);
                color: var(--text-color);
            }
            
            .checkbox-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            /* 风险等级标签 */
            .risk-badge {
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .risk-high {
                background-color: #ff4c4c;
                color: white;
            }
            
            .risk-medium {
                background-color: #ffa64c;
                color: white;
            }
            
            .risk-low {
                background-color: #ffeb4c;
                color: black;
            }
        `;
        document.head.appendChild(style);

        // 数据可视化相关函数
        function refreshVisualization() {
            // 使用真实API获取数据
            fetch('/admin/visualization_data')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                // 获取当前主题
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                
                // 设置Chart.js全局颜色配置
                Chart.defaults.color = isDarkMode ? '#e0e0e0' : '#666';
                Chart.defaults.borderColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                
                // 绘制每日分析次数趋势图
                const dailyCtx = document.getElementById('daily-trend-chart').getContext('2d');
                
                // 获取日期和数据
                const dates = data.trend_data.dates;
                const normalData = data.trend_data.normal_data;
                const aiData = data.trend_data.ai_data;
                
                // 格式化日期显示（只显示月和日）
                const formattedDates = dates.map(date => {
                    const d = new Date(date);
                    return `${d.getMonth() + 1}/${d.getDate()}`;
                });
                
                // 销毁现有图表（如果存在）
                if (window.dailyChart) {
                    window.dailyChart.destroy();
                }
                
                // 创建新图表
                window.dailyChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: formattedDates,
                        datasets: [{
                            label: '普通分析',
                            data: normalData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            fill: true
                        }, {
                            label: 'AI分析',
                            data: aiData,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            fill: true
                         }, {
                            label: '销售分析',
                            data: data.trend_data.sales_data,
                            borderColor: '#FF5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '每日分析次数趋势'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // 绘制分析模式使用比例图
                const modeCtx = document.getElementById('mode-usage-chart').getContext('2d');
                
                // 准备普通分析模式数据
                const normalModes = data.mode_usage.normal_modes;
                const aiTypes = data.mode_usage.ai_types;
                const salesTypes = data.mode_usage.sales_types || {};
                
                // 合并所有分析模式
                const allModes = {};
                
                // 添加普通分析模式
                for (const mode in normalModes) {
                    const displayName = mode === 'single' ? '单文件分析' : '多文件比较';
                    allModes[displayName] = normalModes[mode];
                }
                
                // 添加AI分析类型
                for (const type in aiTypes) {
                    allModes[type] = aiTypes[type];
                }
                
                // 添加销售分析类型
                for (const type in salesTypes) {
                    // 创建中文映射
                    let displayName;
                    switch(type) {
                        case 'trend':
                            displayName = '销售趋势分析';
                            break;
                        case 'year_over_year':
                            displayName = '销售同比分析';
                            break;
                        case 'month_over_month':
                            displayName = '销售环比分析';
                            break;
                        // 如果已经是中文，则保持原样
                        case '趋势分析':
                            displayName = '销售趋势分析';
                            break;
                        case '同比分析':
                            displayName = '销售同比分析';
                            break;
                        case '环比分析':
                            displayName = '销售环比分析';
                            break;
                        default:
                            // 检查是否有其他英文命名需要转换
                            if (type.includes('trend')) {
                                displayName = '销售趋势分析';
                            } else if (type.includes('year')) {
                                displayName = '销售同比分析';
                            } else if (type.includes('month')) {
                                displayName = '销售环比分析';
                            } else {
                                displayName = '销售' + type;
                            }
                    }
                    allModes[displayName] = salesTypes[type];
                }

                // 提取标签和数据
                const modeLabels = Object.keys(allModes);
                const modeValues = Object.values(allModes);
                
                // 设置颜色
                const colors = [
                    '#4CAF50', '#FFC107', '#2196F3', '#9C27B0', '#FF5722',
                    '#3F51B5', '#009688', '#795548', '#607D8B', '#E91E63'
                ];
                
                // 销毁现有图表（如果存在）
                if (window.modeChart) {
                    window.modeChart.destroy();
                }
                
                // 创建新图表
                window.modeChart = new Chart(modeCtx, {
                    type: 'pie',
                    data: {
                        labels: modeLabels,
                        datasets: [{
                            data: modeValues,
                            backgroundColor: colors.slice(0, modeLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: '分析模式使用比例'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.formattedValue;
                                        const dataset = context.dataset;
                                        const total = dataset.data.reduce((acc, data) => acc + data, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1) + '%';
                                        return `${label}: ${value} (${percentage})`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // 生成用户活跃度热图数据
                const heatmapData = data.heatmap_data || {};
                // 使用固定排序的星期数组，而不是Object.keys
                const orderedDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                const heatmapBody = document.getElementById('heatmap-body');
                heatmapBody.innerHTML = '';
                
                // 默认时间段
                const timeSlots = [];
                for (let hour = 0; hour < 24; hour += 2) {
                    timeSlots.push(`${hour.toString().padStart(2, '0')}-${(hour + 2).toString().padStart(2, '0')}`);
                }
                
                // 如果没有获取到数据，显示默认数据
                if (Object.keys(heatmapData).length === 0) {
                    orderedDays.forEach(day => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${day}</td>`;
                        
                        timeSlots.forEach(hourKey => {
                            // 生成随机活跃度
                            const normalActivity = Math.floor(Math.random() * 5) + 1;
                            const aiActivity = Math.floor(Math.random() * 5);
                            const salesActivity = Math.floor(Math.random() * 3); 
                            const totalActivity = normalActivity + aiActivity;
                            const color = getHeatColor(totalActivity);
                            row.innerHTML += `
                                <td>
                                    <div class="heat-cell" style="background-color: ${color}">
                                        <span class="heat-normal">${normalActivity}</span>
                                        <span class="heat-ai">${aiActivity}</span>
                                        <span class="heat-sales">${salesActivity}</span>
                                    </div>
                                </td>
                            `;
                        });
                        
                        heatmapBody.appendChild(row);
                    });
                } else {
                    // 使用真实数据
                    orderedDays.forEach(day => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${day}</td>`;
                        
                        timeSlots.forEach(hourKey => {
                            const cellData = heatmapData[day]?.[hourKey] || {normal: 0, ai: 0, total: 0};
                            const normalActivity = cellData.normal;
                            const aiActivity = cellData.ai;
                            const salesActivity = cellData.sales || 0;
                            const totalActivity = cellData.total;
                            const color = getHeatColor(totalActivity);
                            row.innerHTML += `
                                <td>
                                    <div class="heat-cell" style="background-color: ${color}">
                                        <span class="heat-normal">${normalActivity}</span>
                                        <span class="heat-ai">${aiActivity}</span>
                                        <span class="heat-sales">${salesActivity}</span>
                                    </div>
                                </td>
                            `;
                        });
                        
                        heatmapBody.appendChild(row);
                    });
                }
                
                // 添加图例
                const heatmapContainer = document.getElementById('user-heatmap');
                
                // 先检查并删除已有的图例，防止重复
                const existingLegend = heatmapContainer.querySelector('.legend-container');
                if (existingLegend) {
                    existingLegend.remove();
                }
                
                const legendContainer = document.createElement('div');
                legendContainer.className = 'legend-container';
                legendContainer.innerHTML = `
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #a8d5ff"></span>
                        <span>低活跃度</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #5cbbff"></span>
                        <span>中低活跃度</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #ffb86c"></span>
                        <span>中活跃度</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #ff8f59"></span>
                        <span>中高活跃度</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #ff5c5c"></span>
                        <span>高活跃度</span>
                    </div>
                    <div class="legend-item">
                        <span>上: 普通分析</span>
                    </div>
                    <div class="legend-item">
                        <span>中: AI分析</span>
                    </div>
                     <div class="legend-item">
                        <span>下: 销售分析</span>
                    </div>
                `;
                
                heatmapContainer.appendChild(legendContainer);
                
                showNotification('数据可视化已更新', 'success');
            })
            .catch(error => {
                console.error('获取可视化数据失败:', error);
                showNotification('获取可视化数据失败，请稍后重试', 'error');
            });
        }
        
        // 根据活跃度获取热图颜色
        function getHeatColor(value) {
            // 将value归一化到0-100的范围
            const normalized = Math.min(Math.max(value * 10, 0), 100);
            
            // 颜色从蓝色（低）到红色（高）
            if (normalized < 20) {
                return '#a8d5ff'; // 浅蓝色
            } else if (normalized < 40) {
                return '#5cbbff'; // 蓝色
            } else if (normalized < 60) {
                return '#ffb86c'; // 橙色
            } else if (normalized < 80) {
                return '#ff8f59'; // 深橙色
            } else {
                return '#ff5c5c'; // 红色
            }
        }
        
        // 系统健康状况相关函数
        function refreshHealthStats() {
            fetch('/admin/health_stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取系统健康状况数据失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // 更新数据库性能指标
                    document.getElementById('db-query-count').textContent = data.db_stats.query_count;
                    document.getElementById('db-response-time').textContent = data.db_stats.response_time > 1000 ? 
                        (data.db_stats.response_time / 1000).toFixed(2) + 's' : 
                        data.db_stats.response_time + 'ms';
                    document.getElementById('db-size').textContent = data.db_stats.db_size + 'MB';
                    document.getElementById('uptime').textContent = data.uptime + '天';
                    
                    // 绘制系统响应时间监控图
                    const responseCtx = document.getElementById('response-time-chart').getContext('2d');
                    
                    // 获取小时标签
                    const hours = data.response_times.hours.map(hour => `${hour}:00`);
                    
                    // 获取API和数据库响应时间
                    const apiData = data.response_times.api_times;
                    const dbData = data.response_times.db_times;
                    
                    // 销毁现有图表（如果存在）
                    if (window.responseChart) {
                        window.responseChart.destroy();
                    }
                    
                    // 创建新图表
                    window.responseChart = new Chart(responseCtx, {
                        type: 'line',
                        data: {
                            labels: hours,
                            datasets: [{
                                label: 'API响应时间 (s)',
                                data: apiData,
                                borderColor: '#FF5722',
                                backgroundColor: 'rgba(255, 87, 34, 0.1)',
                                tension: 0.4,
                                borderWidth: 2,
                                fill: true
                            }, {
                                label: '数据库查询时间 (ms)',
                                data: dbData,
                                borderColor: '#673AB7',
                                backgroundColor: 'rgba(103, 58, 183, 0.1)',
                                tension: 0.4,
                                borderWidth: 2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: '24小时系统响应时间'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // 更新最近系统事件
                    const systemEvents = document.getElementById('system-events');
                    systemEvents.innerHTML = '';
                    
                    if (data.system_events && data.system_events.length > 0) {
                        data.system_events.forEach(event => {
                            const tr = document.createElement('tr');
                            const eventTime = new Date(event.time);
                            const timeString = eventTime.toLocaleString('zh-CN');
                            
                            tr.innerHTML = `
                                <td>${timeString}</td>
                                <td>${event.type}</td>
                                <td>${event.event}</td>
                                <td>${event.responseTimeUnit === 'second' ? 
                                  event.responseTime.toFixed(2) + 's' : 
                                  event.responseTime.toFixed(2) + 'ms'}</td>
                                <td>
                                    <span class="status-badge ${event.status === '成功' ? 'status-active' : (event.status === '超时' ? 'status-warning' : 'status-inactive')}">
                                        ${event.status}
                                    </span>
                                </td>
                            `;
                            systemEvents.appendChild(tr);
                        });
                    } else {
                        // 如果没有系统事件，显示"最近无事件"
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="5" class="text-center">最近无事件</td>`;
                        systemEvents.appendChild(tr);
                    }
                    
                    showNotification('系统健康状况数据已更新', 'success');
                    
                    // 设置1分钟后自动刷新
                    setTimeout(refreshHealthStats, 60000);
                })
                .catch(error => {
                    console.error('获取系统健康数据失败:', error);
                    showNotification('获取系统健康数据失败，请检查网络连接', 'error');
                    
                    // 尝试在30秒后重新获取真实数据，不使用模拟数据
                    setTimeout(refreshHealthStats, 30000);
                });
        }
        
        // 异常检测相关函数
        function refreshAnomalies() {
            fetch('/admin/anomaly_detection')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取异常检测数据失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // 更新系统异常行为
                    const systemAnomalies = document.getElementById('system-anomalies');
                    systemAnomalies.innerHTML = '';
                    
                    if (data.system_anomalies && data.system_anomalies.length > 0) {
                        data.system_anomalies.forEach(anomaly => {
                            const tr = document.createElement('tr');
                            // 转换时间格式，添加8小时的时区调整
                            const createdAt = new Date(anomaly.createdAt);
                            createdAt.setHours(createdAt.getHours() + 8); // 添加8小时，调整为中国标准时间
                            const timeString = createdAt.toLocaleString('zh-CN');
                            
                            const riskClass = anomaly.riskLevel === '高' ? 'high' : (anomaly.riskLevel === '中' ? 'medium' : 'low');
                            
                            tr.innerHTML = `
                                <td>${timeString}</td>
                                <td>${anomaly.type}</td>
                                <td><span class="risk-badge risk-${riskClass}">${anomaly.riskLevel}</span></td>
                                <td>${anomaly.description}</td>
                                <td>
                                    <button class="button button-small" onclick="handleAnomaly(${anomaly.id})">
                                        <i class="ri-error-warning-line"></i> 处理
                                    </button>
                                    <button class="button button-small button-secondary" onclick="ignoreAnomaly(${anomaly.id})">
                                        <i class="ri-eye-off-line"></i> 忽略
                                    </button>
                                </td>
                            `;
                            systemAnomalies.appendChild(tr);
                        });
                    } else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="5" class="text-center">暂无系统异常</td>`;
                        systemAnomalies.appendChild(tr);
                    }
                    
                    // 更新可疑用户活动
                    const userAnomalies = document.getElementById('user-anomalies');
                    userAnomalies.innerHTML = '';
                    
                    if (data.user_anomalies && data.user_anomalies.length > 0) {
                        data.user_anomalies.forEach(anomaly => {
                            const tr = document.createElement('tr');
                            // 转换时间格式，添加8小时的时区调整
                            const createdAt = new Date(anomaly.createdAt);
                            createdAt.setHours(createdAt.getHours() + 8); // 添加8小时，调整为中国标准时间
                            const timeString = createdAt.toLocaleString('zh-CN');
                            
                            const riskClass = anomaly.riskLevel === '高' ? 'high' : (anomaly.riskLevel === '中' ? 'medium' : 'low');
                            
                            // 检查用户是否已被禁用
                            const isDisabled = anomaly.user_status === '禁用';
                            
                            // 检查用户是否是管理员
                            const isAdmin = anomaly.is_admin === 1;
                            let adminBadge = '';
                            if (isAdmin) {
                                // 根据管理员级别显示不同的标识
                                const adminLevel = anomaly.admin_level || 3; // 默认为三级管理员
                                const adminLevelText = adminLevel === 1 ? '一级管理员' : (adminLevel === 2 ? '二级管理员' : '三级管理员');
                                adminBadge = ` <span class="status-badge status-active">${adminLevelText}</span>`;
                            }
                            
                            tr.innerHTML = `
                                <td>${timeString}</td>
                                <td>${anomaly.username}${adminBadge}${isDisabled ? ' <span class="status-badge status-inactive">已禁用</span>' : ''}</td>
                                <td>${anomaly.activity}</td>
                                <td>${anomaly.reason}</td>
                                <td><span class="risk-badge risk-${riskClass}">${anomaly.riskLevel}</span></td>
                                <td>
                                    ${isDisabled ? 
                                        `<button class="button button-small" disabled>
                                            <i class="ri-user-forbid-line"></i> 已禁用
                                        </button>` : 
                                        `<button class="button button-small" onclick="blockUser(${anomaly.id}, '${anomaly.username}')">
                                            <i class="ri-user-forbid-line"></i> 封禁用户
                                        </button>`
                                    }
                                    <button class="button button-small button-secondary" onclick="ignoreUserAnomaly(${anomaly.id})">
                                        <i class="ri-eye-off-line"></i> 忽略
                                    </button>
                                </td>
                            `;
                            userAnomalies.appendChild(tr);
                        });
                    } else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="6" class="text-center">暂无可疑用户活动</td>`;
                        userAnomalies.appendChild(tr);
                    }
                    
                    // 更新异常检测规则
                    const anomalyRules = document.getElementById('anomaly-rules');
                    anomalyRules.innerHTML = '';
                    
                    if (data.anomaly_rules && data.anomaly_rules.length > 0) {
                        data.anomaly_rules.forEach(rule => {
                            const tr = document.createElement('tr');
                            const riskClass = rule.risk === '高' ? 'high' : (rule.risk === '中' ? 'medium' : 'low');
                            
                            tr.innerHTML = `
                                <td>${rule.name}</td>
                                <td>${rule.target}</td>
                                <td>${rule.condition}</td>
                                <td><span class="risk-badge risk-${riskClass}">${rule.risk}</span></td>
                                <td><span class="status-badge ${rule.status === '启用' ? 'status-active' : 'status-inactive'}">${rule.status}</span></td>
                                <td>
                                    <button class="button button-small" onclick="editRule(${rule.id})">
                                        <i class="ri-edit-line"></i> 编辑
                                    </button>
                                    <button class="button button-small button-${rule.status === '启用' ? 'warning' : 'success'}" onclick="toggleRule(${rule.id})">
                                        <i class="ri-${rule.status === '启用' ? 'stop-line' : 'play-line'}"></i> ${rule.status === '启用' ? '禁用' : '启用'}
                                    </button>
                                    <button class="button button-small button-danger" onclick="deleteRule(${rule.id})">
                                        <i class="ri-delete-bin-line"></i> 删除
                                    </button>
                                </td>
                            `;
                            anomalyRules.appendChild(tr);
                        });
                    } else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="6" class="text-center">暂无检测规则</td>`;
                        anomalyRules.appendChild(tr);
                    }
                    
                    showNotification('异常检测数据已更新', 'success');
                    
                    // 设置1分钟后自动刷新
                    setTimeout(refreshAnomalies, 60000);
                })
                .catch(error => {
                    console.error('获取异常检测数据失败:', error);
                    showNotification('获取异常检测数据失败', 'error');
                    
                    // 显示无数据信息，而不是使用模拟数据
                    const systemAnomalies = document.getElementById('system-anomalies');
                    systemAnomalies.innerHTML = '';
                    const systemNoDataRow = document.createElement('tr');
                    systemNoDataRow.innerHTML = `<td colspan="5" class="text-center">暂无系统异常</td>`;
                    systemAnomalies.appendChild(systemNoDataRow);
                    
                    const userAnomalies = document.getElementById('user-anomalies');
                    userAnomalies.innerHTML = '';
                    const userNoDataRow = document.createElement('tr');
                    userNoDataRow.innerHTML = `<td colspan="6" class="text-center">暂无可疑用户活动</td>`;
                    userAnomalies.appendChild(userNoDataRow);
                    
                    const anomalyRules = document.getElementById('anomaly-rules');
                    anomalyRules.innerHTML = '';
                    const rulesNoDataRow = document.createElement('tr');
                    rulesNoDataRow.innerHTML = `<td colspan="6" class="text-center">暂无检测规则</td>`;
                    anomalyRules.appendChild(rulesNoDataRow);
                    
                    // 1分钟后重试
                    setTimeout(refreshAnomalies, 60000);
                });
        }
        
        // 获取异常描述
        function getAnomalyDescription(type) {
            const descriptions = {
                'CPU使用率异常': 'CPU使用率持续超过95%，可能存在资源密集型进程',
                '内存泄漏': '系统内存使用持续增长，未释放已分配的内存',
                '数据库连接过多': '数据库连接数接近最大限制，可能存在连接未正确关闭的情况',
                'API响应超时': '多个API请求响应时间超过5秒，影响用户体验',
                '磁盘空间不足': '系统磁盘空间使用率超过90%，可能导致数据无法保存'
            };
            return descriptions[type] || '未知异常';
        }
        
        // 处理系统异常
        function handleAnomaly(id) {
            console.log(`正在处理系统异常ID: ${id}`);
            fetch(`/admin/anomaly/system/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'handle'
                })
            })
            .then(response => {
                console.log(`系统异常处理响应状态: ${response.status}`);
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(`API错误: ${errData.message || '未知错误'}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('系统异常处理成功:', data);
                if (data.success) {
                    showNotification(data.message, 'success');
                    refreshAnomalies();
                } else {
                    showNotification(data.message || '处理异常失败', 'error');
                }
            })
            .catch(error => {
                console.error('处理异常失败详情:', error);
                showNotification(`处理异常失败: ${error.message}`, 'error');
            });
        }
        
        // 忽略系统异常
        function ignoreAnomaly(id) {
            fetch(`/admin/anomaly/system/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'ignore'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    refreshAnomalies();
                } else {
                    showNotification(data.message || '忽略异常失败', 'error');
                }
            })
            .catch(error => {
                console.error('忽略异常失败:', error);
                showNotification('忽略异常失败，请稍后重试', 'error');
            });
        }
        
        // 处理用户异常
        function blockUser(id, username) {
            // 显示管理员验证对话框，使用与用户管理相同的样式
            showAdminVerifyModal('blockAnomalyUser', id, `请输入管理员账号和密码以确认封禁用户: ${username}`);
        }
        
        // 忽略用户异常
        function ignoreUserAnomaly(id) {
            fetch(`/admin/anomaly/user/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'ignore'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    refreshAnomalies();
                } else {
                    showNotification(data.message || '忽略异常失败', 'error');
                }
            })
            .catch(error => {
                console.error('忽略异常失败:', error);
                showNotification('忽略异常失败，请稍后重试', 'error');
            });
        }
        
        // 编辑规则
        function editRule(id) {
            showNotification('规则编辑功能开发中...', 'info');
        }
        
        // 切换规则状态
        function toggleRule(id) {
            fetch(`/admin/anomaly/rules/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'toggle'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    refreshAnomalies();
                } else {
                    showNotification(data.message || '切换规则状态失败', 'error');
                }
            })
            .catch(error => {
                console.error('切换规则状态失败:', error);
                showNotification('切换规则状态失败，请稍后重试', 'error');
            });
        }
        
        // 删除规则
        function deleteRule(id) {
            if (confirm('确定要删除此规则吗？')) {
                fetch(`/admin/anomaly/rules/${id}/action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        refreshAnomalies();
                    } else {
                        showNotification(data.message || '删除规则失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('删除规则失败:', error);
                    showNotification('删除规则失败，请稍后重试', 'error');
                });
            }
        }
        
        // 通知系统相关函数
        function loadNotificationUsers() {
            const userListElement = document.getElementById('user-select-list');
            if (!userListElement) return;
            
            // 清空现有内容
            userListElement.innerHTML = '';
            
            // 获取用户列表
            fetch('/api/notification/users')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const users = data.data;
                    
                    if (users.length === 0) {
                        userListElement.innerHTML = '<div class="empty-user-list"><i class="ri-user-search-line" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>没有可用的用户</div>';
                    } else {
                        // 渲染用户列表
            users.forEach(user => {
                            const userItem = document.createElement('div');
                            userItem.className = 'user-select-item';
                            userItem.dataset.username = user.username;
                            userItem.dataset.email = user.email;
                            userItem.innerHTML = `
                                <input type="checkbox" id="user-${user.username}" value="${user.username}" class="user-checkbox">
                                <label for="user-${user.username}">
                                    ${user.username}
                                    <span class="user-email">${user.email}</span>
                                </label>
                            `;
                            userListElement.appendChild(userItem);
                            
                            // 让整个区域可点击
                            userItem.addEventListener('click', function(e) {
                                if (e.target.type !== 'checkbox') {
                                    const checkbox = this.querySelector('input[type="checkbox"]');
                                    checkbox.checked = !checkbox.checked;
                                    if (checkbox.checked) {
                                        this.classList.add('selected');
                                    } else {
                                        this.classList.remove('selected');
                                    }
                                    updateSelectedUsers();
                                }
                            });
                            
                            // 复选框变更时，更新选中样式
                            const checkbox = userItem.querySelector('input[type="checkbox"]');
                            checkbox.addEventListener('change', function() {
                                if (this.checked) {
                                    userItem.classList.add('selected');
                                } else {
                                    userItem.classList.remove('selected');
                                }
                                updateSelectedUsers();
                            });
                        });
                        
                        // 绑定搜索事件
                        const searchInput = document.getElementById('user-search');
                        if (searchInput) {
                            searchInput.addEventListener('input', function() {
                                const searchTerm = this.value.toLowerCase().trim();
                                const userItems = userListElement.querySelectorAll('.user-select-item');
                                
                                userItems.forEach(item => {
                                    const username = item.dataset.username.toLowerCase();
                                    const email = item.dataset.email.toLowerCase();
                                    
                                    if (username.includes(searchTerm) || email.includes(searchTerm)) {
                                        item.style.display = 'flex';
                                    } else {
                                        item.style.display = 'none';
                                    }
                                });
                            });
                        }
                        
                        // 全选/取消全选按钮
                        const selectAllBtn = document.getElementById('select-all-users');
                        const deselectAllBtn = document.getElementById('deselect-all-users');
                        
                        if (selectAllBtn) {
                            selectAllBtn.addEventListener('click', function() {
                                const visibleItems = Array.from(userListElement.querySelectorAll('.user-select-item')).filter(
                                    item => item.style.display !== 'none'
                                );
                                visibleItems.forEach(item => {
                                    const checkbox = item.querySelector('.user-checkbox');
                                    checkbox.checked = true;
                                    item.classList.add('selected');
                                });
                                updateSelectedUsers();
                                showNotification('已全选可见用户', 'success');
                            });
                        }
                        
                        if (deselectAllBtn) {
                            deselectAllBtn.addEventListener('click', function() {
                                const checkboxes = userListElement.querySelectorAll('.user-checkbox');
                                checkboxes.forEach(cb => {
                                    cb.checked = false;
                                    cb.closest('.user-select-item').classList.remove('selected');
                                });
                                updateSelectedUsers();
                                showNotification('已取消全选', 'info');
                            });
                        }
                        
                        // 初始化隐藏字段
                        updateSelectedUsers();
                    }
                } else {
                    userListElement.innerHTML = '<div class="empty-user-list"><i class="ri-error-warning-line" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>加载用户列表失败</div>';
                    showNotification(data.message || '加载用户列表失败', 'error');
                }
            })
            .catch(error => {
                console.error('加载用户列表失败:', error);
                userListElement.innerHTML = '<div class="empty-user-list"><i class="ri-error-warning-line" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>加载用户列表失败</div>';
                showNotification('加载用户列表失败，请稍后重试', 'error');
            });
            
            // 绑定通知目标变更事件
            const targetSelectElement = document.getElementById('notification-target');
            if (targetSelectElement) {
                targetSelectElement.addEventListener('change', function() {
                const specificUsersGroup = document.getElementById('specific-users-group');
                    if (specificUsersGroup) {
                specificUsersGroup.style.display = this.value === 'specific' ? 'block' : 'none';
                    }
                });
            }
            
            // 更新选中的用户到隐藏字段
            function updateSelectedUsers() {
                const checkboxes = document.querySelectorAll('.user-checkbox:checked');
                const selectedUsers = Array.from(checkboxes).map(cb => cb.value);
                
                const hiddenInput = document.getElementById('notification-users');
                if (hiddenInput) {
                    hiddenInput.value = selectedUsers.join(',');
                }
                
                // 显示选中用户数量
                const selectedCount = selectedUsers.length;
                const countDisplay = document.querySelector('.user-select-actions');
                if (countDisplay && selectedCount > 0) {
                    countDisplay.setAttribute('data-count', `已选择 ${selectedCount} 位用户`);
                } else if (countDisplay) {
                    countDisplay.removeAttribute('data-count');
                }
            }
        }
        
        // 添加一个时区转换函数
        function formatDateTime(dateString, adjustTimezone = false) {
            if (!dateString) return '';
            const date = new Date(dateString);
            
            // 根据参数决定是否调整时区
            if (adjustTimezone) {
                // 调整为中国标准时间（UTC+8）
                date.setHours(date.getHours() + 8);
            }
            
            return date.toLocaleString('zh-CN');
        }
        
        // 修改通知列表时间显示
        function refreshNotificationsList() {
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            
            fetch('/api/notifications')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notifications = data.data;
                    
                    if (notifications.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="6" class="text-center">暂无通知记录</td>';
                        notificationsList.appendChild(tr);
                    } else {
                        notifications.forEach(notification => {
                            // 格式化通知方式显示
                            let methodsText = '';
                            if (notification.methods.includes('web') && notification.methods.includes('email')) {
                                methodsText = '网站+邮件';
                            } else if (notification.methods.includes('web')) {
                                methodsText = '网站';
                            } else if (notification.methods.includes('email')) {
                                methodsText = '邮件';
                            }
                            
                            // 格式化目标显示
                            let targetText = '';
                            switch (notification.target) {
                                case 'all': 
                                    targetText = '所有用户';
                                    break;
                                case 'active': 
                                    targetText = '活跃用户';
                                    break;
                                case 'specific': 
                                    targetText = '特定用户';
                                    break;
                                default: 
                                    targetText = notification.target;
                            }
                            
                            // 格式化类型显示
                            let typeClasses = {
                                'info': 'info',
                                'update': 'success',
                                'maintenance': 'warning',
                                'warning': 'error'
                            };
                            let typeClass = typeClasses[notification.type] || 'default';
                            
                            // 类型文本转换为中文
                            let typeTexts = {
                                'info': '信息',
                                'update': '更新',
                                'maintenance': '维护',
                                'warning': '警告'
                            };
                            let typeText = typeTexts[notification.type] || notification.type;
                            
                            // 确保接收者数量是有效数字
                            let recipientCount = notification.recipients_count || 0;
                            
                            // 创建行
                const tr = document.createElement('tr');
                tr.innerHTML = `
                                <td>${formatDateTime(notification.created_at, true)}</td>
                                <td>${notification.title}</td>
                                <td><span class="badge ${typeClass}">${typeText}</span></td>
                                <td>${targetText} (${recipientCount}人)</td>
                                <td>${methodsText}</td>
                                <td>
                                    <button class="button button-small button-secondary" onclick="viewNotification(${notification.id})">
                            <i class="ri-eye-line"></i> 查看
                        </button>
                                    <button class="button button-small button-secondary" onclick="resendNotification(${notification.id})">
                            <i class="ri-send-plane-line"></i> 重发
                        </button>
                                    <button class="button button-small button-danger" onclick="deleteNotification(${notification.id})">
                            <i class="ri-delete-bin-line"></i> 删除
                        </button>
                    </td>
                `;
                notificationsList.appendChild(tr);
                        });
                    }
                } else {
                    showNotification(data.message || '获取通知列表失败', 'error');
                }
            })
            .catch(error => {
                console.error('获取通知列表失败:', error);
                showNotification('获取通知列表失败，请稍后重试', 'error');
            });
        }
        
        // 发送通知前处理HTML
        function prepareContentForSending() {
            // 创建临时div解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = document.getElementById('notification-content').value;
            
            // 从内容中移除所有动画指示器，但保留动画本身
            const indicators = tempDiv.querySelectorAll('.animation-indicator');
            indicators.forEach(indicator => {
                indicator.remove();
            });
            
            // 返回处理后的HTML
            return tempDiv.innerHTML;
        }
        
        function sendNotification() {
            // 先检查是否填写了必要信息
            const title = document.getElementById('notification-title').value;
            // 处理内容，移除编辑器中的指示器
            const content = prepareContentForSending();
            const type = document.getElementById('notification-type').value;
            const target = document.getElementById('notification-target').value;
            const isWebNotify = document.getElementById('notification-web').checked;
            const isEmailNotify = document.getElementById('notification-email').checked;
            
            if (!title || !content) {
                showNotification('请填写通知标题和内容', 'error');
                return;
            }
            
            if (!isWebNotify && !isEmailNotify) {
                showNotification('请至少选择一种通知方式', 'error');
                return;
            }
            
            // 如果是特定用户，检查是否选择了用户
            if (target === 'specific') {
                const notificationUsers = document.getElementById('notification-users').value;
                const selectedUsers = notificationUsers.split(',').filter(user => user.trim());
                
                if (selectedUsers.length === 0) {
                    showNotification('请选择至少一个用户', 'error');
                    return;
                }
            }
            
            // 显示管理员验证模态框
            showAdminVerifyModalForNotification();
        }
        
        // 实时更新预览内容
        function updatePreviewIfVisible() {
            const previewModal = document.getElementById('previewNotificationModal');
            if (!previewModal || previewModal.style.opacity === '0') return;
            
            const title = document.getElementById('notification-title').value;
            const content = document.getElementById('notification-content').value;
            
            // 处理预览内容，移除编辑器指示器但保留动画效果
            let previewContent = content;
            // 创建临时div解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = previewContent;
            
            // 从预览内容中移除所有动画指示器
            const indicators = tempDiv.querySelectorAll('.animation-indicator');
            indicators.forEach(indicator => {
                indicator.remove();
            });
            
            // 获取处理后的HTML
            previewContent = tempDiv.innerHTML;
            
            // 更新标题
            const titleElement = previewModal.querySelector('.notification-modal-title h3');
            if (titleElement) titleElement.textContent = title;
            
            // 更新内容
            const contentElement = previewModal.querySelector('.notification-modal-message');
            if (contentElement) contentElement.innerHTML = previewContent;
            
            // 重新触发动画
            replayAnimations(previewModal);
        }
        
        // 显示管理员验证模态框用于发送通知
        function showAdminVerifyModalForNotification() {
            // 检查是否处于锁定状态
            if (isAdminVerifyLocked()) {
                showNotification('验证功能已被锁定，请稍后再试', 'error');
                return;
            }
            
            // 设置验证消息
            document.getElementById('admin-verify-message').textContent = '请输入管理员账号和密码以确认发送通知';
            
            // 存储当前动作类型
            currentAdminAction = 'send_notification';
            
            // 显示模态框
            const modal = document.getElementById('adminVerifyModal');
            modal.style.display = 'block';
            
            // 清空输入框
            document.getElementById('verify_admin_username').value = '';
            document.getElementById('verify_admin_password').value = '';
            
            // 更新锁定显示
            updateLockDisplay();
        }
        
        // 执行发送通知操作
        async function executeSendNotification(adminUsername) {
            // 获取表单数据
            const title = document.getElementById('notification-title').value;
            // 处理内容，移除编辑器中的指示器
            const content = prepareContentForSending();
            const type = document.getElementById('notification-type').value;
            const target = document.getElementById('notification-target').value;
            let selectedUsers = [];
            
            if (target === 'specific') {
                const notificationUsers = document.getElementById('notification-users').value;
                selectedUsers = notificationUsers.split(',').filter(user => user.trim());
            }
            
            // 设置通知方式
            const methods = [];
            if (document.getElementById('notification-web').checked) {
                methods.push('web');
            }
            if (document.getElementById('notification-email').checked) {
                methods.push('email');
            }
            
            // 构建请求数据
            const requestData = {
                title: title,
                content: content,
                type: type,
                target: target,
                methods: methods.join(','),
                created_by: adminUsername,  // 使用验证通过的管理员用户名作为创建者
                users: selectedUsers  // 如果是特定用户，获取选中的用户
            };
            
            showNotification('正在发送通知...', 'info');
            
            try {
                const response = await fetch('/api/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message || '通知发送成功', 'success');
                // 清空表单
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-content').value = '';
                    document.getElementById('rich-editor-content').innerHTML = '';
                    // 刷新通知列表
                refreshNotificationsList();
                } else {
                    showNotification(data.message || '发送通知失败', 'error');
                }
            } catch (error) {
                console.error('发送通知失败:', error);
                showNotification('发送通知失败，请稍后重试', 'error');
            }
            
            // 关闭预览（如果正在预览）
            const previewModal = document.getElementById('previewNotificationModal');
            if (previewModal) {
                closePreviewModal(previewModal);
            }
        }
        
        function viewNotification(id) {
            fetch(`/api/notifications/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notification = data.data;
                    
                    // 创建模态框
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.id = 'notificationDetailModal';
                    
                    // 格式化通知方式
                    let methodsText = '';
                    if (notification.methods.includes('web') && notification.methods.includes('email')) {
                        methodsText = '网站+邮件';
                    } else if (notification.methods.includes('web')) {
                        methodsText = '网站';
                    } else if (notification.methods.includes('email')) {
                        methodsText = '邮件';
                    }
                    
                    // 格式化目标
                    let targetText = '';
                    switch (notification.target) {
                        case 'all': 
                            targetText = '所有用户';
                            break;
                        case 'active': 
                            targetText = '活跃用户';
                            break;
                        case 'specific': 
                            targetText = '特定用户';
                            break;
                        default: 
                            targetText = notification.target;
                    }
                    
                    // 统计接收者状态
                    const totalRecipients = notification.recipients.length;
                    const readCount = notification.recipients.filter(r => r.is_read).length;
                    const sentCount = notification.recipients.filter(r => r.is_sent).length;
                    
                    // 创建接收者列表HTML
                    let recipientsHtml = '';
                    if (notification.recipients.length > 0) {
                        recipientsHtml = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>邮箱</th>
                                        <th>发送状态</th>
                                        <th>已读状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        notification.recipients.forEach(recipient => {
                            recipientsHtml += `
                                <tr>
                                    <td>${recipient.username}</td>
                                    <td>${recipient.email}</td>
                                    <td>${recipient.is_sent ? 
                                        `<span class="badge success">已发送</span> <span class="time-info">${formatDateTime(recipient.sent_at)}</span>` : 
                                        '<span class="badge error">未发送</span>'}</td>
                                    <td>${recipient.is_read ? 
                                        `<span class="badge success">已读</span> <span class="time-info">${formatDateTime(recipient.read_at)}</span>` : 
                                        '<span class="badge error">未读</span>'}</td>
                                </tr>
                            `;
                        });
                        
                        recipientsHtml += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        recipientsHtml = '<p class="no-data">没有接收者信息</p>';
                    }
                    
                    // 计算阅读和发送比例
                    const readPercentage = totalRecipients > 0 ? Math.round(readCount/totalRecipients*100) : 0;
                    const sentPercentage = totalRecipients > 0 ? Math.round(sentCount/totalRecipients*100) : 0;
                    
                    // 类型文本转换为中文
                    let typeTexts = {
                        'info': '信息',
                        'update': '更新',
                        'maintenance': '维护',
                        'warning': '警告'
                    };
                    let typeText = typeTexts[notification.type] || notification.type;
                    
                    // 根据is_html属性决定内容的显示方式
                    let contentDisplay = '';
                    if (notification.is_html) {
                        // HTML内容直接显示
                        contentDisplay = `<div class="notification-html-content">${notification.content}</div>`;
                    } else {
                        // 普通文本使用pre标签保留格式
                        contentDisplay = `<pre>${notification.content}</pre>`;
                    }
                    
                    // 设置模态框内容
                    modal.innerHTML = `
                        <div class="modal-content notification-detail-content">
                            <div class="modal-header">
                                <h3>通知详情</h3>
                                <button class="close-button" onclick="document.getElementById('notificationDetailModal').remove()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="notification-info">
                                    <h4>${notification.title}</h4>
                                    <div class="notification-meta">
                                        <span>类型: <span class="badge ${notification.type}">${typeText}</span></span>
                                        <span>创建者: ${notification.created_by}</span>
                                        <span>创建时间: ${formatDateTime(notification.created_at)}</span>
                                        <span>通知方式: ${methodsText}</span>
                                        <span>接收对象: ${targetText}</span>
                                    </div>
                                    <div class="notification-stats">
                                        <span data-value="${totalRecipients}">总接收者</span>
                                        <span data-value="${sentCount}">已发送 (${sentPercentage}%)</span>
                                        <span data-value="${readCount}">已阅读 (${readPercentage}%)</span>
                                    </div>
                                    <div class="notification-content">
                                        <h5>通知内容</h5>
                                        ${contentDisplay}
                                    </div>
                                </div>
                                
                                <div class="recipients-list">
                                    <h5>接收者列表</h5>
                                    <div class="table-container scrollable">
                                        ${recipientsHtml}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="button button-primary" onclick="document.getElementById('notificationDetailModal').remove()">
                                    关闭
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    modal.style.display = 'block';
                    
                } else {
                    showNotification(data.message || '获取通知详情失败', 'error');
                }
            })
            .catch(error => {
                console.error('获取通知详情失败:', error);
                showNotification('获取通知详情失败，请稍后重试', 'error');
            });
        }
        
        function resendNotification(id) {
            if (confirm('确定要重新发送此通知吗？')) {
            showNotification('正在重发通知...', 'info');
                
                fetch(`/api/notifications/${id}/resend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message || '通知已重新发送', 'success');
                        refreshNotificationsList();
                    } else {
                        showNotification(data.message || '重发通知失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('重发通知失败:', error);
                    showNotification('重发通知失败，请稍后重试', 'error');
                });
            }
        }
        
        function deleteNotification(id) {
            if (confirm('确定要删除此通知吗？此操作不可恢复。')) {
                fetch(`/api/notifications/${id}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message || '通知已删除', 'success');
                refreshNotificationsList();
                    } else {
                        showNotification(data.message || '删除通知失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('删除通知失败:', error);
                    showNotification('删除通知失败，请稍后重试', 'error');
                });
            }
        }
        
        function showAddMaintenanceModal() {
            showNotification('添加维护计划功能开发中...', 'info');
        }
        
        function editMaintenance(id) {
            showNotification('编辑维护计划功能开发中...', 'info');
        }
        
        function notifyMaintenance(id) {
            showNotification('正在发送维护通知...', 'info');
            setTimeout(() => {
                showNotification('维护通知已发送', 'success');
                refreshNotificationsList();
            }, 1500);
        }
        
        function deleteMaintenance(id) {
            if (confirm('确定要删除此维护计划吗？')) {
                showNotification('维护计划已删除', 'success');
                refreshNotificationsList();
            }
        }
        
        function showAddRuleModal() {
            showNotification('添加规则功能开发中...', 'info');
        }
        
        // 刷新所有异常检测规则
        function refreshAllRules() {
            fetch('/admin/anomaly/rules/refresh')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        refreshAnomalies(); // 刷新显示
                    } else {
                        showNotification(data.message || '刷新规则失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('刷新规则失败:', error);
                    showNotification('刷新规则失败，请稍后重试', 'error');
                });
        }

        // 过滤用户
        function filterUsers(searchTerm) {
            searchTerm = searchTerm.toLowerCase().trim();
            
            // 处理用户管理页面的过滤
            const userRows = document.querySelectorAll('#users-list tr');
            userRows.forEach(row => {
                const username = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                const email = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                if (searchTerm === '' || username.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // 处理通知系统的用户选择面板
            const userItems = document.querySelectorAll('.user-select-item');
            userItems.forEach(item => {
                const username = item.dataset.username?.toLowerCase() || '';
                const email = item.dataset.email?.toLowerCase() || '';
                
                if (username.includes(searchTerm) || email.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 搜索用户 (原有函数保留)
        function searchUser(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                const searchTerm = document.getElementById('user-search').value.toLowerCase().trim();
                const userRows = document.querySelectorAll('#users-list tr');
                userRows.forEach(row => {
                    const username = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    const email = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                    if (searchTerm === '' || username.includes(searchTerm) || email.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
        }

        // 初始化富文本编辑器
        document.addEventListener('DOMContentLoaded', function() {
            initRichEditor();
        });

        function initRichEditor() {
            const toolbar = document.getElementById('rich-editor-toolbar');
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            const imageUpload = document.getElementById('image-upload');
            const uploadBtn = document.getElementById('upload-image-btn');
            const templateBtn = document.getElementById('template-btn');
            const animationBtn = document.getElementById('animation-btn');
            
            if (!toolbar || !editor || !textarea) return;
            
            // 设置编辑器初始高度
            editor.style.minHeight = '200px';
            
            // 设置编辑器的内容为textarea的内容
            editor.innerHTML = textarea.value;
            
            // 更新textarea的值并更新预览（如果正在预览）
            function updateTextarea() {
                textarea.value = editor.innerHTML;
                updatePreviewIfVisible();
            }
            
            // 编辑器内容变化时更新textarea
            editor.addEventListener('input', updateTextarea);
            editor.addEventListener('blur', updateTextarea);
            
            // 特殊处理四个基本格式按钮
            document.querySelector('.editor-btn[data-command="bold"]').addEventListener('mousedown', function(e) {
                e.preventDefault(); // 阻止默认行为，防止编辑区失去焦点
                handleFormatCommand('bold');
            });

            document.querySelector('.editor-btn[data-command="italic"]').addEventListener('mousedown', function(e) {
                e.preventDefault();
                handleFormatCommand('italic');
            });

            document.querySelector('.editor-btn[data-command="underline"]').addEventListener('mousedown', function(e) {
                e.preventDefault();
                handleFormatCommand('underline');
            });

            document.querySelector('.editor-btn[data-command="strikeThrough"]').addEventListener('mousedown', function(e) {
                e.preventDefault();
                handleFormatCommand('strikeThrough');
            });

            // 格式命令处理函数
            function handleFormatCommand(command) {
                // 确保编辑区获得焦点
                editor.focus();
                
                // 如果没有选中文本，尝试设置光标位置
                if (window.getSelection().toString().trim() === '') {
                    // 保存当前光标位置
                    saveSelection();
                }
                
                // 执行格式命令
                document.execCommand(command, false, null);
                
                // 更新textarea内容
                updateTextarea();
            }

            // 标题输入框变化时更新预览
            document.getElementById('notification-title').addEventListener('input', updatePreviewIfVisible);
            
            // 通知类型变化时更新预览
            document.getElementById('notification-type').addEventListener('change', () => {
                // 如果正在预览，重新打开预览窗口以应用新类型
                const previewModal = document.getElementById('previewNotificationModal');
                if (previewModal && previewModal.style.opacity !== '0') {
                    closePreviewModal(previewModal);
                    setTimeout(previewNotification, 310); // 等待关闭动画结束后重新打开
                }
            });
            
            // 工具栏按钮点击事件
            toolbar.querySelectorAll('.editor-btn[data-command]:not([data-command="bold"]):not([data-command="italic"]):not([data-command="underline"]):not([data-command="strikeThrough"])').forEach(button => {
                button.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    // 先保存当前选择，确保能在正确位置执行命令
                    saveSelection();
                    // 先聚焦编辑区域
                    editor.focus();
                    // 恢复选择
                    restoreSelection();
                    // 执行命令
                    document.execCommand(command, false, null);
                    // 再次更新保存的选择
                    saveSelection();
                    updateTextarea();
                });
            });
            
            // 字体和字号选择事件
            toolbar.querySelectorAll('.editor-select').forEach(select => {
                select.addEventListener('change', function() {
                    const command = this.getAttribute('data-command');
                    const value = this.value;
                    saveSelection();
                    editor.focus();
                    restoreSelection();
                    document.execCommand(command, false, value);
                    saveSelection();
                    updateTextarea();
                });
            });
            
            // 颜色选择事件
            toolbar.querySelectorAll('.editor-color').forEach(input => {
                input.addEventListener('change', function() {
                    const command = this.getAttribute('data-command');
                    const value = this.value;
                    saveSelection();
                    editor.focus();
                    restoreSelection();
                    document.execCommand(command, false, value);
                    saveSelection();
                    updateTextarea();
                });
            });
            
            // 图片上传按钮点击事件
            uploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });
            
            // 模板按钮点击事件
            templateBtn.addEventListener('click', function() {
                showTemplateModal();
            });
            
            // 动态效果按钮点击事件
            animationBtn.addEventListener('click', function(e) {
                // 保存当前选择
                saveSelection();
                
                // 显示动画菜单
                showAnimationMenuAtSelection();
                
                // 阻止事件冒泡，确保不会触发文档点击事件
                e.stopPropagation();
            });
            
            // 添加魔术棒图标点击事件，显示特效菜单
            document.addEventListener('click', function(e) {
                // 检查是否点击了魔术棒图标
                if (e.target.classList.contains('ri-magic-line') && 
                    e.target.closest('.animation-indicator')) {
                    // 获取动画ID
                    const animationEl = e.target.closest('.animated');
                    if (animationEl) {
                        const animationType = animationEl.getAttribute('data-animation-type');
                        
                        // 创建临时文本选择范围，选中动画元素中的文本
                        const textNode = animationEl.childNodes[0];
                        if (textNode) {
                            const range = document.createRange();
                            range.selectNodeContents(textNode);
                            
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            // 保存选择
                            saveSelection();
                            
                            // 显示动画菜单
                            showAnimationMenuAtSelection();
                            
                            // 阻止事件冒泡
                            e.stopPropagation();
                        }
                    }
                }
            });
            
            // 处理图片上传
            imageUpload.addEventListener('change', function() {
                const file = this.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showNotification('请选择图片文件', 'error');
                    return;
                }
                
                // 检查文件大小，限制为2MB
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('图片大小不能超过2MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100%';
                    img.className = 'notification-image';
                    
                    // 插入图片到光标位置
                    const selection = window.getSelection();
                    if (selection.getRangeAt && selection.rangeCount) {
                        const range = selection.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(img);
                        
                        // 将光标移到图片后面
                        range.setStartAfter(img);
                        range.setEndAfter(img);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        editor.appendChild(img);
                    }
                    
                    // 更新textarea内容
                    updateTextarea();
                };
                reader.readAsDataURL(file);
                
                // 清空文件输入框，以便再次选择同一文件
                this.value = '';
            });
        }

        // 修改发送通知函数，处理富文本内容
        function executeSendNotification(adminUsername) {
            const title = document.getElementById('notification-title').value;
            const content = document.getElementById('notification-content').value;
            const type = document.getElementById('notification-type').value;
            const target = document.getElementById('notification-target').value;
            const isWebNotify = document.getElementById('notification-web').checked;
            const isEmailNotify = document.getElementById('notification-email').checked;
            
            // 构建通知方式
            let methods = [];
            if (isWebNotify) methods.push('web');
            if (isEmailNotify) methods.push('email');
            
            // 构建请求数据，使用HTML格式的内容
            const requestData = {
                title: title,
                content: content,
                type: type,
                target: target,
                methods: methods.join(','),
                created_by: adminUsername,  // 使用验证通过的管理员用户名作为创建者
                is_html: true  // 标记内容为HTML格式
            };
            
            // 如果是特定用户，获取选中的用户
            if (target === 'specific') {
                const notificationUsers = document.getElementById('notification-users').value;
                const selectedUsers = notificationUsers.split(',').filter(user => user.trim());
                requestData.users = selectedUsers;
            }
            
            showNotification('正在发送通知...', 'info');
            
            fetch('/api/notifications/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || '通知发送成功', 'success');
                    // 清空表单
                    document.getElementById('notification-title').value = '';
                    document.getElementById('rich-editor-content').innerHTML = '';
                    document.getElementById('notification-content').value = '';
                    refreshNotificationsList();
                } else {
                    showNotification(data.message || '发送通知失败', 'error');
                }
            })
            .catch(error => {
                console.error('发送通知失败:', error);
                showNotification('发送通知失败，请稍后重试', 'error');
                });
        }
        
        // 初始化富文本编辑器
        document.addEventListener('DOMContentLoaded', function() {
            initRichEditor();
        });

        // 创建预览通知模态框
        function createPreviewModal() {
            // 如果已存在预览模态框，则先移除
            const existingModal = document.getElementById('previewNotificationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建新的预览模态框
            const modal = document.createElement('div');
            modal.id = 'previewNotificationModal';
            modal.className = 'notification-modal';
            modal.style.display = 'flex';
            document.body.appendChild(modal);
            
            return modal;
        }

        // 预览通知函数
        function previewNotification() {
            const title = document.getElementById('notification-title').value;
            const content = document.getElementById('notification-content').value;
            const type = document.getElementById('notification-type').value;
            
            if (!title) {
                showNotification('请输入通知标题', 'error');
                return;
            }
            
            // 创建模态框
            const modal = createPreviewModal();
            
            // 根据通知类型设置不同的图标和颜色
            let iconClass = 'ri-information-line';
            let typeColorClass = type;
            switch (type) {
                case 'success':
                    iconClass = 'ri-check-line';
                    break;
                case 'warning':
                    iconClass = 'ri-error-warning-line';
                    break;
                case 'error':
                    iconClass = 'ri-close-circle-line';
                    break;
                case 'maintenance':
                    iconClass = 'ri-tools-line';
                    break;
                case 'update':
                    iconClass = 'ri-refresh-line';
                    break;
                case 'info':
                default:
                    iconClass = 'ri-information-line';
            }
            
            // 处理预览内容，移除编辑器指示器但保留动画效果
            let previewContent = content;
            // 创建临时div解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = previewContent;
            
            // 从预览内容中移除所有动画指示器，但保留动画容器
            const indicators = tempDiv.querySelectorAll('.animation-indicator');
            indicators.forEach(indicator => {
                indicator.remove();
            });
            
            // 获取处理后的HTML
            previewContent = tempDiv.innerHTML;

            // 设置模态框内容
            modal.innerHTML = `
                <div class="notification-modal-content">
                    <div class="notification-modal-header notification-type-${typeColorClass}">
                        <div class="notification-modal-title">
                            <div class="notification-modal-icon">
                                <i class="${iconClass}"></i>
                            </div>
                            <h3>${title}</h3>
                        </div>
                        <button class="close-modal"><i class="ri-close-line"></i></button>
                    </div>
                    <div class="notification-modal-body">
                        <div class="notification-modal-message">${previewContent}</div>
                        <div class="notification-modal-time">
                            <i class="ri-time-line"></i> ${formatDateTime(new Date())} (预览)
                        </div>
                    </div>
                    <div class="notification-modal-footer">
                        <button class="modal-action-button" id="modal-close-button">关闭预览</button>
                    </div>
                </div>
            `;

            // 添加关闭模态框的事件
            const closeButton = modal.querySelector('.close-modal');
            const modalCloseButton = modal.querySelector('#modal-close-button');
            
            if (closeButton) {
                closeButton.addEventListener('click', () => closePreviewModal(modal));
            }
            
            if (modalCloseButton) {
                modalCloseButton.addEventListener('click', () => closePreviewModal(modal));
            }
            
            // 点击模态框外部关闭模态框
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closePreviewModal(modal);
                }
            });
            
            // 添加按键监听 - ESC键关闭模态框
            const escKeyHandler = (e) => {
                if (e.key === 'Escape') {
                    closePreviewModal(modal);
                    document.removeEventListener('keydown', escKeyHandler);
                }
            };
            document.addEventListener('keydown', escKeyHandler);
            
            // 以淡入效果显示模态框
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.opacity = '1';
                // 在预览中特意重新触发动画，确保它们可见
                replayAnimations(modal);
            }, 10);
        }
        
        // 重新触发动画效果，确保在预览中可见
        function replayAnimations(container) {
            if (!container) return;
            
            // 查找所有动画元素
            const animatedElements = container.querySelectorAll('.animated');
            
            // 重新触发每个动画
            animatedElements.forEach(element => {
                // 获取动画类型
                const animationType = element.getAttribute('data-animation-type');
                if (!animationType) return;
                
                // 临时移除动画类，然后重新添加，强制触发动画
                element.classList.remove('animated', animationType);
                
                // 使用setTimeout来确保DOM更新
                setTimeout(() => {
                    element.classList.add('animated', animationType);
                }, 50);
            });
        }

        // 关闭预览模态框
        function closePreviewModal(modal) {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.remove();
            }, 300);
        }

        // 显示模板选择模态框
        function showTemplateModal() {
            const modal = document.getElementById('templateModal');
            modal.style.display = 'block';
        }
        
        // 隐藏模板选择模态框
        function hideTemplateModal() {
            const modal = document.getElementById('templateModal');
            modal.style.display = 'none';
        }
        
        // 显示动态效果选择模态框
        function showAnimationModal() {
            const modal = document.getElementById('animationModal');
            modal.style.display = 'block';
        }
        
        // 隐藏动态效果选择模态框
        function hideAnimationModal() {
            const modal = document.getElementById('animationModal');
            modal.style.display = 'none';
        }
        
        // 应用通知模板
        function applyTemplate(templateType) {
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            let templateContent = '';
            
            // 检测当前主题模式
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            // 根据主题模式设置适当的颜色变量
            const colors = {
                textColor: isDarkMode ? '#e1e1e6' : '#303030',
                secondaryText: isDarkMode ? '#adb5bd' : '#505050',
                
                // 欢迎模板颜色
                welcomePrimary: isDarkMode ? '#81c784' : '#2e7d32',
                welcomeBg: isDarkMode ? 'rgba(76, 175, 80, 0.12)' : '#f1f8e9',
                welcomeBorder: isDarkMode ? 'rgba(76, 175, 80, 0.3)' : '#c5e1a5',
                
                // 更新模板颜色
                updatePrimary: isDarkMode ? '#64b5f6' : '#1565c0',
                updateBg: isDarkMode ? 'rgba(33, 150, 243, 0.12)' : '#e3f2fd',
                updateBorder: isDarkMode ? 'rgba(33, 150, 243, 0.3)' : '#90caf9',
                
                // 促销模板颜色
                promotionPrimary: isDarkMode ? '#f06292' : '#c2185b',
                promotionBg: isDarkMode ? 'rgba(233, 30, 99, 0.12)' : '#fce4ec',
                promotionHighlight: isDarkMode ? '#f48fb1' : '#ad1457',
                promotionBorder: isDarkMode ? 'rgba(233, 30, 99, 0.3)' : '#f48fb1',
                
                // 维护模板颜色
                maintenancePrimary: isDarkMode ? '#ffb74d' : '#e65100',
                maintenanceBg: isDarkMode ? 'rgba(255, 152, 0, 0.12)' : '#fff3e0',
                maintenanceBorder: isDarkMode ? 'rgba(255, 152, 0, 0.3)' : '#ffcc80',
                
                // 警告模板颜色
                warningPrimary: isDarkMode ? '#ef5350' : '#c62828',
                warningBg: isDarkMode ? 'rgba(244, 67, 54, 0.12)' : '#ffebee',
                warningHighlight: isDarkMode ? '#ef9a9a' : '#b71c1c',
                warningBorder: isDarkMode ? 'rgba(244, 67, 54, 0.3)' : '#ef9a9a',
                
                // AI分析模式模板颜色
                aiPrimary: isDarkMode ? '#b39ddb' : '#673ab7',
                aiBg: isDarkMode ? 'rgba(103, 58, 183, 0.12)' : '#ede7f6',
                aiHighlight: isDarkMode ? '#d1c4e9' : '#5e35b1',
                aiBorder: isDarkMode ? 'rgba(103, 58, 183, 0.3)' : '#b39ddb',
                
                // 多文件比较模式模板颜色
                comparePrimary: isDarkMode ? '#4db6ac' : '#00796b',
                compareBg: isDarkMode ? 'rgba(0, 121, 107, 0.12)' : '#e0f2f1',
                compareHighlight: isDarkMode ? '#80cbc4' : '#00695c',
                compareBorder: isDarkMode ? 'rgba(0, 121, 107, 0.3)' : '#80cbc4',
                
                // 单文件分析模式模板颜色
                singleFilePrimary: isDarkMode ? '#9fa8da' : '#3949ab',
                singleFileBg: isDarkMode ? 'rgba(57, 73, 171, 0.12)' : '#e8eaf6',
                singleFileHighlight: isDarkMode ? '#c5cae9' : '#303f9f',
                singleFileBorder: isDarkMode ? 'rgba(57, 73, 171, 0.3)' : '#9fa8da',
                
                // 通用边框和分隔线
                borderColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
            };
            
            // 为每一种模板创建HTML内容，使用固定的颜色（不使用CSS变量）
            switch(templateType) {
                case 'welcome':
                    templateContent = `
                        <div style="background-color: ${colors.welcomeBg} !important; border: 1px solid ${colors.welcomeBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.welcomePrimary} !important; margin-top: 0; font-weight: 600;">欢迎加入数据分析平台！</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，感谢您选择我们的数据分析平台！</p>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">我们很高兴您能加入我们的行列。在这里，您可以体验到先进的数据处理和分析功能，包括：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.welcomePrimary} !important; font-weight: 500;">多文件比较分析</span> - 同时分析多个数据源，找出关键差异</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.welcomePrimary} !important; font-weight: 500;">AI智能数据解读</span> - 通过人工智能快速识别数据趋势</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.welcomePrimary} !important; font-weight: 500;">详细销售趋势</span> - 深入了解您的业务表现</li>
                            </ul>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">如果您在使用过程中有任何问题，请随时联系我们的支持团队。祝您使用愉快！</p>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.welcomePrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">开始体验</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'update':
                    templateContent = `
                        <div style="background-color: ${colors.updateBg} !important; border: 1px solid ${colors.updateBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.updatePrimary} !important; margin-top: 0; font-weight: 600;">系统更新通知</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们的平台已经更新到最新版本！</p>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">此次更新包含以下重要改进：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.updatePrimary} !important; font-weight: 500;">性能优化</span> - 数据处理速度提升50%</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.updatePrimary} !important; font-weight: 500;">新的图表类型</span> - 更丰富的数据可视化选项</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.updatePrimary} !important; font-weight: 500;">界面改进</span> - 更加直观的用户体验</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.updatePrimary} !important; font-weight: 500;">bug修复</span> - 解决了多个已知问题</li>
                            </ul>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">更新已自动完成，您可以立即体验这些新功能。</p>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.updatePrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">查看更多</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'promotion':
                    templateContent = `
                        <div style="background-color: ${colors.promotionBg} !important; border: 1px solid ${colors.promotionBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.promotionPrimary} !important; margin-top: 0; font-weight: 600;">限时促销活动！</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们推出了限时特别优惠！</p>
                            <div style="background-color: rgba(233, 30, 99, 0.08) !important; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid ${colors.promotionHighlight} !important;">
                                <p style="color: ${colors.promotionHighlight} !important; font-weight: 600; margin: 0; font-size: 16px;">升级至专业版，享受<span style="font-size: 120%;">50%</span>折扣！</p>
                                <p style="color: ${colors.textColor} !important; margin: 8px 0 0 0;">优惠截止日期：2023年12月31日</p>
                            </div>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">专业版特权包括：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.promotionPrimary} !important; font-weight: 500;">无限数据导入</span> - 不再受文件大小限制</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.promotionPrimary} !important; font-weight: 500;">高级AI分析</span> - 更深入的数据洞察</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.promotionPrimary} !important; font-weight: 500;">优先支持</span> - 专属客服通道</li>
                            </ul>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.promotionPrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">立即升级</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'maintenance':
                    templateContent = `
                        <div style="background-color: ${colors.maintenanceBg} !important; border: 1px solid ${colors.maintenanceBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.maintenancePrimary} !important; margin-top: 0; font-weight: 600;">系统维护通知</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们计划在近期进行系统维护：</p>
                            <div style="background-color: rgba(255, 152, 0, 0.08) !important; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid ${colors.maintenancePrimary} !important;">
                                <p style="margin: 0; color: ${colors.textColor} !important;">
                                    <strong style="color: ${colors.maintenancePrimary} !important;">维护时间：</strong> 2023年11月15日 02:00-04:00 (UTC+8)
                                </p>
                            </div>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">维护期间，系统将暂时无法访问。我们会尽量缩短维护时间，请您提前安排好工作。</p>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">此次维护内容：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;">数据库优化</li>
                                <li style="margin-bottom: 5px;">服务器升级</li>
                                <li style="margin-bottom: 5px;">安全补丁更新</li>
                            </ul>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">感谢您的理解与支持。</p>
                        </div>
                    `;
                    break;
                    
                case 'warning':
                    templateContent = `
                        <div style="background-color: ${colors.warningBg} !important; border: 1px solid ${colors.warningBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.warningPrimary} !important; margin-top: 0; font-weight: 600;">重要安全警告</h3>
                            <div style="background-color: rgba(244, 67, 54, 0.08) !important; padding: 12px; border-radius: 4px; margin: 15px 0; border-left: 3px solid ${colors.warningHighlight} !important;">
                                <p style="color: ${colors.warningPrimary} !important; font-weight: 600; margin: 0; font-size: 16px;">请立即更新您的密码</p>
                            </div>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们检测到最近有异常登录尝试。为了保障您的账户安全，请立即更新您的密码。</p>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">安全提示：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;">使用至少8位的复杂密码</li>
                                <li style="margin-bottom: 5px;">包含大小写字母、数字和特殊符号</li>
                                <li style="margin-bottom: 5px;">不要使用曾用过的密码</li>
                                <li style="margin-bottom: 5px;">不要在多个网站使用相同密码</li>
                            </ul>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.warningPrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">立即修改密码</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'ai_analysis':
                    templateContent = `
                        <div style="background-color: ${colors.aiBg} !important; border: 1px solid ${colors.aiBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.aiPrimary} !important; margin-top: 0; font-weight: 600;">AI分析模式更新</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们的AI分析功能现已全面升级！</p>
                            <div style="background-color: rgba(103, 58, 183, 0.08) !important; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid ${colors.aiHighlight} !important;">
                                <p style="color: ${colors.aiPrimary} !important; font-weight: 600; margin: 0;">新一代AI算法，分析准确率提升40%</p>
                            </div>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">主要升级内容：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.aiPrimary} !important; font-weight: 500;">智能数据预测</span> - 基于历史数据自动预测未来趋势</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.aiPrimary} !important; font-weight: 500;">异常检测</span> - 自动识别数据中的异常值并提供解释</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.aiPrimary} !important; font-weight: 500;">自然语言报告</span> - 自动生成易于理解的分析报告</li>
                            </ul>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">立即体验这些强大的新功能，提升您的数据分析效率！</p>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.aiPrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">立即体验</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'multi_file':
                    templateContent = `
                        <div style="background-color: ${colors.compareBg} !important; border: 1px solid ${colors.compareBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.comparePrimary} !important; margin-top: 0; font-weight: 600;">多文件比较功能升级</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们的多文件比较功能已经升级！</p>
                            <div style="background-color: rgba(0, 121, 107, 0.08) !important; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid ${colors.compareHighlight} !important;">
                                <p style="color: ${colors.comparePrimary} !important; font-weight: 600; margin: 0;">现在支持同时比较多达10个文件，性能提升3倍</p>
                            </div>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">新功能亮点：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.comparePrimary} !important; font-weight: 500;">批量数据导入</span> - 一次性导入多个文件进行比较</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.comparePrimary} !important; font-weight: 500;">智能差异识别</span> - 自动突出显示关键差异</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.comparePrimary} !important; font-weight: 500;">高级筛选器</span> - 按多种条件筛选比较结果</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.comparePrimary} !important; font-weight: 500;">一键导出</span> - 将比较结果导出为多种格式</li>
                            </ul>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">这些改进将大大提高您的数据比较效率。</p>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.comparePrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">查看教程</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'single_file':
                    templateContent = `
                        <div style="background-color: ${colors.singleFileBg} !important; border: 1px solid ${colors.singleFileBorder} !important; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <h3 style="color: ${colors.singleFilePrimary} !important; margin-top: 0; font-weight: 600;">单文件分析优化</h3>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">尊敬的用户，我们对单文件分析模式进行了全面优化！</p>
                            <div style="background-color: rgba(57, 73, 171, 0.08) !important; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid ${colors.singleFileHighlight} !important;">
                                <p style="color: ${colors.singleFilePrimary} !important; font-weight: 600; margin: 0;">分析速度提升200%，支持超大文件处理</p>
                            </div>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">主要优化内容：</p>
                            <ul style="color: ${colors.textColor} !important; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.singleFilePrimary} !important; font-weight: 500;">流式处理引擎</span> - 处理GB级数据无压力</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.singleFilePrimary} !important; font-weight: 500;">增强可视化</span> - 更丰富的图表类型和交互方式</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.singleFilePrimary} !important; font-weight: 500;">智能数据清洗</span> - 自动检测并修复数据问题</li>
                                <li style="margin-bottom: 5px;"><span style="color: ${colors.singleFilePrimary} !important; font-weight: 500;">分析模板</span> - 保存和复用您的分析流程</li>
                            </ul>
                            <p style="color: ${colors.textColor} !important; margin-bottom: 15px;">这些优化大大提升了单文件分析的性能和用户体验。</p>
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" style="background-color: ${colors.singleFilePrimary} !important; color: white !important; padding: 8px 16px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">了解详情</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    templateContent = '<p>请选择一个模板</p>';
            }
            
            // 将模板内容设置到编辑器
            editor.innerHTML = templateContent;
            
            // 更新textarea的值，这样提交表单时可以获取到完整的HTML内容（包括样式）
            textarea.value = templateContent;
            
            // 关闭模板选择模态框
            hideTemplateModal();
            
            // 更新编辑器工具栏状态
            //updateToolbarState();
        }
        
        // 应用动态效果
        function applyAnimation(animationType) {
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            let selectedText = window.getSelection().toString();
            let animationHTML = '';
            
            // 如果没有选中文本，使用占位符
            if (!selectedText) {
                selectedText = '动态文本';
            }
            
            // 生成唯一标识符
            const animationId = 'anim-' + Date.now();
            
            switch(animationType) {
                case 'fade-in':
                    animationHTML = `<span class="animated fade-in" data-animation-type="fade-in" id="${animationId}">${selectedText} <span class="animation-indicator" title="淡入效果" onclick="removeAnimation('${animationId}')"><i class="ri-magic-line"></i><i class="ri-close-line"></i></span></span>`;
                    break;
                case 'slide-in':
                    animationHTML = `<span class="animated slide-in" data-animation-type="slide-in" id="${animationId}">${selectedText} <span class="animation-indicator" title="滑入效果" onclick="removeAnimation('${animationId}')"><i class="ri-magic-line"></i><i class="ri-close-line"></i></span></span>`;
                    break;
                case 'bounce':
                    animationHTML = `<span class="animated bounce" data-animation-type="bounce" id="${animationId}">${selectedText} <span class="animation-indicator" title="弹跳效果" onclick="removeAnimation('${animationId}')"><i class="ri-magic-line"></i><i class="ri-close-line"></i></span></span>`;
                    break;
                case 'pulse':
                    animationHTML = `<span class="animated pulse" data-animation-type="pulse" id="${animationId}">${selectedText} <span class="animation-indicator" title="脉冲效果" onclick="removeAnimation('${animationId}')"><i class="ri-magic-line"></i><i class="ri-close-line"></i></span></span>`;
                    break;
                case 'flip':
                    animationHTML = `<span class="animated flip" data-animation-type="flip" id="${animationId}">${selectedText} <span class="animation-indicator" title="翻转效果" onclick="removeAnimation('${animationId}')"><i class="ri-magic-line"></i><i class="ri-close-line"></i></span></span>`;
                    break;
                default:
                    animationHTML = selectedText;
            }
            
            document.execCommand('insertHTML', false, animationHTML);
            textarea.value = editor.innerHTML;
            updatePreviewIfVisible();
            hideAnimationModal();
        }
        
        // 移除动态效果
        function removeAnimation(animationId) {
            // 阻止事件冒泡
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log("删除特效:", animationId); // 添加调试日志
            
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            const animElement = document.getElementById(animationId);
            
            if (animElement) {
                // 保存原始文本，移除动态效果
                const originalText = animElement.firstChild.textContent.trim();
                animElement.outerHTML = originalText;
                
                // 更新textarea和预览
                textarea.value = editor.innerHTML;
                updatePreviewIfVisible();
            }
        }

        // 保存当前文本选择
        let savedSelection = null;
        function saveSelection() {
            const editor = document.getElementById('rich-editor-content');
            if (window.getSelection && document.createRange) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    savedSelection = selection.getRangeAt(0);
                }
            }
        }

        // 恢复之前保存的文本选择
        function restoreSelection() {
            const editor = document.getElementById('rich-editor-content');
            if (savedSelection) {
                if (window.getSelection && document.createRange) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(savedSelection);
                }
            }
        }

        // 在选中文本附近显示动画效果选项菜单
        function showAnimationMenuAtSelection() {
            const selection = window.getSelection();
            
            // 确认有文本被选中
            if (!selection.toString().trim()) {
                showNotification('请先选中要添加动态效果的文本', 'warning');
                return;
            }
            
            // 检查是否已有动画菜单
            let animationMenu = document.getElementById('animation-popup-menu');
            // 如果存在但不可见，先移除它
            if (animationMenu && animationMenu.style.display === 'none') {
                animationMenu.remove();
                animationMenu = null;
            }
            
            if (!animationMenu) {
                // 创建动画菜单
                animationMenu = document.createElement('div');
                animationMenu.id = 'animation-popup-menu';
                animationMenu.className = 'animation-popup-menu';
                
                // 添加动画效果选项
                const animations = [
                    { id: 'fade-in', name: '淡入效果', icon: 'ri-contrast-2-line' },
                    { id: 'slide-in', name: '滑入效果', icon: 'ri-slideshow-line' },
                    { id: 'bounce', name: '弹跳效果', icon: 'ri-basketball-line' },
                    { id: 'pulse', name: '脉冲效果', icon: 'ri-heart-pulse-line' },
                    { id: 'flip', name: '翻转效果', icon: 'ri-refresh-line' }
                ];
                
                let menuContent = '<div class="animation-menu-header">选择动态效果</div><div class="animation-menu-options">';
                
                animations.forEach(anim => {
                    menuContent += `<div class="animation-menu-option" data-animation="${anim.id}" onclick="applyAnimationFromMenu('${anim.id}')">
                        <i class="${anim.icon}"></i> ${anim.name}
                    </div>`;
                });
                
                menuContent += '</div>';
                animationMenu.innerHTML = menuContent;
                
                // 添加关闭按钮
                const closeBtn = document.createElement('div');
                closeBtn.className = 'animation-menu-close';
                closeBtn.innerHTML = '<i class="ri-close-line"></i>';
                closeBtn.onclick = closeAnimationMenu;
                animationMenu.appendChild(closeBtn);
                
                // 添加到文档
                document.body.appendChild(animationMenu);
            }
            
            // 确保菜单可见
            animationMenu.style.display = 'block';
            
            // 获取选择区域的位置
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            // 设置菜单位置在选择区域上方
            animationMenu.style.position = 'absolute';
            animationMenu.style.left = `${rect.left + window.scrollX}px`;
            animationMenu.style.top = `${rect.top + window.scrollY - animationMenu.offsetHeight - 10}px`;
            
            // 立即强制浏览器重新计算布局
            animationMenu.offsetHeight; 
            
            // 确保菜单不超出视口
            const menuRect = animationMenu.getBoundingClientRect();
            
            // 如果菜单超出左边界
            if (menuRect.left < 10) {
                animationMenu.style.left = '10px';
            }
            
            // 如果菜单超出右边界
            if (menuRect.right > window.innerWidth - 10) {
                animationMenu.style.left = `${window.innerWidth - menuRect.width - 10}px`;
            }
            
            // 如果菜单超出上边界，则放在选择区域下方
            if (menuRect.top < 10) {
                animationMenu.style.top = `${rect.bottom + window.scrollY + 10}px`;
            }
            
            // 设置点击其他区域关闭菜单的事件
            setTimeout(() => {
                document.addEventListener('click', function closeMenuOnClickOutside(e) {
                    if (!animationMenu.contains(e.target) && e.target.id !== 'animation-btn') {
                        closeAnimationMenu();
                        document.removeEventListener('click', closeMenuOnClickOutside);
                    }
                });
            }, 10);
            
            // 动画显示
            animationMenu.style.opacity = '0';
            animationMenu.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                animationMenu.style.opacity = '1';
                animationMenu.style.transform = 'translateY(0)';
            }, 10);
        }
        
        // 关闭动画效果选项菜单
        function closeAnimationMenu() {
            const animationMenu = document.getElementById('animation-popup-menu');
            if (animationMenu) {
                animationMenu.style.opacity = '0';
                animationMenu.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    animationMenu.style.display = 'none';
                }, 300);
            }
        }
        
        // 从菜单中应用动画效果
        function applyAnimationFromMenu(animationType) {
            // 恢复之前保存的选择
            restoreSelection();
            
            // 应用动画效果
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            let selectedText = window.getSelection().toString();
            let animationHTML = '';
            
            // 如果没有选中文本，使用占位符
            if (!selectedText) {
                selectedText = '动态文本';
            }
            
            // 生成唯一标识符
            const animationId = 'anim-' + Date.now();
            
            switch(animationType) {
                case 'fade-in':
                    animationHTML = `<span class="animated fade-in" data-animation-type="fade-in" id="${animationId}">${selectedText}<span class="animation-indicator" title="淡入效果"><i class="ri-magic-line" onclick="magicWandClick(event, '${animationId}')"></i><i class="ri-close-line" onclick="removeAnimation('${animationId}')"></i></span></span>`;
                    break;
                case 'slide-in':
                    animationHTML = `<span class="animated slide-in" data-animation-type="slide-in" id="${animationId}">${selectedText}<span class="animation-indicator" title="滑入效果"><i class="ri-magic-line" onclick="magicWandClick(event, '${animationId}')"></i><i class="ri-close-line" onclick="removeAnimation('${animationId}')"></i></span></span>`;
                    break;
                case 'bounce':
                    animationHTML = `<span class="animated bounce" data-animation-type="bounce" id="${animationId}">${selectedText}<span class="animation-indicator" title="弹跳效果"><i class="ri-magic-line" onclick="magicWandClick(event, '${animationId}')"></i><i class="ri-close-line" onclick="removeAnimation('${animationId}')"></i></span></span>`;
                    break;
                case 'pulse':
                    animationHTML = `<span class="animated pulse" data-animation-type="pulse" id="${animationId}">${selectedText}<span class="animation-indicator" title="脉冲效果"><i class="ri-magic-line" onclick="magicWandClick(event, '${animationId}')"></i><i class="ri-close-line" onclick="removeAnimation('${animationId}')"></i></span></span>`;
                    break;
                case 'flip':
                    animationHTML = `<span class="animated flip" data-animation-type="flip" id="${animationId}">${selectedText}<span class="animation-indicator" title="翻转效果"><i class="ri-magic-line" onclick="magicWandClick(event, '${animationId}')"></i><i class="ri-close-line" onclick="removeAnimation('${animationId}')"></i></span></span>`;
                    break;
                default:
                    animationHTML = selectedText;
            }
            
            document.execCommand('insertHTML', false, animationHTML);
            textarea.value = editor.innerHTML;
            updatePreviewIfVisible();
            
            // 关闭菜单
            closeAnimationMenu();
        }

        // 新增：魔术棒点击处理函数
        function magicWandClick(event, animationId) {
            // 阻止事件冒泡
            event.stopPropagation();
            event.preventDefault();
            
            console.log("魔术棒点击:", animationId); // 添加调试日志
            
            // 获取动画元素
            const animElement = document.getElementById(animationId);
            if (!animElement) return;
            
            // 保存文本内容
            const textContent = animElement.firstChild.textContent.trim();
            
            // 先删除原有的动画
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            animElement.outerHTML = textContent;
            
            // 更新textarea
            textarea.value = editor.innerHTML;
            
            // 选中刚刚删除动画后的文本
            const selection = window.getSelection();
            const range = document.createRange();
            
            // 找到刚刚插入的文本节点
            let textNode = null;
            const treeWalker = document.createTreeWalker(
                editor,
                NodeFilter.SHOW_TEXT,
                { acceptNode: function(node) { return node.textContent.includes(textContent) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT; } },
                false
            );
            
            while (treeWalker.nextNode()) {
                const currentNode = treeWalker.currentNode;
                if (currentNode.textContent.includes(textContent)) {
                    textNode = currentNode;
                    break;
                }
            }
            
            if (textNode) {
                // 设置选区为原文本的开始到结束
                const startIndex = textNode.textContent.indexOf(textContent);
                range.setStart(textNode, startIndex);
                range.setEnd(textNode, startIndex + textContent.length);
                
                selection.removeAllRanges();
                selection.addRange(range);
                
                // 保存选择
                saveSelection();
                
                // 显示动画菜单
                showAnimationMenuAtSelection();
            }
        }

        // 动态效果按钮点击事件 - 确保这个事件处理器在DOM加载完成后设置
        document.addEventListener('DOMContentLoaded', function() {
            const animationBtn = document.getElementById('animation-btn');
            if (animationBtn) {
                animationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log("动态效果按钮点击"); // 添加调试日志
                    
                    // 保存当前选择
                    saveSelection();
                    
                    // 显示动画菜单
                    showAnimationMenuAtSelection();
                });
            }
        });

        // 更新应用动画效果的HTML创建方式
        function applyAnimationFromMenu(animationType) {
            // 恢复之前保存的选择
            restoreSelection();
            
            // 应用动画效果
            const editor = document.getElementById('rich-editor-content');
            const textarea = document.getElementById('notification-content');
            let selectedText = window.getSelection().toString();
            
            // 如果没有选中文本，使用占位符
            if (!selectedText) {
                selectedText = '动态文本';
            }
            
            // 生成唯一标识符
            const animationId = 'anim-' + Date.now();
            
            // 创建动画容器
            const animContainer = document.createElement('span');
            animContainer.className = `animated ${animationType}`;
            animContainer.setAttribute('data-animation-type', animationType);
            animContainer.id = animationId;
            animContainer.textContent = selectedText;
            
            // 创建指示器
            const indicator = document.createElement('span');
            indicator.className = 'animation-indicator';
            indicator.title = getAnimationTitle(animationType);
            
            // 创建魔术棒图标
            const magicIcon = document.createElement('i');
            magicIcon.className = 'ri-magic-line';
            magicIcon.addEventListener('click', function(e) {
                magicWandClick(e, animationId);
            });
            
            // 创建删除图标
            const closeIcon = document.createElement('i');
            closeIcon.className = 'ri-close-line';
            closeIcon.addEventListener('click', function(e) {
                removeAnimation(animationId);
            });
            
            // 组装元素
            indicator.appendChild(magicIcon);
            indicator.appendChild(closeIcon);
            animContainer.appendChild(indicator);
            
            // 获取当前选区范围
            const range = window.getSelection().getRangeAt(0);
            
            // 删除当前选择的内容并插入新元素
            range.deleteContents();
            range.insertNode(animContainer);
            
            // 将选区光标移动到新元素后面
            range.setStartAfter(animContainer);
            range.setEndAfter(animContainer);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            // 更新textarea和预览
            textarea.value = editor.innerHTML;
            updatePreviewIfVisible();
            
            // 关闭菜单
            closeAnimationMenu();
        }

        // 获取动画效果的中文标题
        function getAnimationTitle(type) {
            switch(type) {
                case 'fade-in': return '淡入效果';
                case 'slide-in': return '滑入效果';
                case 'bounce': return '弹跳效果';
                case 'pulse': return '脉冲效果';
                case 'flip': return '翻转效果';
                default: return '动态效果';
            }
        }

        // 根据当前操作类型决定调用哪个验证函数
        function handleAdminVerification(event) {
            event.preventDefault();
            
            // 检查是哪种类型的操作
            if (currentAdminAction === 'send_notification') {
                // 如果是发送通知操作，调用通知专用的验证函数
                confirmNotificationAdminAction(event);
            } else {
                // 如果是用户管理相关操作，调用用户管理的验证函数
                confirmAdminAction(event);
            }
            
            return false;
        }
    </script>
    <!-- 引入Chart.js库 -->
    <script src="/static/js/chart.min.js"></script>
</body>
</html> 