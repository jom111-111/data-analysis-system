{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="system-name">é”€å”®è¶‹åŠ¿åˆ†æ</h1>
        <button id="back-to-home" class="button back-button">
            <i class="ri-arrow-left-line"></i> è¿”å›ä¸»ç•Œé¢
        </button>
    </div>
    
    <div class="page-description">
        <div class="description-content">
            <p><i class="ri-line-chart-line" style="color: #0062ff; margin-right: 8px;"></i>ä¸Šä¼ Excelé”€å”®æ•°æ®æ–‡ä»¶ï¼Œåˆ†æé”€å”®é¢éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ã€åŒæ¯”å¢é•¿å’Œç¯æ¯”å¢é•¿ï¼Œå¹¶è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸ç‚¹ã€‚</p>
            
            <div class="usage-guide-wrapper">
                <button id="toggle-guide" class="toggle-guide-btn">
                    <i class="ri-information-line"></i>
                    <span class="guide-btn-text">æŸ¥çœ‹è¯´æ˜</span>
                    <i class="ri-arrow-down-s-line toggle-icon"></i>
                </button>
                
                <div class="usage-guide" id="usage-guide">
                    <h3><i class="ri-file-list-3-line" style="color: #0062ff; margin-right: 8px;"></i>åŠŸèƒ½ä»‹ç»</h3>
                    <div class="guide-content">
                        <div class="guide-section">
                            <h4><i class="ri-guide-line" style="color: #3a7bd5; margin-right: 8px;"></i>ä½¿ç”¨æ–¹æ³•</h4>
                            <ol>
                                <li><i class="ri-file-upload-line" style="color: #6a3093; margin-right: 8px;"></i>ä¸Šä¼ åŒ…å«é”€å”®æ•°æ®çš„Excelæ–‡ä»¶ï¼ˆå¿…é¡»åŒ…å«æ—¥æœŸåˆ—å’Œæ•°å€¼åˆ—ï¼‰</li>
                                <li><i class="ri-table-line" style="color: #6a3093; margin-right: 8px;"></i>é€‰æ‹©æ–‡ä»¶ä¸­çš„æ—¥æœŸåˆ—å’Œè¦åˆ†æçš„å€¼åˆ—ï¼ˆé”€å”®é¢ã€è®¢å•é‡ç­‰ï¼‰</li>
                                <li><i class="ri-bar-chart-box-line" style="color: #6a3093; margin-right: 8px;"></i>é€‰æ‹©åˆ†æç±»å‹ï¼ˆè¶‹åŠ¿åˆ†æã€åŒæ¯”åˆ†ææˆ–ç¯æ¯”åˆ†æï¼‰</li>
                                <li><i class="ri-calendar-line" style="color: #6a3093; margin-right: 8px;"></i>é€‰æ‹©æ—¶é—´ç²’åº¦ï¼ˆæŒ‰å¤©ã€å‘¨ã€æœˆã€å­£åº¦æˆ–å¹´ï¼‰</li>
                                <li><i class="ri-settings-3-line" style="color: #6a3093; margin-right: 8px;"></i>é€‰æ‹©æ•°æ®å¤„ç†æ¨¡å¼ï¼ˆå¯¹äºå¤§æ•°æ®é›†ï¼Œå»ºè®®ä½¿ç”¨æ™ºèƒ½å¤„ç†æé«˜æ€§èƒ½ï¼‰</li>
                                <li><i class="ri-play-circle-line" style="color: #6a3093; margin-right: 8px;"></i>ç‚¹å‡»"å¼€å§‹åˆ†æ"è·å–ç»“æœ</li>
                            </ol>
                        </div>
                        
                        <div class="guide-section">
                            <h4><i class="ri-file-chart-line" style="color: #3a7bd5; margin-right: 8px;"></i>åˆ†æç±»å‹è¯´æ˜</h4>
                            <ul>
                                <li><i class="ri-line-chart-line" style="color: #ff7e5f; margin-right: 8px;"></i><strong>è¶‹åŠ¿åˆ†æï¼š</strong>å±•ç¤ºé”€å”®æ•°æ®éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ï¼Œè®¡ç®—æ€»é‡ã€å¹³å‡å€¼ã€å¢é•¿ç‡ç­‰å…³é”®æŒ‡æ ‡ï¼Œå¹¶è¿›è¡Œæ—¶é—´åºåˆ—åˆ†è§£ï¼ˆè¶‹åŠ¿ã€å­£èŠ‚æ€§ã€æ®‹å·®ï¼‰</li>
                                <li><i class="ri-calendar-2-line" style="color: #ff7e5f; margin-right: 8px;"></i><strong>åŒæ¯”åˆ†æï¼š</strong>æ¯”è¾ƒä¸åŒå¹´ä»½åŒæœŸçš„é”€å”®è¡¨ç°ï¼Œè®¡ç®—å¹´åº¦åŒæ¯”å¢é•¿ç‡ï¼Œå¸®åŠ©è¯„ä¼°ä¸šåŠ¡åŒæœŸå¢é•¿æƒ…å†µ</li>
                                <li><i class="ri-calendar-check-line" style="color: #ff7e5f; margin-right: 8px;"></i><strong>ç¯æ¯”åˆ†æï¼š</strong>æ¯”è¾ƒç›¸é‚»æ—¶é—´æ®µçš„é”€å”®å˜åŒ–ï¼Œå¦‚æœˆåº¦ç¯æ¯”ï¼Œå¸®åŠ©å‘ç°çŸ­æœŸå¢é•¿æˆ–ä¸‹é™è¶‹åŠ¿</li>
                            </ul>
                        </div>
                        
                        <div class="guide-section">
                            <h4><i class="ri-file-list-line" style="color: #3a7bd5; margin-right: 8px;"></i>åˆ†æç»“æœåŒ…æ‹¬</h4>
                            <ul>
                                <li><i class="ri-bar-chart-2-line" style="color: #0062ff; margin-right: 8px;"></i>é”€å”®è¶‹åŠ¿å¯è§†åŒ–å›¾è¡¨</li>
                                <li><i class="ri-numbers-line" style="color: #0062ff; margin-right: 8px;"></i>å…³é”®ç»Ÿè®¡æ•°æ®ï¼ˆæ€»é‡ã€å‡å€¼ã€å¢é•¿ç‡ç­‰ï¼‰</li>
                                <li><i class="ri-error-warning-line" style="color: #0062ff; margin-right: 8px;"></i>å¼‚å¸¸ç‚¹æ£€æµ‹åŠå¯èƒ½åŸå› </li>
                                <li><i class="ri-split-cells-horizontal" style="color: #0062ff; margin-right: 8px;"></i>æ—¶é—´åºåˆ—åˆ†è§£ï¼ˆè¶‹åŠ¿ã€å­£èŠ‚æ€§ã€éšæœºæˆåˆ†ï¼‰</li>
                                <li><i class="ri-file-download-line" style="color: #0062ff; margin-right: 8px;"></i>å¯ä¸‹è½½çš„åˆ†ææŠ¥å‘Šï¼ˆCSVæ ¼å¼ï¼‰</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="upload-section">
        <div class="file-upload-container">
            <div class="upload-area" id="upload-area">
                <i class="ri-upload-cloud-line"></i>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„</p>
                <small>æ”¯æŒXLSXã€XLSæ ¼å¼</small>
                <input type="file" id="file-input" accept=".xlsx,.xls" class="file-input">
            </div>
            <div class="file-info" id="file-info" style="display: none;">
                <div class="file-name-container">
                    <i class="ri-file-excel-line file-icon"></i>
                    <span id="file-name">filename.xlsx</span>
                </div>
                <button class="remove-file-btn" id="remove-file">
                    <i class="ri-delete-bin-fill"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="analysis-options" id="analysis-options" style="display: none;">
        <div class="options-header">
            <h2>åˆ†æè®¾ç½®</h2>
        </div>
        
        <div class="option-group">
            <div class="option">
                <label>æ—¥æœŸåˆ—</label>
                <select id="date-column" class="select-input">
                    <option value="">é€‰æ‹©æ—¥æœŸåˆ—</option>
                </select>
            </div>
            
            <div class="option">
                <div class="label-with-info">
                    <label>å€¼åˆ—</label>
                    <div class="value-info-toggle">
                        <i class="ri-information-line" id="value-info-icon"></i>
                        <div class="value-tooltip" id="value-tooltip">
                            <div class="tooltip-title">å€¼åˆ—å‡å€¼è¯´æ˜</div>
                            <div class="tooltip-content-simple">
                                <p>æ­¤å¤„æ˜¾ç¤ºçš„<strong>å‡å€¼</strong>æ˜¯åŸºäºåŸå§‹Excelæ–‡ä»¶ä¸­æ•´åˆ—æ•°æ®ç›´æ¥è®¡ç®—çš„å¹³å‡å€¼ã€‚</p>
                                <p>è€Œåˆ†æç»“æœçš„ç»Ÿè®¡æ•°æ®æ¨¡å—ä¸­çš„<strong>å¹³å‡å€¼</strong>æ˜¯åŸºäºæŒ‰é€‰å®šæ—¶é—´ç²’åº¦ï¼ˆæ—¥/å‘¨/æœˆç­‰ï¼‰èšåˆåçš„æ•°æ®è®¡ç®—çš„å¹³å‡å€¼ã€‚</p>
                                <p>å› æ­¤ï¼Œè¿™ä¸¤ä¸ªæ•°å€¼åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šæœ‰æ‰€ä¸åŒï¼Œç‰¹åˆ«æ˜¯åœ¨é€‰æ‹©éæ—¥ç²’åº¦åˆ†ææ—¶å·®å¼‚æ›´æ˜æ˜¾ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
                <select id="value-column" class="select-input">
                    <option value="">é€‰æ‹©è¦åˆ†æçš„å€¼åˆ—</option>
                </select>
            </div>
        </div>
        
        <div class="option-group">
            <div class="option">
                <label>åˆ†æç±»å‹</label>
                <select id="analysis-type" class="select-input">
                    <option value="trend">è¶‹åŠ¿åˆ†æ</option>
                    <option value="year_over_year">åŒæ¯”åˆ†æ</option>
                    <option value="month_over_month">ç¯æ¯”åˆ†æ</option>
                </select>
            </div>
            
            <div class="option">
                <label>æ—¶é—´ç²’åº¦</label>
                <select id="time-granularity" class="select-input">
                    <option value="day">æŒ‰å¤©</option>
                    <option value="week">æŒ‰å‘¨</option>
                    <option value="month">æŒ‰æœˆ</option>
                    <option value="quarter">æŒ‰å­£åº¦</option>
                    <option value="year">æŒ‰å¹´</option>
                </select>
            </div>
        </div>
        
        <div class="option-group" id="processing-mode-group">
            <div class="option">
                <label>æ•°æ®å¤„ç†æ¨¡å¼</label>
                <select id="processing-mode" class="select-input">
                    <option value="auto">æ™ºèƒ½å¤„ç† (å¤§æ•°æ®è‡ªåŠ¨ä¼˜åŒ–)</option>
                    <option value="full">å®Œæ•´å¤„ç† (å¤„ç†æ‰€æœ‰æ•°æ®ç‚¹)</option>
                </select>
            </div>
            
            <div class="option data-info-option">
                <div class="info-text">
                    <i class="ri-information-line"></i>
                    <span></span>
                </div>
            </div>
        </div>
        
        <!-- è­¦å‘Šä¿¡æ¯å®¹å™¨ -->
        <div id="yoy-warning" class="warning-message">
            å¹´åº¦åŒæ¯”åˆ†æéœ€è¦è‡³å°‘ä¸¤å¹´çš„æ•°æ®ï¼Œè¯·ç¡®ä¿æ‚¨çš„æ•°æ®é›†åŒ…å«è·¨è¶Šä¸¤ä¸ªæˆ–æ›´å¤šå¹´ä»½çš„æ•°æ®ã€‚
        </div>
        
        <button id="analyze-button" class="button primary-button" style="background-color: var(--primary-color); color: white; padding: 12px 24px; border-radius: 10px; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">å¼€å§‹åˆ†æ</button>
    </div>
    
    <div id="loading" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¯†åˆ«/åˆ†ææ•°æ®ä¸­... ï¼ˆæ•°æ®é‡è¶Šå¤§ï¼Œæ‰€éœ€è¦çš„æ—¶é—´è¶Šä¹…ï¼‰è¯·è€å¿ƒç­‰å€™ï¼</div>
    </div>
    
    <div id="error-message" class="error-message" style="display: none;"></div>
    
    <div id="results-container" class="results-container" style="display: none;">
        <div class="results-header">
            <h2>åˆ†æç»“æœ</h2>
            <button id="export-results" class="button secondary-button">
                <i class="ri-download-line"></i> å¯¼å‡ºç»“æœ
            </button>
        </div>
        
        <div class="card trend-card">
            <div class="card-header">
                <h3>é”€å”®è¶‹åŠ¿å›¾</h3>
            </div>
            <div class="card-body">
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="card stats-card">
                <div class="card-header">
                    <h3>ç»Ÿè®¡æ•°æ®</h3>
                </div>
                <div class="card-body" id="stats-content">
                    <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <div class="card anomalies-card">
                <div class="card-header">
                    <div class="header-with-note">
                        <h3>å¼‚å¸¸ç‚¹æ£€æµ‹</h3>
                        <span class="note-text">ï¼ˆä»…ä¾›å‚è€ƒï¼Œè¯·ä»”ç»†æ–Ÿé…Œï¼‰</span>
                    </div>
                    <div class="anomaly-info-toggle">
                        <i class="ri-information-line" id="anomaly-info-icon"></i>
                        <div class="anomaly-tooltip" id="anomaly-tooltip">
                            <div class="tooltip-title">æ£€æµ‹è§„åˆ™è¯´æ˜</div>
                            <ul class="tooltip-content">
                                <li><strong>å¤šç»´åº¦å¼‚å¸¸è¯„åˆ†ï¼š</strong>ç³»ç»Ÿç»¼åˆä½¿ç”¨Zåˆ†æ•°ã€å››åˆ†ä½è·(IQR)å’Œä¸­ä½æ•°ç»å¯¹åå·®(MAD)ä¸‰ç§æ–¹æ³•å¯¹æ•°æ®ç‚¹è¿›è¡Œå¤šç»´åº¦è¯„åˆ†ï¼Œé€šè¿‡æŠ•ç¥¨æœºåˆ¶ç¡®ä¿å¼‚å¸¸ç‚¹çš„å‡†ç¡®æ€§</li>
                                <li><strong>Z-scoreæ–¹æ³•ï¼š</strong>åç¦»å‡å€¼2.5ä¸ªæ ‡å‡†å·®ä»¥ä¸Šçš„ç‚¹è¢«è¯†åˆ«ä¸ºæ½œåœ¨å¼‚å¸¸ç‚¹ï¼Œé€‚åˆæ£€æµ‹çªå‘æ€§æ³¢åŠ¨</li>
                                <li><strong>å°–å³°æ¨¡å¼æ£€æµ‹ï¼š</strong>ä¸“é—¨è¯†åˆ«é”€å”®çªç„¶ä¸Šå‡åè¿…é€Ÿä¸‹é™çš„å°–å³°æ¨¡å¼ï¼Œèƒ½ç²¾ç¡®æ•æ‰ä¿ƒé”€æ´»åŠ¨æˆ–ç‰¹æ®Šäº‹ä»¶å¼•èµ·çš„çŸ­æœŸé”€å”®æ³¢åŠ¨</li>
                                <li><strong>æ—¶é—´å› ç´ åˆ†æï¼š</strong>è€ƒè™‘èŠ‚å‡æ—¥ã€å‘¨æœ«/å·¥ä½œæ—¥ã€æœˆåˆ/æœˆæœ«ã€å­£åº¦æœ«ç­‰æ—¶é—´å› ç´ å¯¹é”€å”®æ•°æ®çš„å½±å“</li>
                                <li><strong>ç¯æ¯”å˜åŒ–ï¼š</strong>æ£€æµ‹ä¸ç›¸é‚»æ—¶é—´ç‚¹çš„æ•°æ®å˜åŒ–å¹…åº¦ï¼Œè¶…è¿‡30%çš„å˜åŒ–ä¼šè¢«é‡ç‚¹å…³æ³¨</li>
                                <li><strong>è¿ç»­å¼‚å¸¸æ£€æµ‹ï¼š</strong>è¯†åˆ«æ—¶é—´çª—å£å†…å‡ºç°çš„è¿ç»­å¼‚å¸¸æ¨¡å¼ï¼Œå¯å‘ç°æŒç»­æ€§é—®é¢˜æˆ–è¶‹åŠ¿å˜åŒ–</li>
                                <li><strong>å­¤ç«‹ç‚¹è¯†åˆ«ï¼š</strong>è¯†åˆ«ä¸å‰åæ•°æ®å‡æœ‰æ˜¾è‘—å·®å¼‚çš„æ•°æ®ç‚¹ï¼Œè¿™äº›å¯èƒ½æ˜¯æ•°æ®å¼‚å¸¸æˆ–ç‰¹æ®Šäº‹ä»¶</li>
                                <li><strong>èŠ‚å‡æ—¥æ™ºèƒ½è¯†åˆ«ï¼š</strong>ç³»ç»Ÿå†…ç½®2018-2030å¹´ä¸­å›½ä¸»è¦èŠ‚å‡æ—¥æ•°æ®ï¼Œèƒ½æ™ºèƒ½è¯†åˆ«èŠ‚å‡æ—¥å¯¹é”€å”®çš„å½±å“</li>
                                <li><strong>ä¸šåŠ¡å½±å“åˆ†æï¼š</strong>ç»“åˆä¸šåŠ¡é€»è¾‘åˆ†æå¼‚å¸¸åŸå› ï¼Œæä¾›æ›´æœ‰å•†ä¸šä»·å€¼çš„å¼‚å¸¸è§£é‡Š</li>
                                <li><strong>æœ‰æ•ˆæ•°æ®æ™ºèƒ½è¿‡æ»¤ï¼š</strong>è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆæˆ–ç¼ºå¤±æ•°æ®ç‚¹ï¼Œç¡®ä¿å¼‚å¸¸æ£€æµ‹ç»“æœçš„å‡†ç¡®æ€§å’Œå¯é æ€§</li>
                                <li><strong>é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼š</strong>ä»…æ˜¾ç¤ºæœ€æ˜¾è‘—çš„20ä¸ªå¼‚å¸¸ç‚¹ï¼Œä»¥é¿å…ä¿¡æ¯è¿‡è½½</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="anomalies-content">
                    <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
        
        <div class="card yoy-card" id="yoy-section" style="display: none;">
            <div class="card-header">
                <h3>åŒæ¯”åˆ†æ</h3>
            </div>
            <div class="card-body">
                <div id="yoy-chart" class="chart-container"></div>
                <div id="yoy-growth-chart" class="chart-container"></div>
                <div class="stats-container yoy-stats-container">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h3>åŒæ¯”ç»Ÿè®¡æ•°æ®</h3>
                        </div>
                        <div class="card-body" id="yoy-stats">
                            <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>
                <div class="card yearly-data-card">
                    <div class="card-header">
                        <h3>å¹´åº¦åŒæ¯”æ•°æ®</h3>
                    </div>
                    <div class="card-body" id="yoy-yearly-data">
                        <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mom-card" id="mom-section" style="display: none;">
            <div class="card-header">
                <h3>ç¯æ¯”åˆ†æ</h3>
            </div>
            <div class="card-body">
                <div id="mom-chart" class="chart-container"></div>
                <div id="mom-growth-chart" class="chart-container"></div>
                <div class="card monthly-data-card">
                    <div class="card-header">
                        <h3>æœˆåº¦æ•°æ®æ˜ç»†</h3>
                    </div>
                    <div class="card-body" id="mom-monthly-data">
                        <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card decomposition-card" id="decomposition-section" style="display: none;">
            <div class="card-header">
                <h3>æ—¶é—´åºåˆ—åˆ†è§£</h3>
            </div>
            <div class="card-body">
                <div class="decomposition-charts">
                    <div id="trend-component" class="chart-container"></div>
                    <div id="seasonal-component" class="chart-container"></div>
                    <div id="residual-component" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å‡ºé€‰é¡¹æ¨¡æ€çª—å£ -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©è¦å¯¼å‡ºçš„å†…å®¹</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-section">
                        <div class="section-header">æ•°æ®å¯¼å‡º (CSV)</div>
                        <label class="checkbox-container">
                            <input type="checkbox" id="export-stats" checked>
                            <span class="checkmark"></span>
                            ç»Ÿè®¡æ•°æ®
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="export-anomalies" checked>
                            <span class="checkmark"></span>
                            å¼‚å¸¸ç‚¹æ£€æµ‹
                        </label>
                        <label class="checkbox-container" id="export-yoy-container" style="display: none;">
                            <input type="checkbox" id="export-yoy" checked>
                            <span class="checkmark"></span>
                            åŒæ¯”åˆ†æ
                        </label>
                        <label class="checkbox-container" id="export-mom-container" style="display: none;">
                            <input type="checkbox" id="export-mom" checked>
                            <span class="checkmark"></span>
                            ç¯æ¯”åˆ†æ
                        </label>
                        <label class="checkbox-container" id="export-decomposition-container" style="display: none;">
                            <input type="checkbox" id="export-decomposition" checked>
                            <span class="checkmark"></span>
                            æ—¶é—´åºåˆ—åˆ†è§£
                        </label>
                    </div>
                    
                    <div class="export-section">
                        <div class="section-header">å›¾è¡¨å¯¼å‡º (PNG)</div>
                        <label class="checkbox-container" id="export-trend-chart-container">
                            <input type="checkbox" id="export-trend-chart" checked>
                            <span class="checkmark"></span>
                            é”€å”®è¶‹åŠ¿å›¾è¡¨
                        </label>
                        <label class="checkbox-container" id="export-yoy-chart-container" style="display: none;">
                            <input type="checkbox" id="export-yoy-chart" checked>
                            <span class="checkmark"></span>
                            åŒæ¯”åˆ†æå›¾è¡¨
                        </label>
                        <label class="checkbox-container" id="export-yoy-monthly-chart-container" style="display: none;">
                            <input type="checkbox" id="export-yoy-monthly-chart" checked>
                            <span class="checkmark"></span>
                            æœˆåº¦åŒæ¯”å˜åŒ–å›¾è¡¨
                        </label>
                        <label class="checkbox-container" id="export-mom-chart-container" style="display: none;">
                            <input type="checkbox" id="export-mom-chart" checked>
                            <span class="checkmark"></span>
                            ç¯æ¯”å¢é•¿ç‡å›¾è¡¨
                        </label>
                        <label class="checkbox-container" id="export-decomposition-chart-container" style="display: none;">
                            <input type="checkbox" id="export-decomposition-chart" checked>
                            <span class="checkmark"></span>
                            æ—¶é—´åºåˆ—åˆ†è§£å›¾è¡¨
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-export" class="button secondary-button">å–æ¶ˆ</button>
                <button id="confirm-export" class="button primary-button">å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <!-- å·¥ä½œè¡¨é€‰æ‹©æ¨¡æ€çª—å£ -->
    <div id="sheet-selection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é€‰æ‹©å·¥ä½œè¡¨</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>æ£€æµ‹åˆ°è¯¥Excelæ–‡ä»¶åŒ…å«å¤šä¸ªå·¥ä½œè¡¨ï¼Œè¯·é€‰æ‹©è¦åˆ†æçš„å·¥ä½œè¡¨ï¼š</p>
                <div class="sheet-list" id="sheet-list">
                    <!-- è¿™é‡Œå°†åŠ¨æ€å¡«å……å·¥ä½œè¡¨åˆ—è¡¨ -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-sheet-selection" class="button primary-button">ç¡®è®¤</button>
                <button id="cancel-sheet-selection" class="button secondary-button">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* å…¨å±€å˜é‡ */
    :root {
        --primary-color: #0071e3;
        --hover-color: #0077ed;
        --background-color: #f5f5f7;
        --card-background: #ffffff;
        --text-color: #333333;
        --border-color: #dddddd;
        --secondary-text: #86868b;
        --card-shadow-color: rgba(0, 0, 0, 0.05);
        --primary-color-rgb: 0, 113, 227;
        --error-color: #dc3545; /* æ·»åŠ é”™è¯¯é¢œè‰²å˜é‡ */
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 40, 167, 69;
    }

    /* æ·±è‰²ç³» */
    [data-theme="dark"] {
        --primary-color: #2997ff;
        --hover-color: #0077ed;
        --background-color: #000000;
        --text-color: #f5f5f7;
        --secondary-text: #86868b;
        --border-color: #424245;
        --card-background: rgb(40, 40, 40);
        --card-border: rgba(66, 66, 69, 0.5);
        --card-shadow: rgba(0, 0, 0, 0.2);
        --primary-color-rgb: 41, 151, 255;
        --error-color: #dc3545; /* æ·»åŠ é”™è¯¯é¢œè‰²å˜é‡ */
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 40, 167, 69;
    }
    
    /* ç¦ç”¨æ‰€æœ‰Plotlyäº¤äº’åŠŸèƒ½å’Œå·¥å…·æ  */
    .js-plotly-plot .plotly .modebar,
    .js-plotly-plot .plotly .modebar-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }
    
    .plotly-notifier,
    .modebar-btn,
    .modebar-group {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* ç¡®ä¿æ‰€æœ‰Plotlyå›¾è¡¨å†…éƒ¨å…ƒç´ ä¸æ¥å—äº¤äº’äº‹ä»¶ - ä½†ä¿ç•™æ‚¬åœåŠŸèƒ½ */
    .js-plotly-plot .plotly .plotbg,
    .js-plotly-plot .plotly .modebar-container,
    .js-plotly-plot .plotly .zoom-container {
        pointer-events: none !important;
    }
    
    /* è¦†ç›–ä»»ä½•å¯èƒ½çš„å†…è”æ ·å¼ */
    .js-plotly-plot .plotly [style*="display: block"].modebar,
    .js-plotly-plot .plotly [style*="display: block"].modebar-container {
        display: none !important;
    }
    
    /* ç§»é™¤å›¾è¡¨ä¸Šæ‰€æœ‰å¯èƒ½çš„äº¤äº’æŒ‰é’®æˆ–å·¥å…· */
    .zoom-container, 
    .zoom-buttons,
    .download-button,
    [role="button"] {
        display: none !important;
    }
    
    /* æš–è‰²ç³» */
    [data-theme="warm"] {
        --primary-color: #e67e22;
        --hover-color: #d35400;
        --background-color: #fffaf0;
        --text-color: #442c2e;
        --secondary-text: #7a6563;
        --border-color: #e8d9c5;
        --card-background: rgb(255, 250, 240);
        --card-border: rgba(232, 217, 197, 0.5);
        --card-shadow: rgba(139, 69, 19, 0.05);
        --primary-color-rgb: 230, 126, 34;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 39, 174, 96;
    }
    
    /* å†·è‰²ç³» */
    [data-theme="cool"] {
        --primary-color: #3498db;
        --hover-color: #2980b9;
        --background-color: #f0f8ff;
        --text-color: #2c3e50;
        --secondary-text: #617487;
        --border-color: #d1e6f9;
        --card-background: rgb(240, 248, 255);
        --card-border: rgba(209, 230, 249, 0.5);
        --card-shadow: rgba(52, 152, 219, 0.05);
        --primary-color-rgb: 52, 152, 219;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 241, 196, 15;
        --success-color-rgb: 46, 204, 113;
    }
    
    /* è‡ªç„¶è‰² */
    [data-theme="nature"] {
        --primary-color: #27ae60;
        --hover-color: #219652;
        --background-color: #f5fff5;
        --text-color: #2d4a22;
        --secondary-text: #5a8c50;
        --border-color: #d5e8d4;
        --card-background: rgb(245, 255, 245);
        --card-border: rgba(213, 232, 212, 0.5);
        --card-shadow: rgba(39, 174, 96, 0.05);
        --primary-color-rgb: 39, 174, 96;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 241, 196, 15;
        --success-color-rgb: 39, 174, 96;
    }
    
    /* ç§‘æŠ€è‰² */
    [data-theme="tech"] {
        --primary-color: #00bcd4;
        --hover-color: #0097a7;
        --background-color: #fafcfd;
        --text-color: #263238;
        --secondary-text: #607d8b;
        --border-color: #cfd8dc;
        --card-background: rgb(250, 252, 253);
        --card-border: rgba(207, 216, 220, 0.5);
        --card-shadow: rgba(0, 188, 212, 0.05);
        --primary-color-rgb: 0, 188, 212;
        --error-color: #ff5722;
        --error-color-rgb: 255, 87, 34;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 76, 175, 80;
    }
    
    /* ç´«è‰²ç³» */
    [data-theme="lavender"] {
        --primary-color: #9c27b0;
        --hover-color: #7b1fa2;
        --background-color: #fdf9ff;
        --text-color: #4a235a;
        --secondary-text: #8e44ad;
        --border-color: #e1bee7;
        --card-background: rgb(253, 249, 255);
        --card-border: rgba(225, 190, 231, 0.5);
        --card-shadow: rgba(156, 39, 176, 0.05);
        --primary-color-rgb: 156, 39, 176;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 76, 175, 80;
    }
    
    /* é«˜å¯¹æ¯” */
    [data-theme="contrast"] {
        --primary-color: #000000;
        --hover-color: #1d1d1f;
        --background-color: #ffffff;
        --text-color: #000000;
        --secondary-text: #424245;
        --border-color: #1d1d1f;
        --card-background: rgb(255, 255, 255);
        --card-border: rgba(0, 0, 0, 0.2);
        --card-shadow: rgba(0, 0, 0, 0.1);
        --primary-color-rgb: 0, 0, 0;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 40, 167, 69;
    }
    
    /* æ•°æ®è¦æ±‚è­¦å‘Šæ ·å¼ */
    .data-requirement-warning {
        margin: 10px 0;
        padding: 12px 15px;
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.5;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .data-requirement-warning.checking {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left-color: #17a2b8;
    }
    
    .data-requirement-warning:before {
        content: "âš ï¸";
        margin-right: 10px;
        font-size: 16px;
    }
    
    .data-requirement-warning.checking:before {
        content: "ğŸ”";
    }
    
    /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
    .analyze-btn.disabled,
    .button.primary-button.disabled {
        background-color: #cccccc !important;
        cursor: not-allowed !important;
        opacity: 0.7 !important;
        pointer-events: none !important;
    }
    
    .analyze-btn.disabled:hover,
    .button.primary-button.disabled:hover {
        background-color: #cccccc !important;
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* æ˜ç¡®ç›´æ¥é’ˆå¯¹å…ƒç´ çš„ç¦ç”¨æ ·å¼ */
    #analyze-button.disabled,
    #analyze-button[disabled] {
        background-color: #cccccc !important;
        color: #666666 !important;
        cursor: not-allowed !important;
        opacity: 0.7 !important;
        pointer-events: none !important;
        box-shadow: none !important;
        transform: none !important;
    }
    
    /* åŸºæœ¬æ ·å¼ */
    body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
            Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        background-image: linear-gradient(to bottom right, 
                          rgba(var(--primary-color-rgb), 0.05) 1px, 
                          transparent 1px),
                          linear-gradient(to bottom, 
                          rgba(var(--primary-color-rgb), 0.05) 1px, 
                          transparent 1px);
        background-size: 20px 20px;
        background-attachment: fixed;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .back-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 120px;
        text-align: center;
    }
    
    .back-button:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .back-button i {
        font-size: 16px;
    }

    h1 {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text-color);
    }

    h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-color);
    }

    h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-color);
    }

    .page-description, 
    .upload-section, 
    .analysis-options, 
    .results-container {
        opacity: 0;
        animation: fadeInUp 0.8s ease forwards;
    }

    .page-description {
        animation-delay: 0.1s;
        font-size: 16px;
        margin-bottom: 30px;
        color: var(--secondary-text);
    }

    /* ä½¿ç”¨æŒ‡å—æ ·å¼ */
    .usage-guide-wrapper {
        margin-top: 10px;
        clear: both;
        overflow: hidden;
    }
    
    .toggle-guide-btn {
        width: auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        background-color: transparent;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        color: var(--secondary-text);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 12px;
        margin-right: 2px;
        float: right;
        text-align: center;
    }
    
    .toggle-guide-btn i {
        flex-shrink: 0;
    }
    
    .toggle-guide-btn .toggle-icon {
        transition: transform 0.4s ease;
        margin-left: auto;
    }
    
    .toggle-guide-btn:hover {
        background-color: rgba(var(--primary-color-rgb), 0.05);
        color: var(--primary-color);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .toggle-guide-btn.active .toggle-icon {
        transform: rotate(180deg);
    }
    
    .usage-guide {
        margin-top: 0;
        padding: 0 20px;
        background-color: var(--card-background);
        border-radius: 12px;
        border: 1px solid var(--card-border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(8px);
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.5s ease-in-out, 
                    padding 0.4s ease-in-out, 
                    margin 0.4s ease-in-out,
                    border-width 0.3s step-end;
        border-width: 0;
    }
    
    .usage-guide.active {
        max-height: 1500px;
        opacity: 1;
        padding: 20px;
        margin-top: 12px;
        border-width: 1px;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.5s ease-in-out, 
                    padding 0.4s ease-in-out, 
                    margin 0.4s ease-in-out,
                    border-width 0.1s step-start;
    }
    
    .usage-guide h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: var(--primary-color);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .guide-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .guide-section {
        padding: 15px;
        background-color: rgba(var(--primary-color-rgb), 0.03);
        border-radius: 8px;
        border-left: 3px solid var(--primary-color);
    }
    
    .guide-section h4 {
        font-size: 16px;
        margin-bottom: 12px;
        color: var(--text-color);
    }
    
    .guide-section ul, 
    .guide-section ol {
        margin: 0;
        padding-left: 20px;
    }
    
    .guide-section li {
        margin-bottom: 8px;
        line-height: 1.5;
    }
    
    .guide-section strong {
        color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
        .guide-content {
            grid-template-columns: 1fr;
            gap: 15px;
        }
    }

    .upload-section {
        animation-delay: 0.3s;
        margin-bottom: 30px;
    }

    .analysis-options {
        animation-delay: 0.5s;
        background-color: var(--card-background);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--card-border);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(10px);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .options-header {
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }

    .options-header h2 {
        font-size: 22px;
        margin: 0;
    }

    .option-group {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
    }

    .option {
        flex: 1;
    }

    .option label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .select-input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 16px;
        transition: all 0.2s ease;
        outline: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
    }

    .select-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
    }

    .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .primary-button {
        background-color: var(--primary-color);
        color: white;
    }

    .primary-button:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.3);
    }

    .secondary-button {
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
    }

    .secondary-button:hover {
        background-color: rgba(var(--primary-color-rgb), 0.5);
    }

    .loading-container {
        margin: 48px 0;
        text-align: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(var(--primary-color-rgb), 0.2);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .results-container {
        margin-top: 40px;
        animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .results-header h2 {
        font-size: 24px;
        margin: 0;
    }

    .card {
        background-color: var(--card-background);
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--card-border);
        overflow: hidden;
        margin-bottom: 24px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--card-border);
        background-color: rgba(var(--primary-color-rgb), 0.05);
    }

    .card-header h3 {
        margin: 0;
    }

    .card-body {
        padding: 20px;
    }

    .chart-container {
        width: 100%;
        height: 400px;
        margin-bottom: 20px;
    }

    .decomposition-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .stats-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .stats-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--card-border);
    }

    .stats-item:last-child {
        border-bottom: none;
    }

    .stats-label {
        font-weight: 500;
    }

    .stats-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .anomaly-item {
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 8px;
        background-color: rgba(var(--warning-color-rgb), 0.1);
        border-left: 3px solid var(--warning-color);
    }

    .anomaly-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .anomaly-date {
        font-weight: 600;
    }

    .anomaly-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .anomaly-reasons {
        margin-top: 8px;
    }

    .anomaly-reason {
        margin-bottom: 4px;
        font-size: 14px;
        color: var(--secondary-text);
    }

    .no-anomalies {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
    }

    @media (max-width: 768px) {
        .option-group {
            flex-direction: column;
            gap: 16px;
        }

        .stats-container {
            grid-template-columns: 1fr;
        }

        .decomposition-charts {
            grid-template-columns: 1fr;
        }
    }

    /* æ”¹è¿›çš„åŠ è½½åŠ¨ç”» */
    .loading-text {
        margin-top: 16px;
        font-size: 16px;
        font-weight: 500;
        color: var(--secondary-text);
        background: linear-gradient(90deg, var(--secondary-text), var(--primary-color), var(--secondary-text));
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 2s linear infinite;
    }

    /* æ•°æ®å¤„ç†æ¨¡å¼ä¿¡æ¯æ–‡æœ¬ */
    .info-text {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        background-color: rgba(var(--primary-color-rgb), 0.05);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
        min-width: 200px; /* ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæœ‰åˆé€‚çš„å®½åº¦ */
    }

    .info-text i {
        margin-right: 8px;
        color: var(--primary-color);
        font-size: 18px;
    }

    .info-text strong {
        color: var(--primary-color);
        font-weight: 600;
    }

    @keyframes shine {
        to {
            background-position: 200% center;
        }
    }

    /* é”™è¯¯æ¶ˆæ¯æ ·å¼æ”¹è¿› */
    .error-message {
        background-color: rgba(var(--error-color-rgb), 0.1);
        border-left: 4px solid var(--error-color);
        color: var(--error-color);
        padding: 16px 20px;
        border-radius: 10px;
        margin: 24px 0;
        font-weight: 500;
        display: flex;
        align-items: center;
        transform: translateX(-10px);
        opacity: 0;
        animation: slideInError 0.5s forwards;
    }

    .error-message::before {
        content: "!";
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background-color: var(--error-color);
        color: white;
        border-radius: 50%;
        margin-right: 12px;
        font-weight: bold;
    }

    @keyframes slideInError {
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* ç¾åŒ–ä¸Šä¼ åŒºåŸŸ */
    .file-upload-container {
        background: var(--card-background);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 20px var(--card-shadow);
    }

    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: var(--card-background);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

    .upload-area::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            45deg,
            rgba(var(--primary-color-rgb), 0) 0%,
            rgba(var(--primary-color-rgb), 0) 40%,
            rgba(var(--primary-color-rgb), 0.1) 50%,
            rgba(var(--primary-color-rgb), 0) 60%,
            rgba(var(--primary-color-rgb), 0) 100%
        );
        transform: rotate(45deg);
        animation: shine-effect 3s infinite;
    }

    @keyframes shine-effect {
        0% {
            top: -100%;
            left: -100%;
        }
        100% {
            top: 100%;
            left: 100%;
        }
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
    }

    .upload-area.drag-over {
        border-color: var(--primary-color);
        background-color: rgba(var(--primary-color-rgb), 0.05);
    }

    .upload-area i {
        font-size: 48px;
        color: var(--primary-color);
        margin-bottom: 16px;
    }

    .upload-area p {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .file-input {
        display: none;
    }

    .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background-color: rgba(var(--primary-color-rgb), 0.05);
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        margin-top: 15px;
        position: relative;
    }
    
    .file-info:hover .remove-file-btn {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
    }

    .file-name-container {
        display: flex;
        align-items: center;
        flex: 1;
    }
    
    .file-icon {
        font-size: 24px;
        color: var(--primary-color);
        margin-right: 10px;
    }

    .remove-file-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #dc3545;
        color: #dc3545;
        font-size: 20px;
        cursor: pointer;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        opacity: 0;
        visibility: hidden;
        transform: scale(0.8);
    }

    .remove-file-btn i {
        font-size: 22px;
        line-height: 1;
        color: #dc3545;
    }

    .remove-file-btn:hover {
        background-color: #dc3545;
        color: white;
        transform: scale(1.08);
    }

    .file-info:hover .remove-file-btn:hover {
        transform: scale(1.08);
    }

    .remove-file-btn:hover i {
        color: white;
    }

    /* åŠ¨ç”»æ§åˆ¶ */
    [data-animation="off"] .page-description,
    [data-animation="off"] .upload-section,
    [data-animation="off"] .analysis-options,
    [data-animation="off"] .results-container {
        opacity: 1 !important;
        transform: translateY(0) !important;
        animation: none !important;
    }
    
    [data-animation="off"] .upload-area::after {
        display: none !important;
    }
    
    [data-animation="off"] .loading-text {
        background: none !important;
        -webkit-text-fill-color: var(--secondary-text) !important;
        animation: none !important;
    }
    
    [data-animation="off"] .error-message {
        transform: translateX(0) !important;
        opacity: 1 !important;
        animation: none !important;
    }
    
    [data-animation="off"] .card:hover {
        transform: none !important;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05) !important;
    }
    
    [data-animation="off"] .ripple {
        display: none !important;
    }
    
    [data-animation="off"] .loading-spinner {
        border-top: 4px solid var(--primary-color) !important;
        animation: none !important;
    }

    .page-description {
        margin-bottom: 30px;
    }
    
    .description-content {
        position: relative;
    }
    
    .description-content p {
        margin-bottom: 15px;
        max-width: 80%;
    }

    .guide-btn-text {
        display: inline-block;
        flex: 1;
        text-align: center;
    }

    /* å¼ºåˆ¶æ˜¾ç¤ºç±» - ç¡®ä¿ç»“æœå§‹ç»ˆå¯è§ */
    .force-display {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 999 !important;
        pointer-events: auto !important;
    }

    /* æ·»åŠ æŒ‰é’®æ³¢çº¹æ•ˆæœ */
    .ripple {
        position: absolute;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
    }
    
    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    /* éšè—Plotlyå·¥å…·æ ä½†ä¿ç•™æ‚¬åœæç¤ºåŠŸèƒ½ */
    .modebar, .modebar-container {
        display: none !important;
    }
    
    /* ç¡®ä¿æ‚¬åœæç¤ºæ˜¾ç¤ºæ­£å¸¸ */
    .hoverlayer {
        pointer-events: auto !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* ç¾åŒ–æ‚¬åœæç¤ºæ ·å¼ */
    .hovertext, .hoverinfo {
        background-color: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        padding: 8px !important;
        font-size: 12px !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
    }

    /* æ·»åŠ ç¯æ¯”åˆ†æç›¸å…³æ ·å¼ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
    }
    
    .data-table th, .data-table td {
        padding: 10px;
        border: 1px solid var(--border-color);
        text-align: left;
    }
    
    .data-table th {
        background-color: rgba(var(--primary-color-rgb), 0.1);
        font-weight: 600;
    }
    
    .data-table tr:nth-child(even) {
        background-color: rgba(var(--primary-color-rgb), 0.03);
    }
    
    .positive-change {
        color: #e74c3c; /* çº¢è‰² - ä¸Šæ¶¨ */
        font-weight: 600;
    }
    
    .negative-change {
        color: #27ae60; /* ç»¿è‰² - ä¸‹è·Œ */
        font-weight: 600;
    }
    
    /* æ·»åŠ ä¸Šæ¶¨å’Œä¸‹è·Œçš„çº¯è‰²ç±»ï¼Œç”¨äºå›¾è¡¨ç­‰å…ƒç´  */
    .positive {
        color: #e74c3c; /* çº¢è‰² - ä¸Šæ¶¨ */
    }
    
    .negative {
        color: #27ae60; /* ç»¿è‰² - ä¸‹è·Œ */
    }
    
    .table-responsive {
        overflow-x: auto;
        margin-top: 20px;
        max-height: 400px; /* æ·»åŠ æœ€å¤§é«˜åº¦é™åˆ¶ */
        overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨ */
        border-radius: 8px; /* æ·»åŠ åœ†è§’ */
        border: 1px solid var(--border-color); /* æ·»åŠ è¾¹æ¡† */
    }
    
    .no-data {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
    }
    
    .monthly-data-card, .mom-stats-container {
        margin-top: 25px;
    }
    
    .monthly-data-card .card-body {
        padding: 10px;
        max-height: 450px; /* ç»™è¡¨æ ¼å®¹å™¨è®¾ç½®æœ€å¤§é«˜åº¦ */
        overflow: hidden; /* éšè—æº¢å‡ºå†…å®¹ */
    }

    /* æ·»åŠ åŒæ¯”åˆ†æç›¸å…³æ ·å¼ */
    .yoy-stats-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }
    
    .yearly-totals, .yoy-changes {
        flex: 1;
        min-width: 250px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .yearly-total-item, .yoy-change-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: rgba(var(--primary-color-rgb), 0.05);
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }
    
    .yearly-total-item:hover, .yoy-change-item:hover {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .year-label {
        font-weight: 500;
        color: var(--text-color);
    }
    
    .year-value {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 1.1em;
    }
    
    .yearly-data-card {
        margin-top: 25px;
    }
    
    .yoy-stats-container {
        margin-top: 25px;
    }

    /* è­¦å‘Šä¿¡æ¯æ ·å¼ */
    .warning-message {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #ffeeba;
        font-size: 14px;
        display: none;
    }

    /* æ–‡æœ¬é€‰ä¸­æ ·å¼ */
    ::selection {
        background-color: var(--primary-color);
        color: white;
    }
    
    ::-moz-selection {
        background-color: var(--primary-color);
        color: white;
    }
    
    [data-theme="dark"] ::selection {
        background-color: rgba(var(--primary-color-rgb), 0.7);
        color: white;
    }
    
    [data-theme="dark"] ::-moz-selection {
        background-color: rgba(var(--primary-color-rgb), 0.7);
        color: white;
    }
    
    /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .custom-select-container {
        position: relative;
        width: 100%;
    }
    
    .custom-select-selected {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }
    
    .custom-select-selected:hover {
        border-color: var(--primary-color);
    }
    
    .custom-select-container.active .custom-select-selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
    }
    
    .custom-select-arrow {
        margin-left: 10px;
        transition: transform 0.2s ease;
    }
    
    .custom-select-container.active .custom-select-arrow {
        transform: rotate(180deg);
    }
    
    .custom-select-options {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 10;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
    }
    
    .custom-select-container.active .custom-select-options {
        max-height: 200px;
        opacity: 1;
        pointer-events: auto;
        overflow-y: auto;
    }
    
    .custom-select-option {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 14px;
    }
    
    .custom-select-option:hover {
        background-color: #e8f0fe;
    }
    
    [data-theme="dark"] .custom-select-option:hover {
        background-color: #3a3a3c;
    }
    
    [data-theme="warm"] .custom-select-option:hover {
        background-color: #fcecd6;
    }
    
    [data-theme="cool"] .custom-select-option:hover {
        background-color: #d9ebff;
    }
    
    [data-theme="nature"] .custom-select-option:hover {
        background-color: #d8f2d8;
    }
    
    [data-theme="tech"] .custom-select-option:hover {
        background-color: #e0f7fa;
    }
    
    .custom-select-option.selected {
        background-color: #c7dbfc;
        font-weight: 500;
    }
    
    [data-theme="dark"] .custom-select-option.selected {
        background-color: #454547;
        font-weight: 500;
    }
    
    [data-theme="warm"] .custom-select-option.selected {
        background-color: #f9d6b0;
        font-weight: 500;
    }
    
    [data-theme="cool"] .custom-select-option.selected {
        background-color: #b3d7ff;
        font-weight: 500;
    }
    
    [data-theme="nature"] .custom-select-option.selected {
        background-color: #b6e5b6;
        font-weight: 500;
    }
    
    [data-theme="tech"] .custom-select-option.selected {
        background-color: #b2ebf2;
        font-weight: 500;
    }
    
    /* ç´«è‰²ç³»ä¸»é¢˜ä¸‹æ‹‰æ¡†æ ·å¼ */
    [data-theme="lavender"] .custom-select-option:hover {
        background-color: #f3e5f5;
    }
    
    [data-theme="lavender"] .custom-select-option.selected {
        background-color: #e1bee7;
        font-weight: 500;
    }
    
    /* é«˜å¯¹æ¯”ä¸»é¢˜ä¸‹æ‹‰æ¡†æ ·å¼ */
    [data-theme="contrast"] .custom-select-option:hover {
        background-color: #e6e6e6;
    }
    
    [data-theme="contrast"] .custom-select-option.selected {
        background-color: #cccccc;
        font-weight: 500;
    }

    .anomaly-reason {
        margin: 5px 0;
        color: var(--secondary-text);
    }

    .no-anomalies {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
    }
    
    /* å¼‚å¸¸ç‚¹æ£€æµ‹è§„åˆ™è¯´æ˜å¼¹å‡ºå¼å°çª—å£æ ·å¼ */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* æ ‡é¢˜+æç¤ºç»„åˆçš„æ ·å¼ */
    .header-with-note {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* æç¤ºæ–‡å­—æ ·å¼ */
    .note-text {
        font-size: 12px;
        color: var(--secondary-text);
        font-weight: normal;
        font-style: italic;
    }
    
    .anomaly-info-toggle {
        position: relative;
    }
    
    .anomaly-info-toggle i {
        font-size: 18px;
        color: var(--primary-color);
        cursor: pointer;
        background-color: rgba(var(--primary-color-rgb), 0.1);
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .anomaly-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    .anomaly-tooltip {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        width: 400px; /* å¢åŠ å®½åº¦ä»350pxåˆ°400px */
        background-color: var(--card-background);
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        padding: 15px;
        z-index: 100;
        border: 1px solid var(--border-color);
        display: none;
        font-size: 13px;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
        max-height: 70vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸è¶…è¿‡è§†å£é«˜åº¦çš„70% */
    }
    
    .anomaly-tooltip.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        display: block;
    }
    
    .tooltip-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }
    
    .tooltip-content {
        margin: 0;
        padding-left: 15px;
        max-height: 250px; /* æ·»åŠ æœ€å¤§é«˜åº¦é™åˆ¶ */
        overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨æ¡ */
        scrollbar-width: thin; /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
        scrollbar-color: var(--border-color) transparent; /* Firefoxæ»šåŠ¨æ¡é¢œè‰² */
        padding-right: 5px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
    }
    
    /* ä¸ºWebkitæµè§ˆå™¨æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    .tooltip-content::-webkit-scrollbar {
        width: 5px;
    }
    
    .tooltip-content::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .tooltip-content::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 5px;
    }
    
    [data-theme="dark"] .tooltip-content::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="contrast"] .tooltip-content::-webkit-scrollbar-thumb {
        background-color: #666;
    }
    
    .tooltip-content li {
        margin-bottom: 8px;
        line-height: 1.4;
    }
    
    .tooltip-content li:last-child {
        margin-bottom: 0;
    }
    
    /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
    [data-theme="dark"] .anomaly-info-toggle i {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    [data-theme="dark"] .anomaly-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.3);
    }
    
    /* é«˜å¯¹æ¯”æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
    [data-theme="contrast"] .anomaly-info-toggle i {
        background-color: #e0e0e0;
    }
    
    [data-theme="contrast"] .anomaly-info-toggle i:hover {
        background-color: #cccccc;
    }

    .anomaly-reason {
        margin: 5px 0;
        color: var(--secondary-text);
    }

    .no-anomalies {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
    }
    
    /* å¼‚å¸¸ç‚¹æ£€æµ‹ç»“æœå®¹å™¨æ ·å¼ */
    #anomalies-content {
        max-height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }
    
    #anomalies-content::-webkit-scrollbar {
        width: 6px;
    }
    
    #anomalies-content::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #anomalies-content::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 6px;
    }
    
    [data-theme="dark"] #anomalies-content::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="contrast"] #anomalies-content::-webkit-scrollbar-thumb {
        background-color: #666;
    }

    /* ä¸º"å€¼åˆ—"æ·»åŠ çš„æç¤ºå›¾æ ‡å’Œå·¥å…·æç¤º */
    .label-with-info {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    /* ç¡®ä¿ä¸åŸæœ‰çš„labelæ ·å¼ä¿æŒä¸€è‡´ */
    .option label,
    .label-with-info label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-color);
    }
    
    .label-with-info label {
        margin-bottom: 0; /* è¦†ç›–.option labelçš„margin-bottom */
        margin-right: 8px;
    }
    
    /* åˆ é™¤ä¸å†éœ€è¦çš„input-with-infoæ ·å¼ */
    .input-with-info {
        display: none;
    }
    
    .value-info-toggle {
        position: relative;
    }
    
    .value-info-toggle i {
        font-size: 16px;
        color: var(--primary-color);
        cursor: pointer;
        background-color: rgba(var(--primary-color-rgb), 0.1);
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .value-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    .value-tooltip {
        position: absolute;
        top: calc(100% + 10px);
        left: -8px;
        width: 350px;
        background-color: var(--card-background);
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        padding: 15px;
        z-index: 100;
        border: 1px solid var(--border-color);
        display: none;
        font-size: 13px;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
    }
    
    .value-tooltip.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        display: block;
    }
    
    .tooltip-content-simple {
        margin: 0;
        font-size: 12px;
        line-height: 1.5;
    }
    
    .tooltip-content-simple p {
        margin-bottom: 8px;
    }
    
    .tooltip-content-simple p:last-child {
        margin-bottom: 0;
    }
    
    /* æ·±è‰²æ¨¡å¼å’Œé«˜å¯¹æ¯”åº¦æ¨¡å¼ä¸‹çš„æ ·å¼ */
    [data-theme="dark"] .value-info-toggle i {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    [data-theme="dark"] .value-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.3);
    }
    
    [data-theme="contrast"] .value-info-toggle i {
        background-color: #e0e0e0;
    }
    
    [data-theme="contrast"] .value-info-toggle i:hover {
        background-color: #cccccc;
    }

    /* å¤„ç†æ¨¡å¼é€‰é¡¹ç»„ç‰¹æ®Šæ ·å¼ */
    #processing-mode-group {
        display: flex;
        align-items: flex-start;
        gap: 20px;
    }
    
    /* æ•°æ®ä¿¡æ¯é€‰é¡¹æ ·å¼ */
    .data-info-option .info-text {
        padding: 11px 16px; /* ä¸select-inputä¿æŒä¸€è‡´çš„å†…è¾¹è· */
        height: 47px; /* ä¸select-inputä¿æŒä¸€è‡´çš„é«˜åº¦ */
        box-sizing: border-box;
        margin-top: 28px; 
    }
    
    /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„å¸ƒå±€è°ƒæ•´ */
    @media (max-width: 768px) {
        #processing-mode-group {
            flex-direction: column;
            align-items: stretch;
        }
        
        .info-text {
            margin-top: 0;
        }
    }

    /* æ¨¡æ€çª—å£æ ·å¼ */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 9999; /* æé«˜z-indexç¡®ä¿åœ¨æœ€é¡¶å±‚ */
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.4);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal.active {
        opacity: 1;
        visibility: visible;
        display: block;
    }
    
    .modal-content {
        background-color: var(--card-background);
        margin: 15% auto;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        max-width: 500px;
        transform: translateY(-20px);
        transition: transform 0.3s;
        position: relative; /* ç¡®ä¿å†…å®¹ç›¸å¯¹å®šä½ */
    }
    
    .modal.active .modal-content {
        transform: translateY(0);
    }
    
    /* ç¡®ä¿æ¨¡æ€çª—å£å†…æŒ‰é’®æ ·å¼ä¸å—å¤–éƒ¨å½±å“ */
    .modal .primary-button:hover,
    .modal .secondary-button:hover {
        transform: none; /* é˜²æ­¢æ‚¬åœæ—¶çš„å˜æ¢æ•ˆæœ */
        box-shadow: 0 0 0 1px var(--primary-color);
    }
    
    .modal-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: var(--text-color);
    }
    
    .close-modal {
        color: var(--secondary-text);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    .export-options {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    
    .export-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }
    
    .export-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .section-header {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
    }
    
    /* å¤é€‰æ¡†æ ·å¼ */
    .checkbox-container {
        display: flex;
        align-items: center;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        font-size: 16px;
        user-select: none;
        color: var(--text-color);
    }
    
    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    
    .checkmark {
        position: absolute;
        left: 0;
        height: 22px;
        width: 22px;
        background-color: transparent;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .checkbox-container:hover input ~ .checkmark {
        border-color: var(--primary-color);
    }
    
    .checkbox-container input:checked ~ .checkmark {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }
    
    .checkbox-container input:checked ~ .checkmark:after {
        display: block;
    }
    
    .checkbox-container .checkmark:after {
        left: 7px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* æç¤ºæ ·å¼ */
    .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(30px);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 9999;
        font-size: 14px;
        opacity: 0;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    
    .toast.success {
        background-color: rgba(40, 167, 69, 0.9);
    }
    
    .toast.error {
        background-color: rgba(220, 53, 69, 0.9);
    }
    
    .toast .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* å·¥ä½œè¡¨é€‰æ‹©æ¨¡æ€çª—å£æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
    }

    .modal-content {
        background-color: var(--card-background);
        margin: auto;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        animation: slideIn 0.3s ease;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .modal-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--card-background);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .modal-body {
        padding: 20px;
        max-height: 50vh;
        overflow-y: auto;
        color: var(--text-color);
        background-color: var(--card-background);
    }

    .modal-footer {
        padding: 15px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid var(--border-color);
        background-color: var(--card-background);
    }

    .close-modal {
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--secondary-text);
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: var(--text-color);
    }

    .sheet-list {
        margin-top: 15px;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-background);
    }

    .sheet-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        color: var(--text-color);
    }

    .sheet-item:last-child {
        border-bottom: none;
    }

    .sheet-item:hover {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }

    .sheet-item.selected {
        background-color: rgba(var(--primary-color-rgb), 0.15);
        color: var(--primary-color);
        font-weight: 500;
    }

    .sheet-item input[type="radio"] {
        margin-right: 10px;
    }

    @keyframes slideIn {
        from {
            transform: translateY(-30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* æ·»åŠ æ•°æ®è¡¨æ ¼å›ºå®šå¤´éƒ¨çš„æ ·å¼ */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead {
        position: sticky;
        top: 0;
        background-color: var(--card-background);
        z-index: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .data-table th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
    }
    
    .data-table td {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .data-table tbody tr:hover {
        background-color: rgba(var(--primary-color-rgb), 0.05);
    }
</style>

<!-- æ¥ä¸‹æ¥æ˜¯æ¨¡æ¿çš„JavaScriptéƒ¨åˆ† -->
<script src="{{ url_for('static', filename='js/html2canvas.min.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const removeFileBtn = document.getElementById('remove-file');
        const analysisOptions = document.getElementById('analysis-options');
        const dateColumnSelect = document.getElementById('date-column');
        const valueColumnSelect = document.getElementById('value-column');
        const analysisTypeSelect = document.getElementById('analysis-type');
        const timeGranularitySelect = document.getElementById('time-granularity');
        const analyzeBtn = document.getElementById('analyze-button');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const resultsContainer = document.getElementById('results-container');
        const exportResultsBtn = document.getElementById('export-results');
        const backToHomeBtn = document.getElementById('back-to-home');

        // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å½“å‰çš„fetchè¯·æ±‚æ§åˆ¶å™¨
        let currentAnalysisFetchController = null;
        let currentCheckEligibilityFetchController = null;
        let currentSuggestionsFetchController = null;

        let selectedFile = null;
        let analysisResults = null;
        
        // æ¸…é™¤å·²æœ‰çš„ä¿æŠ¤é—´éš”
        if (window.resultsProtectionInterval) {
            clearInterval(window.resultsProtectionInterval);
            window.resultsProtectionInterval = null;
        }
        
        // åœæ­¢å·²æœ‰çš„Observer
        if (window.resultsObserver) {
            window.resultsObserver.disconnect();
            window.resultsObserver = null;
            console.log('é¡µé¢åŠ è½½æ—¶åœæ­¢å·²æœ‰çš„MutationObserverç›‘æ§');
        }
        
        // åˆå§‹åŒ–åˆ†æçŠ¶æ€
        window.isAnalyzing = false;
        
        // ä¸»é¢˜å¤„ç†å‡½æ•°
        function applyTheme() {
            // ä» localStorage è¯»å–ä¸»é¢˜è®¾ç½®
            const theme = localStorage.getItem('theme') || 'light';
            
            // åº”ç”¨ä¸»é¢˜
            document.documentElement.setAttribute('data-theme', theme);
            
            // æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•
            console.log('åº”ç”¨ä¸»é¢˜:', theme);
        }
        
        // åŠ¨ç”»è®¾ç½®å¤„ç†å‡½æ•°
        function applyAnimationSetting() {
            // ä» localStorage è¯»å–åŠ¨ç”»è®¾ç½®
            const animation = localStorage.getItem('animation') || 'on';
            
            // åº”ç”¨åŠ¨ç”»è®¾ç½®
            document.documentElement.setAttribute('data-animation', animation);
            
            // æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•
            console.log('åº”ç”¨åŠ¨ç”»è®¾ç½®:', animation);
        }
        
        // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¸»é¢˜å’ŒåŠ¨ç”»è®¾ç½®
        applyTheme();
        applyAnimationSetting();
        
        // ç¡®ä¿å¤„ç†æ¨¡å¼é€‰é¡¹å¯è§
        document.getElementById('processing-mode-group').style.display = 'flex';
        
        // ç›‘å¬è®¾ç½®å˜åŒ–
        window.addEventListener('storage', function(event) {
            if (event.key === 'theme') {
                applyTheme();
            }
            if (event.key === 'animation') {
                applyAnimationSetting();
            }
        });

        // åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
        function createCustomDropdowns() {
            // è·å–æ‰€æœ‰ä¸‹æ‹‰æ¡†
            const selects = document.querySelectorAll('.select-input');
            
            selects.forEach(select => {
                // åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†å®¹å™¨
                const customSelectContainer = document.createElement('div');
                customSelectContainer.className = 'custom-select-container';
                customSelectContainer.dataset.for = select.id;
                
                // åˆ›å»ºé€‰ä¸­é¡¹æ˜¾ç¤ºåŒºåŸŸ
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'custom-select-selected';
                
                // è·å–å½“å‰é€‰ä¸­é¡¹
                const selectedText = select.options[select.selectedIndex]?.text || 'è¯·é€‰æ‹©';
                
                // è®¾ç½®æ˜¾ç¤ºå†…å®¹
                selectedDiv.innerHTML = `
                    <span class="custom-select-text">${selectedText}</span>
                    <i class="ri-arrow-down-s-line custom-select-arrow"></i>
                `;
                
                // åˆ›å»ºé€‰é¡¹åˆ—è¡¨
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'custom-select-options';
                
                // æ·»åŠ é€‰é¡¹
                Array.from(select.options).forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    if (index === select.selectedIndex) {
                        optionDiv.classList.add('selected');
                    }
                    optionDiv.setAttribute('data-value', option.value);
                    optionDiv.textContent = option.text;
                    
                    // é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                    optionDiv.addEventListener('click', () => {
                        // æ›´æ–°åŸå§‹selectçš„å€¼
                        select.value = option.value;
                        
                        // è§¦å‘changeäº‹ä»¶
                        const event = new Event('change', { bubbles: true });
                        select.dispatchEvent(event);
                        
                        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                        selectedDiv.querySelector('.custom-select-text').textContent = option.text;
                        
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        optionDiv.classList.add('selected');
                        
                        // å…³é—­ä¸‹æ‹‰æ¡†
                        customSelectContainer.classList.remove('active');
                    });
                    
                    optionsDiv.appendChild(optionDiv);
                });
                
                // ç‚¹å‡»æ˜¾ç¤º/éšè—é€‰é¡¹
                selectedDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // å…³é—­å…¶ä»–æ‰“å¼€çš„ä¸‹æ‹‰æ¡†
                    document.querySelectorAll('.custom-select-container').forEach(container => {
                        if (container !== customSelectContainer) {
                            container.classList.remove('active');
                        }
                    });
                    
                    // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†çŠ¶æ€
                    customSelectContainer.classList.toggle('active');
                });
                
                // æ·»åŠ å…ƒç´ åˆ°å®¹å™¨
                customSelectContainer.appendChild(selectedDiv);
                customSelectContainer.appendChild(optionsDiv);
                
                // éšè—åŸå§‹select
                select.style.display = 'none';
                
                // å°†è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ’å…¥åˆ°selectä¹‹å
                select.parentNode.insertBefore(customSelectContainer, select.nextSibling);
                
                // ä¸ºåŸå§‹selectæ·»åŠ å˜æ›´ç›‘å¬å™¨ï¼Œä»¥ä¾¿åŒæ­¥æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
                select.addEventListener('change', () => {
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        selectedDiv.querySelector('.custom-select-text').textContent = selectedOption.text;
                        
                        // æ›´æ–°é€‰ä¸­æ ·å¼
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            if (opt.getAttribute('data-value') === selectedOption.value) {
                                opt.classList.add('selected');
                            } else {
                                opt.classList.remove('selected');
                            }
                        });
                    }
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-select-container').forEach(container => {
                    container.classList.remove('active');
                });
            });
        }
        
        // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
        createCustomDropdowns();

        // åˆå§‹åŒ–å¼‚å¸¸ç‚¹æ£€æµ‹è§„åˆ™è¯´æ˜å¼¹å‡ºçª—å£
        const anomalyInfoIcon = document.getElementById('anomaly-info-icon');
        const anomalyTooltip = document.getElementById('anomaly-tooltip');
        
        if (anomalyInfoIcon && anomalyTooltip) {
            // ç‚¹å‡»å›¾æ ‡æ—¶æ˜¾ç¤º/éšè—å¼¹å‡ºçª—å£
            anomalyInfoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // ä½¿ç”¨æ–°çš„åŠ¨ç”»ç±»åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                if (anomalyTooltip.classList.contains('visible')) {
                    anomalyTooltip.classList.remove('visible');
                    // ç­‰å¾…åŠ¨ç”»ç»“æŸåéšè—å…ƒç´ 
                    setTimeout(() => {
                        anomalyTooltip.style.display = 'none';
                    }, 250); // ä¸CSSè¿‡æ¸¡æ—¶é—´ä¸€è‡´
                } else {
                    // å…ˆè®¾ç½®displayä»¥ä¾¿åŠ¨ç”»å¯è§
                    anomalyTooltip.style.display = 'block';
                    // å»¶è¿Ÿä¸€å¸§æ·»åŠ visibleç±»ä»¥ç¡®ä¿è¿‡æ¸¡åŠ¨ç”»ç”Ÿæ•ˆ
                    requestAnimationFrame(() => {
                        anomalyTooltip.classList.add('visible');
                    });
                }
            });
            
            // ç‚¹å‡»å¼¹å‡ºçª—å£å†…éƒ¨æ—¶é˜»æ­¢äº‹ä»¶å†’æ³¡
            anomalyTooltip.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸæ—¶éšè—å¼¹å‡ºçª—å£
            document.addEventListener('click', () => {
                if (anomalyTooltip.classList.contains('visible')) {
                    anomalyTooltip.classList.remove('visible');
                    setTimeout(() => {
                        anomalyTooltip.style.display = 'none';
                    }, 250);
                }
            });
            
            // æŒ‰ESCé”®å…³é—­å¼¹å‡ºçª—å£
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && anomalyTooltip.classList.contains('visible')) {
                    anomalyTooltip.classList.remove('visible');
                    setTimeout(() => {
                        anomalyTooltip.style.display = 'none';
                    }, 250);
                }
            });
        }
        
        // åˆå§‹åŒ–å€¼åˆ—å‡å€¼è¯´æ˜å¼¹å‡ºçª—å£
        const valueInfoIcon = document.getElementById('value-info-icon');
        const valueTooltip = document.getElementById('value-tooltip');
        
        if (valueInfoIcon && valueTooltip) {
            // ç‚¹å‡»å›¾æ ‡æ—¶æ˜¾ç¤º/éšè—å¼¹å‡ºçª—å£
            valueInfoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // ä½¿ç”¨æ–°çš„åŠ¨ç”»ç±»åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                if (valueTooltip.classList.contains('visible')) {
                    valueTooltip.classList.remove('visible');
                    // ç­‰å¾…åŠ¨ç”»ç»“æŸåéšè—å…ƒç´ 
                    setTimeout(() => {
                        valueTooltip.style.display = 'none';
                    }, 250); // ä¸CSSè¿‡æ¸¡æ—¶é—´ä¸€è‡´
                } else {
                    // å…ˆè®¾ç½®displayä»¥ä¾¿åŠ¨ç”»å¯è§
                    valueTooltip.style.display = 'block';
                    // å»¶è¿Ÿä¸€å¸§æ·»åŠ visibleç±»ä»¥ç¡®ä¿è¿‡æ¸¡åŠ¨ç”»ç”Ÿæ•ˆ
                    requestAnimationFrame(() => {
                        valueTooltip.classList.add('visible');
                    });
                }
            });
            
            // ç‚¹å‡»å¼¹å‡ºçª—å£å†…éƒ¨æ—¶é˜»æ­¢äº‹ä»¶å†’æ³¡
            valueTooltip.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸæ—¶éšè—å¼¹å‡ºçª—å£
            document.addEventListener('click', () => {
                if (valueTooltip.classList.contains('visible')) {
                    valueTooltip.classList.remove('visible');
                    setTimeout(() => {
                        valueTooltip.style.display = 'none';
                    }, 250);
                }
            });
            
            // æŒ‰ESCé”®å…³é—­å¼¹å‡ºçª—å£
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && valueTooltip.classList.contains('visible')) {
                    valueTooltip.classList.remove('visible');
                    setTimeout(() => {
                        valueTooltip.style.display = 'none';
                    }, 250);
                }
            });
        }

        // è¿”å›ä¸»ç•Œé¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        backToHomeBtn.addEventListener('click', function() {
            window.location.href = '/';
        });

        // åˆå§‹åŒ–ä¸Šä¼ åŒºåŸŸ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length) {
                handleFileSelection(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFileSelection(fileInput.files[0]);
            }
        });

        removeFileBtn.addEventListener('click', () => {
            // å­˜å‚¨å½“å‰è¿›è¡Œçš„åˆ†æç±»å‹ï¼Œä»¥ä¾¿å‘é€å–æ¶ˆè¯·æ±‚
            const currentAnalysisType = analysisTypeSelect.value;
            
            // æ— è®ºæ˜¯å¦åœ¨åˆ†æä¸­ï¼Œéƒ½å‘é€å–æ¶ˆä¿¡å·åˆ°åç«¯
            console.log('æ­£åœ¨ä¸­æ–­å½“å‰æ“ä½œ...');
            
            // å‘é€å–æ¶ˆä¿¡å·åˆ°åç«¯
            fetch('/api/cancel_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    analysis_type: currentAnalysisType,
                    operation: 'file_preprocessing', // æ ‡è®°ä¸ºé¢„å¤„ç†é˜¶æ®µ
                    timestamp: new Date().getTime()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('åç«¯ä»»åŠ¡å·²æˆåŠŸå–æ¶ˆ');
                } else {
                    console.warn('å–æ¶ˆåç«¯ä»»åŠ¡å¤±è´¥:', data.message);
                }
            })
            .catch(error => {
                console.error('å–æ¶ˆè¯·æ±‚å‡ºé”™:', error);
            });
            
            // ä¸­æ–­å½“å‰çš„åˆ†æè¯·æ±‚
            if (currentAnalysisFetchController) {
                currentAnalysisFetchController.abort();
                currentAnalysisFetchController = null;
            }
            
            // ä¸­æ–­å½“å‰çš„èµ„æ ¼æ£€æŸ¥è¯·æ±‚
            if (currentCheckEligibilityFetchController) {
                currentCheckEligibilityFetchController.abort();
                currentCheckEligibilityFetchController = null;
            }
            
            // ä¸­æ–­å½“å‰çš„å»ºè®®è¯·æ±‚
            if (currentSuggestionsFetchController) {
                currentSuggestionsFetchController.abort();
                currentSuggestionsFetchController = null;
            }
            
            // éšè—åŠ è½½æç¤º
            loading.style.display = 'none';
            
            // å…³é—­å¯èƒ½æ‰“å¼€çš„å·¥ä½œè¡¨é€‰æ‹©æ¨¡æ€çª—å£
            const sheetModal = document.getElementById('sheet-selection-modal');
            if (sheetModal && sheetModal.classList.contains('active')) {
                sheetModal.classList.remove('active');
            }
            
            console.log('å·²ä¸­æ–­æ‰€æœ‰æ“ä½œ');
            
            // é‡ç½®åˆ†æçŠ¶æ€
            window.isAnalyzing = false;
            
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            analysisOptions.style.display = 'none';
            dateColumnSelect.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸåˆ—</option>';
            valueColumnSelect.innerHTML = '<option value="">é€‰æ‹©è¦åˆ†æçš„å€¼åˆ—</option>';
            
            // éšè—ç»“æœå’Œé”™è¯¯ä¿¡æ¯
            resultsContainer.style.display = 'none';
            resultsContainer.classList.remove('force-display');
            errorMessage.style.display = 'none';
            
            // æ¸…é™¤ç»“æœä¿æŠ¤
            if (window.resultsProtectionInterval) {
                clearInterval(window.resultsProtectionInterval);
            }
            
            // åœæ­¢Observer
            if (window.resultsObserver) {
                window.resultsObserver.disconnect();
            }
            
            if (window.bodyObserver) {
                window.bodyObserver.disconnect();
            }
            
            console.log('å·²åœæ­¢æ‰€æœ‰ç›‘æ§');
            
            // æ¸…é™¤å·¥ä½œè¡¨ç›¸å…³ç¼“å­˜
            selectedSheetName = null;
            fileAnalysisData = null;
            console.log('å·²æ¸…é™¤å·¥ä½œè¡¨ç¼“å­˜');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            enableAnalyzeButton();
            hideDataRequirementWarning();
        });

        // åˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        analyzeBtn.addEventListener('click', () => {
            const dateColumn = dateColumnSelect.value;
            const valueColumn = valueColumnSelect.value;
            const analysisType = analysisTypeSelect.value;
            const timeGranularity = timeGranularitySelect.value;
            const processingMode = document.getElementById('processing-mode').value;
            
            if (!selectedFile) {
                showError('è¯·é€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶');
                return;
            }
            
            if (!dateColumn) {
                showError('è¯·é€‰æ‹©æ—¥æœŸåˆ—');
                return;
            }
            
            if (!valueColumn) {
                showError('è¯·é€‰æ‹©å€¼åˆ—');
                return;
            }
            
            // æ‰§è¡Œåˆ†æï¼Œä¼ é€’é€‰ä¸­çš„å·¥ä½œè¡¨
            analyzeData(selectedFile, dateColumn, valueColumn, analysisType, timeGranularity, processingMode, selectedSheetName);
        });
        
        // æŒ‰å›è½¦é”®å¯åŠ¨åˆ†æ
        document.addEventListener('keydown', (e) => {
            // åªæœ‰å½“æŒ‰ä¸‹å›è½¦é”®ï¼Œå¹¶ä¸”åˆ†æè®¾ç½®åŒºåŸŸå¯è§æ—¶æ‰è§¦å‘
            if (e.key === 'Enter' && analysisOptions.style.display !== 'none') {
                // ç¡®ä¿å…‰æ ‡ä¸åœ¨inputæˆ–textareaç­‰è¾“å…¥æ¡†å†…
                if (document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA' &&
                    document.activeElement.tagName !== 'SELECT') {
                    
                    // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„å­—æ®µ
                    const dateColumn = dateColumnSelect.value;
                    const valueColumn = valueColumnSelect.value;
                    
                    if (selectedFile && dateColumn && valueColumn && !analyzeBtn.disabled) {
                        // æ¨¡æ‹Ÿç‚¹å‡»åˆ†ææŒ‰é’®
                        analyzeBtn.click();
                        // é˜»æ­¢é»˜è®¤è¡Œä¸º
                        e.preventDefault();
                    }
                }
            }
        });

        // åˆ†æç±»å‹æ”¹å˜äº‹ä»¶
        analysisTypeSelect.addEventListener('change', () => {
            const analysisType = analysisTypeSelect.value;
            
            // é‡ç½®æ—¶é—´ç²’åº¦é€‰æ‹©å™¨
            resetTimeGranularityOptions();
            
            // æ ¹æ®åˆ†æç±»å‹æ˜¾ç¤º/éšè—æ—¶é—´ç²’åº¦é€‰é¡¹
            if (analysisType === 'year_over_year') {
                // åŒæ¯”åˆ†æå›ºå®šä¸ºæŒ‰æœˆ
                timeGranularitySelect.value = 'month';
                timeGranularitySelect.setAttribute('disabled', 'disabled');
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³åŒæ¯”åˆ†æçš„æ¡ä»¶
                if (selectedFile && dateColumnSelect.value) {
                    checkYearOverYearEligibility(selectedFile, dateColumnSelect.value);
                } else {
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶æˆ–æ—¥æœŸåˆ—ï¼Œåˆ™ä¸è¿›è¡Œæ£€æŸ¥
                    hideDataRequirementWarning();
                }
            } else if (analysisType === 'month_over_month') {
                // ç¯æ¯”åˆ†æå¯ä»¥ä½¿ç”¨ä¸åŒç²’åº¦ï¼Œä½†é»˜è®¤è®¾ç½®ä¸ºæŒ‰å¤©
                timeGranularitySelect.removeAttribute('disabled');
                timeGranularitySelect.value = 'day';
                
                // æ›´æ–°ç²’åº¦é€‰é¡¹çš„æ–‡æœ¬ï¼Œä½¿å…¶æ›´ç¬¦åˆç¯æ¯”åˆ†æçš„å‘½å
                updateTimeGranularityLabels(analysisType);
                
                hideDataRequirementWarning();
            } else {
                // è¶‹åŠ¿åˆ†æï¼Œé»˜è®¤è®¾ç½®ä¸ºæŒ‰å¤©
                timeGranularitySelect.removeAttribute('disabled');
                timeGranularitySelect.value = 'day';
                
                // æ¢å¤åŸå§‹é€‰é¡¹æ–‡æœ¬
                updateTimeGranularityLabels(analysisType);
                
                hideDataRequirementWarning();
            }
            
            // è§¦å‘æ—¶é—´ç²’åº¦å˜æ›´äº‹ä»¶ï¼Œç¡®ä¿UIå’Œè®¾ç½®åŒæ­¥
            const event = new Event('change');
            timeGranularitySelect.dispatchEvent(event);
            
            console.log(`åˆ†æç±»å‹å·²åˆ‡æ¢ä¸º: ${analysisType}, æ—¶é—´ç²’åº¦è®¾ç½®ä¸º: ${timeGranularitySelect.value}`);
        });
        
        // è¾…åŠ©å‡½æ•°ï¼šé‡ç½®æ—¶é—´ç²’åº¦é€‰æ‹©å™¨é€‰é¡¹
        function resetTimeGranularityOptions() {
            // æ¸…é™¤æ‰€æœ‰ç°æœ‰é€‰é¡¹
            while (timeGranularitySelect.options.length > 0) {
                timeGranularitySelect.remove(0);
            }
            
            // æ·»åŠ æ‰€æœ‰æ—¶é—´ç²’åº¦é€‰é¡¹
            const granularities = [
                {value: 'day', label: 'æŒ‰æ—¥'},
                {value: 'week', label: 'æŒ‰å‘¨'},
                {value: 'month', label: 'æŒ‰æœˆ'},
                {value: 'quarter', label: 'æŒ‰å­£åº¦'},
                {value: 'year', label: 'æŒ‰å¹´'}
            ];
            
            granularities.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = item.label;
                timeGranularitySelect.appendChild(option);
            });
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®åˆ†æç±»å‹æ›´æ–°æ—¶é—´ç²’åº¦æ ‡ç­¾
        function updateTimeGranularityLabels(analysisType) {
            const options = timeGranularitySelect.options;
            
            for (let i = 0; i < options.length; i++) {
                const opt = options[i];
                const value = opt.value;
                
                if (analysisType === 'month_over_month') {
                    // ç¯æ¯”åˆ†ææ¨¡å¼çš„æ ‡ç­¾
                    if (value === 'day') opt.textContent = 'æ—¥ç¯æ¯”';
                    else if (value === 'week') opt.textContent = 'å‘¨ç¯æ¯”';
                    else if (value === 'month') opt.textContent = 'æœˆç¯æ¯”';
                    else if (value === 'quarter') opt.textContent = 'å­£ç¯æ¯”';
                    else if (value === 'year') opt.textContent = 'å¹´ç¯æ¯”';
                } else {
                    // è¶‹åŠ¿åˆ†ææˆ–å…¶ä»–æ¨¡å¼çš„æ ‡ç­¾
                    if (value === 'day') opt.textContent = 'æŒ‰æ—¥';
                    else if (value === 'week') opt.textContent = 'æŒ‰å‘¨';
                    else if (value === 'month') opt.textContent = 'æŒ‰æœˆ';
                    else if (value === 'quarter') opt.textContent = 'æŒ‰å­£åº¦';
                    else if (value === 'year') opt.textContent = 'æŒ‰å¹´';
                }
            }
        }

        // æ—¥æœŸåˆ—é€‰æ‹©æ›´æ”¹äº‹ä»¶
        dateColumnSelect.addEventListener('change', () => {
            // å¦‚æœå½“å‰æ˜¯åŒæ¯”åˆ†æï¼Œåˆ™æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³æ¡ä»¶
            if (analysisTypeSelect.value === 'year_over_year' && selectedFile && dateColumnSelect.value) {
                checkYearOverYearEligibility(selectedFile, dateColumnSelect.value);
            } else {
                hideDataRequirementWarning();
            }
        });
        
        // æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³åŒæ¯”åˆ†æçš„æ¡ä»¶
        function checkYearOverYearEligibility(file, dateColumn) {
            if (!file || !dateColumn) {
                console.log('æ–‡ä»¶æˆ–æ—¥æœŸåˆ—æœªé€‰æ‹©ï¼Œæ— æ³•æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶');
                return;
            }

            // åˆ›å»ºæ–°çš„AbortControllerå®ä¾‹
            if (currentCheckEligibilityFetchController) {
                currentCheckEligibilityFetchController.abort(); // ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚
            }
            currentCheckEligibilityFetchController = new AbortController();
            const signal = currentCheckEligibilityFetchController.signal;

            // æ˜¾ç¤ºæ­£åœ¨æ£€æŸ¥çŠ¶æ€
            const warningDiv = document.querySelector('.data-requirement-warning') || createDataRequirementWarning();
            warningDiv.classList.add('checking');
            warningDiv.textContent = 'æ­£åœ¨æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚...';
            warningDiv.style.display = 'block';
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', file);
            formData.append('date_column', dateColumn);
            
            // æ·»åŠ å·¥ä½œè¡¨ä¿¡æ¯
            if (selectedSheetName) {
                formData.append('sheet_name', selectedSheetName);
            }
            
            // å‘é€è¯·æ±‚ä»¥æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³æ¡ä»¶
            fetch('/api/check_year_over_year_eligibility', {
                method: 'POST',
                body: formData,
                signal: signal // æ·»åŠ signalä»¥æ”¯æŒä¸­æ–­
            })
            .then(response => response.json())
            .then(data => {
                currentCheckEligibilityFetchController = null; // è¯·æ±‚å®Œæˆï¼Œæ¸…é™¤controllerå¼•ç”¨
                warningDiv.classList.remove('checking');
                
                if (data.success) {
                    if (data.has_enough_data) {
                        console.log('æ•°æ®æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚');
                        hideDataRequirementWarning();
                        enableAnalyzeButton();
                    } else {
                        console.log('æ•°æ®ä¸æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚');
                        warningDiv.textContent = 'âš ï¸ æ•°æ®ä¸è¶³ä¸¤å¹´ï¼Œæ— æ³•è¿›è¡ŒåŒæ¯”åˆ†æã€‚è¯·é€‰æ‹©å…¶ä»–åˆ†æç±»å‹æˆ–ä½¿ç”¨åŒ…å«è‡³å°‘ä¸¤å¹´æ•°æ®çš„æ–‡ä»¶ã€‚';
                        warningDiv.style.display = 'block';
                        disableAnalyzeButton();
                    }
                } else {
                    console.error('æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶å¤±è´¥:', data.message);
                    warningDiv.textContent = 'âš ï¸ æ— æ³•éªŒè¯æ•°æ®æ˜¯å¦æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚: ' + data.message;
                    warningDiv.style.display = 'block';
                    disableAnalyzeButton();
                }
            })
            .catch(error => {
                // å¦‚æœé”™è¯¯æ˜¯ç”±ä¸­æ–­å¼•èµ·çš„ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (error.name === 'AbortError') {
                    console.log('æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶è¯·æ±‚å·²ä¸­æ–­');
                    return;
                }
                
                currentCheckEligibilityFetchController = null; // è¯·æ±‚å‡ºé”™ï¼Œæ¸…é™¤controllerå¼•ç”¨
                console.error('æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶å‡ºé”™:', error);
                warningDiv.classList.remove('checking');
                warningDiv.textContent = 'âš ï¸ æ£€æŸ¥æ•°æ®æ—¶å‡ºé”™: ' + error.message;
                warningDiv.style.display = 'block';
                disableAnalyzeButton();
            });
        }

        // åˆ›å»ºæ•°æ®è¦æ±‚è­¦å‘ŠåŒºåŸŸ
        function createDataRequirementWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'data-requirement-warning';
            const optionsContainer = document.querySelector('.options-container');
            optionsContainer.insertBefore(warningDiv, document.getElementById('analyze-button'));
            return warningDiv;
        }

        // éšè—æ•°æ®è¦æ±‚è­¦å‘Š
        function hideDataRequirementWarning() {
            const warningDiv = document.querySelector('.data-requirement-warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }

        // ç¦ç”¨åˆ†ææŒ‰é’®
        function disableAnalyzeButton() {
            const analyzeButton = document.getElementById('analyze-button');
            analyzeButton.disabled = true;
            analyzeButton.classList.add('disabled');
            // æ·»åŠ å†…è”æ ·å¼ä»¥ç¡®ä¿ç¦ç”¨æ•ˆæœæ˜æ˜¾
            analyzeButton.style.backgroundColor = '#cccccc';
            analyzeButton.style.cursor = 'not-allowed';
            analyzeButton.style.opacity = '0.7';
            analyzeButton.style.pointerEvents = 'none';
        }

        // å¯ç”¨åˆ†ææŒ‰é’®
        function enableAnalyzeButton() {
            const analyzeButton = document.getElementById('analyze-button');
            analyzeButton.disabled = false;
            analyzeButton.classList.remove('disabled');
            // æ¢å¤åŸå§‹æ ·å¼
            analyzeButton.style.backgroundColor = 'var(--primary-color)';
            analyzeButton.style.cursor = 'pointer';
            analyzeButton.style.opacity = '1';
            analyzeButton.style.pointerEvents = 'auto';
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelection(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsæ ¼å¼ï¼‰');
                return;
            }
            
            // åˆ›å»ºæ–°çš„AbortControllerå®ä¾‹
            if (currentSuggestionsFetchController) {
                currentSuggestionsFetchController.abort(); // ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚
            }
            currentSuggestionsFetchController = new AbortController();
            const signal = currentSuggestionsFetchController.signal;
            
            selectedFile = file;
            fileName.textContent = file.name;
            uploadArea.style.display = 'none';
            fileInfo.style.display = 'flex';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            analysisOptions.style.display = 'none';
            errorMessage.style.display = 'none';
            resultsContainer.style.display = 'none';
            
            // åˆ†ææ–‡ä»¶ï¼Œè·å–åˆ—ä¿¡æ¯å’Œå»ºè®®
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/get_analysis_suggestions', {
                method: 'POST',
                body: formData,
                signal: signal // æ·»åŠ signalä»¥æ”¯æŒä¸­æ–­
            })
            .then(response => {
                console.log('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
                return response.text().then(text => {
                    try {
                        // å°è¯•è§£æJSON
                        console.log('æ¥æ”¶åˆ°çš„åŸå§‹å“åº”:', text);
                        
                        // é¢„å¤„ç†JSONå­—ç¬¦ä¸²ï¼Œå¤„ç†å¯èƒ½çš„NaNå€¼
                        const cleanedText = text.replace(/:\s*NaN\s*([,}])/g, ': null$1')
                                              .replace(/:\s*Infinity\s*([,}])/g, ': null$1')
                                              .replace(/:\s*-Infinity\s*([,}])/g, ': null$1');
                        console.log('æ¸…ç†åçš„å“åº”:', cleanedText);
                        
                        const data = JSON.parse(cleanedText);
                        console.log('è§£æåçš„å®Œæ•´JSONæ•°æ®:', data);
                        console.log('è¡Œæ•°ä¿¡æ¯:', data.row_count, 'ç±»å‹:', typeof data.row_count);
                        
                        // ç¡®ä¿row_countæ˜¯æ•°å­—
                        if (data.row_count !== undefined && data.row_count !== null) {
                            data.row_count = Number(data.row_count);
                            console.log('è½¬æ¢åçš„è¡Œæ•°:', data.row_count, 'ç±»å‹:', typeof data.row_count);
                        }
                        
                        return data;
                    } catch (e) {
                        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
                        console.error('JSONè§£æå¤±è´¥:', e);
                        console.log('æ— æ³•è§£æçš„å“åº”æ–‡æœ¬:', text);
                        throw new Error('æœåŠ¡å™¨è¿”å›çš„å“åº”æ— æ³•è§£æä¸ºJSON: ' + text);
                    }
                });
            })
            .then(data => {
                currentSuggestionsFetchController = null; // è¯·æ±‚å®Œæˆï¼Œæ¸…é™¤controllerå¼•ç”¨
                loading.style.display = 'none';
                
                if (data.success) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªå·¥ä½œè¡¨
                    if (data.multiple_sheets && data.sheet_names && data.sheet_names.length > 1) {
                        // ä¿å­˜å½“å‰æ•°æ®ä¾›åç»­ä½¿ç”¨
                        fileAnalysisData = data;
                        
                        // æ˜¾ç¤ºå·¥ä½œè¡¨é€‰æ‹©æ¨¡æ€çª—å£
                        showSheetSelectionModal(data.sheet_names, data.selected_sheet);
                    } else {
                        // å•ä¸ªå·¥ä½œè¡¨ï¼Œç›´æ¥å¤„ç†æ•°æ®
                        processFileAnalysisData(data);
                    }
                } else {
                    showError(data.message || 'åˆ†ææ–‡ä»¶æ—¶å‡ºé”™');
                }
            })
            .catch(error => {
                // å¦‚æœé”™è¯¯æ˜¯ç”±ä¸­æ–­å¼•èµ·çš„ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (error.name === 'AbortError') {
                    console.log('è·å–åˆ†æå»ºè®®è¯·æ±‚å·²ä¸­æ–­');
                    return;
                }
                
                currentSuggestionsFetchController = null; // è¯·æ±‚å‡ºé”™ï¼Œæ¸…é™¤controllerå¼•ç”¨
                loading.style.display = 'none';
                showError('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
            });
        }

        // æ·»åŠ å·¥ä½œè¡¨é€‰æ‹©ç›¸å…³åŠŸèƒ½
        let fileAnalysisData = null; // ä¿å­˜æ–‡ä»¶åˆ†ææ•°æ®
        let selectedSheetName = null; // é€‰ä¸­çš„å·¥ä½œè¡¨å

        // æ˜¾ç¤ºå·¥ä½œè¡¨é€‰æ‹©æ¨¡æ€çª—å£
        function showSheetSelectionModal(sheetNames, selectedSheet) {
            // æ›´æ–°é€‰ä¸­çš„å·¥ä½œè¡¨
            selectedSheetName = selectedSheet;
            
            // å¡«å……å·¥ä½œè¡¨åˆ—è¡¨
            const sheetList = document.getElementById('sheet-list');
            sheetList.innerHTML = '';
            
            sheetNames.forEach((sheet, index) => {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'sheet-item';
                if (sheet === selectedSheet || (index === 0 && !selectedSheet)) {
                    sheetItem.classList.add('selected');
                    selectedSheetName = sheet;
                }
                
                sheetItem.innerHTML = `
                    <input type="radio" name="sheet" id="sheet-${index}" value="${sheet}" 
                        ${sheet === selectedSheet || (index === 0 && !selectedSheet) ? 'checked' : ''}>
                    <label for="sheet-${index}">${sheet}</label>
                `;
                
                sheetItem.addEventListener('click', () => {
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.sheet-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    sheetItem.classList.add('selected');
                    
                    // æ›´æ–°é€‰ä¸­çš„å·¥ä½œè¡¨
                    const radio = sheetItem.querySelector('input[type="radio"]');
                    radio.checked = true;
                    selectedSheetName = radio.value;
                });
                
                sheetList.appendChild(sheetItem);
            });
            
            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('sheet-selection-modal').classList.add('active');
        }

        // ç¡®è®¤å·¥ä½œè¡¨é€‰æ‹©
        document.getElementById('confirm-sheet-selection').addEventListener('click', () => {
            // éšè—æ¨¡æ€çª—å£
            document.getElementById('sheet-selection-modal').classList.remove('active');
            
            // ä½¿ç”¨é€‰ä¸­çš„å·¥ä½œè¡¨è·å–åˆ†æç»“æœ
            if (fileAnalysisData) {
                // é‡æ–°è¯·æ±‚åˆ†ææ•°æ®ï¼Œä½†æŒ‡å®šå·¥ä½œè¡¨
                loading.style.display = 'block';
                
                // ç¡®ä¿è·å–æ­£ç¡®çš„é€‰ä¸­å·¥ä½œè¡¨ï¼ˆä»å•é€‰æŒ‰é’®è·å–ï¼‰
                const selectedRadio = document.querySelector('input[name="sheet"]:checked');
                if (selectedRadio) {
                    selectedSheetName = selectedRadio.value;
                    console.log("ç¡®è®¤é€‰æ‹©çš„å·¥ä½œè¡¨:", selectedSheetName);
                    
                    // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºï¼Œæ·»åŠ å·¥ä½œè¡¨åç§°
                    updateFileNameWithSheet(selectedFile.name, selectedSheetName);
                }
                
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('sheet_name', selectedSheetName);
                
                console.log("å‘é€å·¥ä½œè¡¨é€‰æ‹©è¯·æ±‚:", {
                    file: selectedFile.name,
                    sheet_name: selectedSheetName
                });
                
                fetch('/api/get_analysis_suggestions', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success) {
                        // æ›´æ–°å…¨å±€å˜é‡ä»¥æ­£ç¡®ä¿å­˜é€‰ä¸­çš„å·¥ä½œè¡¨
                        fileAnalysisData = data;
                        selectedSheetName = data.selected_sheet;
                        console.log("åç«¯è¿”å›çš„å·¥ä½œè¡¨ä¿¡æ¯:", {
                            selectedSheet: selectedSheetName,
                            allSheets: data.sheet_names
                        });
                        
                        // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºï¼Œæ·»åŠ å·¥ä½œè¡¨åç§°
                        updateFileNameWithSheet(selectedFile.name, selectedSheetName);
                        
                        processFileAnalysisData(data);
                    } else {
                        showError(data.message || 'åˆ†æå·¥ä½œè¡¨æ—¶å‡ºé”™');
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    showError('å¤„ç†å·¥ä½œè¡¨æ—¶å‡ºé”™: ' + error.message);
                    console.error('å¤„ç†å·¥ä½œè¡¨æ—¶å‡ºé”™:', error);
                });
            }
        });

        // å–æ¶ˆå·¥ä½œè¡¨é€‰æ‹©
        document.getElementById('cancel-sheet-selection').addEventListener('click', () => {
            // éšè—æ¨¡æ€çª—å£
            document.getElementById('sheet-selection-modal').classList.remove('active');
            
            // å‘é€å–æ¶ˆä¿¡å·åˆ°åç«¯ï¼Œç¡®ä¿ä»»ä½•å¯èƒ½æ­£åœ¨è¿›è¡Œçš„é¢„å¤„ç†è¢«ç»ˆæ­¢
            fetch('/api/cancel_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'file_preprocessing',
                    timestamp: new Date().getTime()
                })
            }).catch(error => {
                console.error('å–æ¶ˆé¢„å¤„ç†è¯·æ±‚å‡ºé”™:', error);
            });
            
            // æ¸…é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶å¹¶é‡ç½®ç•Œé¢
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            analysisOptions.style.display = 'none';
            dateColumnSelect.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸåˆ—</option>';
            valueColumnSelect.innerHTML = '<option value="">é€‰æ‹©è¦åˆ†æçš„å€¼åˆ—</option>';
            
            // æ¸…é™¤å·¥ä½œè¡¨ç›¸å…³ç¼“å­˜
            selectedSheetName = null;
            fileAnalysisData = null;
            console.log('å–æ¶ˆé€‰æ‹©å·¥ä½œè¡¨ï¼Œå·²æ¸…é™¤æ–‡ä»¶å’Œå·¥ä½œè¡¨ç¼“å­˜');
        });

        // å…³é—­å·¥ä½œè¡¨é€‰æ‹©æ¨¡æ€çª—å£ï¼ˆXæŒ‰é’®ï¼‰
        document.querySelector('#sheet-selection-modal .close-modal').addEventListener('click', () => {
            // éšè—æ¨¡æ€çª—å£
            document.getElementById('sheet-selection-modal').classList.remove('active');
            
            // å‘é€å–æ¶ˆä¿¡å·åˆ°åç«¯ï¼Œç¡®ä¿ä»»ä½•å¯èƒ½æ­£åœ¨è¿›è¡Œçš„é¢„å¤„ç†è¢«ç»ˆæ­¢
            fetch('/api/cancel_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'file_preprocessing',
                    timestamp: new Date().getTime()
                })
            }).catch(error => {
                console.error('å–æ¶ˆé¢„å¤„ç†è¯·æ±‚å‡ºé”™:', error);
            });
            
            // æ¸…é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶å¹¶é‡ç½®ç•Œé¢
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            analysisOptions.style.display = 'none';
            dateColumnSelect.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸåˆ—</option>';
            valueColumnSelect.innerHTML = '<option value="">é€‰æ‹©è¦åˆ†æçš„å€¼åˆ—</option>';
            
            // æ¸…é™¤å·¥ä½œè¡¨ç›¸å…³ç¼“å­˜
            selectedSheetName = null;
            fileAnalysisData = null;
            console.log('å…³é—­å·¥ä½œè¡¨é€‰æ‹©çª—å£ï¼Œå·²æ¸…é™¤æ–‡ä»¶å’Œå·¥ä½œè¡¨ç¼“å­˜');
        });

        // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºï¼Œæ·»åŠ å·¥ä½œè¡¨åç§°çš„è¾…åŠ©å‡½æ•°
        function updateFileNameWithSheet(fileName, sheetName) {
            if (!fileName || !sheetName) return;
            
            const fileNameElement = document.getElementById('file-name');
            if (fileNameElement) {
                // ä½¿ç”¨æ ‡ç­¾æ ·å¼åŒºåˆ†æ–‡ä»¶åå’Œå·¥ä½œè¡¨å
                fileNameElement.innerHTML = `
                    ${fileName} <span style="color:var(--primary-color); margin-left:5px; font-size:0.9em;">[${sheetName}]</span>
                `;
            }
        }

        // å¤„ç†æ–‡ä»¶åˆ†ææ•°æ®
        function processFileAnalysisData(data) {
            // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºï¼Œæ·»åŠ å·¥ä½œè¡¨åç§°
            if (selectedFile && data.selected_sheet) {
                updateFileNameWithSheet(selectedFile.name, data.selected_sheet);
            }
            
            // å¡«å……æ—¥æœŸåˆ—é€‰é¡¹
            dateColumnSelect.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸåˆ—</option>';
            data.date_columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                dateColumnSelect.appendChild(option);
            });
            
            // å¡«å……å€¼åˆ—é€‰é¡¹
            valueColumnSelect.innerHTML = '<option value="">é€‰æ‹©è¦åˆ†æçš„å€¼åˆ—</option>';
            data.value_columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.name;
                option.textContent = `${column.name} (å‡å€¼: ${formatNumber(column.avg)})`;
                valueColumnSelect.appendChild(option);
            });
            
            // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            // é¦–å…ˆç§»é™¤ç°æœ‰çš„è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.custom-select-container').forEach(container => {
                if (container.dataset.for === 'date-column' || container.dataset.for === 'value-column') {
                    container.remove();
                }
            });
            
            // æ˜¾ç¤ºåŸå§‹selectä»¥ä¾¿é‡æ–°åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            dateColumnSelect.style.display = '';
            valueColumnSelect.style.display = '';
            
            // ä¸ºè¿™ä¸¤ä¸ªä¸‹æ‹‰æ¡†é‡æ–°åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            [dateColumnSelect, valueColumnSelect].forEach(select => {
                // åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†å®¹å™¨
                const customSelectContainer = document.createElement('div');
                customSelectContainer.className = 'custom-select-container';
                customSelectContainer.dataset.for = select.id;
                
                // åˆ›å»ºé€‰ä¸­é¡¹æ˜¾ç¤ºåŒºåŸŸ
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'custom-select-selected';
                
                // è·å–å½“å‰é€‰ä¸­é¡¹
                const selectedText = select.options[select.selectedIndex]?.text || 'è¯·é€‰æ‹©';
                
                // è®¾ç½®æ˜¾ç¤ºå†…å®¹
                selectedDiv.innerHTML = `
                    <span class="custom-select-text">${selectedText}</span>
                    <i class="ri-arrow-down-s-line custom-select-arrow"></i>
                `;
                
                // åˆ›å»ºé€‰é¡¹åˆ—è¡¨
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'custom-select-options';
                
                // æ·»åŠ é€‰é¡¹
                Array.from(select.options).forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    if (index === select.selectedIndex) {
                        optionDiv.classList.add('selected');
                    }
                    optionDiv.setAttribute('data-value', option.value);
                    optionDiv.textContent = option.text;
                    
                    // é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                    optionDiv.addEventListener('click', () => {
                        // æ›´æ–°åŸå§‹selectçš„å€¼
                        select.value = option.value;
                        
                        // è§¦å‘changeäº‹ä»¶
                        const event = new Event('change', { bubbles: true });
                        select.dispatchEvent(event);
                        
                        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                        selectedDiv.querySelector('.custom-select-text').textContent = option.text;
                        
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        optionDiv.classList.add('selected');
                        
                        // å…³é—­ä¸‹æ‹‰æ¡†
                        customSelectContainer.classList.remove('active');
                    });
                    
                    optionsDiv.appendChild(optionDiv);
                });
                
                // ç‚¹å‡»æ˜¾ç¤º/éšè—é€‰é¡¹
                selectedDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // å…³é—­å…¶ä»–æ‰“å¼€çš„ä¸‹æ‹‰æ¡†
                    document.querySelectorAll('.custom-select-container').forEach(container => {
                        if (container !== customSelectContainer) {
                            container.classList.remove('active');
                        }
                    });
                    
                    // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†çŠ¶æ€
                    customSelectContainer.classList.toggle('active');
                });
                
                // æ·»åŠ å…ƒç´ åˆ°å®¹å™¨
                customSelectContainer.appendChild(selectedDiv);
                customSelectContainer.appendChild(optionsDiv);
                
                // éšè—åŸå§‹select
                select.style.display = 'none';
                
                // å°†è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ’å…¥åˆ°selectä¹‹å
                select.parentNode.insertBefore(customSelectContainer, select.nextSibling);
                
                // ä¸ºåŸå§‹selectæ·»åŠ å˜æ›´ç›‘å¬å™¨ï¼Œä»¥ä¾¿åŒæ­¥æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
                select.addEventListener('change', () => {
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        selectedDiv.querySelector('.custom-select-text').textContent = selectedOption.text;
                        
                        // æ›´æ–°é€‰ä¸­æ ·å¼
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            if (opt.getAttribute('data-value') === selectedOption.value) {
                                opt.classList.add('selected');
                            } else {
                                opt.classList.remove('selected');
                            }
                        });
                    }
                });
            });
            
            // æ ¹æ®æ•°æ®é‡é€‰æ‹©é»˜è®¤å¤„ç†æ¨¡å¼
            const processingModeSelect = document.getElementById('processing-mode');
            
            // ä½¿ç”¨åç«¯æä¾›çš„è¡Œæ•°ä¿¡æ¯
            const rowCount = data.row_count || 0;
            console.log('åç«¯è¿”å›çš„æ•°æ®è¡Œæ•°:', rowCount);

            // æ·»åŠ æ•°æ®é‡æç¤º
            const infoText = document.querySelector('#processing-mode-group .info-text span');
            
            // æ— è®ºå¦‚ä½•éƒ½æ˜¾ç¤ºå¤„ç†æ¨¡å¼æç¤º
            if (rowCount > 10000) {
                console.log('æ•°æ®é‡å¤§äº10000è¡Œï¼Œæ˜¾ç¤ºè¯¦ç»†è¡Œæ•°æç¤º');
                processingModeSelect.value = 'auto';
                infoText.innerHTML = `<strong>æ£€æµ‹åˆ°å¤§æ•°æ®é›† (${formatNumber(rowCount)}è¡Œ)</strong>ï¼Œå»ºè®®ä½¿ç”¨æ™ºèƒ½å¤„ç†æé«˜æ€§èƒ½`;
            } else {
                console.log('æ•°æ®é‡è¾ƒå°æˆ–æœªçŸ¥ï¼Œæ˜¾ç¤ºåŸºæœ¬æç¤º');
                infoText.innerHTML = `<strong>é€‰æ‹©å¤„ç†æ¨¡å¼</strong>ï¼šå¤§æ•°æ®é›†å»ºè®®ä½¿ç”¨æ™ºèƒ½å¤„ç†`;
            }
            
            // æ˜¾ç¤ºåˆ†æé€‰é¡¹
            analysisOptions.style.display = 'block';
            
            // ç¡®ä¿å¤„ç†æ¨¡å¼é€‰é¡¹å¯è§
            document.getElementById('processing-mode-group').style.display = 'flex';
            
            // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯åŒæ¯”åˆ†æï¼Œç«‹å³æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³æ¡ä»¶
            if (analysisTypeSelect.value === 'year_over_year' && dateColumnSelect.value) {
                setTimeout(() => {
                    console.log("æ–‡ä»¶åŠ è½½åæ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶");
                    checkYearOverYearEligibility(selectedFile, dateColumnSelect.value);
                }, 300); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°
            } else {
                // ç¡®ä¿ä»»ä½•å¯èƒ½çš„è­¦å‘Šè¢«æ¸…é™¤
                hideDataRequirementWarning();
                enableAnalyzeButton();
            }
        }

        // æ‰§è¡Œæ•°æ®åˆ†æ
        function analyzeData(file, dateColumn, valueColumn, analysisType, timeGranularity, processingMode, sheetName) {
            // å¦‚æœæ˜¯åŒæ¯”åˆ†æï¼Œå†æ¬¡æ£€æŸ¥æ•°æ®æ¡ä»¶
            if (analysisType === 'year_over_year') {
                checkYearOverYearEligibility(file, dateColumn);
                // æ£€æŸ¥ä¹‹åï¼Œä¼šè‡ªåŠ¨ç¦ç”¨æˆ–å¯ç”¨åˆ†ææŒ‰é’®
                return;
            }
            
            // åˆ›å»ºæ–°çš„AbortControllerå®ä¾‹
            if (currentAnalysisFetchController) {
                currentAnalysisFetchController.abort(); // ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚
            }
            currentAnalysisFetchController = new AbortController();
            const signal = currentAnalysisFetchController.signal;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            resultsContainer.style.display = 'none';
            
            // æ ‡è®°åˆ†ææ­£åœ¨è¿›è¡Œä¸­
            window.isAnalyzing = true;
            
            // æ»šåŠ¨åˆ°åŠ è½½æç¤ºåŒºåŸŸï¼Œè®©ç”¨æˆ·å¯ä»¥çœ‹åˆ°"æ­£åœ¨åˆ†æ"çŠ¶æ€
            setTimeout(() => {
                loading.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('date_column', dateColumn);
            formData.append('value_column', valueColumn);
            formData.append('analysis_type', analysisType);
            formData.append('time_granularity', timeGranularity);
            formData.append('processing_mode', processingMode);
            
            // æ·»åŠ å·¥ä½œè¡¨ä¿¡æ¯
            if (sheetName) {
                formData.append('sheet_name', sheetName);
            }
            
            fetch('/api/analyze_sales_trend', {
                method: 'POST',
                body: formData,
                signal: signal // æ·»åŠ signalä»¥æ”¯æŒä¸­æ–­
            })
            .then(response => {
                console.log('åˆ†æAPIå“åº”çŠ¶æ€:', response.status);
                return response.text().then(text => {
                    try {
                        // å°è¯•è§£æJSON
                        console.log('åˆ†æAPIåŸå§‹å“åº”:', text);
                        
                        // é¢„å¤„ç†JSONå­—ç¬¦ä¸²ï¼Œå¤„ç†å¯èƒ½çš„NaNå€¼
                        const cleanedText = text.replace(/:\s*NaN\s*([,}])/g, ': null$1');
                        console.log('æ¸…ç†åçš„å“åº”:', cleanedText);
                        
                        const data = JSON.parse(cleanedText);
                        console.log('åˆ†æAPIè§£æåçš„JSONæ•°æ®:', data);
                        return data;
                    } catch (e) {
                        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
                        console.error('åˆ†æAPIçš„JSONè§£æå¤±è´¥:', e);
                        console.log('åˆ†æAPIæ— æ³•è§£æçš„å“åº”æ–‡æœ¬:', text);
                        throw new Error('æœåŠ¡å™¨è¿”å›çš„å“åº”æ— æ³•è§£æä¸ºJSON: ' + text);
                    }
                });
            })
            .then(data => {
                currentAnalysisFetchController = null; // è¯·æ±‚å®Œæˆï¼Œæ¸…é™¤controllerå¼•ç”¨
                loading.style.display = 'none';
                // åˆ†æå·²å®Œæˆï¼Œé‡ç½®åˆ†æçŠ¶æ€
                window.isAnalyzing = false;
                
                if (data.success) {
                    // ä¿å­˜åˆ†æç»“æœ
                    analysisResults = data.data;
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayResults(analysisResults, analysisType, valueColumn);
                } else {
                    showError(data.message || 'åˆ†æå¤±è´¥');
                }
            })
            .catch(error => {
                // å¦‚æœé”™è¯¯æ˜¯ç”±ä¸­æ–­å¼•èµ·çš„ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (error.name === 'AbortError') {
                    console.log('åˆ†æè¯·æ±‚å·²ä¸­æ–­');
                    return;
                }
                
                currentAnalysisFetchController = null; // è¯·æ±‚å‡ºé”™ï¼Œæ¸…é™¤controllerå¼•ç”¨
                loading.style.display = 'none';
                // åˆ†æå·²å®Œæˆæˆ–å‡ºé”™ï¼Œé‡ç½®åˆ†æçŠ¶æ€
                window.isAnalyzing = false;
                showError('åˆ†ææ•°æ®æ—¶å‡ºé”™: ' + error.message);
            });
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayResults(results, analysisType, valueColumn) {
            // æ¸…é™¤æ—§çš„å›¾è¡¨
            document.getElementById('trend-chart').innerHTML = '';
            document.getElementById('stats-content').innerHTML = '';
            document.getElementById('anomalies-content').innerHTML = '';
            
            // æ ¹æ®åˆ†æç±»å‹æ˜¾ç¤º/éšè—ç›¸å…³éƒ¨åˆ†
            document.getElementById('yoy-section').style.display = analysisType === 'year_over_year' ? 'block' : 'none';
            document.getElementById('mom-section').style.display = analysisType === 'month_over_month' ? 'block' : 'none';
            document.getElementById('decomposition-section').style.display = results.decomposition ? 'block' : 'none';
            
            // å¤„ç†ç¯æ¯”åˆ†ææ—¶è¶‹åŠ¿å¡ç‰‡çš„æ˜¾ç¤º
            const trendCard = document.querySelector('.trend-card');
            if (analysisType === 'month_over_month') {
                trendCard.style.display = 'none'; // ç¯æ¯”åˆ†ææ—¶éšè—è¶‹åŠ¿å›¾å¡ç‰‡
            } else {
                trendCard.style.display = 'block'; // å…¶ä»–åˆ†æç±»å‹æ˜¾ç¤ºè¶‹åŠ¿å›¾å¡ç‰‡
            }
            
            if (analysisType === 'year_over_year') {
                document.getElementById('yoy-chart').innerHTML = '';
                document.getElementById('yoy-growth-chart').innerHTML = '';
            } else if (analysisType === 'month_over_month') {
                document.getElementById('mom-chart').innerHTML = '';
                document.getElementById('mom-growth-chart').innerHTML = '';
            }
            
            if (results.decomposition) {
                document.getElementById('trend-component').innerHTML = '';
                document.getElementById('seasonal-component').innerHTML = '';
                document.getElementById('residual-component').innerHTML = '';
            }
            
            // æ˜¾ç¤ºè¶‹åŠ¿å›¾
            if (results.chart) {
                // ç¯æ¯”åˆ†æä¸æ˜¾ç¤ºè¶‹åŠ¿å›¾
                if (analysisType !== 'month_over_month') {
                    const chartConfig = {
                        displayModeBar: false, // ç¦ç”¨æ¨¡å¼æ ï¼ˆåŒ…å«æ”¾å¤§ã€ç¼©å°ã€æˆªå›¾ç­‰åŠŸèƒ½ï¼‰
                        responsive: true,
                        scrollZoom: false,     // ç¦ç”¨æ»šè½®ç¼©æ”¾
                        staticPlot: false      // è®¾ä¸ºfalseä»¥ä¿ç•™æ‚¬åœåŠŸèƒ½
                    };
                    
                    // è§£æå›¾è¡¨æ•°æ®
                    const chartData = JSON.parse(results.chart);
                    
                    // ä¿®æ”¹å›¾è¡¨å¸ƒå±€ï¼Œå¼ºåˆ¶ç¦ç”¨æ¨¡å¼æ ä½†ä¿ç•™æ‚¬åœ
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.showlegend = true;
                    layout.hovermode = 'closest';
                    layout.uirevision = false;
                    
                    // ç¡®ä¿æ‚¬åœæ¨¡æ¿æ­£ç¡®è®¾ç½®
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            trace.showlegend = true;
                            // ä¿ç•™æˆ–è®¾ç½®æ‚¬åœæ¨¡æ¿
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('trend-chart', chartData.data, layout, chartConfig);
                    
                    // æ·»åŠ å»¶è¿Ÿè§¦å‘window.resizeäº‹ä»¶ï¼Œç¡®ä¿å›¾è¡¨èƒ½å¤Ÿæ­£ç¡®è°ƒæ•´å¤§å°ä»¥å¡«æ»¡å®¹å™¨
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                } else {
                    // æ¸…ç©ºè¶‹åŠ¿å›¾åŒºåŸŸ
                    document.getElementById('trend-chart').innerHTML = '';
                    // éšè—è¶‹åŠ¿å›¾å¡ç‰‡
                    document.querySelector('.trend-card').style.display = 'none';
                }
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
            if (results.stats) {
                const statsContent = document.getElementById('stats-content');
                const stats = results.stats;
                
                if (analysisType === 'trend') {
                    // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´ç²’åº¦
                    const timeGranularity = document.getElementById('time-granularity').value;
                    
                    // æ£€æŸ¥æœ€å°å€¼å’Œæœ€å¤§å€¼æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°æ®
                    const hasValidMax = stats.max && 
                                       stats.max.value != null && 
                                       !isNaN(stats.max.value) && 
                                       stats.max.date != null && 
                                       stats.max.date !== "None" && 
                                       stats.max.date !== "null";
                    
                    const hasValidMin = stats.min && 
                                       stats.min.value != null && 
                                       !isNaN(stats.min.value) && 
                                       stats.min.date != null && 
                                       stats.min.date !== "None" && 
                                       stats.min.date !== "null";
                    
                    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼Œæ ¹æ®æ—¶é—´ç²’åº¦è°ƒæ•´
                    let formatMaxDate = hasValidMax ? stats.max.date : '';
                    let formatMinDate = hasValidMin ? stats.min.date : '';
                    
                    // æ ¹æ®æ—¶é—´ç²’åº¦è°ƒæ•´æ—¥æœŸæ ¼å¼
                    if (timeGranularity === 'week') {
                        // å¦‚æœæ˜¯å‘¨ç²’åº¦ï¼Œæ ¼å¼åŒ–ä¸ºxxxxå¹´xå‘¨ï¼ˆxxæœˆxxæ—¥-xxæœˆxxæ—¥ï¼‰
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            try {
                                const date = new Date(formatMaxDate);
                                if (!isNaN(date.getTime())) {
                                    // è·å–å¹´ä»½
                                    const year = date.getFullYear();
                                    
                                    // è®¡ç®—å‘¨æ•° - ä½¿ç”¨ISOå‘¨
                                    const getWeekNumber = (d) => {
                                        // ISOå‘¨ä»å‘¨ä¸€å¼€å§‹ï¼Œå‘¨æ—¥ä¸º7
                                        const date = new Date(d.getTime());
                                        date.setHours(0, 0, 0, 0);
                                        // è®¾ç½®ä¸ºå‘¨å››ï¼ˆISOå‘¨çš„å®šä¹‰æ˜¯å‘¨å››æ‰€åœ¨çš„å‘¨ï¼‰
                                        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                                        // ä¸€æœˆå››æ—¥è‚¯å®šåœ¨ç¬¬ä¸€å‘¨
                                        const firstWeek = new Date(date.getFullYear(), 0, 4);
                                        // è°ƒæ•´åˆ°å‘¨å››
                                        firstWeek.setDate(firstWeek.getDate() + 3 - (firstWeek.getDay() + 6) % 7);
                                        // è®¡ç®—å‘¨å·®
                                        const weekNumber = Math.round(((date.getTime() - firstWeek.getTime()) / 86400000 - 3 + (firstWeek.getDay() + 6) % 7) / 7) + 1;
                                        return weekNumber;
                                    };
                                    
                                    const weekNumber = getWeekNumber(date);
                                    
                                    // è®¡ç®—æ‰€åœ¨å‘¨çš„å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰å’Œç»“æŸæ—¥æœŸï¼ˆå‘¨æ—¥ï¼‰
                                    const getWeekDates = (d) => {
                                        const date = new Date(d.getTime());
                                        // è·å–å½“å‰æ˜¯å‘¨å‡ ï¼ˆ0æ˜¯å‘¨æ—¥ï¼Œ1æ˜¯å‘¨ä¸€ï¼Œ...ï¼Œ6æ˜¯å‘¨å…­ï¼‰
                                        const day = date.getDay();
                                        // è®¡ç®—åˆ°å‘¨ä¸€çš„æ—¥æœŸå·®
                                        const diff = day === 0 ? -6 : 1 - day; // å¦‚æœæ˜¯å‘¨æ—¥ï¼Œéœ€è¦å‡6å¤©ï¼Œå¦åˆ™å°±æ˜¯1-day
                                        
                                        // è®¾ç½®ä¸ºå½“å‘¨çš„å‘¨ä¸€
                                        const monday = new Date(date.getTime());
                                        monday.setDate(date.getDate() + diff);
                                        
                                        // è®¾ç½®ä¸ºå½“å‘¨çš„å‘¨æ—¥
                                        const sunday = new Date(monday.getTime());
                                        sunday.setDate(monday.getDate() + 6);
                                        
                                        return { monday, sunday };
                                    };
                                    
                                    const { monday, sunday } = getWeekDates(date);
                                    
                                    // æ ¼å¼åŒ–æ—¥æœŸä¸º"æœˆæ—¥"
                                    const formatMonthDay = (d) => {
                                        return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
                                    };
                                    
                                    // æ ¹æ®åç«¯æ ¼å¼è·å–æ­£ç¡®çš„å‘¨æ•°ï¼Œä¿æŒå‘¨æ•°ä¸å˜
                                    // å°è¯•ä»formatMaxDateä¸­æå–å‘¨æ•°ä¿¡æ¯
                                    let extractedWeekNum = weekNumber;
                                    if (formatMaxDate.includes('å¹´') && formatMaxDate.includes('å‘¨')) {
                                        const weekMatch = formatMaxDate.match(/(\d+)å¹´(?:ç¬¬)?(\d+)å‘¨/);
                                        if (weekMatch && weekMatch.length === 3) {
                                            extractedWeekNum = parseInt(weekMatch[2], 10);
                                        }
                                    }
                                    
                                    // è®¡ç®—ä¸Šä¸€å‘¨çš„æ—¥æœŸèŒƒå›´
                                    const prevMonday = new Date(monday.getTime());
                                    prevMonday.setDate(monday.getDate() - 6);
                                    
                                    const prevSunday = new Date(sunday.getTime());
                                    prevSunday.setDate(sunday.getDate() - 6);
                                    
                                    // ä½¿ç”¨æŒ‡å®šæ ¼å¼ï¼Œä¿æŒå‘¨æ•°ä¸å˜
                                    formatMaxDate = `${year}å¹´${extractedWeekNum}å‘¨ï¼ˆ${formatMonthDay(prevMonday)}-${formatMonthDay(prevSunday)}ï¼‰`;
                                }
                            } catch (e) {
                                console.error('æ ¼å¼åŒ–å‘¨æ—¥æœŸå¤±è´¥:', e);
                            }
                        }
                        
                        if (hasValidMin && formatMinDate.includes('-')) {
                            try {
                                const date = new Date(formatMinDate);
                                if (!isNaN(date.getTime())) {
                                    // è·å–å¹´ä»½
                                    const year = date.getFullYear();
                                    
                                    // è®¡ç®—å‘¨æ•° - ä½¿ç”¨ISOå‘¨
                                    const getWeekNumber = (d) => {
                                        // ISOå‘¨ä»å‘¨ä¸€å¼€å§‹ï¼Œå‘¨æ—¥ä¸º7
                                        const date = new Date(d.getTime());
                                        date.setHours(0, 0, 0, 0);
                                        // è®¾ç½®ä¸ºå‘¨å››ï¼ˆISOå‘¨çš„å®šä¹‰æ˜¯å‘¨å››æ‰€åœ¨çš„å‘¨ï¼‰
                                        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                                        // ä¸€æœˆå››æ—¥è‚¯å®šåœ¨ç¬¬ä¸€å‘¨
                                        const firstWeek = new Date(date.getFullYear(), 0, 4);
                                        // è°ƒæ•´åˆ°å‘¨å››
                                        firstWeek.setDate(firstWeek.getDate() + 3 - (firstWeek.getDay() + 6) % 7);
                                        // è®¡ç®—å‘¨å·®
                                        const weekNumber = Math.round(((date.getTime() - firstWeek.getTime()) / 86400000 - 3 + (firstWeek.getDay() + 6) % 7) / 7) + 1;
                                        return weekNumber;
                                    };
                                    
                                    const weekNumber = getWeekNumber(date);
                                    
                                    // è®¡ç®—æ‰€åœ¨å‘¨çš„å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰å’Œç»“æŸæ—¥æœŸï¼ˆå‘¨æ—¥ï¼‰
                                    const getWeekDates = (d) => {
                                        const date = new Date(d.getTime());
                                        // è·å–å½“å‰æ˜¯å‘¨å‡ ï¼ˆ0æ˜¯å‘¨æ—¥ï¼Œ1æ˜¯å‘¨ä¸€ï¼Œ...ï¼Œ6æ˜¯å‘¨å…­ï¼‰
                                        const day = date.getDay();
                                        // è®¡ç®—åˆ°å‘¨ä¸€çš„æ—¥æœŸå·®
                                        const diff = day === 0 ? -6 : 1 - day; // å¦‚æœæ˜¯å‘¨æ—¥ï¼Œéœ€è¦å‡6å¤©ï¼Œå¦åˆ™å°±æ˜¯1-day
                                        
                                        // è®¾ç½®ä¸ºå½“å‘¨çš„å‘¨ä¸€
                                        const monday = new Date(date.getTime());
                                        monday.setDate(date.getDate() + diff);
                                        
                                        // è®¾ç½®ä¸ºå½“å‘¨çš„å‘¨æ—¥
                                        const sunday = new Date(monday.getTime());
                                        sunday.setDate(monday.getDate() + 6);
                                        
                                        return { monday, sunday };
                                    };
                                    
                                    const { monday, sunday } = getWeekDates(date);
                                    
                                    // æ ¼å¼åŒ–æ—¥æœŸä¸º"æœˆæ—¥"
                                    const formatMonthDay = (d) => {
                                        return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
                                    };
                                    
                                    // æ ¹æ®åç«¯æ ¼å¼è·å–æ­£ç¡®çš„å‘¨æ•°ï¼Œä¿æŒå‘¨æ•°ä¸å˜
                                    // å°è¯•ä»formatMinDateä¸­æå–å‘¨æ•°ä¿¡æ¯
                                    let extractedWeekNum = weekNumber;
                                    if (formatMinDate.includes('å¹´') && formatMinDate.includes('å‘¨')) {
                                        const weekMatch = formatMinDate.match(/(\d+)å¹´(?:ç¬¬)?(\d+)å‘¨/);
                                        if (weekMatch && weekMatch.length === 3) {
                                            extractedWeekNum = parseInt(weekMatch[2], 10);
                                        }
                                    }
                                    
                                    // è®¡ç®—ä¸Šä¸€å‘¨çš„æ—¥æœŸèŒƒå›´
                                    const prevMonday = new Date(monday.getTime());
                                    prevMonday.setDate(monday.getDate() - 6);
                                    
                                    const prevSunday = new Date(sunday.getTime());
                                    prevSunday.setDate(sunday.getDate() - 6);
                                    
                                    // ä½¿ç”¨æŒ‡å®šæ ¼å¼ï¼Œä¿æŒå‘¨æ•°ä¸å˜
                                    formatMinDate = `${year}å¹´${extractedWeekNum}å‘¨ï¼ˆ${formatMonthDay(prevMonday)}-${formatMonthDay(prevSunday)}ï¼‰`;
                                }
                            } catch (e) {
                                console.error('æ ¼å¼åŒ–å‘¨æ—¥æœŸå¤±è´¥:', e);
                            }
                        }
                    } else if (timeGranularity === 'month') {
                        // å¦‚æœæ˜¯æœˆåº¦ç²’åº¦ï¼Œæ ¼å¼åŒ–ä¸ºå¹´æœˆ
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            const dateParts = formatMaxDate.split('-');
                            if (dateParts.length >= 2) {
                                formatMaxDate = `${dateParts[0]}å¹´${dateParts[1]}æœˆ`;
                            }
                        }
                        if (hasValidMin && formatMinDate.includes('-')) {
                            const dateParts = formatMinDate.split('-');
                            if (dateParts.length >= 2) {
                                formatMinDate = `${dateParts[0]}å¹´${dateParts[1]}æœˆ`;
                            }
                        }
                    } else if (timeGranularity === 'quarter') {
                        // å¦‚æœæ˜¯å­£åº¦ç²’åº¦ï¼Œæ ¼å¼åŒ–ä¸ºå¹´å­£åº¦
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            const dateParts = formatMaxDate.split('-');
                            if (dateParts.length >= 2) {
                                const month = parseInt(dateParts[1]);
                                const quarter = Math.ceil(month / 3);
                                formatMaxDate = `${dateParts[0]}å¹´Q${quarter}`;
                            }
                        }
                        if (hasValidMin && formatMinDate.includes('-')) {
                            const dateParts = formatMinDate.split('-');
                            if (dateParts.length >= 2) {
                                const month = parseInt(dateParts[1]);
                                const quarter = Math.ceil(month / 3);
                                formatMinDate = `${dateParts[0]}å¹´Q${quarter}`;
                            }
                        }
                    } else if (timeGranularity === 'year') {
                        // å¦‚æœæ˜¯å¹´åº¦ç²’åº¦ï¼Œåªæ˜¾ç¤ºå¹´ä»½
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            formatMaxDate = formatMaxDate.split('-')[0] + 'å¹´';
                        }
                        if (hasValidMin && formatMinDate.includes('-')) {
                            formatMinDate = formatMinDate.split('-')[0] + 'å¹´';
                        }
                    }
                    
                    // æ ¼å¼åŒ–æœ€é«˜å€¼å’Œæœ€ä½å€¼çš„æ˜¾ç¤º
                    const maxValueDisplay = hasValidMax ? 
                        `${formatNumber(stats.max.value)} (${formatMaxDate})` : 
                        'æ— æ•°æ®';
                    
                    // æœ€ä½å€¼åº”æ˜¾ç¤ºå®é™…çš„æœ€ä½å€¼ï¼ŒåŒ…æ‹¬0ï¼Œä½†ä¸åŒ…æ‹¬å¡«å……çš„æˆ–ç¼ºå¤±çš„æ•°æ®
                    const minValueDisplay = hasValidMin ? 
                        `${formatNumber(stats.min.value)} (${formatMinDate})` : 
                        'æ— æ•°æ®';
                    
                    statsContent.innerHTML = `
                        <div class="stats-item">
                            <div class="stats-label">æ€»${valueColumn}</div>
                            <div class="stats-value">${formatNumber(stats.total)}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">å¹³å‡${valueColumn}</div>
                            <div class="stats-value">${formatNumber(stats.average)}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">æœ€é«˜${valueColumn}</div>
                            <div class="stats-value">${maxValueDisplay}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">æœ€ä½${valueColumn}</div>
                            <div class="stats-value">${minValueDisplay}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">æ€»ä½“å¢é•¿ç‡</div>
                            <div class="stats-value">${formatNumber(stats.growth_rate)}%</div>
                        </div>
                    `;
                } else if (analysisType === 'year_over_year') {
                    let statsHtml = '';
                    
                    // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´ç²’åº¦
                    const timeGranularity = document.getElementById('time-granularity').value;
                    
                    // æ ¹æ®æ—¶é—´ç²’åº¦è®¾ç½®æ ‡é¢˜æ–‡æœ¬
                    let timeUnitTitle = 'å¹´åº¦';
                    let timeUnitSuffix = 'å¹´';
                    
                    if (timeGranularity === 'day') {
                        timeUnitTitle = 'æ—¥æœŸ';
                        timeUnitSuffix = 'æ—¥';  // ä¿ç•™åç¼€ï¼Œä½†åé¢ä¼šç‰¹æ®Šå¤„ç†æ—¥æœŸæ˜¾ç¤º
                    } else if (timeGranularity === 'week') {
                        timeUnitTitle = 'å‘¨åº¦';
                        timeUnitSuffix = 'å‘¨';
                    } else if (timeGranularity === 'month') {
                        timeUnitTitle = 'æœˆåº¦';
                        timeUnitSuffix = 'æœˆ';
                    } else if (timeGranularity === 'quarter') {
                        timeUnitTitle = 'å­£åº¦';
                        timeUnitSuffix = 'å­£';
                    }
                    
                    // æ€»è®¡
                    if (stats.yearly_totals && Object.keys(stats.yearly_totals).length > 0) {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}æ€»è®¡</h4>`;
                        for (const [period, total] of Object.entries(stats.yearly_totals)) {
                            // ä¿®å¤æ—¥æœŸæ ¼å¼ï¼Œå¯¹äºæ—¥ç²’åº¦éœ€è¦ç‰¹æ®Šå¤„ç†
                            let periodLabel = timeGranularity === 'day' ? 
                                `${period}å¹´` : `${period}${timeUnitSuffix}`;
                            
                            statsHtml += `
                                <div class="stats-item">
                                    <div class="stats-label">${periodLabel}</div>
                                    <div class="stats-value">${formatNumber(total)}</div>
                                </div>
                            `;
                        }
                        statsHtml += '</div>';
                    } else {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}æ€»è®¡</h4><div class="no-data">æš‚æ— æ•°æ®</div></div>`;
                    }
                    
                    // åŒæ¯”å˜åŒ–
                    if (stats.yoy_changes && Object.keys(stats.yoy_changes).length > 0) {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}åŒæ¯”å˜åŒ–</h4>`;
                        for (const [period, change] of Object.entries(stats.yoy_changes)) {
                            // ä¿®å¤æ—¥æœŸæ ¼å¼ï¼Œå¯¹äºæ—¥ç²’åº¦éœ€è¦ç‰¹æ®Šå¤„ç†
                            let periodLabel = timeGranularity === 'day' ? 
                                `${period}å¹´` : `${period}${timeUnitSuffix}`;
                            
                            statsHtml += `
                                <div class="stats-item">
                                    <div class="stats-label">${periodLabel}</div>
                                    <div class="stats-value ${change >= 0 ? 'positive' : 'negative'}">${formatNumber(change)}%</div>
                                </div>
                            `;
                        }
                        statsHtml += '</div>';
                    } else {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}åŒæ¯”å˜åŒ–</h4><div class="no-data">æš‚æ— åŒæ¯”æ•°æ®æˆ–æ•°æ®ä¸è¶³ä»¥è®¡ç®—åŒæ¯”</div></div>`;
                    }
                    
                    statsContent.innerHTML = statsHtml;
                } else if (analysisType === 'month_over_month') {
                    // è·å–å‘¨æœŸç±»å‹ï¼Œç”¨äºæ˜¾ç¤º
                    const periodType = stats.period_type || 'æœˆ';
                    
                    // æ ¼å¼åŒ–ç¯æ¯”æ—¶é—´æ˜¾ç¤ºï¼Œç‰¹åˆ«å¤„ç†å‘¨æ ¼å¼
                    function formatMoMPeriod(periodText) {
                        if (!periodText) return '';
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨æ ¼å¼ï¼Œä½†ä¸åŒ…å«æ—¥æœŸèŒƒå›´
                        if (periodText.includes('å‘¨') && !periodText.includes('æœˆ')) {
                            // åªæœ‰ç®€å•çš„"2025å¹´ç¬¬5å‘¨"æ ¼å¼ï¼Œéœ€è¦ä¿®æ”¹
                            const match = periodText.match(/(\d{4})å¹´ç¬¬(\d+)å‘¨/);
                            if (match) {
                                // è¿”å›åŸå§‹æ ¼å¼ï¼Œåç«¯å·²ç»ä¿®æ”¹ä¸º"xxxxå¹´xå‘¨ï¼ˆxæœˆxæ—¥-xæœˆxæ—¥ï¼‰"çš„æ ¼å¼
                                return periodText;
                            }
                        }
                        
                        return periodText;
                    }
                    
                    statsContent.innerHTML = `
                        <div class="stats-item">
                            <div class="stats-label">å¢é•¿${periodType}æ•°</div>
                            <div class="stats-value">${stats.positive_changes}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">ä¸‹é™${periodType}æ•°</div>
                            <div class="stats-value">${stats.negative_changes}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">å¹³å‡ç¯æ¯”å˜åŒ–</div>
                            <div class="stats-value ${stats.average_change >= 0 ? 'positive' : 'negative'}">${formatNumber(stats.average_change)}%</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">æœ€å¤§å¢é•¿</div>
                            <div class="stats-value positive">${formatNumber(stats.max_increase.value)}% (${formatMoMPeriod(stats.max_increase.period)})</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">æœ€å¤§ä¸‹é™</div>
                            <div class="stats-value negative">${formatNumber(stats.max_decrease.value)}% (${formatMoMPeriod(stats.max_decrease.period)})</div>
                        </div>
                    `;
                }
            }
            
            // æ˜¾ç¤ºå¼‚å¸¸ç‚¹
            if (results.anomalies) {
                const anomaliesContent = document.getElementById('anomalies-content');
                
                if (results.anomalies.length === 0) {
                    anomaliesContent.innerHTML = `<div class="no-anomalies">æœªæ£€æµ‹åˆ°æ˜¾è‘—å¼‚å¸¸ç‚¹</div>`;
                } else {
                    let anomaliesHtml = '';
                    
                    results.anomalies.forEach(anomaly => {
                        let reasonsHtml = '';
                        anomaly.reasons.forEach(reason => {
                            reasonsHtml += `<div class="anomaly-reason">â€¢ ${reason}</div>`;
                        });
                        
                        anomaliesHtml += `
                            <div class="anomaly-item">
                                <div class="anomaly-header">
                                    <div class="anomaly-date">${anomaly.date}</div>
                                    <div class="anomaly-value">${formatNumber(anomaly.value)} (${anomaly.direction})</div>
                                </div>
                                <div class="anomaly-reasons">
                                    ${reasonsHtml}
                                </div>
                            </div>
                        `;
                    });
                    
                    anomaliesContent.innerHTML = anomaliesHtml;
                }
            }
            
            // æ˜¾ç¤ºåŒæ¯”åˆ†æå›¾è¡¨
            if (analysisType === 'year_over_year') {
                if (results.chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // è®¾ä¸ºfalseä»¥ä¿ç•™æ‚¬åœåŠŸèƒ½
                    };
                    
                    // è§£æå›¾è¡¨æ•°æ®
                    const chartData = JSON.parse(results.chart);
                    
                    // ä¿®æ”¹å›¾è¡¨å¸ƒå±€ï¼Œå¼ºåˆ¶ç¦ç”¨æ¨¡å¼æ 
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                    
                    // ç¡®ä¿æ‚¬åœæ¨¡æ¿è®¾ç½®
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('yoy-chart', chartData.data, layout, chartConfig);
                }
                
                if (results.yoy_chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // è®¾ä¸ºfalseä»¥ä¿ç•™æ‚¬åœåŠŸèƒ½
                    };
                    
                    // è§£æå›¾è¡¨æ•°æ®
                    const chartData = JSON.parse(results.yoy_chart);
                    
                    // ä¿®æ”¹å›¾è¡¨å¸ƒå±€ï¼Œå¼ºåˆ¶ç¦ç”¨æ¨¡å¼æ 
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                    
                    // ç¡®ä¿æ‚¬åœæ¨¡æ¿è®¾ç½®
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('yoy-growth-chart', chartData.data, layout, chartConfig);
                    
                    // æ·»åŠ å»¶è¿Ÿè§¦å‘window.resizeäº‹ä»¶ï¼Œç¡®ä¿å›¾è¡¨èƒ½å¤Ÿæ­£ç¡®è°ƒæ•´å¤§å°ä»¥å¡«æ»¡å®¹å™¨
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                }
                
                // æ˜¾ç¤ºåŒæ¯”åˆ†æç»Ÿè®¡æ•°æ®
                if (results.stats) {
                    const stats = results.stats;
                    
                    // ç”Ÿæˆå¹´åº¦æ€»é¢è¡¨æ ¼HTML
                    let yearlyTotalsHTML = '';
                    if (stats.yearly_totals) {
                        const years = Object.keys(stats.yearly_totals).sort();
                        yearlyTotalsHTML = '<div class="yearly-totals">';
                        
                        years.forEach(year => {
                            yearlyTotalsHTML += `
                                <div class="yearly-total-item">
                                    <div class="year-label">${year}å¹´æ€»å€¼</div>
                                    <div class="year-value">${formatNumber(stats.yearly_totals[year])}</div>
                                </div>
                            `;
                        });
                        
                        yearlyTotalsHTML += '</div>';
                    }
                    
                    // ç”ŸæˆåŒæ¯”å¢é•¿ç‡HTML
                    let yoyChangesHTML = '';
                    if (stats.yoy_changes) {
                        const years = Object.keys(stats.yoy_changes).sort();
                        yoyChangesHTML = '<div class="yoy-changes">';
                        
                        years.forEach(year => {
                            const changeValue = stats.yoy_changes[year];
                            const changeClass = changeValue > 0 ? 'positive-change' : (changeValue < 0 ? 'negative-change' : '');
                            
                            yoyChangesHTML += `
                                <div class="yoy-change-item">
                                    <div class="year-label">${year}å¹´åŒæ¯”å¢é•¿ç‡</div>
                                    <div class="year-value ${changeClass}">${formatNumber(changeValue)}%</div>
                                </div>
                            `;
                        });
                        
                        yoyChangesHTML += '</div>';
                    }
                    
                    // ç»„åˆæ‰€æœ‰ç»Ÿè®¡æ•°æ®
                    const statsHTML = `
                        <div class="yoy-stats-wrapper">
                            ${yearlyTotalsHTML}
                            ${yoyChangesHTML}
                        </div>
                    `;
                    
                    document.getElementById('yoy-stats').innerHTML = statsHTML;
                }
                
                // æ˜¾ç¤ºåŒæ¯”æ•°æ®è¡¨æ ¼
                if (results.pivot_data) {
                    // è·å–æ‰€æœ‰å¹´ä»½ï¼ˆæ’é™¤ä»¥_yoyç»“å°¾çš„é”®ï¼‰
                    const years = Object.keys(results.pivot_data)
                        .filter(key => !key.endsWith('_yoy'))
                        .sort();
                    
                    // è·å–æ‰€æœ‰æœˆä»½ï¼ˆä»ä»»æ„å¹´ä»½ä¸­æå–ï¼‰
                    const months = [];
                    if (years.length > 0) {
                        const firstYear = years[0];
                        months.push(...Object.keys(results.pivot_data[firstYear]));
                    }
                    
                    // åˆ›å»ºè¡¨æ ¼HTML
                    if (months.length > 0) {
                        let tableHTML = `
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>æœˆä»½</th>
                        `;
                        
                        // ä¸ºæ¯ä¸€å¹´æ·»åŠ åˆ—æ ‡é¢˜
                        years.forEach(year => {
                            tableHTML += `<th>${year}å¹´</th>`;
                        });
                        
                        // å¦‚æœæœ‰åŒæ¯”å¢é•¿ç‡æ•°æ®ï¼Œæ·»åŠ å¯¹åº”çš„åˆ—
                        const hasYoyData = years.length > 1 && Object.keys(results.pivot_data).some(key => key.endsWith('_yoy'));
                        if (hasYoyData) {
                            // æ’é™¤ç¬¬ä¸€å¹´ï¼Œå› ä¸ºæ²¡æœ‰åŒæ¯”å¢é•¿ç‡
                            years.slice(1).forEach(year => {
                                tableHTML += `<th>${year}å¹´åŒæ¯”</th>`;
                            });
                        }
                        
                        tableHTML += `
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        // ä¸ºæ¯ä¸ªæœˆæ·»åŠ æ•°æ®è¡Œ
                        months.forEach(month => {
                            tableHTML += `
                                <tr>
                                    <td>${month}</td>
                            `;
                            
                            // æ·»åŠ æ¯å¹´è¯¥æœˆçš„å€¼
                            years.forEach(year => {
                                const value = results.pivot_data[year][month];
                                tableHTML += `<td>${formatNumber(value)}</td>`;
                            });
                            
                            // æ·»åŠ åŒæ¯”å¢é•¿ç‡ï¼ˆå¦‚æœæœ‰ï¼‰
                            if (hasYoyData) {
                                years.slice(1).forEach(year => {
                                    const yoyKey = `${year}_yoy`;
                                    let yoyValue = '';
                                    let changeClass = '';
                                    
                                    if (results.pivot_data[yoyKey] && results.pivot_data[yoyKey][month] !== undefined) {
                                        const yoyVal = results.pivot_data[yoyKey][month];
                                        yoyValue = `${formatNumber(yoyVal)}%`;
                                        changeClass = yoyVal > 0 ? 'positive-change' : (yoyVal < 0 ? 'negative-change' : '');
                                    }
                                    
                                    tableHTML += `<td class="${changeClass}">${yoyValue}</td>`;
                                });
                            }
                            
                            tableHTML += `
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        document.getElementById('yoy-yearly-data').innerHTML = tableHTML;
                    } else {
                        document.getElementById('yoy-yearly-data').innerHTML = '<div class="no-data">æ²¡æœ‰åŒæ¯”æ•°æ®å¯æ˜¾ç¤º</div>';
                    }
                } else {
                    document.getElementById('yoy-yearly-data').innerHTML = '<div class="no-data">æ²¡æœ‰åŒæ¯”æ•°æ®å¯æ˜¾ç¤º</div>';
                }
            }
            
            // æ˜¾ç¤ºç¯æ¯”åˆ†æå›¾è¡¨
            if (analysisType === 'month_over_month') {
                if (results.chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // è®¾ä¸ºfalseä»¥ä¿ç•™æ‚¬åœåŠŸèƒ½
                    };
                    
                    // è§£æå›¾è¡¨æ•°æ®
                    const chartData = JSON.parse(results.chart);
                    
                    // ä¿®æ”¹å›¾è¡¨å¸ƒå±€ï¼Œå¼ºåˆ¶ç¦ç”¨æ¨¡å¼æ 
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                    
                    // ç¡®ä¿æ‚¬åœæ¨¡æ¿è®¾ç½®
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('mom-chart', chartData.data, layout, chartConfig);
                }
                
                if (results.mom_chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // è®¾ä¸ºfalseä»¥ä¿ç•™æ‚¬åœåŠŸèƒ½
                    };
                    
                    // è§£æå›¾è¡¨æ•°æ®
                    const chartData = JSON.parse(results.mom_chart);
                    
                    // ä¿®æ”¹å›¾è¡¨å¸ƒå±€ï¼Œå¼ºåˆ¶ç¦ç”¨æ¨¡å¼æ 
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                    
                    // ç¡®ä¿æ‚¬åœæ¨¡æ¿è®¾ç½®
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('mom-growth-chart', chartData.data, layout, chartConfig);
                    
                    // æ·»åŠ å»¶è¿Ÿè§¦å‘window.resizeäº‹ä»¶ï¼Œç¡®ä¿å›¾è¡¨èƒ½å¤Ÿæ­£ç¡®è°ƒæ•´å¤§å°ä»¥å¡«æ»¡å®¹å™¨
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                }
                
                // æ˜¾ç¤ºç¯æ¯”åˆ†æçš„æœˆåº¦æ•°æ®è¡¨æ ¼
                if (analysisType === 'month_over_month') {
                    // è·å–å‘¨æœŸç±»å‹ç”¨äºæ˜¾ç¤º
                    const periodType = results.stats && results.stats.period_type ? results.stats.period_type : 'æœˆ';
                    
                    if (results.period_data && results.period_data.length > 0) {
                        // æ›´æ–°æ ‡é¢˜
                        document.querySelector('.monthly-data-card .card-header h3').textContent = `${periodType}åº¦æ•°æ®æ˜ç»†`;
                        
                        let tableHTML = `
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>${periodType}ä»½</th>
                                            <th>${valueColumn}</th>
                                            <th>ä¸Š${periodType}${valueColumn}</th>
                                            <th>ç¯æ¯”å¢é•¿ç‡</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        results.period_data.forEach(item => {
                            const prevValue = item.prev_value !== null ? formatNumber(item.prev_value) : '-';
                            const momChange = item.mom_change !== null ? formatNumber(item.mom_change) + '%' : '-';
                            
                            // æ ¹æ®ç¯æ¯”å¢é•¿ç‡æ·»åŠ ä¸åŒçš„CSSç±»
                            let changeClass = '';
                            if (item.mom_change !== null) {
                                changeClass = item.mom_change > 0 ? 'positive-change' : (item.mom_change < 0 ? 'negative-change' : '');
                            }
                            
                            tableHTML += `
                                <tr>
                                    <td>${item.period}</td>
                                    <td>${formatNumber(item.value)}</td>
                                    <td>${prevValue}</td>
                                    <td class="${changeClass}">${momChange}</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        document.getElementById('mom-monthly-data').innerHTML = tableHTML;
                    } else {
                        document.getElementById('mom-monthly-data').innerHTML = `<div class="no-data">æ²¡æœ‰å¯ç”¨çš„${periodType}åº¦æ•°æ®</div>`;
                    }
                }
            }
            
            // æ˜¾ç¤ºæ—¶é—´åºåˆ—åˆ†è§£
            if (results.decomposition) {
                const chartConfig = {
                    displayModeBar: false,
                    responsive: true,
                    scrollZoom: false,
                    staticPlot: false // è®¾ä¸ºfalseä»¥ä¿ç•™æ‚¬åœåŠŸèƒ½
                };
                
                // è¶‹åŠ¿åˆ†é‡
                const trendData = JSON.parse(results.decomposition.trend_chart);
                const trendLayout = trendData.layout || {};
                trendLayout.modebar = {
                    remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                             "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                    display: false,
                    visible: false
                };
                trendLayout.dragmode = false;
                trendLayout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                
                // å­£èŠ‚æ€§åˆ†é‡
                const seasonalData = JSON.parse(results.decomposition.seasonal_chart);
                const seasonalLayout = seasonalData.layout || {};
                seasonalLayout.modebar = {
                    remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                             "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                    display: false,
                    visible: false
                };
                seasonalLayout.dragmode = false;
                seasonalLayout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                
                // æ®‹å·®åˆ†é‡
                const residualData = JSON.parse(results.decomposition.residual_chart);
                const residualLayout = residualData.layout || {};
                residualLayout.modebar = {
                    remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                             "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                    display: false,
                    visible: false
                };
                residualLayout.dragmode = false;
                residualLayout.hovermode = 'closest'; // ç¡®ä¿æ‚¬åœåŠŸèƒ½
                
                // è®¾ç½®æ‚¬åœæ¨¡æ¿
                if (trendData.data) {
                    trendData.data.forEach(trace => {
                        if (!trace.hovertemplate) {
                            trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                        }
                    });
                }
                
                if (seasonalData.data) {
                    seasonalData.data.forEach(trace => {
                        if (!trace.hovertemplate) {
                            trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                        }
                    });
                }
                
                if (residualData.data) {
                    residualData.data.forEach(trace => {
                        if (!trace.hovertemplate) {
                            trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                        }
                    });
                }
                
                Plotly.newPlot('trend-component', trendData.data, trendLayout, chartConfig);
                Plotly.newPlot('seasonal-component', seasonalData.data, seasonalLayout, chartConfig);
                Plotly.newPlot('residual-component', residualData.data, residualLayout, chartConfig);
                
                // æ·»åŠ å»¶è¿Ÿè§¦å‘window.resizeäº‹ä»¶ï¼Œç¡®ä¿æ‰€æœ‰å›¾è¡¨èƒ½å¤Ÿæ­£ç¡®è°ƒæ•´å¤§å°ä»¥å¡«æ»¡å®¹å™¨
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            }
            
            // æ˜¾ç¤ºç»“æœå®¹å™¨
            resultsContainer.style.display = 'block';
            resultsContainer.classList.add('force-display');
            
            // æ ‡è®°åˆ†æå·²å®Œæˆ
            window.isAnalyzing = false;
            
            // æ·»åŠ å…¨å±€å»¶è¿Ÿè§¦å‘resizeäº‹ä»¶ï¼Œç¡®ä¿æ‰€æœ‰å›¾è¡¨åœ¨DOMå®Œå…¨æ¸²æŸ“åæ­£ç¡®è°ƒæ•´å¤§å°
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 300);
            
            // ä½¿ç”¨setTimeoutç¡®ä¿DOMå®Œå…¨æ›´æ–°åå†æ»šåŠ¨åˆ°ç»“æœ
            setTimeout(() => {
                // å†æ¬¡ç¡®ä¿ç»“æœå®¹å™¨å¯è§
                resultsContainer.style.display = 'block';
                resultsContainer.classList.add('force-display');
                
                // æ»šåŠ¨åˆ°ç»“æœ
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                
                // è®°å½•åˆ°æ§åˆ¶å°ï¼Œå¸®åŠ©è°ƒè¯•
                console.log('ç»“æœæ˜¾ç¤ºå®Œæˆï¼Œç»“æœå®¹å™¨æ˜¾ç¤ºçŠ¶æ€:', resultsContainer.style.display);
                
                // æ¸…é™¤å·²æœ‰çš„ä¿æŠ¤é—´éš”
                if (window.resultsProtectionInterval) {
                    clearInterval(window.resultsProtectionInterval);
                }
                
                // æ·»åŠ å…¨å±€ä¿æŠ¤æªæ–½ï¼Œé˜²æ­¢ç»“æœè¢«éšè—
                window.resultsProtectionInterval = setInterval(() => {
                    if (!window.isAnalyzing && 
                        (resultsContainer.style.display !== 'block' || 
                         getComputedStyle(resultsContainer).display === 'none')) {
                        console.log('æ£€æµ‹åˆ°ç»“æœè¢«éšè—ï¼Œæ­£åœ¨æ¢å¤æ˜¾ç¤º');
                        resultsContainer.style.display = 'block';
                        resultsContainer.classList.add('force-display');
                    }
                }, 200); // æ›´é¢‘ç¹åœ°æ£€æŸ¥
                
                // ä½¿ç”¨æ›´å¼ºå¤§çš„MutationObserverç›‘æ§ç»“æœå®¹å™¨çš„å˜åŒ–
                if (window.resultsObserver) {
                    window.resultsObserver.disconnect();
                }
                
                window.resultsObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                            const currentDisplay = getComputedStyle(resultsContainer).display;
                            if (!window.isAnalyzing && currentDisplay === 'none') {
                                console.log('MutationObserveræ£€æµ‹åˆ°ç»“æœè¢«éšè—ï¼Œç«‹å³æ¢å¤æ˜¾ç¤º');
                                resultsContainer.style.display = 'block';
                                resultsContainer.classList.add('force-display');
                            }
                        }
                    });
                });
                
                // å¼€å§‹è§‚å¯Ÿ
                window.resultsObserver.observe(resultsContainer, { 
                    attributes: true, 
                    attributeFilter: ['style', 'class'] 
                });
                
                console.log('å·²å¯åŠ¨MutationObserverç›‘æ§');
                
                // æ·»åŠ é¢å¤–çš„ä¿æŠ¤ - ç›‘æ§bodyçš„å˜åŒ–
                if (window.bodyObserver) {
                    window.bodyObserver.disconnect();
                }
                
                window.bodyObserver = new MutationObserver(() => {
                    if (!window.isAnalyzing && 
                        (resultsContainer.style.display !== 'block' || 
                         getComputedStyle(resultsContainer).display === 'none')) {
                        console.log('Bodyå˜åŒ–æ£€æµ‹åˆ°ç»“æœè¢«éšè—ï¼Œæ¢å¤æ˜¾ç¤º');
                        resultsContainer.style.display = 'block';
                        resultsContainer.classList.add('force-display');
                    }
                });
                
                // ç›‘æ§bodyçš„æ‰€æœ‰å­å…ƒç´ å˜åŒ–
                window.bodyObserver.observe(document.body, { 
                    childList: true, 
                    subtree: true 
                });
            }, 500);
        }

        // å¯¼å‡ºåˆ†æç»“æœ
        exportResultsBtn.addEventListener('click', () => {
            if (!analysisResults) {
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹æ¨¡æ€çª—å£
            const modal = document.getElementById('export-modal');
            if (!modal) return;
            modal.classList.add('active');
            
            // æ ¹æ®å½“å‰åˆ†æç±»å‹æ˜¾ç¤º/éšè—ç›¸å…³é€‰é¡¹
            const analysisType = analysisTypeSelect.value;
            
            console.log('å½“å‰åˆ†æç±»å‹:', analysisType);
            
            // è®°å½•æ‰€æœ‰å¯è§å›¾è¡¨
            const visibleCharts = {};
            
            // é»˜è®¤éšè—æ‰€æœ‰å¯¼å‡ºé€‰é¡¹ï¼Œç„¶åæ ¹æ®åˆ†æç±»å‹æ˜¾ç¤ºå¯¹åº”é€‰é¡¹
            const chartOptions = [
                'export-trend-chart-container',
                'export-yoy-chart-container',
                'export-yoy-monthly-chart-container',
                'export-mom-chart-container',
                'export-decomposition-chart-container'
            ];
            
            chartOptions.forEach(optionId => {
                const optionElement = document.getElementById(optionId);
                if (optionElement) {
                    optionElement.style.display = 'none';
                }
            });
            
            // æ ¹æ®åˆ†æç±»å‹æ˜¾ç¤ºç›¸åº”å›¾è¡¨é€‰é¡¹
            if (analysisType === 'trend' || analysisType === '') {
                // é”€å”®è¶‹åŠ¿åˆ†ææ¨¡å¼
                showExportOption('export-trend-chart-container');
                showExportOption('export-decomposition-chart-container');
            } else if (analysisType === 'year_over_year') {
                // åŒæ¯”åˆ†ææ¨¡å¼
                showExportOption('export-trend-chart-container'); // åŒæ¯”åˆ†æä¹Ÿéœ€è¦æ˜¾ç¤ºé”€å”®è¶‹åŠ¿å›¾
                showExportOption('export-yoy-chart-container');
                showExportOption('export-yoy-monthly-chart-container');
                showExportOption('export-decomposition-chart-container');
            } else if (analysisType === 'month_over_month') {
                // ç¯æ¯”åˆ†ææ¨¡å¼
                showExportOption('export-trend-chart-container'); // ç¯æ¯”åˆ†æéœ€è¦æ˜¾ç¤ºé”€å”®è¶‹åŠ¿å›¾
                showExportOption('export-mom-chart-container');
                // ç¯æ¯”åˆ†æä¸åŒ…å«æ—¶é—´åºåˆ—åˆ†è§£å›¾
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
            function showExportOption(optionId) {
                const optionElement = document.getElementById(optionId);
                if (optionElement) {
                    optionElement.style.display = 'block';
                    console.log(`æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹: ${optionId}`);
                }
            }
            
            // æ£€æŸ¥å„å›¾è¡¨çš„å¯è§æ€§å¹¶è®°å½•
            const chartElements = [
                {id: 'trend-chart-container', option: 'export-trend-chart-container', name: 'é”€å”®è¶‹åŠ¿å›¾'},
                {id: 'yoy-chart-container', option: 'export-yoy-chart-container', name: 'åŒæ¯”åˆ†æå›¾'},
                {id: 'yoy-monthly-chart-container', option: 'export-yoy-monthly-chart-container', name: 'æœˆåº¦åŒæ¯”å›¾'},
                {id: 'mom-chart-container', option: 'export-mom-chart-container', name: 'ç¯æ¯”åˆ†æå›¾'},
                {id: 'decomposition-section', option: 'export-decomposition-chart-container', name: 'æ—¶é—´åºåˆ—åˆ†è§£å›¾'}
            ];
            
            console.log('æ£€æŸ¥å¯è§å›¾è¡¨:');
            chartElements.forEach(chart => {
                const chartElement = document.getElementById(chart.id);
                
                // ä½¿ç”¨å¤šç§æ–¹æ³•æ£€æŸ¥å¯è§æ€§
                let isVisible = false;
                
                if (chartElement) {
                    const style = window.getComputedStyle(chartElement);
                    const displayVisible = style.display !== 'none';
                    const visibilityVisible = style.visibility !== 'hidden';
                    const opacityVisible = parseFloat(style.opacity) > 0;
                    const hasDimensions = chartElement.offsetWidth > 0 && chartElement.offsetHeight > 0;
                    
                    isVisible = displayVisible && visibilityVisible && opacityVisible && hasDimensions;
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šæ ¹æ®åˆ†æç±»å‹å¼ºåˆ¶è®¾ç½®å¯¹åº”å›¾è¡¨å¯è§
                    if ((chart.id === 'trend-chart-container' && analysisType === 'trend') ||
                        (chart.id === 'yoy-chart-container' && analysisType === 'year_over_year') ||
                        (chart.id === 'yoy-monthly-chart-container' && analysisType === 'year_over_year') ||
                        (chart.id === 'mom-chart-container' && analysisType === 'month_over_month')) {
                        isVisible = true;
                    }
                    
                    console.log(`${chart.name}(${chart.id}): ${isVisible ? 'å¯è§' : 'ä¸å¯è§'} - display:${displayVisible}, visibility:${visibilityVisible}, opacity:${opacityVisible}, dimensions:${hasDimensions}`);
                }
                
                visibleCharts[chart.id] = isVisible;
            });
            
            // æ•°æ®å¯¼å‡ºé€‰é¡¹
            const yoyContainer = document.getElementById('export-yoy-container');
            if (yoyContainer) {
                yoyContainer.style.display = analysisType === 'year_over_year' ? 'block' : 'none';
            }
            
            const momContainer = document.getElementById('export-mom-container');
            if (momContainer) {
                momContainer.style.display = analysisType === 'month_over_month' ? 'block' : 'none';
            }
            
            const decompositionContainer = document.getElementById('export-decomposition-container');
            if (decompositionContainer) {
                const decompositionSection = document.getElementById('decomposition-section');
                const decompositionVisible = decompositionSection && window.getComputedStyle(decompositionSection).display !== 'none';
                decompositionContainer.style.display = decompositionVisible ? 'block' : 'none';
            }
        });
        
        // å–æ¶ˆå¯¼å‡º
        document.getElementById('cancel-export').addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            document.getElementById('export-modal').classList.remove('active');
        });
        
        // å…³é—­æ¨¡æ€çª—å£
        document.querySelector('.close-modal').addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            document.getElementById('export-modal').classList.remove('active');
        });
        
        // ç¡®è®¤å¯¼å‡º
        document.getElementById('confirm-export').addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            const exportStats = document.getElementById('export-stats').checked;
            const exportAnomalies = document.getElementById('export-anomalies').checked;
            const exportYoY = document.getElementById('export-yoy').checked;
            const exportMoM = document.getElementById('export-mom').checked;
            const exportDecomposition = document.getElementById('export-decomposition').checked;
            
            // å›¾è¡¨å¯¼å‡ºé€‰é¡¹ - åªæœ‰åœ¨é€‰é¡¹å¯è§ä¸”è¢«å‹¾é€‰æ—¶æ‰å¯¼å‡º
            const trendChartOption = document.getElementById('export-trend-chart-container');
            const exportTrendChart = document.getElementById('export-trend-chart') && 
                                     document.getElementById('export-trend-chart').checked &&
                                     (!trendChartOption || trendChartOption.style.display !== 'none');
            
            const yoyChartOption = document.getElementById('export-yoy-chart-container');
            const exportYoYChart = document.getElementById('export-yoy-chart') && 
                                   document.getElementById('export-yoy-chart').checked &&
                                   (!yoyChartOption || yoyChartOption.style.display !== 'none');
            
            const yoyMonthlyChartOption = document.getElementById('export-yoy-monthly-chart-container');
            const exportYoYMonthlyChart = document.getElementById('export-yoy-monthly-chart') && 
                                         document.getElementById('export-yoy-monthly-chart').checked &&
                                         (!yoyMonthlyChartOption || yoyMonthlyChartOption.style.display !== 'none');
            
            const momChartOption = document.getElementById('export-mom-chart-container');
            const exportMoMChart = document.getElementById('export-mom-chart') && 
                                  document.getElementById('export-mom-chart').checked &&
                                  (!momChartOption || momChartOption.style.display !== 'none');
            
            const decompositionChartOption = document.getElementById('export-decomposition-chart-container');
            const exportDecompositionChart = document.getElementById('export-decomposition-chart') && 
                                            document.getElementById('export-decomposition-chart').checked &&
                                            (!decompositionChartOption || decompositionChartOption.style.display !== 'none');
            
            console.log('å¯¼å‡ºé€‰é¡¹çŠ¶æ€:', {
                æ•°æ®: {exportStats, exportAnomalies, exportYoY, exportMoM, exportDecomposition},
                å›¾è¡¨: {exportTrendChart, exportYoYChart, exportYoYMonthlyChart, exportMoMChart, exportDecompositionChart}
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å‹¾é€‰ä»»ä½•é€‰é¡¹
            const hasDataExport = exportStats || exportAnomalies || exportYoY || exportMoM || exportDecomposition;
            const hasChartExport = exportTrendChart || exportYoYChart || exportYoYMonthlyChart || exportMoMChart || exportDecompositionChart;
            
            if (!hasDataExport && !hasChartExport) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹è¦å¯¼å‡ºçš„å†…å®¹');
                return;
            }
            
            // åˆ›å»ºåŠ è½½æç¤º
            const loadingToast = document.createElement('div');
            loadingToast.className = 'toast';
            loadingToast.innerHTML = '<span class="spinner"></span> æ­£åœ¨å‡†å¤‡å¯¼å‡º...';
            document.body.appendChild(loadingToast);
            setTimeout(() => { loadingToast.classList.add('show'); }, 10);
            
            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('export-modal').classList.remove('active');
            
            // ç¨å¾®å»¶è¿Ÿå¯¼å‡ºæ“ä½œä»¥ç¡®ä¿UIæ›´æ–°
            setTimeout(async () => {
                try {
                    // æ•°æ®å¯¼å‡ºéƒ¨åˆ†
                    if (hasDataExport) {
                        exportDataToCSV();
                    }
                    
                    // å›¾è¡¨å¯¼å‡ºéƒ¨åˆ†
                    if (hasChartExport) {
                        await exportCharts();
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    loadingToast.innerHTML = 'å¯¼å‡ºå®Œæˆï¼';
                    loadingToast.classList.add('success');
                    setTimeout(() => {
                        loadingToast.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(loadingToast);
                        }, 300);
                    }, 2000);
                } catch (error) {
                    console.error('å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    loadingToast.innerHTML = 'å¯¼å‡ºå¤±è´¥: ' + error.message;
                    loadingToast.classList.add('error');
                    setTimeout(() => {
                        loadingToast.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(loadingToast);
                        }, 300);
                    }, 3000);
                }
            }, 300);
            
            // å¯¼å‡ºæ•°æ®åˆ°CSV
            function exportDataToCSV() {
                // å°†åˆ†æç»“æœè½¬æ¢ä¸ºCSVå­—ç¬¦ä¸²
                let csvContent = 'data:text/csv;charset=utf-8,';
                let hasContent = false;
                
                // æ·»åŠ æ ‡é¢˜è¡Œ
                csvContent += 'åˆ†æç±»å‹,' + analysisTypeSelect.options[analysisTypeSelect.selectedIndex].text + '\r\n';
                csvContent += 'åˆ†ææ—¥æœŸ,' + new Date().toLocaleString() + '\r\n\r\n';
                
                // æ·»åŠ ç»Ÿè®¡æ•°æ®
                if (exportStats && analysisResults.stats) {
                    hasContent = true;
                    csvContent += 'ç»Ÿè®¡æ•°æ®:\r\n';
                    
                    const analysisType = analysisTypeSelect.value;
                    const stats = analysisResults.stats;
                    
                    if (analysisType === 'trend') {
                        csvContent += 'æ€»è®¡,' + stats.total + '\r\n';
                        csvContent += 'å¹³å‡å€¼,' + stats.average + '\r\n';
                        csvContent += 'æœ€é«˜å€¼,' + stats.max.value + ',' + stats.max.date + '\r\n';
                        csvContent += 'æœ€ä½å€¼,' + stats.min.value + ',' + stats.min.date + '\r\n';
                        csvContent += 'æ€»ä½“å¢é•¿ç‡,' + stats.growth_rate + '%\r\n';
                    } else if (analysisType === 'year_over_year' && exportYoY) {
                        csvContent += 'å¹´åº¦æ€»è®¡:\r\n';
                        for (const [year, total] of Object.entries(stats.yearly_totals)) {
                            csvContent += year + 'å¹´,' + total + '\r\n';
                        }
                        
                        csvContent += '\r\nå¹´åº¦åŒæ¯”å˜åŒ–:\r\n';
                        for (const [year, change] of Object.entries(stats.yoy_changes)) {
                            csvContent += year + 'å¹´,' + change + '%\r\n';
                        }
                    } else if (analysisType === 'month_over_month' && exportMoM) {
                        csvContent += 'å¢é•¿æœˆä»½æ•°,' + stats.positive_months + '\r\n';
                        csvContent += 'ä¸‹é™æœˆä»½æ•°,' + stats.negative_months + '\r\n';
                        csvContent += 'å¹³å‡ç¯æ¯”å˜åŒ–,' + stats.average_change + '%\r\n';
                        csvContent += 'æœ€å¤§å¢é•¿,' + stats.max_increase.value + '%,' + stats.max_increase.month + '\r\n';
                        csvContent += 'æœ€å¤§ä¸‹é™,' + stats.max_decrease.value + '%,' + stats.max_decrease.month + '\r\n';
                    }
                    
                    csvContent += '\r\n';
                }
                
                // æ·»åŠ å¼‚å¸¸ç‚¹
                if (exportAnomalies && analysisResults.anomalies && analysisResults.anomalies.length > 0) {
                    hasContent = true;
                    csvContent += 'å¼‚å¸¸ç‚¹:\r\n';
                    csvContent += 'æ—¥æœŸ,å€¼,Zåˆ†æ•°,æ–¹å‘,å¯èƒ½åŸå› \r\n';
                    
                    analysisResults.anomalies.forEach(anomaly => {
                        csvContent += anomaly.date + ',' + 
                                    anomaly.value + ',' + 
                                    anomaly.z_score + ',' + 
                                    anomaly.direction + ',"' + 
                                    anomaly.reasons.join('; ') + '"\r\n';
                    });
                    
                    csvContent += '\r\n';
                }
                
                // æ·»åŠ è¯¦ç»†æ•°æ®
                if (exportMoM && analysisTypeSelect.value === 'month_over_month' && analysisResults.monthly_data) {
                    hasContent = true;
                    csvContent += 'æœˆåº¦æ•°æ®:\r\n';
                    csvContent += 'å¹´æœˆ,å€¼,ç¯æ¯”å˜åŒ–(%)\r\n';
                    
                    analysisResults.monthly_data.forEach(item => {
                        csvContent += item.year_month + ',' + 
                                    item[valueColumnSelect.value] + ',' + 
                                    (item.mom_change ? item.mom_change : '') + '\r\n';
                    });
                }
                
                // åªæœ‰åœ¨æœ‰å†…å®¹æ—¶æ‰åˆ›å»ºä¸‹è½½
                if (hasContent) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', 'é”€å”®è¶‹åŠ¿åˆ†æ_æ•°æ®_' + new Date().toISOString().slice(0, 10) + '.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // å›¾è¡¨å¯¼å‡ºå‡½æ•°
            async function exportCharts() {
                // è°ƒè¯•ç”¨ï¼šåˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å›¾è¡¨å®¹å™¨
                console.log('æ‰€æœ‰å¯èƒ½çš„å›¾è¡¨å®¹å™¨:');
                const possibleChartIds = [
                    'trend-chart-card', 'trend-chart-container', 'trend-chart', 
                    'yoy-section', 'yoy-chart-container', 'yoy-chart', 
                    'yoy-monthly-chart-container', 'yoy-monthly-chart', 
                    'mom-section', 'mom-chart-container', 'mom-chart',
                    'decomposition-section', 'decomposition-charts',
                    // æ·»åŠ æ›´å¤šå¯èƒ½çš„å›¾è¡¨ID
                    'analysis-type-trend', 'analysis-type-mom'
                ];
                
                possibleChartIds.forEach(id => {
                    const el = document.getElementById(id);
                    console.log(`${id}: ${el ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    if (el) {
                        console.log(`   - display: ${window.getComputedStyle(el).display}`);
                        console.log(`   - visibility: ${window.getComputedStyle(el).visibility}`);
                        console.log(`   - opacity: ${window.getComputedStyle(el).opacity}`);
                    }
                });
                
                const chartContainers = [];
                
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§çš„è¾…åŠ©å‡½æ•°
                function isElementVisible(element) {
                    if (!element) return false;
                    const style = window.getComputedStyle(element);
                    return style.display !== 'none' && 
                           style.visibility !== 'hidden' && 
                           style.opacity !== '0' &&
                           element.offsetWidth > 0 &&
                           element.offsetHeight > 0;
                }
                
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                chartContainers.length = 0;
                
                // è·å–å½“å‰åˆ†æç±»å‹
                const currentAnalysisType = analysisTypeSelect.value;
                console.log(`å½“å‰åˆ†æç±»å‹: ${currentAnalysisType}`);
                
                // å®šä¹‰è¦å¯¼å‡ºçš„å›¾è¡¨æ˜ å°„å…³ç³»
                const chartMappings = [];
                
                // æ ¹æ®åˆ†æç±»å‹æ·»åŠ ä¸åŒçš„å›¾è¡¨æ˜ å°„
                if (currentAnalysisType === 'trend' || currentAnalysisType === '') {
                    // é”€å”®è¶‹åŠ¿åˆ†ææ¨¡å¼çš„å›¾è¡¨
                    if (exportTrendChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'trend-chart-card',
                            containerId: 'trend-chart-container',
                            chartId: 'trend-chart',
                            name: 'é”€å”®è¶‹åŠ¿å›¾'
                        });
                    }
                    
                    if (exportDecompositionChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'decomposition-section',
                            containerId: 'decomposition-section',
                            chartId: 'decomposition-charts',
                            name: 'æ—¶é—´åºåˆ—åˆ†è§£å›¾'
                        });
                    }
                } else if (currentAnalysisType === 'year_over_year') {
                    // åŒæ¯”åˆ†ææ¨¡å¼çš„å›¾è¡¨
                    if (exportTrendChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'trend-chart-card',
                            containerId: 'trend-chart-container',
                            chartId: 'trend-chart',
                            name: 'é”€å”®è¶‹åŠ¿å›¾'
                        });
                    }
                    
                    if (exportYoYChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'yoy-chart-card',
                            containerId: 'yoy-chart-container',
                            chartId: 'yoy-chart',
                            name: 'åŒæ¯”åˆ†æå›¾'
                        });
                    }
                    
                    if (exportYoYMonthlyChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'yoy-monthly-chart-card',
                            containerId: 'yoy-monthly-chart-container',
                            chartId: 'yoy-monthly-chart',
                            name: 'æœˆåº¦åŒæ¯”å˜åŒ–å›¾'
                        });
                    }
                    
                    if (exportDecompositionChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'decomposition-section',
                            containerId: 'decomposition-section',
                            chartId: 'decomposition-charts',
                            name: 'æ—¶é—´åºåˆ—åˆ†è§£å›¾'
                        });
                    }
                } else if (currentAnalysisType === 'month_over_month') {
                    // ç¯æ¯”åˆ†ææ¨¡å¼çš„å›¾è¡¨
                    
                    // è·å–ç¯æ¯”åˆ†æéƒ¨åˆ†çš„æ‰€æœ‰å›¾è¡¨å®¹å™¨
                    const momSection = document.getElementById('mom-section');
                    if (momSection) {
                        console.log('æ‰¾åˆ°ç¯æ¯”åˆ†æéƒ¨åˆ†ï¼Œæ£€æŸ¥å­å…ƒç´ :');
                        Array.from(momSection.children).forEach((child, index) => {
                            console.log(`å­å…ƒç´  ${index}:`, child.tagName, child.id, child.className);
                            
                            // æ·±åº¦æ£€æŸ¥æ¯ä¸ªå­å…ƒç´ å†…éƒ¨ç»“æ„
                            console.log(`å­å…ƒç´  ${index} å†…éƒ¨ç»“æ„:`);
                            Array.from(child.children || []).forEach((grandchild, idx) => {
                                console.log(`  - å­™å…ƒç´  ${idx}:`, grandchild.tagName, grandchild.id, grandchild.className);
                            });
                        });
                        
                        // æŸ¥æ‰¾ç¯æ¯”åˆ†æéƒ¨åˆ†ä¸­çš„æ‰€æœ‰å›¾è¡¨
                        const charts = momSection.querySelectorAll('.chart-container, [id*="chart"], [class*="chart"]');
                        console.log(`åœ¨ç¯æ¯”åˆ†æéƒ¨åˆ†æ‰¾åˆ° ${charts.length} ä¸ªå¯èƒ½çš„å›¾è¡¨`);
                        charts.forEach((chart, index) => {
                            console.log(`å›¾è¡¨ ${index}:`, chart.tagName, chart.id, chart.className);
                            // æŸ¥çœ‹æ¯ä¸ªå›¾è¡¨çš„å†…éƒ¨ç»“æ„
                            const title = chart.querySelector('h4, h3, .chart-title');
                            console.log(`  - æ ‡é¢˜: ${title ? title.textContent : 'æ— æ ‡é¢˜'}`);
                            const svgs = chart.querySelectorAll('svg');
                            console.log(`  - SVGæ•°é‡: ${svgs.length}`);
                            
                            // æ£€æŸ¥å›¾è¡¨å†…çš„æ‰€æœ‰å­å›¾è¡¨åŒºåŸŸ
                            const chartAreas = chart.querySelectorAll('.chart-area, [id*="chart"], svg');
                            console.log(`  - å›¾è¡¨åŒºåŸŸæ•°é‡: ${chartAreas.length}`);
                            chartAreas.forEach((area, areaIndex) => {
                                console.log(`    - åŒºåŸŸ ${areaIndex}:`, area.tagName, area.id, area.className);
                                // å°è¯•è·å–åŒºåŸŸæ ‡é¢˜
                                const areaTitle = area.closest('div').querySelector('h3, h4, .chart-title');
                                console.log(`      - åŒºåŸŸæ ‡é¢˜: ${areaTitle ? areaTitle.textContent : 'æ— æ ‡é¢˜'}`);
                            });
                        });
                    }
                    
                    // ç¯æ¯”åˆ†ææ¨¡å¼ä¸‹çš„é”€å”®è¶‹åŠ¿å›¾
                    if (exportTrendChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'mom-trend-chart-card',
                            containerId: 'trend-chart-container',
                            chartId: 'trend-chart',
                            name: 'é”€å”®è¶‹åŠ¿å›¾',
                            // é’ˆå¯¹åµŒå¥—ç»“æ„æ·»åŠ é€‰æ‹©å™¨
                            selector: function(container) {
                                if (!container) return null;
                                
                                // å¦‚æœå®¹å™¨åŒ…å«å¤šä¸ªå›¾è¡¨ï¼Œå°è¯•æ‰¾å‡ºç¬¬ä¸€ä¸ªï¼ˆä¸Šé¢ï¼‰çš„å›¾è¡¨
                                const charts = container.querySelectorAll('svg, canvas, .highcharts-container');
                                if (charts.length > 1) {
                                    return charts[0]; // è¿”å›ç¬¬ä¸€ä¸ªå›¾è¡¨å…ƒç´ 
                                }
                                
                                // å°è¯•é€šè¿‡æ ‡é¢˜æŸ¥æ‰¾é”€å”®è¶‹åŠ¿ç›¸å…³çš„å›¾è¡¨åŒºåŸŸ
                                const titles = container.querySelectorAll('h3, h4, .chart-title');
                                for (const title of titles) {
                                    if (title.textContent.includes('é”€å”®è¶‹åŠ¿') || title.textContent.includes('é”€å”®é‡‘é¢')) {
                                        // è¿”å›è¿™ä¸ªæ ‡é¢˜é™„è¿‘çš„å›¾è¡¨å…ƒç´ 
                                        const nearestChart = title.nextElementSibling?.querySelector('svg, canvas, .highcharts-container') ||
                                                           title.parentElement?.querySelector('svg, canvas, .highcharts-container');
                                        if (nearestChart) return nearestChart;
                                    }
                                }
                                
                                // å¦‚æœæ‰¾ä¸åˆ°æ˜ç¡®çš„å›¾è¡¨ï¼Œå°è¯•æ‰¾å‡ºç¬¬ä¸€ä¸ªå›¾è¡¨åŒºåŸŸ
                                const firstChartArea = container.querySelector('.chart-area:first-child, [id*="chart"]:first-child, svg:first-of-type');
                                return firstChartArea;
                            },
                            fallbackSelectors: [
                                '#mom-section .chart-container:first-child',
                                '#mom-section svg:first-of-type',
                                '#mom-section > div:first-child svg',
                                '#mom-section [id*="trend"] svg',
                                '#mom-section [id*="sales"] svg'
                            ]
                        });
                    }
                    
                    // ç¯æ¯”å¢é•¿ç‡å›¾
                    if (exportMoMChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'mom-chart-card',
                            containerId: 'mom-chart-container',
                            chartId: 'mom-chart',
                            name: 'ç¯æ¯”å¢é•¿ç‡å›¾',
                            // é’ˆå¯¹åµŒå¥—ç»“æ„æ·»åŠ é€‰æ‹©å™¨
                            selector: function(container) {
                                if (!container) return null;
                                
                                // å¦‚æœå®¹å™¨åŒ…å«å¤šä¸ªå›¾è¡¨ï¼Œå°è¯•æ‰¾å‡ºç¬¬äºŒä¸ªï¼ˆä¸‹é¢ï¼‰çš„å›¾è¡¨
                                const charts = container.querySelectorAll('svg, canvas, .highcharts-container');
                                if (charts.length > 1) {
                                    return charts[1]; // è¿”å›ç¬¬äºŒä¸ªå›¾è¡¨å…ƒç´ 
                                }
                                
                                // å°è¯•é€šè¿‡æ ‡é¢˜æŸ¥æ‰¾ç¯æ¯”ç›¸å…³çš„å›¾è¡¨åŒºåŸŸ
                                const titles = container.querySelectorAll('h3, h4, .chart-title');
                                for (const title of titles) {
                                    if (title.textContent.includes('ç¯æ¯”') || title.textContent.includes('å¢é•¿ç‡')) {
                                        // è¿”å›è¿™ä¸ªæ ‡é¢˜é™„è¿‘çš„å›¾è¡¨å…ƒç´ 
                                        const nearestChart = title.nextElementSibling?.querySelector('svg, canvas, .highcharts-container') ||
                                                           title.parentElement?.querySelector('svg, canvas, .highcharts-container');
                                        if (nearestChart) return nearestChart;
                                    }
                                }
                                
                                // å¦‚æœæ‰¾ä¸åˆ°æ˜ç¡®çš„å›¾è¡¨ï¼Œå°è¯•æ‰¾å‡ºç¬¬äºŒä¸ªå›¾è¡¨åŒºåŸŸ
                                const chartAreas = container.querySelectorAll('.chart-area, [id*="chart"], svg');
                                if (chartAreas.length > 1) {
                                    return chartAreas[1]; // è¿”å›ç¬¬äºŒä¸ªå›¾è¡¨åŒºåŸŸ
                                }
                                
                                // æœ€åå°è¯•æ‰¾å‡ºå«æœ‰"ç¯æ¯”"ã€"å¢é•¿ç‡"æ–‡å­—çš„SVG
                                const allSVGs = container.querySelectorAll('svg');
                                for (const svg of allSVGs) {
                                    const text = svg.textContent;
                                    if (text.includes('ç¯æ¯”') || text.includes('å¢é•¿ç‡') || text.includes('MoM')) {
                                        return svg;
                                    }
                                }
                                
                                return null;
                            },
                            fallbackSelectors: [
                                '#mom-section .chart-container:nth-child(2)',
                                '#mom-section svg:nth-of-type(2)',
                                '#mom-section > div:first-child svg:nth-of-type(2)',
                                '#mom-section [id*="growth"] svg',
                                '#mom-section [id*="rate"] svg'
                            ]
                        });
                    }
                }
                
                console.log('è¦å¯¼å‡ºçš„å›¾è¡¨æ˜ å°„:', chartMappings);
                
                // æ ¹æ®æ˜ å°„å…³ç³»æ”¶é›†å›¾è¡¨
                for (const mapping of chartMappings) {
                    if (!mapping.shouldExport) {
                        console.log(`è·³è¿‡å›¾è¡¨: ${mapping.name} (æœªé€‰æ‹©)`);
                        continue;
                    }
                    
                    console.log(`æ£€æŸ¥å›¾è¡¨: ${mapping.name}`);
                    
                    // å°è¯•æŒ‰ä¼˜å…ˆçº§è·å–å…ƒç´ ï¼šå¡ç‰‡ > å®¹å™¨ > å›¾è¡¨
                    let elementToExport = null;
                    let elementId = '';
                    
                    // é¦–å…ˆå°è¯•ä½¿ç”¨è‡ªå®šä¹‰é€‰æ‹©å™¨å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (!elementToExport && mapping.selector) {
                        // å…ˆæ‰¾åˆ°å¯èƒ½çš„å®¹å™¨
                        const containerCandidates = [
                            document.getElementById(mapping.cardId),
                            document.getElementById(mapping.containerId),
                            document.getElementById('mom-section')
                        ].filter(Boolean);
                        
                        for (const container of containerCandidates) {
                            const selectedElement = mapping.selector(container);
                            if (selectedElement && isElementVisible(selectedElement)) {
                                elementToExport = selectedElement;
                                elementId = selectedElement.id || `${mapping.name}-selected`;
                                console.log(`  - ä½¿ç”¨è‡ªå®šä¹‰é€‰æ‹©å™¨å‡½æ•°æ‰¾åˆ°å…ƒç´ `);
                                break;
                            }
                        }
                    }
                    
                    // é¦–å…ˆå°è¯•è·å–å¡ç‰‡ï¼ˆåŒ…å«æ ‡é¢˜å’Œå›¾ä¾‹ï¼‰
                    if (!elementToExport && mapping.cardId) {
                        const card = document.getElementById(mapping.cardId);
                        if (card && isElementVisible(card)) {
                            elementToExport = card;
                            elementId = mapping.cardId;
                            console.log(`  - ä½¿ç”¨å¡ç‰‡å…ƒç´  ${mapping.cardId}`);
                        }
                    }
                    
                    // å…¶æ¬¡å°è¯•è·å–å®¹å™¨
                    if (!elementToExport && mapping.containerId) {
                        const container = document.getElementById(mapping.containerId);
                        if (container && isElementVisible(container)) {
                            elementToExport = container;
                            elementId = mapping.containerId;
                            console.log(`  - ä½¿ç”¨å®¹å™¨å…ƒç´  ${mapping.containerId}`);
                        }
                    }
                    
                    // ç„¶åå°è¯•è·å–å›¾è¡¨å…ƒç´ æœ¬èº«
                    if (!elementToExport && mapping.chartId) {
                        const chart = document.getElementById(mapping.chartId);
                        if (chart && isElementVisible(chart)) {
                            elementToExport = chart;
                            elementId = mapping.chartId;
                            console.log(`  - ä½¿ç”¨å›¾è¡¨å…ƒç´  ${mapping.chartId}`);
                        }
                    }
                    
                    // æœ€åå°è¯•ä½¿ç”¨å¤‡ç”¨é€‰æ‹©å™¨ï¼ˆç‰¹åˆ«é€‚ç”¨äºç¯æ¯”åˆ†ææ¨¡å¼ï¼‰
                    if (!elementToExport && mapping.fallbackSelectors) {
                        for (const selector of mapping.fallbackSelectors) {
                            const element = document.querySelector(selector);
                            if (element && isElementVisible(element)) {
                                elementToExport = element;
                                elementId = selector;
                                console.log(`  - ä½¿ç”¨å¤‡ç”¨é€‰æ‹©å™¨ ${selector} æ‰¾åˆ°å…ƒç´ `);
                                break;
                            }
                        }
                    }
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šåœ¨ç¯æ¯”æ¨¡å¼ä¸‹æŸ¥æ‰¾ç‰¹å®šå›¾è¡¨
                    if (!elementToExport && currentAnalysisType === 'month_over_month') {
                        const momSection = document.getElementById('mom-section');
                        if (momSection) {
                            // æ ¹æ®å›¾è¡¨ç±»å‹åœ¨ç¯æ¯”éƒ¨åˆ†æŸ¥æ‰¾
                            if (mapping.name === 'é”€å”®è¶‹åŠ¿å›¾') {
                                // ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥æŸ¥æ‰¾ç¯æ¯”éƒ¨åˆ†ä¸­çš„ç¬¬ä¸€ä¸ªSVGå…ƒç´ ï¼ˆé€šå¸¸æ˜¯é”€å”®è¶‹åŠ¿å›¾ï¼‰
                                const firstSVG = momSection.querySelector('svg');
                                if (firstSVG) {
                                    elementToExport = firstSVG;
                                    elementId = 'mom-sales-trend-svg';
                                    console.log('  - æ‰¾åˆ°é”€å”®è¶‹åŠ¿å›¾SVGå…ƒç´ ');
                                } else {
                                    // é¦–å…ˆå°è¯•é€šè¿‡æ ‡é¢˜æŸ¥æ‰¾"é”€å”®è¶‹åŠ¿"å›¾è¡¨
                                    const salesTrendTitle = Array.from(momSection.querySelectorAll('h3, h4, .chart-title')).find(el => 
                                        el.textContent.includes('é”€å”®è¶‹åŠ¿') || el.textContent.includes('é”€å”®é‡‘é¢'));
                                    
                                    if (salesTrendTitle) {
                                        // è·å–æ ‡é¢˜æ‰€åœ¨çš„å¡ç‰‡æˆ–å®¹å™¨
                                        let container = salesTrendTitle.closest('.chart-container, .card, [id*="chart"]');
                                        if (container) {
                                            // è·å–å®¹å™¨ä¸­çš„ç¬¬ä¸€ä¸ªSVGï¼ˆé€šå¸¸æ˜¯é”€å”®è¶‹åŠ¿å›¾ï¼‰
                                            const svg = container.querySelector('svg');
                                            if (svg) {
                                                elementToExport = svg;
                                                elementId = 'sales-trend-svg';
                                                console.log('  - é€šè¿‡æ ‡é¢˜æ‰¾åˆ°é”€å”®è¶‹åŠ¿å›¾SVG');
                                            } else {
                                                elementToExport = container;
                                                elementId = container.id || 'sales-trend-chart';
                                                console.log('  - é€šè¿‡æ ‡é¢˜æ‰¾åˆ°é”€å”®è¶‹åŠ¿å›¾');
                                            }
                                        }
                                    }
                                }
                            } else if (mapping.name === 'ç¯æ¯”å¢é•¿ç‡å›¾') {
                                // ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥æŸ¥æ‰¾ç¯æ¯”éƒ¨åˆ†ä¸­çš„ç¬¬äºŒä¸ªSVGå…ƒç´ ï¼ˆé€šå¸¸æ˜¯ç¯æ¯”å¢é•¿ç‡å›¾ï¼‰
                                const svgs = momSection.querySelectorAll('svg');
                                if (svgs.length > 1) {
                                    elementToExport = svgs[1];
                                    elementId = 'mom-growth-rate-svg';
                                    console.log('  - æ‰¾åˆ°ç¯æ¯”å¢é•¿ç‡å›¾SVGå…ƒç´ ');
                                } else {
                                    // é¦–å…ˆå°è¯•é€šè¿‡æ ‡é¢˜æŸ¥æ‰¾"ç¯æ¯”å¢é•¿ç‡"å›¾è¡¨
                                    const momGrowthTitle = Array.from(momSection.querySelectorAll('h3, h4, .chart-title')).find(el => 
                                        el.textContent.includes('ç¯æ¯”') || 
                                        el.textContent.includes('å¢é•¿ç‡') || 
                                        el.textContent.includes('MoM'));
                                    
                                    if (momGrowthTitle) {
                                        // è·å–æ ‡é¢˜æ‰€åœ¨çš„å¡ç‰‡æˆ–å®¹å™¨
                                        let container = momGrowthTitle.closest('.chart-container, .card, [id*="chart"]');
                                        if (container) {
                                            // è·å–å®¹å™¨ä¸­çš„SVGï¼ˆé€šå¸¸æ˜¯ç¯æ¯”å¢é•¿ç‡å›¾ï¼‰
                                            const svg = container.querySelector('svg');
                                            if (svg) {
                                                elementToExport = svg;
                                                elementId = 'growth-rate-svg';
                                                console.log('  - é€šè¿‡æ ‡é¢˜æ‰¾åˆ°ç¯æ¯”å¢é•¿ç‡å›¾SVG');
                                            } else {
                                                elementToExport = container;
                                                elementId = container.id || 'mom-growth-chart';
                                                console.log('  - é€šè¿‡æ ‡é¢˜æ‰¾åˆ°ç¯æ¯”å¢é•¿ç‡å›¾');
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    if (elementToExport) {
                        chartContainers.push({
                            element: elementToExport,
                            elementId: elementId,
                            name: mapping.name
                        });
                    } else {
                        console.log(`  - æœªæ‰¾åˆ°å¯å¯¼å‡ºçš„å…ƒç´ : ${mapping.name}`);
                    }
                }
                
                // å•ç‹¬å¤„ç†æ—¶é—´åºåˆ—åˆ†è§£å›¾
                if (exportDecompositionChart && currentAnalysisType !== 'month_over_month') {
                    console.log('æ£€æŸ¥æ—¶é—´åºåˆ—åˆ†è§£å›¾');
                    const decompositionSection = document.getElementById('decomposition-section');
                    
                    if (decompositionSection && isElementVisible(decompositionSection)) {
                        console.log('  - æ‰¾åˆ°åˆ†è§£éƒ¨åˆ†');
                        // å°è¯•æŸ¥æ‰¾ç‹¬ç«‹çš„åˆ†è§£å›¾è¡¨
                        const decompositionCharts = decompositionSection.querySelectorAll('.decomposition-chart');
                        
                        if (decompositionCharts && decompositionCharts.length > 0) {
                            console.log(`  - æ‰¾åˆ° ${decompositionCharts.length} ä¸ªåˆ†è§£å›¾è¡¨`);
                            let chartIndex = 0;
                            decompositionCharts.forEach((chart, index) => {
                                if (chart && isElementVisible(chart)) {
                                    // è·å–å›¾è¡¨æ ‡é¢˜ - é€šå¸¸æ˜¯ä¸Šä¸€ä¸ªæˆ–çˆ¶å…ƒç´ ä¸­çš„æ ‡é¢˜å…ƒç´ 
                                    let chartTitle = 'åˆ†è§£ç»„ä»¶';
                                    const prevElement = chart.previousElementSibling;
                                    if (prevElement && prevElement.tagName.toLowerCase() === 'h4') {
                                        chartTitle = prevElement.textContent.trim();
                                    }
                                    
                                    chartContainers.push({
                                        element: chart,
                                        elementId: chart.id || `decomposition-chart-${index}`,
                                        name: `æ—¶é—´åºåˆ—åˆ†è§£_${chartTitle}_${++chartIndex}`
                                    });
                                }
                            });
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°ç‹¬ç«‹å›¾è¡¨ï¼Œå¯¼å‡ºæ•´ä¸ªéƒ¨åˆ†
                            console.log('  - æœªæ‰¾åˆ°ç‹¬ç«‹å›¾è¡¨ï¼Œå¯¼å‡ºæ•´ä¸ªåˆ†è§£éƒ¨åˆ†');
                            chartContainers.push({
                                element: decompositionSection,
                                elementId: 'decomposition-section',
                                name: 'æ—¶é—´åºåˆ—åˆ†è§£'
                            });
                        }
                    } else {
                        console.log('  - åˆ†è§£éƒ¨åˆ†ä¸å¯è§æˆ–ä¸å­˜åœ¨');
                    }
                } else {
                    console.log('è·³è¿‡æ—¶é—´åºåˆ—åˆ†è§£å›¾ (æœªé€‰æ‹©æˆ–åœ¨ç¯æ¯”æ¨¡å¼ä¸‹)');
                }
                
                console.log('æ‰¾åˆ°å¯å¯¼å‡ºçš„å›¾è¡¨æ•°é‡:', chartContainers.length);
                for (const chart of chartContainers) {
                    console.log(` - ${chart.name} (${chart.elementId})`);
                }
                
                if (chartContainers.length === 0) {
                    console.log('æ²¡æœ‰æ‰¾åˆ°è¦å¯¼å‡ºçš„å›¾è¡¨');
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    alert('æœªæ‰¾åˆ°é€‰æ‹©çš„å›¾è¡¨ï¼Œè¯·ç¡®ä¿å›¾è¡¨å·²æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š');
                    return; // æ²¡æœ‰å›¾è¡¨å¯å¯¼å‡º
                }
                
                console.log('å‡†å¤‡å¯¼å‡ºå›¾è¡¨ï¼š', chartContainers.length, 'ä¸ªå›¾è¡¨');
                
                // å­˜å‚¨å½“å‰çš„èƒŒæ™¯è‰²å’Œä¸»é¢˜ï¼Œä»¥ä¾¿åç»­æ¢å¤
                const originalTheme = document.body.getAttribute('data-theme');
                const originalBodyBg = document.body.style.backgroundColor;
                
                // ä¸´æ—¶è®¾ç½®ä¸ºæµ…è‰²ä¸»é¢˜ä»¥è·å¾—æ›´å¥½çš„å›¾è¡¨å¯¼å‡ºæ•ˆæœ
                document.body.setAttribute('data-theme', 'light');
                
                // ç­‰å¾…DOMæ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // å¯¼å‡ºæ¯ä¸ªå›¾è¡¨
                for (const container of chartContainers) {
                    try {
                        console.log('æ­£åœ¨å¤„ç†å›¾è¡¨:', container.name, container.elementId);
                        
                        // ç¡®ä¿html2canvaså·²åŠ è½½
                        if (typeof html2canvas !== 'function') {
                            throw new Error('html2canvasåº“æœªåŠ è½½ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                        }
                        
                        // è·å–è¦æ•è·çš„å…ƒç´ 
                        const elementToCapture = container.element;
                        
                        // æ£€æŸ¥å…ƒç´ å°ºå¯¸
                        const rect = elementToCapture.getBoundingClientRect();
                        console.log('è¦æ•è·çš„å…ƒç´ å°ºå¯¸:', rect.width, 'x', rect.height);
                        
                        if (rect.width < 10 || rect.height < 10) {
                            throw new Error('å…ƒç´ å°ºå¯¸è¿‡å°ï¼Œæ— æ³•å¯¼å‡ºæœ‰æ•ˆå›¾åƒ');
                        }
                        
                        // å¯¹äºéSVGå›¾è¡¨ä½¿ç”¨html2canvas
                        console.log('ä½¿ç”¨html2canvaså¯¼å‡ºå›¾è¡¨');
                        
                        // åˆ›å»ºä¸€ä¸ªé«˜åˆ†è¾¨ç‡çš„å›¾åƒ
                        const canvas = await html2canvas(elementToCapture, {
                            scale: 2, // æé«˜åˆ†è¾¨ç‡ä»¥å¢åŠ æ¸…æ™°åº¦
                            logging: true,
                            backgroundColor: '#FFFFFF',
                            useCORS: true, // å…è®¸è·¨åŸŸå›¾åƒ
                            allowTaint: true, // å…è®¸å¯èƒ½è¢«æ±¡æŸ“çš„å›¾åƒ
                            width: rect.width,
                            height: rect.height,
                            onclone: (documentClone, element) => {
                                console.log('å…‹éš†çš„å…ƒç´ :', element.id || element.className);
                                
                                // æŸ¥æ‰¾å¹¶ç¡®ä¿å…‹éš†æ–‡æ¡£ä¸­çš„ç›®æ ‡å…ƒç´ å¯è§
                                const clonedElement = documentClone.getElementById(container.elementId) || 
                                                     documentClone.querySelector(`[id="${container.elementId}"]`);
                                
                                if (clonedElement) {
                                    console.log('æ‰¾åˆ°å…‹éš†å…ƒç´ :', clonedElement.id || clonedElement.className);
                                    
                                    // ç¡®ä¿å…ƒç´ åŠå…¶æ‰€æœ‰çˆ¶å…ƒç´ éƒ½å¯è§
                                    let el = clonedElement;
                                    while (el) {
                                        el.style.display = 'block';
                                        el.style.visibility = 'visible';
                                        el.style.opacity = '1';
                                        el.style.height = 'auto';
                                        el.style.overflow = 'visible';
                                        el = el.parentElement;
                                    }
                                    
                                    // ç¡®ä¿å›¾è¡¨æ ‡é¢˜å¯è§
                                    const titles = clonedElement.querySelectorAll('h2, h3, h4, .card-title, .chart-title');
                                    titles.forEach(title => {
                                        if (title) {
                                            title.style.display = 'block';
                                            title.style.visibility = 'visible';
                                            title.style.opacity = '1';
                                            console.log('  - ç¡®ä¿æ ‡é¢˜å¯è§:', title.textContent);
                                        }
                                    });
                                    
                                    // ç¡®ä¿å›¾ä¾‹å¯è§
                                    const legends = clonedElement.querySelectorAll('.legend, .chart-legend, .apexcharts-legend, [class*="legend"]');
                                    legends.forEach(legend => {
                                        if (legend) {
                                            legend.style.display = 'block';
                                            legend.style.visibility = 'visible';
                                            legend.style.opacity = '1';
                                            console.log('  - ç¡®ä¿å›¾ä¾‹å¯è§');
                                        }
                                    });
                                    
                                    // ç‰¹åˆ«å¤„ç†ApexChartså›¾ä¾‹
                                    const apexElements = clonedElement.querySelectorAll('[class*="apexcharts"]');
                                    apexElements.forEach(el => {
                                        el.style.visibility = 'visible';
                                        el.style.opacity = '1';
                                    });
                                    
                                    // ç¡®ä¿å°ºå¯¸æ­£ç¡®
                                    clonedElement.style.width = rect.width + 'px';
                                    clonedElement.style.height = rect.height + 'px';
                                }
                            }
                        });
                        
                        console.log('html2canvasç”Ÿæˆcanvaså°ºå¯¸:', canvas.width, 'x', canvas.height);
                        
                        // è½¬æ¢ä¸ºPNGå¹¶ä¸‹è½½
                        const image = canvas.toDataURL('image/png', 1.0); // ä½¿ç”¨æœ€é«˜è´¨é‡
                        console.log('ç”Ÿæˆçš„Data URLé•¿åº¦:', image.length);
                        
                        if (image.length < 100) {
                            throw new Error('ç”Ÿæˆçš„å›¾åƒæ•°æ®æ— æ•ˆ');
                        }
                        
                        const link = document.createElement('a');
                        link.setAttribute('href', image);
                        link.setAttribute('download', 'é”€å”®åˆ†æ_' + container.name + '_' + new Date().toISOString().slice(0, 10) + '.png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        console.log('å›¾è¡¨å¯¼å‡ºæˆåŠŸ:', container.name);
                        
                        // çŸ­æš‚å»¶è¿Ÿé¿å…æµè§ˆå™¨é˜»æ­¢å¤šæ¬¡ä¸‹è½½
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (err) {
                        console.error('å¯¼å‡ºå›¾è¡¨å¤±è´¥:', err, container.name);
                        throw new Error('å¯¼å‡ºå›¾è¡¨"' + container.name + '"å¤±è´¥: ' + err.message);
                    }
                }
                
                // æ¢å¤åŸå§‹ä¸»é¢˜å’ŒèƒŒæ™¯è‰²
                document.body.setAttribute('data-theme', originalTheme);
                document.body.style.backgroundColor = originalBodyBg;
                
                console.log('æ‰€æœ‰å›¾è¡¨å¯¼å‡ºå®Œæˆ');
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loading.style.display = 'none';
            
            // é‡ç½®åˆ†æçŠ¶æ€
            window.isAnalyzing = false;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            console.log('æ ¼å¼åŒ–æ•°å­—:', num, 'ç±»å‹:', typeof num);
            
            if (num === null || num === undefined) {
                return '0';
            }
            
            // ç¡®ä¿numæ˜¯æ•°å­—ç±»å‹
            if (typeof num === 'string') {
                num = parseFloat(num);
                if (isNaN(num)) {
                    return '0';
                }
            }
            
            if (typeof num !== 'number') {
                return num.toString();
            }
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºæ•´æ•°
            if (Number.isInteger(num) || Math.abs(num - Math.round(num)) < 0.00001) {
                // å¯¹äºè¡Œæ•°ç­‰æ•´æ•°å€¼ï¼Œä¸æ˜¾ç¤ºå°æ•°ä½
                return Math.round(num).toLocaleString('zh-CN');
            } else {
                // å¯¹äºé‡‘é¢ç­‰å°æ•°å€¼ï¼Œæ ¼å¼åŒ–ä¸º2ä½å°æ•°
                return num.toLocaleString('zh-CN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        // åœ¨é¡µé¢åŠ è½½åæ·»åŠ åŠ¨æ€æ•ˆæœ
        const buttons = document.querySelectorAll('.button');
        
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                // æ£€æŸ¥åŠ¨ç”»è®¾ç½®æ˜¯å¦å¼€å¯
                const animationSetting = document.documentElement.getAttribute('data-animation');
                if (animationSetting === 'off') return;
                
                const x = e.clientX - e.target.getBoundingClientRect().left;
                const y = e.clientY - e.target.getBoundingClientRect().top;
                
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });

        // åˆå§‹åŒ–æŠ˜å åŠŸèƒ½
        const toggleGuideBtn = document.getElementById('toggle-guide');
        const usageGuide = document.getElementById('usage-guide');
        
        if (toggleGuideBtn && usageGuide) {
            toggleGuideBtn.addEventListener('click', function() {
                // ä½¿ç”¨classList.toggleæ¥åˆ‡æ¢activeçŠ¶æ€
                const isActive = usageGuide.classList.toggle('active');
                toggleGuideBtn.classList.toggle('active', isActive);
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                const textNode = toggleGuideBtn.querySelector('.guide-btn-text');
                if (textNode) {
                    textNode.textContent = isActive ? 'æ”¶èµ·è¯´æ˜' : 'æŸ¥çœ‹è¯´æ˜';
                }
            });
        }

        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚
        function checkYearOverYearEligibility() {
            const selectedFile = document.getElementById('file-input').files[0];
            const dateColumn = document.getElementById('date-column').value;
            
            if (!selectedFile || !dateColumn) {
                console.log("æ–‡ä»¶æˆ–æ—¥æœŸåˆ—æœªé€‰æ‹©ï¼Œæ— æ³•æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶");
                return;
            }
            
            // æ˜¾ç¤ºæ£€æŸ¥ä¸­çš„æç¤º
            const warningDiv = document.createElement('div');
            warningDiv.id = 'year-over-year-warning';
            warningDiv.className = 'warning-message';
            warningDiv.style.display = 'block';
            warningDiv.textContent = 'æ­£åœ¨æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚...';
            
            // æ’å…¥åˆ°åˆ†æç±»å‹é€‰é¡¹ä¸‹æ–¹
            const analysisTypeContainer = document.getElementById('analysis-type').parentNode;
            const existingWarning = document.getElementById('year-over-year-warning');
            if (existingWarning) {
                existingWarning.textContent = warningDiv.textContent;
                existingWarning.style.display = 'block';
            } else {
                analysisTypeContainer.appendChild(warningDiv);
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('date_column', dateColumn);
            
            fetch('/api/check_year_over_year_eligibility', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const warningElement = document.getElementById('year-over-year-warning');
                
                if (data.success) {
                    if (data.has_enough_data) {
                        // æ•°æ®æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚
                        if (warningElement) {
                            warningElement.style.display = 'none';
                        }
                        document.getElementById('analyze-button').disabled = false;
                    } else {
                        // æ•°æ®ä¸æ»¡è¶³åŒæ¯”åˆ†æè¦æ±‚
                        if (warningElement) {
                            warningElement.textContent = 'åŒæ¯”åˆ†æéœ€è¦è‡³å°‘ä¸¤å¹´çš„æ•°æ®ï¼Œå½“å‰æ•°æ®ä¸æ»¡è¶³è¦æ±‚';
                            warningElement.style.display = 'block';
                        }
                        // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯åŒæ¯”åˆ†æï¼Œåˆ™ç¦ç”¨åˆ†ææŒ‰é’®
                        if (document.getElementById('analysis-type').value === 'year_over_year') {
                            document.getElementById('analyze-button').disabled = true;
                        }
                    }
                } else {
                    // æ£€æŸ¥å¤±è´¥
                    if (warningElement) {
                        warningElement.textContent = `æ£€æŸ¥æ•°æ®å¤±è´¥: ${data.message}`;
                        warningElement.style.display = 'block';
                    }
                    console.error('æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶å¤±è´¥:', data.message);
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶è¯·æ±‚å¤±è´¥:', error);
                const warningElement = document.getElementById('year-over-year-warning');
                if (warningElement) {
                    warningElement.textContent = `æ£€æŸ¥åŒæ¯”åˆ†ææ¡ä»¶å¤±è´¥: ${error.message}`;
                    warningElement.style.display = 'block';
                }
            });
        }

        // ç›‘å¬åˆ†æç±»å‹å˜åŒ–
        document.getElementById('analysis-type').addEventListener('change', function() {
            // é‡ç½®åˆ†ææŒ‰é’®çŠ¶æ€
            document.getElementById('analyze-button').disabled = false;
            
            // éšè—ä¹‹å‰çš„è­¦å‘Šä¿¡æ¯
            const warningElement = document.getElementById('year-over-year-warning');
            if (warningElement) {
                warningElement.style.display = 'none';
            }
            
            // å¦‚æœé€‰æ‹©äº†åŒæ¯”åˆ†æï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³è¦æ±‚
            if (this.value === 'year_over_year') {
                checkYearOverYearEligibility();
            }
        });

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©å’Œæ—¥æœŸåˆ—é€‰æ‹©ï¼Œåœ¨é€‰æ‹©åŒæ¯”åˆ†ææ—¶è§¦å‘æ£€æŸ¥
        document.getElementById('file-input').addEventListener('change', function() {
            if (document.getElementById('analysis-type').value === 'year_over_year') {
                checkYearOverYearEligibility();
            }
        });
        
        document.getElementById('date-column').addEventListener('change', function() {
            if (document.getElementById('analysis-type').value === 'year_over_year') {
                checkYearOverYearEligibility();
            }
        });

        // é˜»æ­¢æ¨¡æ€çª—å£å†…ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ°å¤–éƒ¨
        document.querySelector('.modal-content').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // ç‚¹å‡»æ¨¡æ€çª—å£èƒŒæ™¯å…³é—­çª—å£
        document.getElementById('export-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });
</script>
{% endblock %} 