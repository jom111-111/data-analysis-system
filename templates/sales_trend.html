{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="system-name">销售趋势分析</h1>
        <button id="back-to-home" class="button back-button">
            <i class="ri-arrow-left-line"></i> 返回主界面
        </button>
    </div>
    
    <div class="page-description">
        <div class="description-content">
            <p><i class="ri-line-chart-line" style="color: #0062ff; margin-right: 8px;"></i>上传Excel销售数据文件，分析销售额随时间的变化趋势、同比增长和环比增长，并自动检测异常点。</p>
            
            <div class="usage-guide-wrapper">
                <button id="toggle-guide" class="toggle-guide-btn">
                    <i class="ri-information-line"></i>
                    <span class="guide-btn-text">查看说明</span>
                    <i class="ri-arrow-down-s-line toggle-icon"></i>
                </button>
                
                <div class="usage-guide" id="usage-guide">
                    <h3><i class="ri-file-list-3-line" style="color: #0062ff; margin-right: 8px;"></i>功能介绍</h3>
                    <div class="guide-content">
                        <div class="guide-section">
                            <h4><i class="ri-guide-line" style="color: #3a7bd5; margin-right: 8px;"></i>使用方法</h4>
                            <ol>
                                <li><i class="ri-file-upload-line" style="color: #6a3093; margin-right: 8px;"></i>上传包含销售数据的Excel文件（必须包含日期列和数值列）</li>
                                <li><i class="ri-table-line" style="color: #6a3093; margin-right: 8px;"></i>选择文件中的日期列和要分析的值列（销售额、订单量等）</li>
                                <li><i class="ri-bar-chart-box-line" style="color: #6a3093; margin-right: 8px;"></i>选择分析类型（趋势分析、同比分析或环比分析）</li>
                                <li><i class="ri-calendar-line" style="color: #6a3093; margin-right: 8px;"></i>选择时间粒度（按天、周、月、季度或年）</li>
                                <li><i class="ri-settings-3-line" style="color: #6a3093; margin-right: 8px;"></i>选择数据处理模式（对于大数据集，建议使用智能处理提高性能）</li>
                                <li><i class="ri-play-circle-line" style="color: #6a3093; margin-right: 8px;"></i>点击"开始分析"获取结果</li>
                            </ol>
                        </div>
                        
                        <div class="guide-section">
                            <h4><i class="ri-file-chart-line" style="color: #3a7bd5; margin-right: 8px;"></i>分析类型说明</h4>
                            <ul>
                                <li><i class="ri-line-chart-line" style="color: #ff7e5f; margin-right: 8px;"></i><strong>趋势分析：</strong>展示销售数据随时间的变化趋势，计算总量、平均值、增长率等关键指标，并进行时间序列分解（趋势、季节性、残差）</li>
                                <li><i class="ri-calendar-2-line" style="color: #ff7e5f; margin-right: 8px;"></i><strong>同比分析：</strong>比较不同年份同期的销售表现，计算年度同比增长率，帮助评估业务同期增长情况</li>
                                <li><i class="ri-calendar-check-line" style="color: #ff7e5f; margin-right: 8px;"></i><strong>环比分析：</strong>比较相邻时间段的销售变化，如月度环比，帮助发现短期增长或下降趋势</li>
                            </ul>
                        </div>
                        
                        <div class="guide-section">
                            <h4><i class="ri-file-list-line" style="color: #3a7bd5; margin-right: 8px;"></i>分析结果包括</h4>
                            <ul>
                                <li><i class="ri-bar-chart-2-line" style="color: #0062ff; margin-right: 8px;"></i>销售趋势可视化图表</li>
                                <li><i class="ri-numbers-line" style="color: #0062ff; margin-right: 8px;"></i>关键统计数据（总量、均值、增长率等）</li>
                                <li><i class="ri-error-warning-line" style="color: #0062ff; margin-right: 8px;"></i>异常点检测及可能原因</li>
                                <li><i class="ri-split-cells-horizontal" style="color: #0062ff; margin-right: 8px;"></i>时间序列分解（趋势、季节性、随机成分）</li>
                                <li><i class="ri-file-download-line" style="color: #0062ff; margin-right: 8px;"></i>可下载的分析报告（CSV格式）</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="upload-section">
        <div class="file-upload-container">
            <div class="upload-area" id="upload-area">
                <i class="ri-upload-cloud-line"></i>
                <p>点击或拖拽Excel文件到此处</p>
                <small>支持XLSX、XLS格式</small>
                <input type="file" id="file-input" accept=".xlsx,.xls" class="file-input">
            </div>
            <div class="file-info" id="file-info" style="display: none;">
                <div class="file-name-container">
                    <i class="ri-file-excel-line file-icon"></i>
                    <span id="file-name">filename.xlsx</span>
                </div>
                <button class="remove-file-btn" id="remove-file">
                    <i class="ri-delete-bin-fill"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="analysis-options" id="analysis-options" style="display: none;">
        <div class="options-header">
            <h2>分析设置</h2>
        </div>
        
        <div class="option-group">
            <div class="option">
                <label>日期列</label>
                <select id="date-column" class="select-input">
                    <option value="">选择日期列</option>
                </select>
            </div>
            
            <div class="option">
                <div class="label-with-info">
                    <label>值列</label>
                    <div class="value-info-toggle">
                        <i class="ri-information-line" id="value-info-icon"></i>
                        <div class="value-tooltip" id="value-tooltip">
                            <div class="tooltip-title">值列均值说明</div>
                            <div class="tooltip-content-simple">
                                <p>此处显示的<strong>均值</strong>是基于原始Excel文件中整列数据直接计算的平均值。</p>
                                <p>而分析结果的统计数据模块中的<strong>平均值</strong>是基于按选定时间粒度（日/周/月等）聚合后的数据计算的平均值。</p>
                                <p>因此，这两个数值在大多数情况下会有所不同，特别是在选择非日粒度分析时差异更明显。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <select id="value-column" class="select-input">
                    <option value="">选择要分析的值列</option>
                </select>
            </div>
        </div>
        
        <div class="option-group">
            <div class="option">
                <label>分析类型</label>
                <select id="analysis-type" class="select-input">
                    <option value="trend">趋势分析</option>
                    <option value="year_over_year">同比分析</option>
                    <option value="month_over_month">环比分析</option>
                </select>
            </div>
            
            <div class="option">
                <label>时间粒度</label>
                <select id="time-granularity" class="select-input">
                    <option value="day">按天</option>
                    <option value="week">按周</option>
                    <option value="month">按月</option>
                    <option value="quarter">按季度</option>
                    <option value="year">按年</option>
                </select>
            </div>
        </div>
        
        <div class="option-group" id="processing-mode-group">
            <div class="option">
                <label>数据处理模式</label>
                <select id="processing-mode" class="select-input">
                    <option value="auto">智能处理 (大数据自动优化)</option>
                    <option value="full">完整处理 (处理所有数据点)</option>
                </select>
            </div>
            
            <div class="option data-info-option">
                <div class="info-text">
                    <i class="ri-information-line"></i>
                    <span></span>
                </div>
            </div>
        </div>
        
        <!-- 警告信息容器 -->
        <div id="yoy-warning" class="warning-message">
            年度同比分析需要至少两年的数据，请确保您的数据集包含跨越两个或更多年份的数据。
        </div>
        
        <button id="analyze-button" class="button primary-button" style="background-color: var(--primary-color); color: white; padding: 12px 24px; border-radius: 10px; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">开始分析</button>
    </div>
    
    <div id="loading" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在识别/分析数据中... （数据量越大，所需要的时间越久）请耐心等候！</div>
    </div>
    
    <div id="error-message" class="error-message" style="display: none;"></div>
    
    <div id="results-container" class="results-container" style="display: none;">
        <div class="results-header">
            <h2>分析结果</h2>
            <button id="export-results" class="button secondary-button">
                <i class="ri-download-line"></i> 导出结果
            </button>
        </div>
        
        <div class="card trend-card">
            <div class="card-header">
                <h3>销售趋势图</h3>
            </div>
            <div class="card-body">
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="card stats-card">
                <div class="card-header">
                    <h3>统计数据</h3>
                </div>
                <div class="card-body" id="stats-content">
                    <!-- 将通过JavaScript动态填充 -->
                </div>
            </div>
            
            <div class="card anomalies-card">
                <div class="card-header">
                    <div class="header-with-note">
                        <h3>异常点检测</h3>
                        <span class="note-text">（仅供参考，请仔细斟酌）</span>
                    </div>
                    <div class="anomaly-info-toggle">
                        <i class="ri-information-line" id="anomaly-info-icon"></i>
                        <div class="anomaly-tooltip" id="anomaly-tooltip">
                            <div class="tooltip-title">检测规则说明</div>
                            <ul class="tooltip-content">
                                <li><strong>多维度异常评分：</strong>系统综合使用Z分数、四分位距(IQR)和中位数绝对偏差(MAD)三种方法对数据点进行多维度评分，通过投票机制确保异常点的准确性</li>
                                <li><strong>Z-score方法：</strong>偏离均值2.5个标准差以上的点被识别为潜在异常点，适合检测突发性波动</li>
                                <li><strong>尖峰模式检测：</strong>专门识别销售突然上升后迅速下降的尖峰模式，能精确捕捉促销活动或特殊事件引起的短期销售波动</li>
                                <li><strong>时间因素分析：</strong>考虑节假日、周末/工作日、月初/月末、季度末等时间因素对销售数据的影响</li>
                                <li><strong>环比变化：</strong>检测与相邻时间点的数据变化幅度，超过30%的变化会被重点关注</li>
                                <li><strong>连续异常检测：</strong>识别时间窗口内出现的连续异常模式，可发现持续性问题或趋势变化</li>
                                <li><strong>孤立点识别：</strong>识别与前后数据均有显著差异的数据点，这些可能是数据异常或特殊事件</li>
                                <li><strong>节假日智能识别：</strong>系统内置2018-2030年中国主要节假日数据，能智能识别节假日对销售的影响</li>
                                <li><strong>业务影响分析：</strong>结合业务逻辑分析异常原因，提供更有商业价值的异常解释</li>
                                <li><strong>有效数据智能过滤：</strong>自动过滤无效或缺失数据点，确保异常检测结果的准确性和可靠性</li>
                                <li><strong>限制显示数量：</strong>仅显示最显著的20个异常点，以避免信息过载</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="anomalies-content">
                    <!-- 将通过JavaScript动态填充 -->
                </div>
            </div>
        </div>
        
        <div class="card yoy-card" id="yoy-section" style="display: none;">
            <div class="card-header">
                <h3>同比分析</h3>
            </div>
            <div class="card-body">
                <div id="yoy-chart" class="chart-container"></div>
                <div id="yoy-growth-chart" class="chart-container"></div>
                <div class="stats-container yoy-stats-container">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h3>同比统计数据</h3>
                        </div>
                        <div class="card-body" id="yoy-stats">
                            <!-- 将通过JavaScript动态填充 -->
                        </div>
                    </div>
                </div>
                <div class="card yearly-data-card">
                    <div class="card-header">
                        <h3>年度同比数据</h3>
                    </div>
                    <div class="card-body" id="yoy-yearly-data">
                        <!-- 将通过JavaScript动态填充 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mom-card" id="mom-section" style="display: none;">
            <div class="card-header">
                <h3>环比分析</h3>
            </div>
            <div class="card-body">
                <div id="mom-chart" class="chart-container"></div>
                <div id="mom-growth-chart" class="chart-container"></div>
                <div class="card monthly-data-card">
                    <div class="card-header">
                        <h3>月度数据明细</h3>
                    </div>
                    <div class="card-body" id="mom-monthly-data">
                        <!-- 将通过JavaScript动态填充 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card decomposition-card" id="decomposition-section" style="display: none;">
            <div class="card-header">
                <h3>时间序列分解</h3>
            </div>
            <div class="card-body">
                <div class="decomposition-charts">
                    <div id="trend-component" class="chart-container"></div>
                    <div id="seasonal-component" class="chart-container"></div>
                    <div id="residual-component" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 导出选项模态窗口 -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择要导出的内容</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-section">
                        <div class="section-header">数据导出 (CSV)</div>
                        <label class="checkbox-container">
                            <input type="checkbox" id="export-stats" checked>
                            <span class="checkmark"></span>
                            统计数据
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="export-anomalies" checked>
                            <span class="checkmark"></span>
                            异常点检测
                        </label>
                        <label class="checkbox-container" id="export-yoy-container" style="display: none;">
                            <input type="checkbox" id="export-yoy" checked>
                            <span class="checkmark"></span>
                            同比分析
                        </label>
                        <label class="checkbox-container" id="export-mom-container" style="display: none;">
                            <input type="checkbox" id="export-mom" checked>
                            <span class="checkmark"></span>
                            环比分析
                        </label>
                        <label class="checkbox-container" id="export-decomposition-container" style="display: none;">
                            <input type="checkbox" id="export-decomposition" checked>
                            <span class="checkmark"></span>
                            时间序列分解
                        </label>
                    </div>
                    
                    <div class="export-section">
                        <div class="section-header">图表导出 (PNG)</div>
                        <label class="checkbox-container" id="export-trend-chart-container">
                            <input type="checkbox" id="export-trend-chart" checked>
                            <span class="checkmark"></span>
                            销售趋势图表
                        </label>
                        <label class="checkbox-container" id="export-yoy-chart-container" style="display: none;">
                            <input type="checkbox" id="export-yoy-chart" checked>
                            <span class="checkmark"></span>
                            同比分析图表
                        </label>
                        <label class="checkbox-container" id="export-yoy-monthly-chart-container" style="display: none;">
                            <input type="checkbox" id="export-yoy-monthly-chart" checked>
                            <span class="checkmark"></span>
                            月度同比变化图表
                        </label>
                        <label class="checkbox-container" id="export-mom-chart-container" style="display: none;">
                            <input type="checkbox" id="export-mom-chart" checked>
                            <span class="checkmark"></span>
                            环比增长率图表
                        </label>
                        <label class="checkbox-container" id="export-decomposition-chart-container" style="display: none;">
                            <input type="checkbox" id="export-decomposition-chart" checked>
                            <span class="checkmark"></span>
                            时间序列分解图表
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-export" class="button secondary-button">取消</button>
                <button id="confirm-export" class="button primary-button">导出</button>
            </div>
        </div>
    </div>

    <!-- 工作表选择模态窗口 -->
    <div id="sheet-selection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>选择工作表</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>检测到该Excel文件包含多个工作表，请选择要分析的工作表：</p>
                <div class="sheet-list" id="sheet-list">
                    <!-- 这里将动态填充工作表列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-sheet-selection" class="button primary-button">确认</button>
                <button id="cancel-sheet-selection" class="button secondary-button">取消</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* 全局变量 */
    :root {
        --primary-color: #0071e3;
        --hover-color: #0077ed;
        --background-color: #f5f5f7;
        --card-background: #ffffff;
        --text-color: #333333;
        --border-color: #dddddd;
        --secondary-text: #86868b;
        --card-shadow-color: rgba(0, 0, 0, 0.05);
        --primary-color-rgb: 0, 113, 227;
        --error-color: #dc3545; /* 添加错误颜色变量 */
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 40, 167, 69;
    }

    /* 深色系 */
    [data-theme="dark"] {
        --primary-color: #2997ff;
        --hover-color: #0077ed;
        --background-color: #000000;
        --text-color: #f5f5f7;
        --secondary-text: #86868b;
        --border-color: #424245;
        --card-background: rgb(40, 40, 40);
        --card-border: rgba(66, 66, 69, 0.5);
        --card-shadow: rgba(0, 0, 0, 0.2);
        --primary-color-rgb: 41, 151, 255;
        --error-color: #dc3545; /* 添加错误颜色变量 */
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 40, 167, 69;
    }
    
    /* 禁用所有Plotly交互功能和工具栏 */
    .js-plotly-plot .plotly .modebar,
    .js-plotly-plot .plotly .modebar-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }
    
    .plotly-notifier,
    .modebar-btn,
    .modebar-group {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* 确保所有Plotly图表内部元素不接受交互事件 - 但保留悬停功能 */
    .js-plotly-plot .plotly .plotbg,
    .js-plotly-plot .plotly .modebar-container,
    .js-plotly-plot .plotly .zoom-container {
        pointer-events: none !important;
    }
    
    /* 覆盖任何可能的内联样式 */
    .js-plotly-plot .plotly [style*="display: block"].modebar,
    .js-plotly-plot .plotly [style*="display: block"].modebar-container {
        display: none !important;
    }
    
    /* 移除图表上所有可能的交互按钮或工具 */
    .zoom-container, 
    .zoom-buttons,
    .download-button,
    [role="button"] {
        display: none !important;
    }
    
    /* 暖色系 */
    [data-theme="warm"] {
        --primary-color: #e67e22;
        --hover-color: #d35400;
        --background-color: #fffaf0;
        --text-color: #442c2e;
        --secondary-text: #7a6563;
        --border-color: #e8d9c5;
        --card-background: rgb(255, 250, 240);
        --card-border: rgba(232, 217, 197, 0.5);
        --card-shadow: rgba(139, 69, 19, 0.05);
        --primary-color-rgb: 230, 126, 34;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 39, 174, 96;
    }
    
    /* 冷色系 */
    [data-theme="cool"] {
        --primary-color: #3498db;
        --hover-color: #2980b9;
        --background-color: #f0f8ff;
        --text-color: #2c3e50;
        --secondary-text: #617487;
        --border-color: #d1e6f9;
        --card-background: rgb(240, 248, 255);
        --card-border: rgba(209, 230, 249, 0.5);
        --card-shadow: rgba(52, 152, 219, 0.05);
        --primary-color-rgb: 52, 152, 219;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 241, 196, 15;
        --success-color-rgb: 46, 204, 113;
    }
    
    /* 自然色 */
    [data-theme="nature"] {
        --primary-color: #27ae60;
        --hover-color: #219652;
        --background-color: #f5fff5;
        --text-color: #2d4a22;
        --secondary-text: #5a8c50;
        --border-color: #d5e8d4;
        --card-background: rgb(245, 255, 245);
        --card-border: rgba(213, 232, 212, 0.5);
        --card-shadow: rgba(39, 174, 96, 0.05);
        --primary-color-rgb: 39, 174, 96;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 241, 196, 15;
        --success-color-rgb: 39, 174, 96;
    }
    
    /* 科技色 */
    [data-theme="tech"] {
        --primary-color: #00bcd4;
        --hover-color: #0097a7;
        --background-color: #fafcfd;
        --text-color: #263238;
        --secondary-text: #607d8b;
        --border-color: #cfd8dc;
        --card-background: rgb(250, 252, 253);
        --card-border: rgba(207, 216, 220, 0.5);
        --card-shadow: rgba(0, 188, 212, 0.05);
        --primary-color-rgb: 0, 188, 212;
        --error-color: #ff5722;
        --error-color-rgb: 255, 87, 34;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 76, 175, 80;
    }
    
    /* 紫色系 */
    [data-theme="lavender"] {
        --primary-color: #9c27b0;
        --hover-color: #7b1fa2;
        --background-color: #fdf9ff;
        --text-color: #4a235a;
        --secondary-text: #8e44ad;
        --border-color: #e1bee7;
        --card-background: rgb(253, 249, 255);
        --card-border: rgba(225, 190, 231, 0.5);
        --card-shadow: rgba(156, 39, 176, 0.05);
        --primary-color-rgb: 156, 39, 176;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 76, 175, 80;
    }
    
    /* 高对比 */
    [data-theme="contrast"] {
        --primary-color: #000000;
        --hover-color: #1d1d1f;
        --background-color: #ffffff;
        --text-color: #000000;
        --secondary-text: #424245;
        --border-color: #1d1d1f;
        --card-background: rgb(255, 255, 255);
        --card-border: rgba(0, 0, 0, 0.2);
        --card-shadow: rgba(0, 0, 0, 0.1);
        --primary-color-rgb: 0, 0, 0;
        --error-color: #dc3545;
        --error-color-rgb: 220, 53, 69;
        --warning-color-rgb: 255, 193, 7;
        --success-color-rgb: 40, 167, 69;
    }
    
    /* 数据要求警告样式 */
    .data-requirement-warning {
        margin: 10px 0;
        padding: 12px 15px;
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.5;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .data-requirement-warning.checking {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left-color: #17a2b8;
    }
    
    .data-requirement-warning:before {
        content: "⚠️";
        margin-right: 10px;
        font-size: 16px;
    }
    
    .data-requirement-warning.checking:before {
        content: "🔍";
    }
    
    /* 禁用按钮样式 */
    .analyze-btn.disabled,
    .button.primary-button.disabled {
        background-color: #cccccc !important;
        cursor: not-allowed !important;
        opacity: 0.7 !important;
        pointer-events: none !important;
    }
    
    .analyze-btn.disabled:hover,
    .button.primary-button.disabled:hover {
        background-color: #cccccc !important;
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* 明确直接针对元素的禁用样式 */
    #analyze-button.disabled,
    #analyze-button[disabled] {
        background-color: #cccccc !important;
        color: #666666 !important;
        cursor: not-allowed !important;
        opacity: 0.7 !important;
        pointer-events: none !important;
        box-shadow: none !important;
        transform: none !important;
    }
    
    /* 基本样式 */
    body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
            Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        background-image: linear-gradient(to bottom right, 
                          rgba(var(--primary-color-rgb), 0.05) 1px, 
                          transparent 1px),
                          linear-gradient(to bottom, 
                          rgba(var(--primary-color-rgb), 0.05) 1px, 
                          transparent 1px);
        background-size: 20px 20px;
        background-attachment: fixed;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .back-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 120px;
        text-align: center;
    }
    
    .back-button:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .back-button i {
        font-size: 16px;
    }

    h1 {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text-color);
    }

    h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-color);
    }

    h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-color);
    }

    .page-description, 
    .upload-section, 
    .analysis-options, 
    .results-container {
        opacity: 0;
        animation: fadeInUp 0.8s ease forwards;
    }

    .page-description {
        animation-delay: 0.1s;
        font-size: 16px;
        margin-bottom: 30px;
        color: var(--secondary-text);
    }

    /* 使用指南样式 */
    .usage-guide-wrapper {
        margin-top: 10px;
        clear: both;
        overflow: hidden;
    }
    
    .toggle-guide-btn {
        width: auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        background-color: transparent;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        color: var(--secondary-text);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 12px;
        margin-right: 2px;
        float: right;
        text-align: center;
    }
    
    .toggle-guide-btn i {
        flex-shrink: 0;
    }
    
    .toggle-guide-btn .toggle-icon {
        transition: transform 0.4s ease;
        margin-left: auto;
    }
    
    .toggle-guide-btn:hover {
        background-color: rgba(var(--primary-color-rgb), 0.05);
        color: var(--primary-color);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .toggle-guide-btn.active .toggle-icon {
        transform: rotate(180deg);
    }
    
    .usage-guide {
        margin-top: 0;
        padding: 0 20px;
        background-color: var(--card-background);
        border-radius: 12px;
        border: 1px solid var(--card-border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(8px);
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.5s ease-in-out, 
                    padding 0.4s ease-in-out, 
                    margin 0.4s ease-in-out,
                    border-width 0.3s step-end;
        border-width: 0;
    }
    
    .usage-guide.active {
        max-height: 1500px;
        opacity: 1;
        padding: 20px;
        margin-top: 12px;
        border-width: 1px;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.5s ease-in-out, 
                    padding 0.4s ease-in-out, 
                    margin 0.4s ease-in-out,
                    border-width 0.1s step-start;
    }
    
    .usage-guide h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: var(--primary-color);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .guide-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .guide-section {
        padding: 15px;
        background-color: rgba(var(--primary-color-rgb), 0.03);
        border-radius: 8px;
        border-left: 3px solid var(--primary-color);
    }
    
    .guide-section h4 {
        font-size: 16px;
        margin-bottom: 12px;
        color: var(--text-color);
    }
    
    .guide-section ul, 
    .guide-section ol {
        margin: 0;
        padding-left: 20px;
    }
    
    .guide-section li {
        margin-bottom: 8px;
        line-height: 1.5;
    }
    
    .guide-section strong {
        color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
        .guide-content {
            grid-template-columns: 1fr;
            gap: 15px;
        }
    }

    .upload-section {
        animation-delay: 0.3s;
        margin-bottom: 30px;
    }

    .analysis-options {
        animation-delay: 0.5s;
        background-color: var(--card-background);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--card-border);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(10px);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .options-header {
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }

    .options-header h2 {
        font-size: 22px;
        margin: 0;
    }

    .option-group {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
    }

    .option {
        flex: 1;
    }

    .option label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .select-input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 16px;
        transition: all 0.2s ease;
        outline: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
    }

    .select-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
    }

    .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .primary-button {
        background-color: var(--primary-color);
        color: white;
    }

    .primary-button:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.3);
    }

    .secondary-button {
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
    }

    .secondary-button:hover {
        background-color: rgba(var(--primary-color-rgb), 0.5);
    }

    .loading-container {
        margin: 48px 0;
        text-align: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(var(--primary-color-rgb), 0.2);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .results-container {
        margin-top: 40px;
        animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .results-header h2 {
        font-size: 24px;
        margin: 0;
    }

    .card {
        background-color: var(--card-background);
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--card-border);
        overflow: hidden;
        margin-bottom: 24px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--card-border);
        background-color: rgba(var(--primary-color-rgb), 0.05);
    }

    .card-header h3 {
        margin: 0;
    }

    .card-body {
        padding: 20px;
    }

    .chart-container {
        width: 100%;
        height: 400px;
        margin-bottom: 20px;
    }

    .decomposition-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .stats-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .stats-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--card-border);
    }

    .stats-item:last-child {
        border-bottom: none;
    }

    .stats-label {
        font-weight: 500;
    }

    .stats-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .anomaly-item {
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 8px;
        background-color: rgba(var(--warning-color-rgb), 0.1);
        border-left: 3px solid var(--warning-color);
    }

    .anomaly-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .anomaly-date {
        font-weight: 600;
    }

    .anomaly-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .anomaly-reasons {
        margin-top: 8px;
    }

    .anomaly-reason {
        margin-bottom: 4px;
        font-size: 14px;
        color: var(--secondary-text);
    }

    .no-anomalies {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
    }

    @media (max-width: 768px) {
        .option-group {
            flex-direction: column;
            gap: 16px;
        }

        .stats-container {
            grid-template-columns: 1fr;
        }

        .decomposition-charts {
            grid-template-columns: 1fr;
        }
    }

    /* 改进的加载动画 */
    .loading-text {
        margin-top: 16px;
        font-size: 16px;
        font-weight: 500;
        color: var(--secondary-text);
        background: linear-gradient(90deg, var(--secondary-text), var(--primary-color), var(--secondary-text));
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 2s linear infinite;
    }

    /* 数据处理模式信息文本 */
    .info-text {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        background-color: rgba(var(--primary-color-rgb), 0.05);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
        min-width: 200px; /* 确保在移动设备上有合适的宽度 */
    }

    .info-text i {
        margin-right: 8px;
        color: var(--primary-color);
        font-size: 18px;
    }

    .info-text strong {
        color: var(--primary-color);
        font-weight: 600;
    }

    @keyframes shine {
        to {
            background-position: 200% center;
        }
    }

    /* 错误消息样式改进 */
    .error-message {
        background-color: rgba(var(--error-color-rgb), 0.1);
        border-left: 4px solid var(--error-color);
        color: var(--error-color);
        padding: 16px 20px;
        border-radius: 10px;
        margin: 24px 0;
        font-weight: 500;
        display: flex;
        align-items: center;
        transform: translateX(-10px);
        opacity: 0;
        animation: slideInError 0.5s forwards;
    }

    .error-message::before {
        content: "!";
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background-color: var(--error-color);
        color: white;
        border-radius: 50%;
        margin-right: 12px;
        font-weight: bold;
    }

    @keyframes slideInError {
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* 美化上传区域 */
    .file-upload-container {
        background: var(--card-background);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 20px var(--card-shadow);
    }

    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: var(--card-background);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

    .upload-area::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            45deg,
            rgba(var(--primary-color-rgb), 0) 0%,
            rgba(var(--primary-color-rgb), 0) 40%,
            rgba(var(--primary-color-rgb), 0.1) 50%,
            rgba(var(--primary-color-rgb), 0) 60%,
            rgba(var(--primary-color-rgb), 0) 100%
        );
        transform: rotate(45deg);
        animation: shine-effect 3s infinite;
    }

    @keyframes shine-effect {
        0% {
            top: -100%;
            left: -100%;
        }
        100% {
            top: 100%;
            left: 100%;
        }
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
    }

    .upload-area.drag-over {
        border-color: var(--primary-color);
        background-color: rgba(var(--primary-color-rgb), 0.05);
    }

    .upload-area i {
        font-size: 48px;
        color: var(--primary-color);
        margin-bottom: 16px;
    }

    .upload-area p {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .file-input {
        display: none;
    }

    .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background-color: rgba(var(--primary-color-rgb), 0.05);
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        margin-top: 15px;
        position: relative;
    }
    
    .file-info:hover .remove-file-btn {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
    }

    .file-name-container {
        display: flex;
        align-items: center;
        flex: 1;
    }
    
    .file-icon {
        font-size: 24px;
        color: var(--primary-color);
        margin-right: 10px;
    }

    .remove-file-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #dc3545;
        color: #dc3545;
        font-size: 20px;
        cursor: pointer;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        opacity: 0;
        visibility: hidden;
        transform: scale(0.8);
    }

    .remove-file-btn i {
        font-size: 22px;
        line-height: 1;
        color: #dc3545;
    }

    .remove-file-btn:hover {
        background-color: #dc3545;
        color: white;
        transform: scale(1.08);
    }

    .file-info:hover .remove-file-btn:hover {
        transform: scale(1.08);
    }

    .remove-file-btn:hover i {
        color: white;
    }

    /* 动画控制 */
    [data-animation="off"] .page-description,
    [data-animation="off"] .upload-section,
    [data-animation="off"] .analysis-options,
    [data-animation="off"] .results-container {
        opacity: 1 !important;
        transform: translateY(0) !important;
        animation: none !important;
    }
    
    [data-animation="off"] .upload-area::after {
        display: none !important;
    }
    
    [data-animation="off"] .loading-text {
        background: none !important;
        -webkit-text-fill-color: var(--secondary-text) !important;
        animation: none !important;
    }
    
    [data-animation="off"] .error-message {
        transform: translateX(0) !important;
        opacity: 1 !important;
        animation: none !important;
    }
    
    [data-animation="off"] .card:hover {
        transform: none !important;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05) !important;
    }
    
    [data-animation="off"] .ripple {
        display: none !important;
    }
    
    [data-animation="off"] .loading-spinner {
        border-top: 4px solid var(--primary-color) !important;
        animation: none !important;
    }

    .page-description {
        margin-bottom: 30px;
    }
    
    .description-content {
        position: relative;
    }
    
    .description-content p {
        margin-bottom: 15px;
        max-width: 80%;
    }

    .guide-btn-text {
        display: inline-block;
        flex: 1;
        text-align: center;
    }

    /* 强制显示类 - 确保结果始终可见 */
    .force-display {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 999 !important;
        pointer-events: auto !important;
    }

    /* 添加按钮波纹效果 */
    .ripple {
        position: absolute;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
    }
    
    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    /* 隐藏Plotly工具栏但保留悬停提示功能 */
    .modebar, .modebar-container {
        display: none !important;
    }
    
    /* 确保悬停提示显示正常 */
    .hoverlayer {
        pointer-events: auto !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* 美化悬停提示样式 */
    .hovertext, .hoverinfo {
        background-color: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        padding: 8px !important;
        font-size: 12px !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
    }

    /* 添加环比分析相关样式 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
    }
    
    .data-table th, .data-table td {
        padding: 10px;
        border: 1px solid var(--border-color);
        text-align: left;
    }
    
    .data-table th {
        background-color: rgba(var(--primary-color-rgb), 0.1);
        font-weight: 600;
    }
    
    .data-table tr:nth-child(even) {
        background-color: rgba(var(--primary-color-rgb), 0.03);
    }
    
    .positive-change {
        color: #e74c3c; /* 红色 - 上涨 */
        font-weight: 600;
    }
    
    .negative-change {
        color: #27ae60; /* 绿色 - 下跌 */
        font-weight: 600;
    }
    
    /* 添加上涨和下跌的纯色类，用于图表等元素 */
    .positive {
        color: #e74c3c; /* 红色 - 上涨 */
    }
    
    .negative {
        color: #27ae60; /* 绿色 - 下跌 */
    }
    
    .table-responsive {
        overflow-x: auto;
        margin-top: 20px;
        max-height: 400px; /* 添加最大高度限制 */
        overflow-y: auto; /* 添加垂直滚动 */
        border-radius: 8px; /* 添加圆角 */
        border: 1px solid var(--border-color); /* 添加边框 */
    }
    
    .no-data {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
    }
    
    .monthly-data-card, .mom-stats-container {
        margin-top: 25px;
    }
    
    .monthly-data-card .card-body {
        padding: 10px;
        max-height: 450px; /* 给表格容器设置最大高度 */
        overflow: hidden; /* 隐藏溢出内容 */
    }

    /* 添加同比分析相关样式 */
    .yoy-stats-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }
    
    .yearly-totals, .yoy-changes {
        flex: 1;
        min-width: 250px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .yearly-total-item, .yoy-change-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: rgba(var(--primary-color-rgb), 0.05);
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }
    
    .yearly-total-item:hover, .yoy-change-item:hover {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .year-label {
        font-weight: 500;
        color: var(--text-color);
    }
    
    .year-value {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 1.1em;
    }
    
    .yearly-data-card {
        margin-top: 25px;
    }
    
    .yoy-stats-container {
        margin-top: 25px;
    }

    /* 警告信息样式 */
    .warning-message {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #ffeeba;
        font-size: 14px;
        display: none;
    }

    /* 文本选中样式 */
    ::selection {
        background-color: var(--primary-color);
        color: white;
    }
    
    ::-moz-selection {
        background-color: var(--primary-color);
        color: white;
    }
    
    [data-theme="dark"] ::selection {
        background-color: rgba(var(--primary-color-rgb), 0.7);
        color: white;
    }
    
    [data-theme="dark"] ::-moz-selection {
        background-color: rgba(var(--primary-color-rgb), 0.7);
        color: white;
    }
    
    /* 自定义下拉框样式 */
    .custom-select-container {
        position: relative;
        width: 100%;
    }
    
    .custom-select-selected {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }
    
    .custom-select-selected:hover {
        border-color: var(--primary-color);
    }
    
    .custom-select-container.active .custom-select-selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
    }
    
    .custom-select-arrow {
        margin-left: 10px;
        transition: transform 0.2s ease;
    }
    
    .custom-select-container.active .custom-select-arrow {
        transform: rotate(180deg);
    }
    
    .custom-select-options {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 10;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
    }
    
    .custom-select-container.active .custom-select-options {
        max-height: 200px;
        opacity: 1;
        pointer-events: auto;
        overflow-y: auto;
    }
    
    .custom-select-option {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 14px;
    }
    
    .custom-select-option:hover {
        background-color: #e8f0fe;
    }
    
    [data-theme="dark"] .custom-select-option:hover {
        background-color: #3a3a3c;
    }
    
    [data-theme="warm"] .custom-select-option:hover {
        background-color: #fcecd6;
    }
    
    [data-theme="cool"] .custom-select-option:hover {
        background-color: #d9ebff;
    }
    
    [data-theme="nature"] .custom-select-option:hover {
        background-color: #d8f2d8;
    }
    
    [data-theme="tech"] .custom-select-option:hover {
        background-color: #e0f7fa;
    }
    
    .custom-select-option.selected {
        background-color: #c7dbfc;
        font-weight: 500;
    }
    
    [data-theme="dark"] .custom-select-option.selected {
        background-color: #454547;
        font-weight: 500;
    }
    
    [data-theme="warm"] .custom-select-option.selected {
        background-color: #f9d6b0;
        font-weight: 500;
    }
    
    [data-theme="cool"] .custom-select-option.selected {
        background-color: #b3d7ff;
        font-weight: 500;
    }
    
    [data-theme="nature"] .custom-select-option.selected {
        background-color: #b6e5b6;
        font-weight: 500;
    }
    
    [data-theme="tech"] .custom-select-option.selected {
        background-color: #b2ebf2;
        font-weight: 500;
    }
    
    /* 紫色系主题下拉框样式 */
    [data-theme="lavender"] .custom-select-option:hover {
        background-color: #f3e5f5;
    }
    
    [data-theme="lavender"] .custom-select-option.selected {
        background-color: #e1bee7;
        font-weight: 500;
    }
    
    /* 高对比主题下拉框样式 */
    [data-theme="contrast"] .custom-select-option:hover {
        background-color: #e6e6e6;
    }
    
    [data-theme="contrast"] .custom-select-option.selected {
        background-color: #cccccc;
        font-weight: 500;
    }

    .anomaly-reason {
        margin: 5px 0;
        color: var(--secondary-text);
    }

    .no-anomalies {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
    }
    
    /* 异常点检测规则说明弹出式小窗口样式 */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* 标题+提示组合的样式 */
    .header-with-note {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* 提示文字样式 */
    .note-text {
        font-size: 12px;
        color: var(--secondary-text);
        font-weight: normal;
        font-style: italic;
    }
    
    .anomaly-info-toggle {
        position: relative;
    }
    
    .anomaly-info-toggle i {
        font-size: 18px;
        color: var(--primary-color);
        cursor: pointer;
        background-color: rgba(var(--primary-color-rgb), 0.1);
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .anomaly-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    .anomaly-tooltip {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        width: 400px; /* 增加宽度从350px到400px */
        background-color: var(--card-background);
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        padding: 15px;
        z-index: 100;
        border: 1px solid var(--border-color);
        display: none;
        font-size: 13px;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
        max-height: 70vh; /* 限制最大高度不超过视口高度的70% */
    }
    
    .anomaly-tooltip.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        display: block;
    }
    
    .tooltip-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }
    
    .tooltip-content {
        margin: 0;
        padding-left: 15px;
        max-height: 250px; /* 添加最大高度限制 */
        overflow-y: auto; /* 添加垂直滚动条 */
        scrollbar-width: thin; /* Firefox滚动条样式 */
        scrollbar-color: var(--border-color) transparent; /* Firefox滚动条颜色 */
        padding-right: 5px; /* 为滚动条留出空间 */
    }
    
    /* 为Webkit浏览器添加自定义滚动条样式 */
    .tooltip-content::-webkit-scrollbar {
        width: 5px;
    }
    
    .tooltip-content::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .tooltip-content::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 5px;
    }
    
    [data-theme="dark"] .tooltip-content::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="contrast"] .tooltip-content::-webkit-scrollbar-thumb {
        background-color: #666;
    }
    
    .tooltip-content li {
        margin-bottom: 8px;
        line-height: 1.4;
    }
    
    .tooltip-content li:last-child {
        margin-bottom: 0;
    }
    
    /* 深色模式下的样式调整 */
    [data-theme="dark"] .anomaly-info-toggle i {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    [data-theme="dark"] .anomaly-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.3);
    }
    
    /* 高对比模式下的样式调整 */
    [data-theme="contrast"] .anomaly-info-toggle i {
        background-color: #e0e0e0;
    }
    
    [data-theme="contrast"] .anomaly-info-toggle i:hover {
        background-color: #cccccc;
    }

    .anomaly-reason {
        margin: 5px 0;
        color: var(--secondary-text);
    }

    .no-anomalies {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
    }
    
    /* 异常点检测结果容器样式 */
    #anomalies-content {
        max-height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }
    
    #anomalies-content::-webkit-scrollbar {
        width: 6px;
    }
    
    #anomalies-content::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #anomalies-content::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 6px;
    }
    
    [data-theme="dark"] #anomalies-content::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="contrast"] #anomalies-content::-webkit-scrollbar-thumb {
        background-color: #666;
    }

    /* 为"值列"添加的提示图标和工具提示 */
    .label-with-info {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    /* 确保与原有的label样式保持一致 */
    .option label,
    .label-with-info label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-color);
    }
    
    .label-with-info label {
        margin-bottom: 0; /* 覆盖.option label的margin-bottom */
        margin-right: 8px;
    }
    
    /* 删除不再需要的input-with-info样式 */
    .input-with-info {
        display: none;
    }
    
    .value-info-toggle {
        position: relative;
    }
    
    .value-info-toggle i {
        font-size: 16px;
        color: var(--primary-color);
        cursor: pointer;
        background-color: rgba(var(--primary-color-rgb), 0.1);
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .value-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    .value-tooltip {
        position: absolute;
        top: calc(100% + 10px);
        left: -8px;
        width: 350px;
        background-color: var(--card-background);
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        padding: 15px;
        z-index: 100;
        border: 1px solid var(--border-color);
        display: none;
        font-size: 13px;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
    }
    
    .value-tooltip.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        display: block;
    }
    
    .tooltip-content-simple {
        margin: 0;
        font-size: 12px;
        line-height: 1.5;
    }
    
    .tooltip-content-simple p {
        margin-bottom: 8px;
    }
    
    .tooltip-content-simple p:last-child {
        margin-bottom: 0;
    }
    
    /* 深色模式和高对比度模式下的样式 */
    [data-theme="dark"] .value-info-toggle i {
        background-color: rgba(var(--primary-color-rgb), 0.2);
    }
    
    [data-theme="dark"] .value-info-toggle i:hover {
        background-color: rgba(var(--primary-color-rgb), 0.3);
    }
    
    [data-theme="contrast"] .value-info-toggle i {
        background-color: #e0e0e0;
    }
    
    [data-theme="contrast"] .value-info-toggle i:hover {
        background-color: #cccccc;
    }

    /* 处理模式选项组特殊样式 */
    #processing-mode-group {
        display: flex;
        align-items: flex-start;
        gap: 20px;
    }
    
    /* 数据信息选项样式 */
    .data-info-option .info-text {
        padding: 11px 16px; /* 与select-input保持一致的内边距 */
        height: 47px; /* 与select-input保持一致的高度 */
        box-sizing: border-box;
        margin-top: 28px; 
    }
    
    /* 移动设备上的布局调整 */
    @media (max-width: 768px) {
        #processing-mode-group {
            flex-direction: column;
            align-items: stretch;
        }
        
        .info-text {
            margin-top: 0;
        }
    }

    /* 模态窗口样式 */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 9999; /* 提高z-index确保在最顶层 */
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.4);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal.active {
        opacity: 1;
        visibility: visible;
        display: block;
    }
    
    .modal-content {
        background-color: var(--card-background);
        margin: 15% auto;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        max-width: 500px;
        transform: translateY(-20px);
        transition: transform 0.3s;
        position: relative; /* 确保内容相对定位 */
    }
    
    .modal.active .modal-content {
        transform: translateY(0);
    }
    
    /* 确保模态窗口内按钮样式不受外部影响 */
    .modal .primary-button:hover,
    .modal .secondary-button:hover {
        transform: none; /* 防止悬停时的变换效果 */
        box-shadow: 0 0 0 1px var(--primary-color);
    }
    
    .modal-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: var(--text-color);
    }
    
    .close-modal {
        color: var(--secondary-text);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    .export-options {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    
    .export-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }
    
    .export-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .section-header {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
    }
    
    /* 复选框样式 */
    .checkbox-container {
        display: flex;
        align-items: center;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        font-size: 16px;
        user-select: none;
        color: var(--text-color);
    }
    
    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    
    .checkmark {
        position: absolute;
        left: 0;
        height: 22px;
        width: 22px;
        background-color: transparent;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .checkbox-container:hover input ~ .checkmark {
        border-color: var(--primary-color);
    }
    
    .checkbox-container input:checked ~ .checkmark {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }
    
    .checkbox-container input:checked ~ .checkmark:after {
        display: block;
    }
    
    .checkbox-container .checkmark:after {
        left: 7px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* 提示样式 */
    .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(30px);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 9999;
        font-size: 14px;
        opacity: 0;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    
    .toast.success {
        background-color: rgba(40, 167, 69, 0.9);
    }
    
    .toast.error {
        background-color: rgba(220, 53, 69, 0.9);
    }
    
    .toast .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 工作表选择模态窗口样式 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
    }

    .modal-content {
        background-color: var(--card-background);
        margin: auto;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        animation: slideIn 0.3s ease;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .modal-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--card-background);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .modal-body {
        padding: 20px;
        max-height: 50vh;
        overflow-y: auto;
        color: var(--text-color);
        background-color: var(--card-background);
    }

    .modal-footer {
        padding: 15px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid var(--border-color);
        background-color: var(--card-background);
    }

    .close-modal {
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--secondary-text);
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: var(--text-color);
    }

    .sheet-list {
        margin-top: 15px;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-background);
    }

    .sheet-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        color: var(--text-color);
    }

    .sheet-item:last-child {
        border-bottom: none;
    }

    .sheet-item:hover {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }

    .sheet-item.selected {
        background-color: rgba(var(--primary-color-rgb), 0.15);
        color: var(--primary-color);
        font-weight: 500;
    }

    .sheet-item input[type="radio"] {
        margin-right: 10px;
    }

    @keyframes slideIn {
        from {
            transform: translateY(-30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* 添加数据表格固定头部的样式 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead {
        position: sticky;
        top: 0;
        background-color: var(--card-background);
        z-index: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .data-table th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
    }
    
    .data-table td {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .data-table tbody tr:hover {
        background-color: rgba(var(--primary-color-rgb), 0.05);
    }
</style>

<!-- 接下来是模板的JavaScript部分 -->
<script src="{{ url_for('static', filename='js/html2canvas.min.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM 元素
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const removeFileBtn = document.getElementById('remove-file');
        const analysisOptions = document.getElementById('analysis-options');
        const dateColumnSelect = document.getElementById('date-column');
        const valueColumnSelect = document.getElementById('value-column');
        const analysisTypeSelect = document.getElementById('analysis-type');
        const timeGranularitySelect = document.getElementById('time-granularity');
        const analyzeBtn = document.getElementById('analyze-button');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const resultsContainer = document.getElementById('results-container');
        const exportResultsBtn = document.getElementById('export-results');
        const backToHomeBtn = document.getElementById('back-to-home');

        // 全局变量用于存储当前的fetch请求控制器
        let currentAnalysisFetchController = null;
        let currentCheckEligibilityFetchController = null;
        let currentSuggestionsFetchController = null;

        let selectedFile = null;
        let analysisResults = null;
        
        // 清除已有的保护间隔
        if (window.resultsProtectionInterval) {
            clearInterval(window.resultsProtectionInterval);
            window.resultsProtectionInterval = null;
        }
        
        // 停止已有的Observer
        if (window.resultsObserver) {
            window.resultsObserver.disconnect();
            window.resultsObserver = null;
            console.log('页面加载时停止已有的MutationObserver监控');
        }
        
        // 初始化分析状态
        window.isAnalyzing = false;
        
        // 主题处理函数
        function applyTheme() {
            // 从 localStorage 读取主题设置
            const theme = localStorage.getItem('theme') || 'light';
            
            // 应用主题
            document.documentElement.setAttribute('data-theme', theme);
            
            // 日志输出，方便调试
            console.log('应用主题:', theme);
        }
        
        // 动画设置处理函数
        function applyAnimationSetting() {
            // 从 localStorage 读取动画设置
            const animation = localStorage.getItem('animation') || 'on';
            
            // 应用动画设置
            document.documentElement.setAttribute('data-animation', animation);
            
            // 日志输出，方便调试
            console.log('应用动画设置:', animation);
        }
        
        // 页面加载时应用主题和动画设置
        applyTheme();
        applyAnimationSetting();
        
        // 确保处理模式选项可见
        document.getElementById('processing-mode-group').style.display = 'flex';
        
        // 监听设置变化
        window.addEventListener('storage', function(event) {
            if (event.key === 'theme') {
                applyTheme();
            }
            if (event.key === 'animation') {
                applyAnimationSetting();
            }
        });

        // 创建自定义下拉框
        function createCustomDropdowns() {
            // 获取所有下拉框
            const selects = document.querySelectorAll('.select-input');
            
            selects.forEach(select => {
                // 创建自定义下拉框容器
                const customSelectContainer = document.createElement('div');
                customSelectContainer.className = 'custom-select-container';
                customSelectContainer.dataset.for = select.id;
                
                // 创建选中项显示区域
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'custom-select-selected';
                
                // 获取当前选中项
                const selectedText = select.options[select.selectedIndex]?.text || '请选择';
                
                // 设置显示内容
                selectedDiv.innerHTML = `
                    <span class="custom-select-text">${selectedText}</span>
                    <i class="ri-arrow-down-s-line custom-select-arrow"></i>
                `;
                
                // 创建选项列表
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'custom-select-options';
                
                // 添加选项
                Array.from(select.options).forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    if (index === select.selectedIndex) {
                        optionDiv.classList.add('selected');
                    }
                    optionDiv.setAttribute('data-value', option.value);
                    optionDiv.textContent = option.text;
                    
                    // 选项点击事件
                    optionDiv.addEventListener('click', () => {
                        // 更新原始select的值
                        select.value = option.value;
                        
                        // 触发change事件
                        const event = new Event('change', { bubbles: true });
                        select.dispatchEvent(event);
                        
                        // 更新显示文本
                        selectedDiv.querySelector('.custom-select-text').textContent = option.text;
                        
                        // 更新选中状态
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        optionDiv.classList.add('selected');
                        
                        // 关闭下拉框
                        customSelectContainer.classList.remove('active');
                    });
                    
                    optionsDiv.appendChild(optionDiv);
                });
                
                // 点击显示/隐藏选项
                selectedDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 关闭其他打开的下拉框
                    document.querySelectorAll('.custom-select-container').forEach(container => {
                        if (container !== customSelectContainer) {
                            container.classList.remove('active');
                        }
                    });
                    
                    // 切换当前下拉框状态
                    customSelectContainer.classList.toggle('active');
                });
                
                // 添加元素到容器
                customSelectContainer.appendChild(selectedDiv);
                customSelectContainer.appendChild(optionsDiv);
                
                // 隐藏原始select
                select.style.display = 'none';
                
                // 将自定义下拉框插入到select之后
                select.parentNode.insertBefore(customSelectContainer, select.nextSibling);
                
                // 为原始select添加变更监听器，以便同步更新自定义下拉框
                select.addEventListener('change', () => {
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        selectedDiv.querySelector('.custom-select-text').textContent = selectedOption.text;
                        
                        // 更新选中样式
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            if (opt.getAttribute('data-value') === selectedOption.value) {
                                opt.classList.add('selected');
                            } else {
                                opt.classList.remove('selected');
                            }
                        });
                    }
                });
            });
            
            // 点击页面其他区域关闭下拉框
            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-select-container').forEach(container => {
                    container.classList.remove('active');
                });
            });
        }
        
        // 初始化自定义下拉框
        createCustomDropdowns();

        // 初始化异常点检测规则说明弹出窗口
        const anomalyInfoIcon = document.getElementById('anomaly-info-icon');
        const anomalyTooltip = document.getElementById('anomaly-tooltip');
        
        if (anomalyInfoIcon && anomalyTooltip) {
            // 点击图标时显示/隐藏弹出窗口
            anomalyInfoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 使用新的动画类切换显示状态
                if (anomalyTooltip.classList.contains('visible')) {
                    anomalyTooltip.classList.remove('visible');
                    // 等待动画结束后隐藏元素
                    setTimeout(() => {
                        anomalyTooltip.style.display = 'none';
                    }, 250); // 与CSS过渡时间一致
                } else {
                    // 先设置display以便动画可见
                    anomalyTooltip.style.display = 'block';
                    // 延迟一帧添加visible类以确保过渡动画生效
                    requestAnimationFrame(() => {
                        anomalyTooltip.classList.add('visible');
                    });
                }
            });
            
            // 点击弹出窗口内部时阻止事件冒泡
            anomalyTooltip.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 点击页面其他区域时隐藏弹出窗口
            document.addEventListener('click', () => {
                if (anomalyTooltip.classList.contains('visible')) {
                    anomalyTooltip.classList.remove('visible');
                    setTimeout(() => {
                        anomalyTooltip.style.display = 'none';
                    }, 250);
                }
            });
            
            // 按ESC键关闭弹出窗口
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && anomalyTooltip.classList.contains('visible')) {
                    anomalyTooltip.classList.remove('visible');
                    setTimeout(() => {
                        anomalyTooltip.style.display = 'none';
                    }, 250);
                }
            });
        }
        
        // 初始化值列均值说明弹出窗口
        const valueInfoIcon = document.getElementById('value-info-icon');
        const valueTooltip = document.getElementById('value-tooltip');
        
        if (valueInfoIcon && valueTooltip) {
            // 点击图标时显示/隐藏弹出窗口
            valueInfoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 使用新的动画类切换显示状态
                if (valueTooltip.classList.contains('visible')) {
                    valueTooltip.classList.remove('visible');
                    // 等待动画结束后隐藏元素
                    setTimeout(() => {
                        valueTooltip.style.display = 'none';
                    }, 250); // 与CSS过渡时间一致
                } else {
                    // 先设置display以便动画可见
                    valueTooltip.style.display = 'block';
                    // 延迟一帧添加visible类以确保过渡动画生效
                    requestAnimationFrame(() => {
                        valueTooltip.classList.add('visible');
                    });
                }
            });
            
            // 点击弹出窗口内部时阻止事件冒泡
            valueTooltip.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 点击页面其他区域时隐藏弹出窗口
            document.addEventListener('click', () => {
                if (valueTooltip.classList.contains('visible')) {
                    valueTooltip.classList.remove('visible');
                    setTimeout(() => {
                        valueTooltip.style.display = 'none';
                    }, 250);
                }
            });
            
            // 按ESC键关闭弹出窗口
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && valueTooltip.classList.contains('visible')) {
                    valueTooltip.classList.remove('visible');
                    setTimeout(() => {
                        valueTooltip.style.display = 'none';
                    }, 250);
                }
            });
        }

        // 返回主界面按钮点击事件
        backToHomeBtn.addEventListener('click', function() {
            window.location.href = '/';
        });

        // 初始化上传区域
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length) {
                handleFileSelection(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFileSelection(fileInput.files[0]);
            }
        });

        removeFileBtn.addEventListener('click', () => {
            // 存储当前进行的分析类型，以便发送取消请求
            const currentAnalysisType = analysisTypeSelect.value;
            
            // 无论是否在分析中，都发送取消信号到后端
            console.log('正在中断当前操作...');
            
            // 发送取消信号到后端
            fetch('/api/cancel_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    analysis_type: currentAnalysisType,
                    operation: 'file_preprocessing', // 标记为预处理阶段
                    timestamp: new Date().getTime()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('后端任务已成功取消');
                } else {
                    console.warn('取消后端任务失败:', data.message);
                }
            })
            .catch(error => {
                console.error('取消请求出错:', error);
            });
            
            // 中断当前的分析请求
            if (currentAnalysisFetchController) {
                currentAnalysisFetchController.abort();
                currentAnalysisFetchController = null;
            }
            
            // 中断当前的资格检查请求
            if (currentCheckEligibilityFetchController) {
                currentCheckEligibilityFetchController.abort();
                currentCheckEligibilityFetchController = null;
            }
            
            // 中断当前的建议请求
            if (currentSuggestionsFetchController) {
                currentSuggestionsFetchController.abort();
                currentSuggestionsFetchController = null;
            }
            
            // 隐藏加载提示
            loading.style.display = 'none';
            
            // 关闭可能打开的工作表选择模态窗口
            const sheetModal = document.getElementById('sheet-selection-modal');
            if (sheetModal && sheetModal.classList.contains('active')) {
                sheetModal.classList.remove('active');
            }
            
            console.log('已中断所有操作');
            
            // 重置分析状态
            window.isAnalyzing = false;
            
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            analysisOptions.style.display = 'none';
            dateColumnSelect.innerHTML = '<option value="">选择日期列</option>';
            valueColumnSelect.innerHTML = '<option value="">选择要分析的值列</option>';
            
            // 隐藏结果和错误信息
            resultsContainer.style.display = 'none';
            resultsContainer.classList.remove('force-display');
            errorMessage.style.display = 'none';
            
            // 清除结果保护
            if (window.resultsProtectionInterval) {
                clearInterval(window.resultsProtectionInterval);
            }
            
            // 停止Observer
            if (window.resultsObserver) {
                window.resultsObserver.disconnect();
            }
            
            if (window.bodyObserver) {
                window.bodyObserver.disconnect();
            }
            
            console.log('已停止所有监控');
            
            // 清除工作表相关缓存
            selectedSheetName = null;
            fileAnalysisData = null;
            console.log('已清除工作表缓存');
            
            // 恢复按钮状态
            enableAnalyzeButton();
            hideDataRequirementWarning();
        });

        // 分析按钮点击事件
        analyzeBtn.addEventListener('click', () => {
            const dateColumn = dateColumnSelect.value;
            const valueColumn = valueColumnSelect.value;
            const analysisType = analysisTypeSelect.value;
            const timeGranularity = timeGranularitySelect.value;
            const processingMode = document.getElementById('processing-mode').value;
            
            if (!selectedFile) {
                showError('请选择一个Excel文件');
                return;
            }
            
            if (!dateColumn) {
                showError('请选择日期列');
                return;
            }
            
            if (!valueColumn) {
                showError('请选择值列');
                return;
            }
            
            // 执行分析，传递选中的工作表
            analyzeData(selectedFile, dateColumn, valueColumn, analysisType, timeGranularity, processingMode, selectedSheetName);
        });
        
        // 按回车键启动分析
        document.addEventListener('keydown', (e) => {
            // 只有当按下回车键，并且分析设置区域可见时才触发
            if (e.key === 'Enter' && analysisOptions.style.display !== 'none') {
                // 确保光标不在input或textarea等输入框内
                if (document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA' &&
                    document.activeElement.tagName !== 'SELECT') {
                    
                    // 检查所有必需的字段
                    const dateColumn = dateColumnSelect.value;
                    const valueColumn = valueColumnSelect.value;
                    
                    if (selectedFile && dateColumn && valueColumn && !analyzeBtn.disabled) {
                        // 模拟点击分析按钮
                        analyzeBtn.click();
                        // 阻止默认行为
                        e.preventDefault();
                    }
                }
            }
        });

        // 分析类型改变事件
        analysisTypeSelect.addEventListener('change', () => {
            const analysisType = analysisTypeSelect.value;
            
            // 重置时间粒度选择器
            resetTimeGranularityOptions();
            
            // 根据分析类型显示/隐藏时间粒度选项
            if (analysisType === 'year_over_year') {
                // 同比分析固定为按月
                timeGranularitySelect.value = 'month';
                timeGranularitySelect.setAttribute('disabled', 'disabled');
                
                // 检查数据是否满足同比分析的条件
                if (selectedFile && dateColumnSelect.value) {
                    checkYearOverYearEligibility(selectedFile, dateColumnSelect.value);
                } else {
                    // 如果没有选择文件或日期列，则不进行检查
                    hideDataRequirementWarning();
                }
            } else if (analysisType === 'month_over_month') {
                // 环比分析可以使用不同粒度，但默认设置为按天
                timeGranularitySelect.removeAttribute('disabled');
                timeGranularitySelect.value = 'day';
                
                // 更新粒度选项的文本，使其更符合环比分析的命名
                updateTimeGranularityLabels(analysisType);
                
                hideDataRequirementWarning();
            } else {
                // 趋势分析，默认设置为按天
                timeGranularitySelect.removeAttribute('disabled');
                timeGranularitySelect.value = 'day';
                
                // 恢复原始选项文本
                updateTimeGranularityLabels(analysisType);
                
                hideDataRequirementWarning();
            }
            
            // 触发时间粒度变更事件，确保UI和设置同步
            const event = new Event('change');
            timeGranularitySelect.dispatchEvent(event);
            
            console.log(`分析类型已切换为: ${analysisType}, 时间粒度设置为: ${timeGranularitySelect.value}`);
        });
        
        // 辅助函数：重置时间粒度选择器选项
        function resetTimeGranularityOptions() {
            // 清除所有现有选项
            while (timeGranularitySelect.options.length > 0) {
                timeGranularitySelect.remove(0);
            }
            
            // 添加所有时间粒度选项
            const granularities = [
                {value: 'day', label: '按日'},
                {value: 'week', label: '按周'},
                {value: 'month', label: '按月'},
                {value: 'quarter', label: '按季度'},
                {value: 'year', label: '按年'}
            ];
            
            granularities.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = item.label;
                timeGranularitySelect.appendChild(option);
            });
        }
        
        // 辅助函数：根据分析类型更新时间粒度标签
        function updateTimeGranularityLabels(analysisType) {
            const options = timeGranularitySelect.options;
            
            for (let i = 0; i < options.length; i++) {
                const opt = options[i];
                const value = opt.value;
                
                if (analysisType === 'month_over_month') {
                    // 环比分析模式的标签
                    if (value === 'day') opt.textContent = '日环比';
                    else if (value === 'week') opt.textContent = '周环比';
                    else if (value === 'month') opt.textContent = '月环比';
                    else if (value === 'quarter') opt.textContent = '季环比';
                    else if (value === 'year') opt.textContent = '年环比';
                } else {
                    // 趋势分析或其他模式的标签
                    if (value === 'day') opt.textContent = '按日';
                    else if (value === 'week') opt.textContent = '按周';
                    else if (value === 'month') opt.textContent = '按月';
                    else if (value === 'quarter') opt.textContent = '按季度';
                    else if (value === 'year') opt.textContent = '按年';
                }
            }
        }

        // 日期列选择更改事件
        dateColumnSelect.addEventListener('change', () => {
            // 如果当前是同比分析，则检查数据是否满足条件
            if (analysisTypeSelect.value === 'year_over_year' && selectedFile && dateColumnSelect.value) {
                checkYearOverYearEligibility(selectedFile, dateColumnSelect.value);
            } else {
                hideDataRequirementWarning();
            }
        });
        
        // 检查数据是否满足同比分析的条件
        function checkYearOverYearEligibility(file, dateColumn) {
            if (!file || !dateColumn) {
                console.log('文件或日期列未选择，无法检查同比分析条件');
                return;
            }

            // 创建新的AbortController实例
            if (currentCheckEligibilityFetchController) {
                currentCheckEligibilityFetchController.abort(); // 中断之前的请求
            }
            currentCheckEligibilityFetchController = new AbortController();
            const signal = currentCheckEligibilityFetchController.signal;

            // 显示正在检查状态
            const warningDiv = document.querySelector('.data-requirement-warning') || createDataRequirementWarning();
            warningDiv.classList.add('checking');
            warningDiv.textContent = '正在检查数据是否满足同比分析要求...';
            warningDiv.style.display = 'block';
            
            // 创建FormData对象
            const formData = new FormData();
            formData.append('file', file);
            formData.append('date_column', dateColumn);
            
            // 添加工作表信息
            if (selectedSheetName) {
                formData.append('sheet_name', selectedSheetName);
            }
            
            // 发送请求以检查数据是否满足条件
            fetch('/api/check_year_over_year_eligibility', {
                method: 'POST',
                body: formData,
                signal: signal // 添加signal以支持中断
            })
            .then(response => response.json())
            .then(data => {
                currentCheckEligibilityFetchController = null; // 请求完成，清除controller引用
                warningDiv.classList.remove('checking');
                
                if (data.success) {
                    if (data.has_enough_data) {
                        console.log('数据满足同比分析要求');
                        hideDataRequirementWarning();
                        enableAnalyzeButton();
                    } else {
                        console.log('数据不满足同比分析要求');
                        warningDiv.textContent = '⚠️ 数据不足两年，无法进行同比分析。请选择其他分析类型或使用包含至少两年数据的文件。';
                        warningDiv.style.display = 'block';
                        disableAnalyzeButton();
                    }
                } else {
                    console.error('检查同比分析条件失败:', data.message);
                    warningDiv.textContent = '⚠️ 无法验证数据是否满足同比分析要求: ' + data.message;
                    warningDiv.style.display = 'block';
                    disableAnalyzeButton();
                }
            })
            .catch(error => {
                // 如果错误是由中断引起的，不显示错误信息
                if (error.name === 'AbortError') {
                    console.log('检查同比分析条件请求已中断');
                    return;
                }
                
                currentCheckEligibilityFetchController = null; // 请求出错，清除controller引用
                console.error('检查同比分析条件出错:', error);
                warningDiv.classList.remove('checking');
                warningDiv.textContent = '⚠️ 检查数据时出错: ' + error.message;
                warningDiv.style.display = 'block';
                disableAnalyzeButton();
            });
        }

        // 创建数据要求警告区域
        function createDataRequirementWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'data-requirement-warning';
            const optionsContainer = document.querySelector('.options-container');
            optionsContainer.insertBefore(warningDiv, document.getElementById('analyze-button'));
            return warningDiv;
        }

        // 隐藏数据要求警告
        function hideDataRequirementWarning() {
            const warningDiv = document.querySelector('.data-requirement-warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }

        // 禁用分析按钮
        function disableAnalyzeButton() {
            const analyzeButton = document.getElementById('analyze-button');
            analyzeButton.disabled = true;
            analyzeButton.classList.add('disabled');
            // 添加内联样式以确保禁用效果明显
            analyzeButton.style.backgroundColor = '#cccccc';
            analyzeButton.style.cursor = 'not-allowed';
            analyzeButton.style.opacity = '0.7';
            analyzeButton.style.pointerEvents = 'none';
        }

        // 启用分析按钮
        function enableAnalyzeButton() {
            const analyzeButton = document.getElementById('analyze-button');
            analyzeButton.disabled = false;
            analyzeButton.classList.remove('disabled');
            // 恢复原始样式
            analyzeButton.style.backgroundColor = 'var(--primary-color)';
            analyzeButton.style.cursor = 'pointer';
            analyzeButton.style.opacity = '1';
            analyzeButton.style.pointerEvents = 'auto';
        }
        
        // 处理文件选择
        function handleFileSelection(file) {
            // 验证文件类型
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('请选择Excel文件（.xlsx 或 .xls格式）');
                return;
            }
            
            // 创建新的AbortController实例
            if (currentSuggestionsFetchController) {
                currentSuggestionsFetchController.abort(); // 中断之前的请求
            }
            currentSuggestionsFetchController = new AbortController();
            const signal = currentSuggestionsFetchController.signal;
            
            selectedFile = file;
            fileName.textContent = file.name;
            uploadArea.style.display = 'none';
            fileInfo.style.display = 'flex';
            
            // 显示加载状态
            loading.style.display = 'block';
            analysisOptions.style.display = 'none';
            errorMessage.style.display = 'none';
            resultsContainer.style.display = 'none';
            
            // 分析文件，获取列信息和建议
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/get_analysis_suggestions', {
                method: 'POST',
                body: formData,
                signal: signal // 添加signal以支持中断
            })
            .then(response => {
                console.log('服务器响应状态:', response.status);
                return response.text().then(text => {
                    try {
                        // 尝试解析JSON
                        console.log('接收到的原始响应:', text);
                        
                        // 预处理JSON字符串，处理可能的NaN值
                        const cleanedText = text.replace(/:\s*NaN\s*([,}])/g, ': null$1')
                                              .replace(/:\s*Infinity\s*([,}])/g, ': null$1')
                                              .replace(/:\s*-Infinity\s*([,}])/g, ': null$1');
                        console.log('清理后的响应:', cleanedText);
                        
                        const data = JSON.parse(cleanedText);
                        console.log('解析后的完整JSON数据:', data);
                        console.log('行数信息:', data.row_count, '类型:', typeof data.row_count);
                        
                        // 确保row_count是数字
                        if (data.row_count !== undefined && data.row_count !== null) {
                            data.row_count = Number(data.row_count);
                            console.log('转换后的行数:', data.row_count, '类型:', typeof data.row_count);
                        }
                        
                        return data;
                    } catch (e) {
                        // 如果JSON解析失败，记录错误并显示原始文本
                        console.error('JSON解析失败:', e);
                        console.log('无法解析的响应文本:', text);
                        throw new Error('服务器返回的响应无法解析为JSON: ' + text);
                    }
                });
            })
            .then(data => {
                currentSuggestionsFetchController = null; // 请求完成，清除controller引用
                loading.style.display = 'none';
                
                if (data.success) {
                    // 检查是否有多个工作表
                    if (data.multiple_sheets && data.sheet_names && data.sheet_names.length > 1) {
                        // 保存当前数据供后续使用
                        fileAnalysisData = data;
                        
                        // 显示工作表选择模态窗口
                        showSheetSelectionModal(data.sheet_names, data.selected_sheet);
                    } else {
                        // 单个工作表，直接处理数据
                        processFileAnalysisData(data);
                    }
                } else {
                    showError(data.message || '分析文件时出错');
                }
            })
            .catch(error => {
                // 如果错误是由中断引起的，不显示错误信息
                if (error.name === 'AbortError') {
                    console.log('获取分析建议请求已中断');
                    return;
                }
                
                currentSuggestionsFetchController = null; // 请求出错，清除controller引用
                loading.style.display = 'none';
                showError('处理文件时出错: ' + error.message);
                console.error('处理文件时出错:', error);
            });
        }

        // 添加工作表选择相关功能
        let fileAnalysisData = null; // 保存文件分析数据
        let selectedSheetName = null; // 选中的工作表名

        // 显示工作表选择模态窗口
        function showSheetSelectionModal(sheetNames, selectedSheet) {
            // 更新选中的工作表
            selectedSheetName = selectedSheet;
            
            // 填充工作表列表
            const sheetList = document.getElementById('sheet-list');
            sheetList.innerHTML = '';
            
            sheetNames.forEach((sheet, index) => {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'sheet-item';
                if (sheet === selectedSheet || (index === 0 && !selectedSheet)) {
                    sheetItem.classList.add('selected');
                    selectedSheetName = sheet;
                }
                
                sheetItem.innerHTML = `
                    <input type="radio" name="sheet" id="sheet-${index}" value="${sheet}" 
                        ${sheet === selectedSheet || (index === 0 && !selectedSheet) ? 'checked' : ''}>
                    <label for="sheet-${index}">${sheet}</label>
                `;
                
                sheetItem.addEventListener('click', () => {
                    // 更新选中状态
                    document.querySelectorAll('.sheet-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    sheetItem.classList.add('selected');
                    
                    // 更新选中的工作表
                    const radio = sheetItem.querySelector('input[type="radio"]');
                    radio.checked = true;
                    selectedSheetName = radio.value;
                });
                
                sheetList.appendChild(sheetItem);
            });
            
            // 显示模态窗口
            document.getElementById('sheet-selection-modal').classList.add('active');
        }

        // 确认工作表选择
        document.getElementById('confirm-sheet-selection').addEventListener('click', () => {
            // 隐藏模态窗口
            document.getElementById('sheet-selection-modal').classList.remove('active');
            
            // 使用选中的工作表获取分析结果
            if (fileAnalysisData) {
                // 重新请求分析数据，但指定工作表
                loading.style.display = 'block';
                
                // 确保获取正确的选中工作表（从单选按钮获取）
                const selectedRadio = document.querySelector('input[name="sheet"]:checked');
                if (selectedRadio) {
                    selectedSheetName = selectedRadio.value;
                    console.log("确认选择的工作表:", selectedSheetName);
                    
                    // 更新文件名显示，添加工作表名称
                    updateFileNameWithSheet(selectedFile.name, selectedSheetName);
                }
                
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('sheet_name', selectedSheetName);
                
                console.log("发送工作表选择请求:", {
                    file: selectedFile.name,
                    sheet_name: selectedSheetName
                });
                
                fetch('/api/get_analysis_suggestions', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success) {
                        // 更新全局变量以正确保存选中的工作表
                        fileAnalysisData = data;
                        selectedSheetName = data.selected_sheet;
                        console.log("后端返回的工作表信息:", {
                            selectedSheet: selectedSheetName,
                            allSheets: data.sheet_names
                        });
                        
                        // 更新文件名显示，添加工作表名称
                        updateFileNameWithSheet(selectedFile.name, selectedSheetName);
                        
                        processFileAnalysisData(data);
                    } else {
                        showError(data.message || '分析工作表时出错');
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    showError('处理工作表时出错: ' + error.message);
                    console.error('处理工作表时出错:', error);
                });
            }
        });

        // 取消工作表选择
        document.getElementById('cancel-sheet-selection').addEventListener('click', () => {
            // 隐藏模态窗口
            document.getElementById('sheet-selection-modal').classList.remove('active');
            
            // 发送取消信号到后端，确保任何可能正在进行的预处理被终止
            fetch('/api/cancel_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'file_preprocessing',
                    timestamp: new Date().getTime()
                })
            }).catch(error => {
                console.error('取消预处理请求出错:', error);
            });
            
            // 清除已上传的文件并重置界面
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            analysisOptions.style.display = 'none';
            dateColumnSelect.innerHTML = '<option value="">选择日期列</option>';
            valueColumnSelect.innerHTML = '<option value="">选择要分析的值列</option>';
            
            // 清除工作表相关缓存
            selectedSheetName = null;
            fileAnalysisData = null;
            console.log('取消选择工作表，已清除文件和工作表缓存');
        });

        // 关闭工作表选择模态窗口（X按钮）
        document.querySelector('#sheet-selection-modal .close-modal').addEventListener('click', () => {
            // 隐藏模态窗口
            document.getElementById('sheet-selection-modal').classList.remove('active');
            
            // 发送取消信号到后端，确保任何可能正在进行的预处理被终止
            fetch('/api/cancel_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'file_preprocessing',
                    timestamp: new Date().getTime()
                })
            }).catch(error => {
                console.error('取消预处理请求出错:', error);
            });
            
            // 清除已上传的文件并重置界面
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            analysisOptions.style.display = 'none';
            dateColumnSelect.innerHTML = '<option value="">选择日期列</option>';
            valueColumnSelect.innerHTML = '<option value="">选择要分析的值列</option>';
            
            // 清除工作表相关缓存
            selectedSheetName = null;
            fileAnalysisData = null;
            console.log('关闭工作表选择窗口，已清除文件和工作表缓存');
        });

        // 更新文件名显示，添加工作表名称的辅助函数
        function updateFileNameWithSheet(fileName, sheetName) {
            if (!fileName || !sheetName) return;
            
            const fileNameElement = document.getElementById('file-name');
            if (fileNameElement) {
                // 使用标签样式区分文件名和工作表名
                fileNameElement.innerHTML = `
                    ${fileName} <span style="color:var(--primary-color); margin-left:5px; font-size:0.9em;">[${sheetName}]</span>
                `;
            }
        }

        // 处理文件分析数据
        function processFileAnalysisData(data) {
            // 更新文件名显示，添加工作表名称
            if (selectedFile && data.selected_sheet) {
                updateFileNameWithSheet(selectedFile.name, data.selected_sheet);
            }
            
            // 填充日期列选项
            dateColumnSelect.innerHTML = '<option value="">选择日期列</option>';
            data.date_columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                dateColumnSelect.appendChild(option);
            });
            
            // 填充值列选项
            valueColumnSelect.innerHTML = '<option value="">选择要分析的值列</option>';
            data.value_columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.name;
                option.textContent = `${column.name} (均值: ${formatNumber(column.avg)})`;
                valueColumnSelect.appendChild(option);
            });
            
            // 更新自定义下拉框
            // 首先移除现有的自定义下拉框
            document.querySelectorAll('.custom-select-container').forEach(container => {
                if (container.dataset.for === 'date-column' || container.dataset.for === 'value-column') {
                    container.remove();
                }
            });
            
            // 显示原始select以便重新创建自定义下拉框
            dateColumnSelect.style.display = '';
            valueColumnSelect.style.display = '';
            
            // 为这两个下拉框重新创建自定义下拉框
            [dateColumnSelect, valueColumnSelect].forEach(select => {
                // 创建自定义下拉框容器
                const customSelectContainer = document.createElement('div');
                customSelectContainer.className = 'custom-select-container';
                customSelectContainer.dataset.for = select.id;
                
                // 创建选中项显示区域
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'custom-select-selected';
                
                // 获取当前选中项
                const selectedText = select.options[select.selectedIndex]?.text || '请选择';
                
                // 设置显示内容
                selectedDiv.innerHTML = `
                    <span class="custom-select-text">${selectedText}</span>
                    <i class="ri-arrow-down-s-line custom-select-arrow"></i>
                `;
                
                // 创建选项列表
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'custom-select-options';
                
                // 添加选项
                Array.from(select.options).forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    if (index === select.selectedIndex) {
                        optionDiv.classList.add('selected');
                    }
                    optionDiv.setAttribute('data-value', option.value);
                    optionDiv.textContent = option.text;
                    
                    // 选项点击事件
                    optionDiv.addEventListener('click', () => {
                        // 更新原始select的值
                        select.value = option.value;
                        
                        // 触发change事件
                        const event = new Event('change', { bubbles: true });
                        select.dispatchEvent(event);
                        
                        // 更新显示文本
                        selectedDiv.querySelector('.custom-select-text').textContent = option.text;
                        
                        // 更新选中状态
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        optionDiv.classList.add('selected');
                        
                        // 关闭下拉框
                        customSelectContainer.classList.remove('active');
                    });
                    
                    optionsDiv.appendChild(optionDiv);
                });
                
                // 点击显示/隐藏选项
                selectedDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 关闭其他打开的下拉框
                    document.querySelectorAll('.custom-select-container').forEach(container => {
                        if (container !== customSelectContainer) {
                            container.classList.remove('active');
                        }
                    });
                    
                    // 切换当前下拉框状态
                    customSelectContainer.classList.toggle('active');
                });
                
                // 添加元素到容器
                customSelectContainer.appendChild(selectedDiv);
                customSelectContainer.appendChild(optionsDiv);
                
                // 隐藏原始select
                select.style.display = 'none';
                
                // 将自定义下拉框插入到select之后
                select.parentNode.insertBefore(customSelectContainer, select.nextSibling);
                
                // 为原始select添加变更监听器，以便同步更新自定义下拉框
                select.addEventListener('change', () => {
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        selectedDiv.querySelector('.custom-select-text').textContent = selectedOption.text;
                        
                        // 更新选中样式
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(opt => {
                            if (opt.getAttribute('data-value') === selectedOption.value) {
                                opt.classList.add('selected');
                            } else {
                                opt.classList.remove('selected');
                            }
                        });
                    }
                });
            });
            
            // 根据数据量选择默认处理模式
            const processingModeSelect = document.getElementById('processing-mode');
            
            // 使用后端提供的行数信息
            const rowCount = data.row_count || 0;
            console.log('后端返回的数据行数:', rowCount);

            // 添加数据量提示
            const infoText = document.querySelector('#processing-mode-group .info-text span');
            
            // 无论如何都显示处理模式提示
            if (rowCount > 10000) {
                console.log('数据量大于10000行，显示详细行数提示');
                processingModeSelect.value = 'auto';
                infoText.innerHTML = `<strong>检测到大数据集 (${formatNumber(rowCount)}行)</strong>，建议使用智能处理提高性能`;
            } else {
                console.log('数据量较小或未知，显示基本提示');
                infoText.innerHTML = `<strong>选择处理模式</strong>：大数据集建议使用智能处理`;
            }
            
            // 显示分析选项
            analysisOptions.style.display = 'block';
            
            // 确保处理模式选项可见
            document.getElementById('processing-mode-group').style.display = 'flex';
            
            // 如果当前选择的是同比分析，立即检查数据是否满足条件
            if (analysisTypeSelect.value === 'year_over_year' && dateColumnSelect.value) {
                setTimeout(() => {
                    console.log("文件加载后检查同比分析条件");
                    checkYearOverYearEligibility(selectedFile, dateColumnSelect.value);
                }, 300); // 短暂延迟确保DOM更新
            } else {
                // 确保任何可能的警告被清除
                hideDataRequirementWarning();
                enableAnalyzeButton();
            }
        }

        // 执行数据分析
        function analyzeData(file, dateColumn, valueColumn, analysisType, timeGranularity, processingMode, sheetName) {
            // 如果是同比分析，再次检查数据条件
            if (analysisType === 'year_over_year') {
                checkYearOverYearEligibility(file, dateColumn);
                // 检查之后，会自动禁用或启用分析按钮
                return;
            }
            
            // 创建新的AbortController实例
            if (currentAnalysisFetchController) {
                currentAnalysisFetchController.abort(); // 中断之前的请求
            }
            currentAnalysisFetchController = new AbortController();
            const signal = currentAnalysisFetchController.signal;
            
            // 显示加载状态
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            resultsContainer.style.display = 'none';
            
            // 标记分析正在进行中
            window.isAnalyzing = true;
            
            // 滚动到加载提示区域，让用户可以看到"正在分析"状态
            setTimeout(() => {
                loading.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('date_column', dateColumn);
            formData.append('value_column', valueColumn);
            formData.append('analysis_type', analysisType);
            formData.append('time_granularity', timeGranularity);
            formData.append('processing_mode', processingMode);
            
            // 添加工作表信息
            if (sheetName) {
                formData.append('sheet_name', sheetName);
            }
            
            fetch('/api/analyze_sales_trend', {
                method: 'POST',
                body: formData,
                signal: signal // 添加signal以支持中断
            })
            .then(response => {
                console.log('分析API响应状态:', response.status);
                return response.text().then(text => {
                    try {
                        // 尝试解析JSON
                        console.log('分析API原始响应:', text);
                        
                        // 预处理JSON字符串，处理可能的NaN值
                        const cleanedText = text.replace(/:\s*NaN\s*([,}])/g, ': null$1');
                        console.log('清理后的响应:', cleanedText);
                        
                        const data = JSON.parse(cleanedText);
                        console.log('分析API解析后的JSON数据:', data);
                        return data;
                    } catch (e) {
                        // 如果JSON解析失败，记录错误并显示原始文本
                        console.error('分析API的JSON解析失败:', e);
                        console.log('分析API无法解析的响应文本:', text);
                        throw new Error('服务器返回的响应无法解析为JSON: ' + text);
                    }
                });
            })
            .then(data => {
                currentAnalysisFetchController = null; // 请求完成，清除controller引用
                loading.style.display = 'none';
                // 分析已完成，重置分析状态
                window.isAnalyzing = false;
                
                if (data.success) {
                    // 保存分析结果
                    analysisResults = data.data;
                    
                    // 显示结果
                    displayResults(analysisResults, analysisType, valueColumn);
                } else {
                    showError(data.message || '分析失败');
                }
            })
            .catch(error => {
                // 如果错误是由中断引起的，不显示错误信息
                if (error.name === 'AbortError') {
                    console.log('分析请求已中断');
                    return;
                }
                
                currentAnalysisFetchController = null; // 请求出错，清除controller引用
                loading.style.display = 'none';
                // 分析已完成或出错，重置分析状态
                window.isAnalyzing = false;
                showError('分析数据时出错: ' + error.message);
            });
        }

        // 显示分析结果
        function displayResults(results, analysisType, valueColumn) {
            // 清除旧的图表
            document.getElementById('trend-chart').innerHTML = '';
            document.getElementById('stats-content').innerHTML = '';
            document.getElementById('anomalies-content').innerHTML = '';
            
            // 根据分析类型显示/隐藏相关部分
            document.getElementById('yoy-section').style.display = analysisType === 'year_over_year' ? 'block' : 'none';
            document.getElementById('mom-section').style.display = analysisType === 'month_over_month' ? 'block' : 'none';
            document.getElementById('decomposition-section').style.display = results.decomposition ? 'block' : 'none';
            
            // 处理环比分析时趋势卡片的显示
            const trendCard = document.querySelector('.trend-card');
            if (analysisType === 'month_over_month') {
                trendCard.style.display = 'none'; // 环比分析时隐藏趋势图卡片
            } else {
                trendCard.style.display = 'block'; // 其他分析类型显示趋势图卡片
            }
            
            if (analysisType === 'year_over_year') {
                document.getElementById('yoy-chart').innerHTML = '';
                document.getElementById('yoy-growth-chart').innerHTML = '';
            } else if (analysisType === 'month_over_month') {
                document.getElementById('mom-chart').innerHTML = '';
                document.getElementById('mom-growth-chart').innerHTML = '';
            }
            
            if (results.decomposition) {
                document.getElementById('trend-component').innerHTML = '';
                document.getElementById('seasonal-component').innerHTML = '';
                document.getElementById('residual-component').innerHTML = '';
            }
            
            // 显示趋势图
            if (results.chart) {
                // 环比分析不显示趋势图
                if (analysisType !== 'month_over_month') {
                    const chartConfig = {
                        displayModeBar: false, // 禁用模式栏（包含放大、缩小、截图等功能）
                        responsive: true,
                        scrollZoom: false,     // 禁用滚轮缩放
                        staticPlot: false      // 设为false以保留悬停功能
                    };
                    
                    // 解析图表数据
                    const chartData = JSON.parse(results.chart);
                    
                    // 修改图表布局，强制禁用模式栏但保留悬停
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.showlegend = true;
                    layout.hovermode = 'closest';
                    layout.uirevision = false;
                    
                    // 确保悬停模板正确设置
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            trace.showlegend = true;
                            // 保留或设置悬停模板
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('trend-chart', chartData.data, layout, chartConfig);
                    
                    // 添加延迟触发window.resize事件，确保图表能够正确调整大小以填满容器
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                } else {
                    // 清空趋势图区域
                    document.getElementById('trend-chart').innerHTML = '';
                    // 隐藏趋势图卡片
                    document.querySelector('.trend-card').style.display = 'none';
                }
            }
            
            // 显示统计数据
            if (results.stats) {
                const statsContent = document.getElementById('stats-content');
                const stats = results.stats;
                
                if (analysisType === 'trend') {
                    // 获取当前选择的时间粒度
                    const timeGranularity = document.getElementById('time-granularity').value;
                    
                    // 检查最小值和最大值是否为有效数据
                    const hasValidMax = stats.max && 
                                       stats.max.value != null && 
                                       !isNaN(stats.max.value) && 
                                       stats.max.date != null && 
                                       stats.max.date !== "None" && 
                                       stats.max.date !== "null";
                    
                    const hasValidMin = stats.min && 
                                       stats.min.value != null && 
                                       !isNaN(stats.min.value) && 
                                       stats.min.date != null && 
                                       stats.min.date !== "None" && 
                                       stats.min.date !== "null";
                    
                    // 格式化日期显示，根据时间粒度调整
                    let formatMaxDate = hasValidMax ? stats.max.date : '';
                    let formatMinDate = hasValidMin ? stats.min.date : '';
                    
                    // 根据时间粒度调整日期格式
                    if (timeGranularity === 'week') {
                        // 如果是周粒度，格式化为xxxx年x周（xx月xx日-xx月xx日）
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            try {
                                const date = new Date(formatMaxDate);
                                if (!isNaN(date.getTime())) {
                                    // 获取年份
                                    const year = date.getFullYear();
                                    
                                    // 计算周数 - 使用ISO周
                                    const getWeekNumber = (d) => {
                                        // ISO周从周一开始，周日为7
                                        const date = new Date(d.getTime());
                                        date.setHours(0, 0, 0, 0);
                                        // 设置为周四（ISO周的定义是周四所在的周）
                                        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                                        // 一月四日肯定在第一周
                                        const firstWeek = new Date(date.getFullYear(), 0, 4);
                                        // 调整到周四
                                        firstWeek.setDate(firstWeek.getDate() + 3 - (firstWeek.getDay() + 6) % 7);
                                        // 计算周差
                                        const weekNumber = Math.round(((date.getTime() - firstWeek.getTime()) / 86400000 - 3 + (firstWeek.getDay() + 6) % 7) / 7) + 1;
                                        return weekNumber;
                                    };
                                    
                                    const weekNumber = getWeekNumber(date);
                                    
                                    // 计算所在周的开始日期（周一）和结束日期（周日）
                                    const getWeekDates = (d) => {
                                        const date = new Date(d.getTime());
                                        // 获取当前是周几（0是周日，1是周一，...，6是周六）
                                        const day = date.getDay();
                                        // 计算到周一的日期差
                                        const diff = day === 0 ? -6 : 1 - day; // 如果是周日，需要减6天，否则就是1-day
                                        
                                        // 设置为当周的周一
                                        const monday = new Date(date.getTime());
                                        monday.setDate(date.getDate() + diff);
                                        
                                        // 设置为当周的周日
                                        const sunday = new Date(monday.getTime());
                                        sunday.setDate(monday.getDate() + 6);
                                        
                                        return { monday, sunday };
                                    };
                                    
                                    const { monday, sunday } = getWeekDates(date);
                                    
                                    // 格式化日期为"月日"
                                    const formatMonthDay = (d) => {
                                        return `${d.getMonth() + 1}月${d.getDate()}日`;
                                    };
                                    
                                    // 根据后端格式获取正确的周数，保持周数不变
                                    // 尝试从formatMaxDate中提取周数信息
                                    let extractedWeekNum = weekNumber;
                                    if (formatMaxDate.includes('年') && formatMaxDate.includes('周')) {
                                        const weekMatch = formatMaxDate.match(/(\d+)年(?:第)?(\d+)周/);
                                        if (weekMatch && weekMatch.length === 3) {
                                            extractedWeekNum = parseInt(weekMatch[2], 10);
                                        }
                                    }
                                    
                                    // 计算上一周的日期范围
                                    const prevMonday = new Date(monday.getTime());
                                    prevMonday.setDate(monday.getDate() - 6);
                                    
                                    const prevSunday = new Date(sunday.getTime());
                                    prevSunday.setDate(sunday.getDate() - 6);
                                    
                                    // 使用指定格式，保持周数不变
                                    formatMaxDate = `${year}年${extractedWeekNum}周（${formatMonthDay(prevMonday)}-${formatMonthDay(prevSunday)}）`;
                                }
                            } catch (e) {
                                console.error('格式化周日期失败:', e);
                            }
                        }
                        
                        if (hasValidMin && formatMinDate.includes('-')) {
                            try {
                                const date = new Date(formatMinDate);
                                if (!isNaN(date.getTime())) {
                                    // 获取年份
                                    const year = date.getFullYear();
                                    
                                    // 计算周数 - 使用ISO周
                                    const getWeekNumber = (d) => {
                                        // ISO周从周一开始，周日为7
                                        const date = new Date(d.getTime());
                                        date.setHours(0, 0, 0, 0);
                                        // 设置为周四（ISO周的定义是周四所在的周）
                                        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                                        // 一月四日肯定在第一周
                                        const firstWeek = new Date(date.getFullYear(), 0, 4);
                                        // 调整到周四
                                        firstWeek.setDate(firstWeek.getDate() + 3 - (firstWeek.getDay() + 6) % 7);
                                        // 计算周差
                                        const weekNumber = Math.round(((date.getTime() - firstWeek.getTime()) / 86400000 - 3 + (firstWeek.getDay() + 6) % 7) / 7) + 1;
                                        return weekNumber;
                                    };
                                    
                                    const weekNumber = getWeekNumber(date);
                                    
                                    // 计算所在周的开始日期（周一）和结束日期（周日）
                                    const getWeekDates = (d) => {
                                        const date = new Date(d.getTime());
                                        // 获取当前是周几（0是周日，1是周一，...，6是周六）
                                        const day = date.getDay();
                                        // 计算到周一的日期差
                                        const diff = day === 0 ? -6 : 1 - day; // 如果是周日，需要减6天，否则就是1-day
                                        
                                        // 设置为当周的周一
                                        const monday = new Date(date.getTime());
                                        monday.setDate(date.getDate() + diff);
                                        
                                        // 设置为当周的周日
                                        const sunday = new Date(monday.getTime());
                                        sunday.setDate(monday.getDate() + 6);
                                        
                                        return { monday, sunday };
                                    };
                                    
                                    const { monday, sunday } = getWeekDates(date);
                                    
                                    // 格式化日期为"月日"
                                    const formatMonthDay = (d) => {
                                        return `${d.getMonth() + 1}月${d.getDate()}日`;
                                    };
                                    
                                    // 根据后端格式获取正确的周数，保持周数不变
                                    // 尝试从formatMinDate中提取周数信息
                                    let extractedWeekNum = weekNumber;
                                    if (formatMinDate.includes('年') && formatMinDate.includes('周')) {
                                        const weekMatch = formatMinDate.match(/(\d+)年(?:第)?(\d+)周/);
                                        if (weekMatch && weekMatch.length === 3) {
                                            extractedWeekNum = parseInt(weekMatch[2], 10);
                                        }
                                    }
                                    
                                    // 计算上一周的日期范围
                                    const prevMonday = new Date(monday.getTime());
                                    prevMonday.setDate(monday.getDate() - 6);
                                    
                                    const prevSunday = new Date(sunday.getTime());
                                    prevSunday.setDate(sunday.getDate() - 6);
                                    
                                    // 使用指定格式，保持周数不变
                                    formatMinDate = `${year}年${extractedWeekNum}周（${formatMonthDay(prevMonday)}-${formatMonthDay(prevSunday)}）`;
                                }
                            } catch (e) {
                                console.error('格式化周日期失败:', e);
                            }
                        }
                    } else if (timeGranularity === 'month') {
                        // 如果是月度粒度，格式化为年月
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            const dateParts = formatMaxDate.split('-');
                            if (dateParts.length >= 2) {
                                formatMaxDate = `${dateParts[0]}年${dateParts[1]}月`;
                            }
                        }
                        if (hasValidMin && formatMinDate.includes('-')) {
                            const dateParts = formatMinDate.split('-');
                            if (dateParts.length >= 2) {
                                formatMinDate = `${dateParts[0]}年${dateParts[1]}月`;
                            }
                        }
                    } else if (timeGranularity === 'quarter') {
                        // 如果是季度粒度，格式化为年季度
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            const dateParts = formatMaxDate.split('-');
                            if (dateParts.length >= 2) {
                                const month = parseInt(dateParts[1]);
                                const quarter = Math.ceil(month / 3);
                                formatMaxDate = `${dateParts[0]}年Q${quarter}`;
                            }
                        }
                        if (hasValidMin && formatMinDate.includes('-')) {
                            const dateParts = formatMinDate.split('-');
                            if (dateParts.length >= 2) {
                                const month = parseInt(dateParts[1]);
                                const quarter = Math.ceil(month / 3);
                                formatMinDate = `${dateParts[0]}年Q${quarter}`;
                            }
                        }
                    } else if (timeGranularity === 'year') {
                        // 如果是年度粒度，只显示年份
                        if (hasValidMax && formatMaxDate.includes('-')) {
                            formatMaxDate = formatMaxDate.split('-')[0] + '年';
                        }
                        if (hasValidMin && formatMinDate.includes('-')) {
                            formatMinDate = formatMinDate.split('-')[0] + '年';
                        }
                    }
                    
                    // 格式化最高值和最低值的显示
                    const maxValueDisplay = hasValidMax ? 
                        `${formatNumber(stats.max.value)} (${formatMaxDate})` : 
                        '无数据';
                    
                    // 最低值应显示实际的最低值，包括0，但不包括填充的或缺失的数据
                    const minValueDisplay = hasValidMin ? 
                        `${formatNumber(stats.min.value)} (${formatMinDate})` : 
                        '无数据';
                    
                    statsContent.innerHTML = `
                        <div class="stats-item">
                            <div class="stats-label">总${valueColumn}</div>
                            <div class="stats-value">${formatNumber(stats.total)}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">平均${valueColumn}</div>
                            <div class="stats-value">${formatNumber(stats.average)}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">最高${valueColumn}</div>
                            <div class="stats-value">${maxValueDisplay}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">最低${valueColumn}</div>
                            <div class="stats-value">${minValueDisplay}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">总体增长率</div>
                            <div class="stats-value">${formatNumber(stats.growth_rate)}%</div>
                        </div>
                    `;
                } else if (analysisType === 'year_over_year') {
                    let statsHtml = '';
                    
                    // 获取当前选择的时间粒度
                    const timeGranularity = document.getElementById('time-granularity').value;
                    
                    // 根据时间粒度设置标题文本
                    let timeUnitTitle = '年度';
                    let timeUnitSuffix = '年';
                    
                    if (timeGranularity === 'day') {
                        timeUnitTitle = '日期';
                        timeUnitSuffix = '日';  // 保留后缀，但后面会特殊处理日期显示
                    } else if (timeGranularity === 'week') {
                        timeUnitTitle = '周度';
                        timeUnitSuffix = '周';
                    } else if (timeGranularity === 'month') {
                        timeUnitTitle = '月度';
                        timeUnitSuffix = '月';
                    } else if (timeGranularity === 'quarter') {
                        timeUnitTitle = '季度';
                        timeUnitSuffix = '季';
                    }
                    
                    // 总计
                    if (stats.yearly_totals && Object.keys(stats.yearly_totals).length > 0) {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}总计</h4>`;
                        for (const [period, total] of Object.entries(stats.yearly_totals)) {
                            // 修复日期格式，对于日粒度需要特殊处理
                            let periodLabel = timeGranularity === 'day' ? 
                                `${period}年` : `${period}${timeUnitSuffix}`;
                            
                            statsHtml += `
                                <div class="stats-item">
                                    <div class="stats-label">${periodLabel}</div>
                                    <div class="stats-value">${formatNumber(total)}</div>
                                </div>
                            `;
                        }
                        statsHtml += '</div>';
                    } else {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}总计</h4><div class="no-data">暂无数据</div></div>`;
                    }
                    
                    // 同比变化
                    if (stats.yoy_changes && Object.keys(stats.yoy_changes).length > 0) {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}同比变化</h4>`;
                        for (const [period, change] of Object.entries(stats.yoy_changes)) {
                            // 修复日期格式，对于日粒度需要特殊处理
                            let periodLabel = timeGranularity === 'day' ? 
                                `${period}年` : `${period}${timeUnitSuffix}`;
                            
                            statsHtml += `
                                <div class="stats-item">
                                    <div class="stats-label">${periodLabel}</div>
                                    <div class="stats-value ${change >= 0 ? 'positive' : 'negative'}">${formatNumber(change)}%</div>
                                </div>
                            `;
                        }
                        statsHtml += '</div>';
                    } else {
                        statsHtml += `<div class="stats-group"><h4>${timeUnitTitle}同比变化</h4><div class="no-data">暂无同比数据或数据不足以计算同比</div></div>`;
                    }
                    
                    statsContent.innerHTML = statsHtml;
                } else if (analysisType === 'month_over_month') {
                    // 获取周期类型，用于显示
                    const periodType = stats.period_type || '月';
                    
                    // 格式化环比时间显示，特别处理周格式
                    function formatMoMPeriod(periodText) {
                        if (!periodText) return '';
                        
                        // 检查是否是周格式，但不包含日期范围
                        if (periodText.includes('周') && !periodText.includes('月')) {
                            // 只有简单的"2025年第5周"格式，需要修改
                            const match = periodText.match(/(\d{4})年第(\d+)周/);
                            if (match) {
                                // 返回原始格式，后端已经修改为"xxxx年x周（x月x日-x月x日）"的格式
                                return periodText;
                            }
                        }
                        
                        return periodText;
                    }
                    
                    statsContent.innerHTML = `
                        <div class="stats-item">
                            <div class="stats-label">增长${periodType}数</div>
                            <div class="stats-value">${stats.positive_changes}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">下降${periodType}数</div>
                            <div class="stats-value">${stats.negative_changes}</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">平均环比变化</div>
                            <div class="stats-value ${stats.average_change >= 0 ? 'positive' : 'negative'}">${formatNumber(stats.average_change)}%</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">最大增长</div>
                            <div class="stats-value positive">${formatNumber(stats.max_increase.value)}% (${formatMoMPeriod(stats.max_increase.period)})</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-label">最大下降</div>
                            <div class="stats-value negative">${formatNumber(stats.max_decrease.value)}% (${formatMoMPeriod(stats.max_decrease.period)})</div>
                        </div>
                    `;
                }
            }
            
            // 显示异常点
            if (results.anomalies) {
                const anomaliesContent = document.getElementById('anomalies-content');
                
                if (results.anomalies.length === 0) {
                    anomaliesContent.innerHTML = `<div class="no-anomalies">未检测到显著异常点</div>`;
                } else {
                    let anomaliesHtml = '';
                    
                    results.anomalies.forEach(anomaly => {
                        let reasonsHtml = '';
                        anomaly.reasons.forEach(reason => {
                            reasonsHtml += `<div class="anomaly-reason">• ${reason}</div>`;
                        });
                        
                        anomaliesHtml += `
                            <div class="anomaly-item">
                                <div class="anomaly-header">
                                    <div class="anomaly-date">${anomaly.date}</div>
                                    <div class="anomaly-value">${formatNumber(anomaly.value)} (${anomaly.direction})</div>
                                </div>
                                <div class="anomaly-reasons">
                                    ${reasonsHtml}
                                </div>
                            </div>
                        `;
                    });
                    
                    anomaliesContent.innerHTML = anomaliesHtml;
                }
            }
            
            // 显示同比分析图表
            if (analysisType === 'year_over_year') {
                if (results.chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // 设为false以保留悬停功能
                    };
                    
                    // 解析图表数据
                    const chartData = JSON.parse(results.chart);
                    
                    // 修改图表布局，强制禁用模式栏
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // 确保悬停功能
                    
                    // 确保悬停模板设置
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('yoy-chart', chartData.data, layout, chartConfig);
                }
                
                if (results.yoy_chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // 设为false以保留悬停功能
                    };
                    
                    // 解析图表数据
                    const chartData = JSON.parse(results.yoy_chart);
                    
                    // 修改图表布局，强制禁用模式栏
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // 确保悬停功能
                    
                    // 确保悬停模板设置
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('yoy-growth-chart', chartData.data, layout, chartConfig);
                    
                    // 添加延迟触发window.resize事件，确保图表能够正确调整大小以填满容器
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                }
                
                // 显示同比分析统计数据
                if (results.stats) {
                    const stats = results.stats;
                    
                    // 生成年度总额表格HTML
                    let yearlyTotalsHTML = '';
                    if (stats.yearly_totals) {
                        const years = Object.keys(stats.yearly_totals).sort();
                        yearlyTotalsHTML = '<div class="yearly-totals">';
                        
                        years.forEach(year => {
                            yearlyTotalsHTML += `
                                <div class="yearly-total-item">
                                    <div class="year-label">${year}年总值</div>
                                    <div class="year-value">${formatNumber(stats.yearly_totals[year])}</div>
                                </div>
                            `;
                        });
                        
                        yearlyTotalsHTML += '</div>';
                    }
                    
                    // 生成同比增长率HTML
                    let yoyChangesHTML = '';
                    if (stats.yoy_changes) {
                        const years = Object.keys(stats.yoy_changes).sort();
                        yoyChangesHTML = '<div class="yoy-changes">';
                        
                        years.forEach(year => {
                            const changeValue = stats.yoy_changes[year];
                            const changeClass = changeValue > 0 ? 'positive-change' : (changeValue < 0 ? 'negative-change' : '');
                            
                            yoyChangesHTML += `
                                <div class="yoy-change-item">
                                    <div class="year-label">${year}年同比增长率</div>
                                    <div class="year-value ${changeClass}">${formatNumber(changeValue)}%</div>
                                </div>
                            `;
                        });
                        
                        yoyChangesHTML += '</div>';
                    }
                    
                    // 组合所有统计数据
                    const statsHTML = `
                        <div class="yoy-stats-wrapper">
                            ${yearlyTotalsHTML}
                            ${yoyChangesHTML}
                        </div>
                    `;
                    
                    document.getElementById('yoy-stats').innerHTML = statsHTML;
                }
                
                // 显示同比数据表格
                if (results.pivot_data) {
                    // 获取所有年份（排除以_yoy结尾的键）
                    const years = Object.keys(results.pivot_data)
                        .filter(key => !key.endsWith('_yoy'))
                        .sort();
                    
                    // 获取所有月份（从任意年份中提取）
                    const months = [];
                    if (years.length > 0) {
                        const firstYear = years[0];
                        months.push(...Object.keys(results.pivot_data[firstYear]));
                    }
                    
                    // 创建表格HTML
                    if (months.length > 0) {
                        let tableHTML = `
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>月份</th>
                        `;
                        
                        // 为每一年添加列标题
                        years.forEach(year => {
                            tableHTML += `<th>${year}年</th>`;
                        });
                        
                        // 如果有同比增长率数据，添加对应的列
                        const hasYoyData = years.length > 1 && Object.keys(results.pivot_data).some(key => key.endsWith('_yoy'));
                        if (hasYoyData) {
                            // 排除第一年，因为没有同比增长率
                            years.slice(1).forEach(year => {
                                tableHTML += `<th>${year}年同比</th>`;
                            });
                        }
                        
                        tableHTML += `
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        // 为每个月添加数据行
                        months.forEach(month => {
                            tableHTML += `
                                <tr>
                                    <td>${month}</td>
                            `;
                            
                            // 添加每年该月的值
                            years.forEach(year => {
                                const value = results.pivot_data[year][month];
                                tableHTML += `<td>${formatNumber(value)}</td>`;
                            });
                            
                            // 添加同比增长率（如果有）
                            if (hasYoyData) {
                                years.slice(1).forEach(year => {
                                    const yoyKey = `${year}_yoy`;
                                    let yoyValue = '';
                                    let changeClass = '';
                                    
                                    if (results.pivot_data[yoyKey] && results.pivot_data[yoyKey][month] !== undefined) {
                                        const yoyVal = results.pivot_data[yoyKey][month];
                                        yoyValue = `${formatNumber(yoyVal)}%`;
                                        changeClass = yoyVal > 0 ? 'positive-change' : (yoyVal < 0 ? 'negative-change' : '');
                                    }
                                    
                                    tableHTML += `<td class="${changeClass}">${yoyValue}</td>`;
                                });
                            }
                            
                            tableHTML += `
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        document.getElementById('yoy-yearly-data').innerHTML = tableHTML;
                    } else {
                        document.getElementById('yoy-yearly-data').innerHTML = '<div class="no-data">没有同比数据可显示</div>';
                    }
                } else {
                    document.getElementById('yoy-yearly-data').innerHTML = '<div class="no-data">没有同比数据可显示</div>';
                }
            }
            
            // 显示环比分析图表
            if (analysisType === 'month_over_month') {
                if (results.chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // 设为false以保留悬停功能
                    };
                    
                    // 解析图表数据
                    const chartData = JSON.parse(results.chart);
                    
                    // 修改图表布局，强制禁用模式栏
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // 确保悬停功能
                    
                    // 确保悬停模板设置
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('mom-chart', chartData.data, layout, chartConfig);
                }
                
                if (results.mom_chart) {
                    const chartConfig = {
                        displayModeBar: false,
                        responsive: true,
                        scrollZoom: false,
                        staticPlot: false // 设为false以保留悬停功能
                    };
                    
                    // 解析图表数据
                    const chartData = JSON.parse(results.mom_chart);
                    
                    // 修改图表布局，强制禁用模式栏
                    const layout = chartData.layout || {};
                    layout.modebar = {
                        remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                                 "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                        display: false,
                        visible: false
                    };
                    layout.dragmode = false;
                    layout.hovermode = 'closest'; // 确保悬停功能
                    
                    // 确保悬停模板设置
                    if (chartData.data) {
                        chartData.data.forEach(trace => {
                            if (!trace.hovertemplate) {
                                trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                            }
                        });
                    }
                    
                    Plotly.newPlot('mom-growth-chart', chartData.data, layout, chartConfig);
                    
                    // 添加延迟触发window.resize事件，确保图表能够正确调整大小以填满容器
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                }
                
                // 显示环比分析的月度数据表格
                if (analysisType === 'month_over_month') {
                    // 获取周期类型用于显示
                    const periodType = results.stats && results.stats.period_type ? results.stats.period_type : '月';
                    
                    if (results.period_data && results.period_data.length > 0) {
                        // 更新标题
                        document.querySelector('.monthly-data-card .card-header h3').textContent = `${periodType}度数据明细`;
                        
                        let tableHTML = `
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>${periodType}份</th>
                                            <th>${valueColumn}</th>
                                            <th>上${periodType}${valueColumn}</th>
                                            <th>环比增长率</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        results.period_data.forEach(item => {
                            const prevValue = item.prev_value !== null ? formatNumber(item.prev_value) : '-';
                            const momChange = item.mom_change !== null ? formatNumber(item.mom_change) + '%' : '-';
                            
                            // 根据环比增长率添加不同的CSS类
                            let changeClass = '';
                            if (item.mom_change !== null) {
                                changeClass = item.mom_change > 0 ? 'positive-change' : (item.mom_change < 0 ? 'negative-change' : '');
                            }
                            
                            tableHTML += `
                                <tr>
                                    <td>${item.period}</td>
                                    <td>${formatNumber(item.value)}</td>
                                    <td>${prevValue}</td>
                                    <td class="${changeClass}">${momChange}</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        document.getElementById('mom-monthly-data').innerHTML = tableHTML;
                    } else {
                        document.getElementById('mom-monthly-data').innerHTML = `<div class="no-data">没有可用的${periodType}度数据</div>`;
                    }
                }
            }
            
            // 显示时间序列分解
            if (results.decomposition) {
                const chartConfig = {
                    displayModeBar: false,
                    responsive: true,
                    scrollZoom: false,
                    staticPlot: false // 设为false以保留悬停功能
                };
                
                // 趋势分量
                const trendData = JSON.parse(results.decomposition.trend_chart);
                const trendLayout = trendData.layout || {};
                trendLayout.modebar = {
                    remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                             "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                    display: false,
                    visible: false
                };
                trendLayout.dragmode = false;
                trendLayout.hovermode = 'closest'; // 确保悬停功能
                
                // 季节性分量
                const seasonalData = JSON.parse(results.decomposition.seasonal_chart);
                const seasonalLayout = seasonalData.layout || {};
                seasonalLayout.modebar = {
                    remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                             "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                    display: false,
                    visible: false
                };
                seasonalLayout.dragmode = false;
                seasonalLayout.hovermode = 'closest'; // 确保悬停功能
                
                // 残差分量
                const residualData = JSON.parse(results.decomposition.residual_chart);
                const residualLayout = residualData.layout || {};
                residualLayout.modebar = {
                    remove: ["zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d", "autoScale2d", "resetScale2d", 
                             "hoverClosest", "hoverCompare", "toggleSpikelines", "toImage", "sendDataToCloud"],
                    display: false,
                    visible: false
                };
                residualLayout.dragmode = false;
                residualLayout.hovermode = 'closest'; // 确保悬停功能
                
                // 设置悬停模板
                if (trendData.data) {
                    trendData.data.forEach(trace => {
                        if (!trace.hovertemplate) {
                            trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                        }
                    });
                }
                
                if (seasonalData.data) {
                    seasonalData.data.forEach(trace => {
                        if (!trace.hovertemplate) {
                            trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                        }
                    });
                }
                
                if (residualData.data) {
                    residualData.data.forEach(trace => {
                        if (!trace.hovertemplate) {
                            trace.hovertemplate = '%{x}<br>%{y}<extra></extra>';
                        }
                    });
                }
                
                Plotly.newPlot('trend-component', trendData.data, trendLayout, chartConfig);
                Plotly.newPlot('seasonal-component', seasonalData.data, seasonalLayout, chartConfig);
                Plotly.newPlot('residual-component', residualData.data, residualLayout, chartConfig);
                
                // 添加延迟触发window.resize事件，确保所有图表能够正确调整大小以填满容器
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            }
            
            // 显示结果容器
            resultsContainer.style.display = 'block';
            resultsContainer.classList.add('force-display');
            
            // 标记分析已完成
            window.isAnalyzing = false;
            
            // 添加全局延迟触发resize事件，确保所有图表在DOM完全渲染后正确调整大小
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 300);
            
            // 使用setTimeout确保DOM完全更新后再滚动到结果
            setTimeout(() => {
                // 再次确保结果容器可见
                resultsContainer.style.display = 'block';
                resultsContainer.classList.add('force-display');
                
                // 滚动到结果
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                
                // 记录到控制台，帮助调试
                console.log('结果显示完成，结果容器显示状态:', resultsContainer.style.display);
                
                // 清除已有的保护间隔
                if (window.resultsProtectionInterval) {
                    clearInterval(window.resultsProtectionInterval);
                }
                
                // 添加全局保护措施，防止结果被隐藏
                window.resultsProtectionInterval = setInterval(() => {
                    if (!window.isAnalyzing && 
                        (resultsContainer.style.display !== 'block' || 
                         getComputedStyle(resultsContainer).display === 'none')) {
                        console.log('检测到结果被隐藏，正在恢复显示');
                        resultsContainer.style.display = 'block';
                        resultsContainer.classList.add('force-display');
                    }
                }, 200); // 更频繁地检查
                
                // 使用更强大的MutationObserver监控结果容器的变化
                if (window.resultsObserver) {
                    window.resultsObserver.disconnect();
                }
                
                window.resultsObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                            const currentDisplay = getComputedStyle(resultsContainer).display;
                            if (!window.isAnalyzing && currentDisplay === 'none') {
                                console.log('MutationObserver检测到结果被隐藏，立即恢复显示');
                                resultsContainer.style.display = 'block';
                                resultsContainer.classList.add('force-display');
                            }
                        }
                    });
                });
                
                // 开始观察
                window.resultsObserver.observe(resultsContainer, { 
                    attributes: true, 
                    attributeFilter: ['style', 'class'] 
                });
                
                console.log('已启动MutationObserver监控');
                
                // 添加额外的保护 - 监控body的变化
                if (window.bodyObserver) {
                    window.bodyObserver.disconnect();
                }
                
                window.bodyObserver = new MutationObserver(() => {
                    if (!window.isAnalyzing && 
                        (resultsContainer.style.display !== 'block' || 
                         getComputedStyle(resultsContainer).display === 'none')) {
                        console.log('Body变化检测到结果被隐藏，恢复显示');
                        resultsContainer.style.display = 'block';
                        resultsContainer.classList.add('force-display');
                    }
                });
                
                // 监控body的所有子元素变化
                window.bodyObserver.observe(document.body, { 
                    childList: true, 
                    subtree: true 
                });
            }, 500);
        }

        // 导出分析结果
        exportResultsBtn.addEventListener('click', () => {
            if (!analysisResults) {
                return;
            }
            
            // 显示导出选项模态窗口
            const modal = document.getElementById('export-modal');
            if (!modal) return;
            modal.classList.add('active');
            
            // 根据当前分析类型显示/隐藏相关选项
            const analysisType = analysisTypeSelect.value;
            
            console.log('当前分析类型:', analysisType);
            
            // 记录所有可见图表
            const visibleCharts = {};
            
            // 默认隐藏所有导出选项，然后根据分析类型显示对应选项
            const chartOptions = [
                'export-trend-chart-container',
                'export-yoy-chart-container',
                'export-yoy-monthly-chart-container',
                'export-mom-chart-container',
                'export-decomposition-chart-container'
            ];
            
            chartOptions.forEach(optionId => {
                const optionElement = document.getElementById(optionId);
                if (optionElement) {
                    optionElement.style.display = 'none';
                }
            });
            
            // 根据分析类型显示相应图表选项
            if (analysisType === 'trend' || analysisType === '') {
                // 销售趋势分析模式
                showExportOption('export-trend-chart-container');
                showExportOption('export-decomposition-chart-container');
            } else if (analysisType === 'year_over_year') {
                // 同比分析模式
                showExportOption('export-trend-chart-container'); // 同比分析也需要显示销售趋势图
                showExportOption('export-yoy-chart-container');
                showExportOption('export-yoy-monthly-chart-container');
                showExportOption('export-decomposition-chart-container');
            } else if (analysisType === 'month_over_month') {
                // 环比分析模式
                showExportOption('export-trend-chart-container'); // 环比分析需要显示销售趋势图
                showExportOption('export-mom-chart-container');
                // 环比分析不包含时间序列分解图
            }
            
            // 辅助函数：显示导出选项
            function showExportOption(optionId) {
                const optionElement = document.getElementById(optionId);
                if (optionElement) {
                    optionElement.style.display = 'block';
                    console.log(`显示导出选项: ${optionId}`);
                }
            }
            
            // 检查各图表的可见性并记录
            const chartElements = [
                {id: 'trend-chart-container', option: 'export-trend-chart-container', name: '销售趋势图'},
                {id: 'yoy-chart-container', option: 'export-yoy-chart-container', name: '同比分析图'},
                {id: 'yoy-monthly-chart-container', option: 'export-yoy-monthly-chart-container', name: '月度同比图'},
                {id: 'mom-chart-container', option: 'export-mom-chart-container', name: '环比分析图'},
                {id: 'decomposition-section', option: 'export-decomposition-chart-container', name: '时间序列分解图'}
            ];
            
            console.log('检查可见图表:');
            chartElements.forEach(chart => {
                const chartElement = document.getElementById(chart.id);
                
                // 使用多种方法检查可见性
                let isVisible = false;
                
                if (chartElement) {
                    const style = window.getComputedStyle(chartElement);
                    const displayVisible = style.display !== 'none';
                    const visibilityVisible = style.visibility !== 'hidden';
                    const opacityVisible = parseFloat(style.opacity) > 0;
                    const hasDimensions = chartElement.offsetWidth > 0 && chartElement.offsetHeight > 0;
                    
                    isVisible = displayVisible && visibilityVisible && opacityVisible && hasDimensions;
                    
                    // 特殊处理：根据分析类型强制设置对应图表可见
                    if ((chart.id === 'trend-chart-container' && analysisType === 'trend') ||
                        (chart.id === 'yoy-chart-container' && analysisType === 'year_over_year') ||
                        (chart.id === 'yoy-monthly-chart-container' && analysisType === 'year_over_year') ||
                        (chart.id === 'mom-chart-container' && analysisType === 'month_over_month')) {
                        isVisible = true;
                    }
                    
                    console.log(`${chart.name}(${chart.id}): ${isVisible ? '可见' : '不可见'} - display:${displayVisible}, visibility:${visibilityVisible}, opacity:${opacityVisible}, dimensions:${hasDimensions}`);
                }
                
                visibleCharts[chart.id] = isVisible;
            });
            
            // 数据导出选项
            const yoyContainer = document.getElementById('export-yoy-container');
            if (yoyContainer) {
                yoyContainer.style.display = analysisType === 'year_over_year' ? 'block' : 'none';
            }
            
            const momContainer = document.getElementById('export-mom-container');
            if (momContainer) {
                momContainer.style.display = analysisType === 'month_over_month' ? 'block' : 'none';
            }
            
            const decompositionContainer = document.getElementById('export-decomposition-container');
            if (decompositionContainer) {
                const decompositionSection = document.getElementById('decomposition-section');
                const decompositionVisible = decompositionSection && window.getComputedStyle(decompositionSection).display !== 'none';
                decompositionContainer.style.display = decompositionVisible ? 'block' : 'none';
            }
        });
        
        // 取消导出
        document.getElementById('cancel-export').addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止事件冒泡
            document.getElementById('export-modal').classList.remove('active');
        });
        
        // 关闭模态窗口
        document.querySelector('.close-modal').addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止事件冒泡
            document.getElementById('export-modal').classList.remove('active');
        });
        
        // 确认导出
        document.getElementById('confirm-export').addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止事件冒泡
            
            const exportStats = document.getElementById('export-stats').checked;
            const exportAnomalies = document.getElementById('export-anomalies').checked;
            const exportYoY = document.getElementById('export-yoy').checked;
            const exportMoM = document.getElementById('export-mom').checked;
            const exportDecomposition = document.getElementById('export-decomposition').checked;
            
            // 图表导出选项 - 只有在选项可见且被勾选时才导出
            const trendChartOption = document.getElementById('export-trend-chart-container');
            const exportTrendChart = document.getElementById('export-trend-chart') && 
                                     document.getElementById('export-trend-chart').checked &&
                                     (!trendChartOption || trendChartOption.style.display !== 'none');
            
            const yoyChartOption = document.getElementById('export-yoy-chart-container');
            const exportYoYChart = document.getElementById('export-yoy-chart') && 
                                   document.getElementById('export-yoy-chart').checked &&
                                   (!yoyChartOption || yoyChartOption.style.display !== 'none');
            
            const yoyMonthlyChartOption = document.getElementById('export-yoy-monthly-chart-container');
            const exportYoYMonthlyChart = document.getElementById('export-yoy-monthly-chart') && 
                                         document.getElementById('export-yoy-monthly-chart').checked &&
                                         (!yoyMonthlyChartOption || yoyMonthlyChartOption.style.display !== 'none');
            
            const momChartOption = document.getElementById('export-mom-chart-container');
            const exportMoMChart = document.getElementById('export-mom-chart') && 
                                  document.getElementById('export-mom-chart').checked &&
                                  (!momChartOption || momChartOption.style.display !== 'none');
            
            const decompositionChartOption = document.getElementById('export-decomposition-chart-container');
            const exportDecompositionChart = document.getElementById('export-decomposition-chart') && 
                                            document.getElementById('export-decomposition-chart').checked &&
                                            (!decompositionChartOption || decompositionChartOption.style.display !== 'none');
            
            console.log('导出选项状态:', {
                数据: {exportStats, exportAnomalies, exportYoY, exportMoM, exportDecomposition},
                图表: {exportTrendChart, exportYoYChart, exportYoYMonthlyChart, exportMoMChart, exportDecompositionChart}
            });
            
            // 检查是否有勾选任何选项
            const hasDataExport = exportStats || exportAnomalies || exportYoY || exportMoM || exportDecomposition;
            const hasChartExport = exportTrendChart || exportYoYChart || exportYoYMonthlyChart || exportMoMChart || exportDecompositionChart;
            
            if (!hasDataExport && !hasChartExport) {
                alert('请至少选择一项要导出的内容');
                return;
            }
            
            // 创建加载提示
            const loadingToast = document.createElement('div');
            loadingToast.className = 'toast';
            loadingToast.innerHTML = '<span class="spinner"></span> 正在准备导出...';
            document.body.appendChild(loadingToast);
            setTimeout(() => { loadingToast.classList.add('show'); }, 10);
            
            // 关闭模态窗口
            document.getElementById('export-modal').classList.remove('active');
            
            // 稍微延迟导出操作以确保UI更新
            setTimeout(async () => {
                try {
                    // 数据导出部分
                    if (hasDataExport) {
                        exportDataToCSV();
                    }
                    
                    // 图表导出部分
                    if (hasChartExport) {
                        await exportCharts();
                    }
                    
                    // 显示成功提示
                    loadingToast.innerHTML = '导出完成！';
                    loadingToast.classList.add('success');
                    setTimeout(() => {
                        loadingToast.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(loadingToast);
                        }, 300);
                    }, 2000);
                } catch (error) {
                    console.error('导出过程中出错:', error);
                    loadingToast.innerHTML = '导出失败: ' + error.message;
                    loadingToast.classList.add('error');
                    setTimeout(() => {
                        loadingToast.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(loadingToast);
                        }, 300);
                    }, 3000);
                }
            }, 300);
            
            // 导出数据到CSV
            function exportDataToCSV() {
                // 将分析结果转换为CSV字符串
                let csvContent = 'data:text/csv;charset=utf-8,';
                let hasContent = false;
                
                // 添加标题行
                csvContent += '分析类型,' + analysisTypeSelect.options[analysisTypeSelect.selectedIndex].text + '\r\n';
                csvContent += '分析日期,' + new Date().toLocaleString() + '\r\n\r\n';
                
                // 添加统计数据
                if (exportStats && analysisResults.stats) {
                    hasContent = true;
                    csvContent += '统计数据:\r\n';
                    
                    const analysisType = analysisTypeSelect.value;
                    const stats = analysisResults.stats;
                    
                    if (analysisType === 'trend') {
                        csvContent += '总计,' + stats.total + '\r\n';
                        csvContent += '平均值,' + stats.average + '\r\n';
                        csvContent += '最高值,' + stats.max.value + ',' + stats.max.date + '\r\n';
                        csvContent += '最低值,' + stats.min.value + ',' + stats.min.date + '\r\n';
                        csvContent += '总体增长率,' + stats.growth_rate + '%\r\n';
                    } else if (analysisType === 'year_over_year' && exportYoY) {
                        csvContent += '年度总计:\r\n';
                        for (const [year, total] of Object.entries(stats.yearly_totals)) {
                            csvContent += year + '年,' + total + '\r\n';
                        }
                        
                        csvContent += '\r\n年度同比变化:\r\n';
                        for (const [year, change] of Object.entries(stats.yoy_changes)) {
                            csvContent += year + '年,' + change + '%\r\n';
                        }
                    } else if (analysisType === 'month_over_month' && exportMoM) {
                        csvContent += '增长月份数,' + stats.positive_months + '\r\n';
                        csvContent += '下降月份数,' + stats.negative_months + '\r\n';
                        csvContent += '平均环比变化,' + stats.average_change + '%\r\n';
                        csvContent += '最大增长,' + stats.max_increase.value + '%,' + stats.max_increase.month + '\r\n';
                        csvContent += '最大下降,' + stats.max_decrease.value + '%,' + stats.max_decrease.month + '\r\n';
                    }
                    
                    csvContent += '\r\n';
                }
                
                // 添加异常点
                if (exportAnomalies && analysisResults.anomalies && analysisResults.anomalies.length > 0) {
                    hasContent = true;
                    csvContent += '异常点:\r\n';
                    csvContent += '日期,值,Z分数,方向,可能原因\r\n';
                    
                    analysisResults.anomalies.forEach(anomaly => {
                        csvContent += anomaly.date + ',' + 
                                    anomaly.value + ',' + 
                                    anomaly.z_score + ',' + 
                                    anomaly.direction + ',"' + 
                                    anomaly.reasons.join('; ') + '"\r\n';
                    });
                    
                    csvContent += '\r\n';
                }
                
                // 添加详细数据
                if (exportMoM && analysisTypeSelect.value === 'month_over_month' && analysisResults.monthly_data) {
                    hasContent = true;
                    csvContent += '月度数据:\r\n';
                    csvContent += '年月,值,环比变化(%)\r\n';
                    
                    analysisResults.monthly_data.forEach(item => {
                        csvContent += item.year_month + ',' + 
                                    item[valueColumnSelect.value] + ',' + 
                                    (item.mom_change ? item.mom_change : '') + '\r\n';
                    });
                }
                
                // 只有在有内容时才创建下载
                if (hasContent) {
                    // 创建下载链接
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', '销售趋势分析_数据_' + new Date().toISOString().slice(0, 10) + '.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // 图表导出函数
            async function exportCharts() {
                // 调试用：列出所有可能的图表容器
                console.log('所有可能的图表容器:');
                const possibleChartIds = [
                    'trend-chart-card', 'trend-chart-container', 'trend-chart', 
                    'yoy-section', 'yoy-chart-container', 'yoy-chart', 
                    'yoy-monthly-chart-container', 'yoy-monthly-chart', 
                    'mom-section', 'mom-chart-container', 'mom-chart',
                    'decomposition-section', 'decomposition-charts',
                    // 添加更多可能的图表ID
                    'analysis-type-trend', 'analysis-type-mom'
                ];
                
                possibleChartIds.forEach(id => {
                    const el = document.getElementById(id);
                    console.log(`${id}: ${el ? '存在' : '不存在'}`);
                    if (el) {
                        console.log(`   - display: ${window.getComputedStyle(el).display}`);
                        console.log(`   - visibility: ${window.getComputedStyle(el).visibility}`);
                        console.log(`   - opacity: ${window.getComputedStyle(el).opacity}`);
                    }
                });
                
                const chartContainers = [];
                
                // 检查元素是否可见的辅助函数
                function isElementVisible(element) {
                    if (!element) return false;
                    const style = window.getComputedStyle(element);
                    return style.display !== 'none' && 
                           style.visibility !== 'hidden' && 
                           style.opacity !== '0' &&
                           element.offsetWidth > 0 &&
                           element.offsetHeight > 0;
                }
                
                // 清除之前的选择
                chartContainers.length = 0;
                
                // 获取当前分析类型
                const currentAnalysisType = analysisTypeSelect.value;
                console.log(`当前分析类型: ${currentAnalysisType}`);
                
                // 定义要导出的图表映射关系
                const chartMappings = [];
                
                // 根据分析类型添加不同的图表映射
                if (currentAnalysisType === 'trend' || currentAnalysisType === '') {
                    // 销售趋势分析模式的图表
                    if (exportTrendChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'trend-chart-card',
                            containerId: 'trend-chart-container',
                            chartId: 'trend-chart',
                            name: '销售趋势图'
                        });
                    }
                    
                    if (exportDecompositionChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'decomposition-section',
                            containerId: 'decomposition-section',
                            chartId: 'decomposition-charts',
                            name: '时间序列分解图'
                        });
                    }
                } else if (currentAnalysisType === 'year_over_year') {
                    // 同比分析模式的图表
                    if (exportTrendChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'trend-chart-card',
                            containerId: 'trend-chart-container',
                            chartId: 'trend-chart',
                            name: '销售趋势图'
                        });
                    }
                    
                    if (exportYoYChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'yoy-chart-card',
                            containerId: 'yoy-chart-container',
                            chartId: 'yoy-chart',
                            name: '同比分析图'
                        });
                    }
                    
                    if (exportYoYMonthlyChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'yoy-monthly-chart-card',
                            containerId: 'yoy-monthly-chart-container',
                            chartId: 'yoy-monthly-chart',
                            name: '月度同比变化图'
                        });
                    }
                    
                    if (exportDecompositionChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'decomposition-section',
                            containerId: 'decomposition-section',
                            chartId: 'decomposition-charts',
                            name: '时间序列分解图'
                        });
                    }
                } else if (currentAnalysisType === 'month_over_month') {
                    // 环比分析模式的图表
                    
                    // 获取环比分析部分的所有图表容器
                    const momSection = document.getElementById('mom-section');
                    if (momSection) {
                        console.log('找到环比分析部分，检查子元素:');
                        Array.from(momSection.children).forEach((child, index) => {
                            console.log(`子元素 ${index}:`, child.tagName, child.id, child.className);
                            
                            // 深度检查每个子元素内部结构
                            console.log(`子元素 ${index} 内部结构:`);
                            Array.from(child.children || []).forEach((grandchild, idx) => {
                                console.log(`  - 孙元素 ${idx}:`, grandchild.tagName, grandchild.id, grandchild.className);
                            });
                        });
                        
                        // 查找环比分析部分中的所有图表
                        const charts = momSection.querySelectorAll('.chart-container, [id*="chart"], [class*="chart"]');
                        console.log(`在环比分析部分找到 ${charts.length} 个可能的图表`);
                        charts.forEach((chart, index) => {
                            console.log(`图表 ${index}:`, chart.tagName, chart.id, chart.className);
                            // 查看每个图表的内部结构
                            const title = chart.querySelector('h4, h3, .chart-title');
                            console.log(`  - 标题: ${title ? title.textContent : '无标题'}`);
                            const svgs = chart.querySelectorAll('svg');
                            console.log(`  - SVG数量: ${svgs.length}`);
                            
                            // 检查图表内的所有子图表区域
                            const chartAreas = chart.querySelectorAll('.chart-area, [id*="chart"], svg');
                            console.log(`  - 图表区域数量: ${chartAreas.length}`);
                            chartAreas.forEach((area, areaIndex) => {
                                console.log(`    - 区域 ${areaIndex}:`, area.tagName, area.id, area.className);
                                // 尝试获取区域标题
                                const areaTitle = area.closest('div').querySelector('h3, h4, .chart-title');
                                console.log(`      - 区域标题: ${areaTitle ? areaTitle.textContent : '无标题'}`);
                            });
                        });
                    }
                    
                    // 环比分析模式下的销售趋势图
                    if (exportTrendChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'mom-trend-chart-card',
                            containerId: 'trend-chart-container',
                            chartId: 'trend-chart',
                            name: '销售趋势图',
                            // 针对嵌套结构添加选择器
                            selector: function(container) {
                                if (!container) return null;
                                
                                // 如果容器包含多个图表，尝试找出第一个（上面）的图表
                                const charts = container.querySelectorAll('svg, canvas, .highcharts-container');
                                if (charts.length > 1) {
                                    return charts[0]; // 返回第一个图表元素
                                }
                                
                                // 尝试通过标题查找销售趋势相关的图表区域
                                const titles = container.querySelectorAll('h3, h4, .chart-title');
                                for (const title of titles) {
                                    if (title.textContent.includes('销售趋势') || title.textContent.includes('销售金额')) {
                                        // 返回这个标题附近的图表元素
                                        const nearestChart = title.nextElementSibling?.querySelector('svg, canvas, .highcharts-container') ||
                                                           title.parentElement?.querySelector('svg, canvas, .highcharts-container');
                                        if (nearestChart) return nearestChart;
                                    }
                                }
                                
                                // 如果找不到明确的图表，尝试找出第一个图表区域
                                const firstChartArea = container.querySelector('.chart-area:first-child, [id*="chart"]:first-child, svg:first-of-type');
                                return firstChartArea;
                            },
                            fallbackSelectors: [
                                '#mom-section .chart-container:first-child',
                                '#mom-section svg:first-of-type',
                                '#mom-section > div:first-child svg',
                                '#mom-section [id*="trend"] svg',
                                '#mom-section [id*="sales"] svg'
                            ]
                        });
                    }
                    
                    // 环比增长率图
                    if (exportMoMChart) {
                        chartMappings.push({
                            shouldExport: true,
                            cardId: 'mom-chart-card',
                            containerId: 'mom-chart-container',
                            chartId: 'mom-chart',
                            name: '环比增长率图',
                            // 针对嵌套结构添加选择器
                            selector: function(container) {
                                if (!container) return null;
                                
                                // 如果容器包含多个图表，尝试找出第二个（下面）的图表
                                const charts = container.querySelectorAll('svg, canvas, .highcharts-container');
                                if (charts.length > 1) {
                                    return charts[1]; // 返回第二个图表元素
                                }
                                
                                // 尝试通过标题查找环比相关的图表区域
                                const titles = container.querySelectorAll('h3, h4, .chart-title');
                                for (const title of titles) {
                                    if (title.textContent.includes('环比') || title.textContent.includes('增长率')) {
                                        // 返回这个标题附近的图表元素
                                        const nearestChart = title.nextElementSibling?.querySelector('svg, canvas, .highcharts-container') ||
                                                           title.parentElement?.querySelector('svg, canvas, .highcharts-container');
                                        if (nearestChart) return nearestChart;
                                    }
                                }
                                
                                // 如果找不到明确的图表，尝试找出第二个图表区域
                                const chartAreas = container.querySelectorAll('.chart-area, [id*="chart"], svg');
                                if (chartAreas.length > 1) {
                                    return chartAreas[1]; // 返回第二个图表区域
                                }
                                
                                // 最后尝试找出含有"环比"、"增长率"文字的SVG
                                const allSVGs = container.querySelectorAll('svg');
                                for (const svg of allSVGs) {
                                    const text = svg.textContent;
                                    if (text.includes('环比') || text.includes('增长率') || text.includes('MoM')) {
                                        return svg;
                                    }
                                }
                                
                                return null;
                            },
                            fallbackSelectors: [
                                '#mom-section .chart-container:nth-child(2)',
                                '#mom-section svg:nth-of-type(2)',
                                '#mom-section > div:first-child svg:nth-of-type(2)',
                                '#mom-section [id*="growth"] svg',
                                '#mom-section [id*="rate"] svg'
                            ]
                        });
                    }
                }
                
                console.log('要导出的图表映射:', chartMappings);
                
                // 根据映射关系收集图表
                for (const mapping of chartMappings) {
                    if (!mapping.shouldExport) {
                        console.log(`跳过图表: ${mapping.name} (未选择)`);
                        continue;
                    }
                    
                    console.log(`检查图表: ${mapping.name}`);
                    
                    // 尝试按优先级获取元素：卡片 > 容器 > 图表
                    let elementToExport = null;
                    let elementId = '';
                    
                    // 首先尝试使用自定义选择器函数（如果存在）
                    if (!elementToExport && mapping.selector) {
                        // 先找到可能的容器
                        const containerCandidates = [
                            document.getElementById(mapping.cardId),
                            document.getElementById(mapping.containerId),
                            document.getElementById('mom-section')
                        ].filter(Boolean);
                        
                        for (const container of containerCandidates) {
                            const selectedElement = mapping.selector(container);
                            if (selectedElement && isElementVisible(selectedElement)) {
                                elementToExport = selectedElement;
                                elementId = selectedElement.id || `${mapping.name}-selected`;
                                console.log(`  - 使用自定义选择器函数找到元素`);
                                break;
                            }
                        }
                    }
                    
                    // 首先尝试获取卡片（包含标题和图例）
                    if (!elementToExport && mapping.cardId) {
                        const card = document.getElementById(mapping.cardId);
                        if (card && isElementVisible(card)) {
                            elementToExport = card;
                            elementId = mapping.cardId;
                            console.log(`  - 使用卡片元素 ${mapping.cardId}`);
                        }
                    }
                    
                    // 其次尝试获取容器
                    if (!elementToExport && mapping.containerId) {
                        const container = document.getElementById(mapping.containerId);
                        if (container && isElementVisible(container)) {
                            elementToExport = container;
                            elementId = mapping.containerId;
                            console.log(`  - 使用容器元素 ${mapping.containerId}`);
                        }
                    }
                    
                    // 然后尝试获取图表元素本身
                    if (!elementToExport && mapping.chartId) {
                        const chart = document.getElementById(mapping.chartId);
                        if (chart && isElementVisible(chart)) {
                            elementToExport = chart;
                            elementId = mapping.chartId;
                            console.log(`  - 使用图表元素 ${mapping.chartId}`);
                        }
                    }
                    
                    // 最后尝试使用备用选择器（特别适用于环比分析模式）
                    if (!elementToExport && mapping.fallbackSelectors) {
                        for (const selector of mapping.fallbackSelectors) {
                            const element = document.querySelector(selector);
                            if (element && isElementVisible(element)) {
                                elementToExport = element;
                                elementId = selector;
                                console.log(`  - 使用备用选择器 ${selector} 找到元素`);
                                break;
                            }
                        }
                    }
                    
                    // 特殊处理：在环比模式下查找特定图表
                    if (!elementToExport && currentAnalysisType === 'month_over_month') {
                        const momSection = document.getElementById('mom-section');
                        if (momSection) {
                            // 根据图表类型在环比部分查找
                            if (mapping.name === '销售趋势图') {
                                // 特殊处理：直接查找环比部分中的第一个SVG元素（通常是销售趋势图）
                                const firstSVG = momSection.querySelector('svg');
                                if (firstSVG) {
                                    elementToExport = firstSVG;
                                    elementId = 'mom-sales-trend-svg';
                                    console.log('  - 找到销售趋势图SVG元素');
                                } else {
                                    // 首先尝试通过标题查找"销售趋势"图表
                                    const salesTrendTitle = Array.from(momSection.querySelectorAll('h3, h4, .chart-title')).find(el => 
                                        el.textContent.includes('销售趋势') || el.textContent.includes('销售金额'));
                                    
                                    if (salesTrendTitle) {
                                        // 获取标题所在的卡片或容器
                                        let container = salesTrendTitle.closest('.chart-container, .card, [id*="chart"]');
                                        if (container) {
                                            // 获取容器中的第一个SVG（通常是销售趋势图）
                                            const svg = container.querySelector('svg');
                                            if (svg) {
                                                elementToExport = svg;
                                                elementId = 'sales-trend-svg';
                                                console.log('  - 通过标题找到销售趋势图SVG');
                                            } else {
                                                elementToExport = container;
                                                elementId = container.id || 'sales-trend-chart';
                                                console.log('  - 通过标题找到销售趋势图');
                                            }
                                        }
                                    }
                                }
                            } else if (mapping.name === '环比增长率图') {
                                // 特殊处理：直接查找环比部分中的第二个SVG元素（通常是环比增长率图）
                                const svgs = momSection.querySelectorAll('svg');
                                if (svgs.length > 1) {
                                    elementToExport = svgs[1];
                                    elementId = 'mom-growth-rate-svg';
                                    console.log('  - 找到环比增长率图SVG元素');
                                } else {
                                    // 首先尝试通过标题查找"环比增长率"图表
                                    const momGrowthTitle = Array.from(momSection.querySelectorAll('h3, h4, .chart-title')).find(el => 
                                        el.textContent.includes('环比') || 
                                        el.textContent.includes('增长率') || 
                                        el.textContent.includes('MoM'));
                                    
                                    if (momGrowthTitle) {
                                        // 获取标题所在的卡片或容器
                                        let container = momGrowthTitle.closest('.chart-container, .card, [id*="chart"]');
                                        if (container) {
                                            // 获取容器中的SVG（通常是环比增长率图）
                                            const svg = container.querySelector('svg');
                                            if (svg) {
                                                elementToExport = svg;
                                                elementId = 'growth-rate-svg';
                                                console.log('  - 通过标题找到环比增长率图SVG');
                                            } else {
                                                elementToExport = container;
                                                elementId = container.id || 'mom-growth-chart';
                                                console.log('  - 通过标题找到环比增长率图');
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    if (elementToExport) {
                        chartContainers.push({
                            element: elementToExport,
                            elementId: elementId,
                            name: mapping.name
                        });
                    } else {
                        console.log(`  - 未找到可导出的元素: ${mapping.name}`);
                    }
                }
                
                // 单独处理时间序列分解图
                if (exportDecompositionChart && currentAnalysisType !== 'month_over_month') {
                    console.log('检查时间序列分解图');
                    const decompositionSection = document.getElementById('decomposition-section');
                    
                    if (decompositionSection && isElementVisible(decompositionSection)) {
                        console.log('  - 找到分解部分');
                        // 尝试查找独立的分解图表
                        const decompositionCharts = decompositionSection.querySelectorAll('.decomposition-chart');
                        
                        if (decompositionCharts && decompositionCharts.length > 0) {
                            console.log(`  - 找到 ${decompositionCharts.length} 个分解图表`);
                            let chartIndex = 0;
                            decompositionCharts.forEach((chart, index) => {
                                if (chart && isElementVisible(chart)) {
                                    // 获取图表标题 - 通常是上一个或父元素中的标题元素
                                    let chartTitle = '分解组件';
                                    const prevElement = chart.previousElementSibling;
                                    if (prevElement && prevElement.tagName.toLowerCase() === 'h4') {
                                        chartTitle = prevElement.textContent.trim();
                                    }
                                    
                                    chartContainers.push({
                                        element: chart,
                                        elementId: chart.id || `decomposition-chart-${index}`,
                                        name: `时间序列分解_${chartTitle}_${++chartIndex}`
                                    });
                                }
                            });
                        } else {
                            // 如果找不到独立图表，导出整个部分
                            console.log('  - 未找到独立图表，导出整个分解部分');
                            chartContainers.push({
                                element: decompositionSection,
                                elementId: 'decomposition-section',
                                name: '时间序列分解'
                            });
                        }
                    } else {
                        console.log('  - 分解部分不可见或不存在');
                    }
                } else {
                    console.log('跳过时间序列分解图 (未选择或在环比模式下)');
                }
                
                console.log('找到可导出的图表数量:', chartContainers.length);
                for (const chart of chartContainers) {
                    console.log(` - ${chart.name} (${chart.elementId})`);
                }
                
                if (chartContainers.length === 0) {
                    console.log('没有找到要导出的图表');
                    // 显示错误提示
                    alert('未找到选择的图表，请确保图表已显示在页面上');
                    return; // 没有图表可导出
                }
                
                console.log('准备导出图表：', chartContainers.length, '个图表');
                
                // 存储当前的背景色和主题，以便后续恢复
                const originalTheme = document.body.getAttribute('data-theme');
                const originalBodyBg = document.body.style.backgroundColor;
                
                // 临时设置为浅色主题以获得更好的图表导出效果
                document.body.setAttribute('data-theme', 'light');
                
                // 等待DOM更新
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // 导出每个图表
                for (const container of chartContainers) {
                    try {
                        console.log('正在处理图表:', container.name, container.elementId);
                        
                        // 确保html2canvas已加载
                        if (typeof html2canvas !== 'function') {
                            throw new Error('html2canvas库未加载！请检查网络连接。');
                        }
                        
                        // 获取要捕获的元素
                        const elementToCapture = container.element;
                        
                        // 检查元素尺寸
                        const rect = elementToCapture.getBoundingClientRect();
                        console.log('要捕获的元素尺寸:', rect.width, 'x', rect.height);
                        
                        if (rect.width < 10 || rect.height < 10) {
                            throw new Error('元素尺寸过小，无法导出有效图像');
                        }
                        
                        // 对于非SVG图表使用html2canvas
                        console.log('使用html2canvas导出图表');
                        
                        // 创建一个高分辨率的图像
                        const canvas = await html2canvas(elementToCapture, {
                            scale: 2, // 提高分辨率以增加清晰度
                            logging: true,
                            backgroundColor: '#FFFFFF',
                            useCORS: true, // 允许跨域图像
                            allowTaint: true, // 允许可能被污染的图像
                            width: rect.width,
                            height: rect.height,
                            onclone: (documentClone, element) => {
                                console.log('克隆的元素:', element.id || element.className);
                                
                                // 查找并确保克隆文档中的目标元素可见
                                const clonedElement = documentClone.getElementById(container.elementId) || 
                                                     documentClone.querySelector(`[id="${container.elementId}"]`);
                                
                                if (clonedElement) {
                                    console.log('找到克隆元素:', clonedElement.id || clonedElement.className);
                                    
                                    // 确保元素及其所有父元素都可见
                                    let el = clonedElement;
                                    while (el) {
                                        el.style.display = 'block';
                                        el.style.visibility = 'visible';
                                        el.style.opacity = '1';
                                        el.style.height = 'auto';
                                        el.style.overflow = 'visible';
                                        el = el.parentElement;
                                    }
                                    
                                    // 确保图表标题可见
                                    const titles = clonedElement.querySelectorAll('h2, h3, h4, .card-title, .chart-title');
                                    titles.forEach(title => {
                                        if (title) {
                                            title.style.display = 'block';
                                            title.style.visibility = 'visible';
                                            title.style.opacity = '1';
                                            console.log('  - 确保标题可见:', title.textContent);
                                        }
                                    });
                                    
                                    // 确保图例可见
                                    const legends = clonedElement.querySelectorAll('.legend, .chart-legend, .apexcharts-legend, [class*="legend"]');
                                    legends.forEach(legend => {
                                        if (legend) {
                                            legend.style.display = 'block';
                                            legend.style.visibility = 'visible';
                                            legend.style.opacity = '1';
                                            console.log('  - 确保图例可见');
                                        }
                                    });
                                    
                                    // 特别处理ApexCharts图例
                                    const apexElements = clonedElement.querySelectorAll('[class*="apexcharts"]');
                                    apexElements.forEach(el => {
                                        el.style.visibility = 'visible';
                                        el.style.opacity = '1';
                                    });
                                    
                                    // 确保尺寸正确
                                    clonedElement.style.width = rect.width + 'px';
                                    clonedElement.style.height = rect.height + 'px';
                                }
                            }
                        });
                        
                        console.log('html2canvas生成canvas尺寸:', canvas.width, 'x', canvas.height);
                        
                        // 转换为PNG并下载
                        const image = canvas.toDataURL('image/png', 1.0); // 使用最高质量
                        console.log('生成的Data URL长度:', image.length);
                        
                        if (image.length < 100) {
                            throw new Error('生成的图像数据无效');
                        }
                        
                        const link = document.createElement('a');
                        link.setAttribute('href', image);
                        link.setAttribute('download', '销售分析_' + container.name + '_' + new Date().toISOString().slice(0, 10) + '.png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        console.log('图表导出成功:', container.name);
                        
                        // 短暂延迟避免浏览器阻止多次下载
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (err) {
                        console.error('导出图表失败:', err, container.name);
                        throw new Error('导出图表"' + container.name + '"失败: ' + err.message);
                    }
                }
                
                // 恢复原始主题和背景色
                document.body.setAttribute('data-theme', originalTheme);
                document.body.style.backgroundColor = originalBodyBg;
                
                console.log('所有图表导出完成');
            }
        });

        // 辅助函数：显示错误消息
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loading.style.display = 'none';
            
            // 重置分析状态
            window.isAnalyzing = false;
        }

        // 辅助函数：格式化数字
        function formatNumber(num) {
            console.log('格式化数字:', num, '类型:', typeof num);
            
            if (num === null || num === undefined) {
                return '0';
            }
            
            // 确保num是数字类型
            if (typeof num === 'string') {
                num = parseFloat(num);
                if (isNaN(num)) {
                    return '0';
                }
            }
            
            if (typeof num !== 'number') {
                return num.toString();
            }
            
            // 判断是否为整数
            if (Number.isInteger(num) || Math.abs(num - Math.round(num)) < 0.00001) {
                // 对于行数等整数值，不显示小数位
                return Math.round(num).toLocaleString('zh-CN');
            } else {
                // 对于金额等小数值，格式化为2位小数
                return num.toLocaleString('zh-CN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        // 在页面加载后添加动态效果
        const buttons = document.querySelectorAll('.button');
        
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                // 检查动画设置是否开启
                const animationSetting = document.documentElement.getAttribute('data-animation');
                if (animationSetting === 'off') return;
                
                const x = e.clientX - e.target.getBoundingClientRect().left;
                const y = e.clientY - e.target.getBoundingClientRect().top;
                
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });

        // 初始化折叠功能
        const toggleGuideBtn = document.getElementById('toggle-guide');
        const usageGuide = document.getElementById('usage-guide');
        
        if (toggleGuideBtn && usageGuide) {
            toggleGuideBtn.addEventListener('click', function() {
                // 使用classList.toggle来切换active状态
                const isActive = usageGuide.classList.toggle('active');
                toggleGuideBtn.classList.toggle('active', isActive);
                
                // 更新按钮文本
                const textNode = toggleGuideBtn.querySelector('.guide-btn-text');
                if (textNode) {
                    textNode.textContent = isActive ? '收起说明' : '查看说明';
                }
            });
        }

        // 检查是否满足同比分析要求
        function checkYearOverYearEligibility() {
            const selectedFile = document.getElementById('file-input').files[0];
            const dateColumn = document.getElementById('date-column').value;
            
            if (!selectedFile || !dateColumn) {
                console.log("文件或日期列未选择，无法检查同比分析条件");
                return;
            }
            
            // 显示检查中的提示
            const warningDiv = document.createElement('div');
            warningDiv.id = 'year-over-year-warning';
            warningDiv.className = 'warning-message';
            warningDiv.style.display = 'block';
            warningDiv.textContent = '正在检查数据是否满足同比分析要求...';
            
            // 插入到分析类型选项下方
            const analysisTypeContainer = document.getElementById('analysis-type').parentNode;
            const existingWarning = document.getElementById('year-over-year-warning');
            if (existingWarning) {
                existingWarning.textContent = warningDiv.textContent;
                existingWarning.style.display = 'block';
            } else {
                analysisTypeContainer.appendChild(warningDiv);
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('date_column', dateColumn);
            
            fetch('/api/check_year_over_year_eligibility', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const warningElement = document.getElementById('year-over-year-warning');
                
                if (data.success) {
                    if (data.has_enough_data) {
                        // 数据满足同比分析要求
                        if (warningElement) {
                            warningElement.style.display = 'none';
                        }
                        document.getElementById('analyze-button').disabled = false;
                    } else {
                        // 数据不满足同比分析要求
                        if (warningElement) {
                            warningElement.textContent = '同比分析需要至少两年的数据，当前数据不满足要求';
                            warningElement.style.display = 'block';
                        }
                        // 如果当前选择的是同比分析，则禁用分析按钮
                        if (document.getElementById('analysis-type').value === 'year_over_year') {
                            document.getElementById('analyze-button').disabled = true;
                        }
                    }
                } else {
                    // 检查失败
                    if (warningElement) {
                        warningElement.textContent = `检查数据失败: ${data.message}`;
                        warningElement.style.display = 'block';
                    }
                    console.error('检查同比分析条件失败:', data.message);
                }
            })
            .catch(error => {
                console.error('检查同比分析条件请求失败:', error);
                const warningElement = document.getElementById('year-over-year-warning');
                if (warningElement) {
                    warningElement.textContent = `检查同比分析条件失败: ${error.message}`;
                    warningElement.style.display = 'block';
                }
            });
        }

        // 监听分析类型变化
        document.getElementById('analysis-type').addEventListener('change', function() {
            // 重置分析按钮状态
            document.getElementById('analyze-button').disabled = false;
            
            // 隐藏之前的警告信息
            const warningElement = document.getElementById('year-over-year-warning');
            if (warningElement) {
                warningElement.style.display = 'none';
            }
            
            // 如果选择了同比分析，检查数据是否满足要求
            if (this.value === 'year_over_year') {
                checkYearOverYearEligibility();
            }
        });

        // 监听文件选择和日期列选择，在选择同比分析时触发检查
        document.getElementById('file-input').addEventListener('change', function() {
            if (document.getElementById('analysis-type').value === 'year_over_year') {
                checkYearOverYearEligibility();
            }
        });
        
        document.getElementById('date-column').addEventListener('change', function() {
            if (document.getElementById('analysis-type').value === 'year_over_year') {
                checkYearOverYearEligibility();
            }
        });

        // 阻止模态窗口内点击事件冒泡到外部
        document.querySelector('.modal-content').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // 点击模态窗口背景关闭窗口
        document.getElementById('export-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });
</script>
{% endblock %} 