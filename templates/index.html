<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">数据分析系统</title>
    <script src="/static/js/lib/plotly-2.27.0.min.js"></script>
    <link href="/static/css/lib/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/notifications.css">
    <link rel="stylesheet" href="/static/css/login_animation.css">
    <script src="/static/js/notifications.js"></script>
    <script src="/static/js/login_animation.js"></script>
    
    <!-- 登录动画容器 -->
    <div id="login-animation"></div>
    
    <style>
        :root {
            --primary-color: #0071e3;
            --hover-color: #0077ed;
            --background-color: #f5f5f7;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --border-color: #d2d2d7;
            --success-color: #28a745;
            --error-color: #dc3545;
            --gradient-start: #e8e8ed;
            --gradient-end: #f5f5f7;
            --card-background: rgba(255, 255, 255, 0.8);
            --card-border: rgba(210, 210, 215, 0.5);
            --card-shadow: rgba(0, 0, 0, 0.05);
            --error-color-rgb: 220, 53, 69;
            --warning-color: #ff9500;
            --warning-bg: rgba(255, 149, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary-color: #2997ff;
            --hover-color: #0077ed;
            --background-color: #000000;
            --text-color: #f5f5f7;
            --secondary-text: #86868b;
            --border-color: #424245;
            --gradient-start: #1d1d1f;
            --gradient-end: #000000;
            --card-background: rgba(40, 40, 40, 0.8);
            --card-border: rgba(66, 66, 69, 0.5);
            --card-shadow: rgba(0, 0, 0, 0.2);
            --error-color-rgb: 255, 60, 77;
            --warning-color: #ff9f0a;
            --warning-bg: rgba(255, 159, 10, 0.15);
        }

        [data-theme="warm"] {
            --primary-color: #ff9500;
            --hover-color: #ff9f0a;
            --background-color: #fff8f0;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --border-color: #ffd591;
            --gradient-start: #fff2e6;
            --gradient-end: #fff8f0;
            --card-background: rgba(255, 255, 255, 0.8);
            --card-border: rgba(255, 213, 145, 0.5);
            --card-shadow: rgba(255, 149, 0, 0.1);
        }

        [data-theme="cool"] {
            --primary-color: #5856d6;
            --hover-color: #5e5ce6;
            --background-color: #f0f0ff;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --border-color: #c7c6ff;
            --gradient-start: #e6e6ff;
            --gradient-end: #f0f0ff;
            --card-background: rgba(255, 255, 255, 0.8);
            --card-border: rgba(199, 198, 255, 0.5);
            --card-shadow: rgba(88, 86, 214, 0.1);
        }

        [data-theme="nature"] {
            --primary-color: #34c759;
            --hover-color: #30d158;
            --background-color: #f0fff5;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --border-color: #98e2ad;
            --gradient-start: #e6ffe6;
            --gradient-end: #f0fff5;
            --card-background: rgba(255, 255, 255, 0.8);
            --card-border: rgba(152, 226, 173, 0.5);
            --card-shadow: rgba(52, 199, 89, 0.1);
        }

        [data-theme="tech"] {
            --primary-color: #007aff;
            --hover-color: #0a84ff;
            --background-color: #f0f9ff;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --border-color: #99caff;
            --gradient-start: #e6f3ff;
            --gradient-end: #f0f9ff;
            --card-background: rgba(255, 255, 255, 0.8);
            --card-border: rgba(153, 202, 255, 0.5);
            --card-shadow: rgba(0, 122, 255, 0.1);
        }

        [data-theme="lavender"] {
            --primary-color: #af52de;
            --hover-color: #bf5af2;
            --background-color: #f9f0ff;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --border-color: #dcb1ff;
            --gradient-start: #f3e6ff;
            --gradient-end: #f9f0ff;
            --card-background: rgba(255, 255, 255, 0.8);
            --card-border: rgba(220, 177, 255, 0.5);
            --card-shadow: rgba(175, 82, 222, 0.1);
        }

        [data-theme="contrast"] {
            --primary-color: #000000;
            --hover-color: #1d1d1f;
            --background-color: #ffffff;
            --text-color: #000000;
            --secondary-text: #424245;
            --border-color: #1d1d1f;
            --gradient-start: #f5f5f7;
            --gradient-end: #ffffff;
            --card-background: rgba(255, 255, 255, 0.95);
            --card-border: rgba(0, 0, 0, 0.2);
            --card-shadow: rgba(0, 0, 0, 0.1);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 50px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px var(--card-shadow);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--card-shadow);
        }

        .theme-toggle .icon {
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
        }

        .theme-toggle .text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
                filter: blur(10px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
                filter: blur(0);
            }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* 允许文件输入框和下拉菜单可选中 */
        input, select, option {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: linear-gradient(-45deg, var(--gradient-start), var(--gradient-end));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-color);
            line-height: 1.5;
            letter-spacing: -0.022em;
            min-height: 100vh;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: transparent;
            box-shadow: none;
            animation: fadeIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        h1 {
            font-size: 48px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: -0.003em;
            color: var(--text-color);
            position: relative;
            animation: float 6s ease-in-out infinite;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            border-radius: 3px;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }

        .button {
            background: linear-gradient(145deg, var(--primary-color), var(--hover-color));
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 980px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 400;
            letter-spacing: -0.022em;
            min-width: 140px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 113, 227, 0.2);
            transform: translateY(0);
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                120deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: 0.5s;
        }

        .button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 113, 227, 0.3);
        }

        .button:hover::before {
            left: 100%;
        }

        .button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .upload-tips {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 30px var(--card-shadow);
            border-radius: 18px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
            font-size: 17px;
            line-height: 1.6;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .upload-tips:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 12px 40px var(--card-shadow);
        }

        .file-section {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 20px var(--card-shadow);
            border-radius: 18px;
            padding: 30px;
            margin: 20px 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .file-section:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 12px 40px var(--card-shadow);
        }

        .file-input {
            width: 100%;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--card-background);
            cursor: pointer;
            transform: scale(1);
        }

        .file-input:hover {
            border-color: var(--primary-color);
            background: var(--card-background);
            transform: scale(1.01);
            box-shadow: 0 4px 20px var(--card-shadow);
        }

        .column-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 17px;
            margin: 10px 0;
            background: var(--card-background);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            color: var(--text-color);
            transform: scale(1);
        }

        .column-select:hover {
            border-color: var(--primary-color);
            transform: scale(1.01);
            box-shadow: 0 4px 20px var(--card-shadow);
        }

        .column-select option {
            background: var(--background-color);
            color: var(--text-color);
        }

        .selected-column {
            background: linear-gradient(135deg, rgba(0, 113, 227, 0.1), rgba(0, 113, 227, 0.05));
            color: var(--primary-color);
            padding: 12px;
            border-radius: 12px;
            margin-top: 10px;
            font-size: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 113, 227, 0.2);
            animation: fadeIn 0.3s ease-out;
        }

        #loading {
            text-align: center;
            margin: 30px 0;
            font-size: 17px;
            color: var(--secondary-text);
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 113, 227, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 自动选择工作表提示样式 */
        .auto-select-info {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 10px;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(74, 222, 128, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #059669;
            text-align: left;
            animation: slideInUp 0.6s ease-out;
        }

        .auto-select-info i {
            font-size: 1.1rem;
            margin-right: 8px;
            color: #10b981;
        }

        /* 深色模式下的自动选择提示 */
        [data-theme="dark"] .auto-select-info {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(74, 222, 128, 0.15));
            border-color: rgba(34, 197, 94, 0.4);
            color: #6ee7b7;
        }

        [data-theme="dark"] .auto-select-info i {
            color: #34d399;
        }

        #error {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
            color: var(--error-color);
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 15px;
            text-align: center;
            display: none;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(220, 53, 69, 0.2);
            animation: fadeIn 0.3s ease-out;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 32px;
            }

            .button {
            width: 100%;
                margin: 10px 0;
            }

            .file-section {
                padding: 20px;
            }
        }

        #result-section {
            background: var(--card-background);
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            margin: 30px 0;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-section {
            background: linear-gradient(135deg, var(--card-background) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px var(--card-shadow);
            border-radius: 20px;
            padding: 32px;
            margin: 24px 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .result-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--hover-color));
            border-radius: 20px 20px 0 0;
        }

        .result-section:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px var(--card-shadow);
        }

        /* 分析结果标题美化 */
        .analysis-results-header h3 {
            color: var(--text-color);
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 30px 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .analysis-results-header h3 i {
            color: var(--primary-color);
            font-size: 32px;
        }

        [data-theme="dark"] .analysis-results-header h3 i {
            color: #64b5f6;
        }

        /* 分析模式标签 */
        .analysis-mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeInScale 0.5s ease-out;
        }

        .analysis-mode-badge.multi-file {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        [data-theme="dark"] .analysis-mode-badge {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .analysis-mode-badge.multi-file {
            background: linear-gradient(135deg, #7c4dff, #9c27b0);
        }

        .analysis-mode-badge i {
            font-size: 16px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* 数据洞察网格布局 */
        .data-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* 数据洞察卡片 */
        .data-insight-card {
            background: linear-gradient(135deg, var(--card-background) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            animation: slideInLeft 0.6s ease-out;
        }

        [data-theme="dark"] .data-insight-card {
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(60, 60, 60, 0.3) 100%);
            border: 1px solid rgba(66, 66, 69, 0.8);
        }

        .data-insight-card:nth-child(even) {
            animation: slideInRight 0.6s ease-out;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .data-insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--card-shadow);
        }

        .data-insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--hover-color));
            border-radius: 16px 16px 0 0;
        }

        .data-insight-card.unique-data::before {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
        }

        .data-insight-card.duplicate-data::before {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
        }

        .data-insight-card.common-data::before {
            background: linear-gradient(90deg, #45b7d1, #5ab7cd);
        }

        /* 洞察图标 */
        .insight-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .unique-data .insight-icon {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }

        .duplicate-data .insight-icon {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .common-data .insight-icon {
            background: linear-gradient(135deg, #45b7d1, #5ab7cd);
        }

        .insight-icon i {
            font-size: 24px;
            color: white;
        }

        /* 洞察内容 */
        .insight-content {
            flex: 1;
        }

        .insight-content h5 {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .insight-content .description {
            color: var(--secondary-text);
            font-size: 14px;
            margin: 0 0 16px 0;
            line-height: 1.5;
        }

        /* 指标显示 */
        .metric-display {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .metric-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        [data-theme="dark"] .metric-number {
            color: #64b5f6;
        }

        .metric-label {
            font-size: 14px;
            color: var(--secondary-text);
            font-weight: 500;
        }

        /* 文件头部样式 */
        .file-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        [data-theme="dark"] .file-header {
            border-bottom: 2px solid rgba(66, 66, 69, 0.8);
        }

        .file-name {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        .file-name i {
            font-size: 24px;
            color: var(--primary-color);
        }

        [data-theme="dark"] .file-name i {
            color: #64b5f6;
        }

        /* 多文件分析容器 */
        .multi-file-analysis {
            animation: fadeInUp 0.6s ease-out;
        }

        .file-comparison-section {
            margin-bottom: 32px;
        }

        .file-comparison-section:last-child {
            margin-bottom: 0;
        }

        /* 图表区域美化 */
        .chart-section-header {
            text-align: center;
            margin: 40px 0 30px 0;
            animation: fadeInDown 0.6s ease-out;
        }

        .chart-section-header h4 {
            color: var(--text-color);
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .chart-section-header h4 i {
            color: var(--primary-color);
            font-size: 28px;
        }

        .chart-section-header.single-file h4 i {
            color: #ff6b6b;
        }

        [data-theme="dark"] .chart-section-header h4 i {
            color: #64b5f6;
        }

        [data-theme="dark"] .chart-section-header.single-file h4 i {
            color: #ff8a80;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 多文件图表容器 */
        .multi-chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        /* 图表项 */
        .chart-item {
            animation: zoomIn 0.6s ease-out;
        }

        .chart-item:nth-child(even) {
            animation-delay: 0.2s;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* 图表卡片 */
        .chart-card {
            background: linear-gradient(135deg, var(--card-background) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .chart-card {
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(60, 60, 60, 0.3) 100%);
            border: 1px solid rgba(66, 66, 69, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--hover-color));
            border-radius: 20px 20px 0 0;
        }

        .chart-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px var(--card-shadow);
        }

        .chart-card.single-chart {
            max-width: 800px;
            margin: 0 auto;
        }

        .chart-card.single-chart::before {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
        }

        /* 图表标题 */
        .chart-title {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        [data-theme="dark"] .chart-title {
            border-bottom: 2px solid rgba(66, 66, 69, 0.8);
        }

        .chart-title i {
            color: var(--primary-color);
            font-size: 20px;
        }

        [data-theme="dark"] .chart-title i {
            color: #64b5f6;
        }

        /* 图表绘制区域 */
        .chart-plot-area {
            min-height: 400px;
            border-radius: 12px;
            position: relative;
        }

        .chart-plot-area.single-plot {
            min-height: 500px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .multi-chart-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .data-insights-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .chart-card {
                padding: 20px;
            }
            
            .chart-plot-area {
                min-height: 350px;
            }
            
            .analysis-results-header h3 {
                font-size: 24px;
            }
            
            .chart-section-header h4 {
                font-size: 20px;
            }
            
            .metric-number {
                font-size: 28px;
            }
            
            .data-insight-card {
                padding: 20px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .insight-icon {
                align-self: center;
            }
        }

        @media (max-width: 480px) {
            .chart-card {
                padding: 16px;
            }
            
            .result-section {
                padding: 24px;
            }
            
            .analysis-mode-badge {
                padding: 10px 20px;
                font-size: 13px;
            }
            
            .metric-number {
                font-size: 24px;
            }
            
                         .insight-content h5 {
                 font-size: 16px;
             }
         }

         /* 导出区域美化 */
         .export-section {
             margin-top: 40px;
             animation: slideInUp 0.8s ease-out;
         }

                 .export-card {
            background: linear-gradient(135deg, var(--card-background) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            display: flex;
            align-items: center;
            gap: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .export-card {
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(60, 60, 60, 0.3) 100%);
            border: 1px solid rgba(66, 66, 69, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

         .export-card::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 4px;
             background: linear-gradient(90deg, #28a745, #20c997);
             border-radius: 20px 20px 0 0;
         }

         .export-card:hover {
             transform: translateY(-4px);
             box-shadow: 0 12px 40px var(--card-shadow);
         }

         .export-icon {
             width: 64px;
             height: 64px;
             border-radius: 16px;
             background: linear-gradient(135deg, #28a745, #20c997);
             display: flex;
             align-items: center;
             justify-content: center;
             flex-shrink: 0;
             box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
         }

         .export-icon i {
             font-size: 32px;
             color: white;
         }

         .export-content {
             flex: 1;
         }

         .export-content h4 {
             color: var(--text-color);
             font-size: 20px;
             font-weight: 600;
             margin: 0 0 8px 0;
         }

         .export-content p {
             color: var(--secondary-text);
             font-size: 14px;
             margin: 0;
             line-height: 1.5;
         }

         .export-button {
             background: linear-gradient(135deg, #28a745, #20c997);
             color: white;
             border: none;
             border-radius: 12px;
             padding: 16px 32px;
             font-size: 16px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             display: flex;
             align-items: center;
             gap: 8px;
             box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
             flex-shrink: 0;
         }

         .export-button:hover {
             transform: translateY(-2px);
             box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
             background: linear-gradient(135deg, #218838, #1e7e34);
         }

         .export-button:active {
             transform: translateY(0);
         }

         .export-button i {
             font-size: 18px;
         }

         /* 导出区域响应式设计 */
         @media (max-width: 768px) {
             .export-card {
                 flex-direction: column;
                 text-align: center;
                 gap: 20px;
                 padding: 24px;
             }
             
             .export-content h4 {
                 font-size: 18px;
             }
             
             .export-button {
                 width: 100%;
                 justify-content: center;
                 padding: 14px 24px;
             }
         }

         @media (max-width: 480px) {
             .export-card {
                 padding: 20px;
             }
             
             .export-icon {
                 width: 56px;
                 height: 56px;
             }
             
             .export-icon i {
                 font-size: 28px;
             }
         }

         /* 数据可视化统计信息美化 */
         .chart-stats-container {
             margin: 30px 0;
             animation: slideInUp 0.8s ease-out;
         }

         .chart-stats-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
             gap: 20px;
         }

         .stat-item {
             background: linear-gradient(135deg, var(--card-background) 0%, rgba(255, 255, 255, 0.1) 100%);
             border: 1px solid var(--card-border);
             border-radius: 16px;
             padding: 20px;
             display: flex;
             align-items: center;
             gap: 16px;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             position: relative;
             overflow: hidden;
         }

         [data-theme="dark"] .stat-item {
             background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(60, 60, 60, 0.3) 100%);
             border: 1px solid rgba(66, 66, 69, 0.8);
         }

         .stat-item:hover {
             transform: translateY(-4px);
             box-shadow: 0 8px 24px var(--card-shadow);
         }

         .stat-item::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 3px;
             background: linear-gradient(90deg, var(--primary-color), var(--hover-color));
             border-radius: 16px 16px 0 0;
         }

         .stat-icon {
             width: 48px;
             height: 48px;
             border-radius: 12px;
             background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
             display: flex;
             align-items: center;
             justify-content: center;
             flex-shrink: 0;
         }

         .stat-icon i {
             font-size: 24px;
             color: white;
         }

         .stat-content {
             flex: 1;
         }

         .stat-value {
             display: block;
             font-size: 24px;
             font-weight: 700;
             color: var(--text-color);
             line-height: 1;
         }

         .stat-label {
             display: block;
             font-size: 13px;
             color: var(--secondary-text);
             margin-top: 4px;
             font-weight: 500;
         }

         /* 单个图表统计信息 */
         .single-chart-stats {
             margin: 16px 0;
             padding: 16px 0;
             border-bottom: 1px solid var(--border-color);
         }

         [data-theme="dark"] .single-chart-stats {
             border-bottom: 1px solid rgba(66, 66, 69, 0.8);
         }

         .mini-stats-grid {
             display: grid;
             grid-template-columns: repeat(3, 1fr);
             gap: 16px;
         }

         .mini-stat {
             text-align: center;
             padding: 12px;
             background: rgba(var(--primary-rgb), 0.1);
             border-radius: 12px;
             transition: all 0.2s ease;
         }

         .mini-stat:hover {
             background: rgba(var(--primary-rgb), 0.15);
             transform: translateY(-2px);
         }

         .mini-stat.unique {
             background: rgba(255, 107, 107, 0.1);
         }

         .mini-stat.unique:hover {
             background: rgba(255, 107, 107, 0.15);
         }

         .mini-stat.duplicate {
             background: rgba(78, 205, 196, 0.1);
         }

         .mini-stat.duplicate:hover {
             background: rgba(78, 205, 196, 0.15);
         }

         .mini-stat-value {
             display: block;
             font-size: 18px;
             font-weight: 700;
             color: var(--text-color);
             line-height: 1;
         }

         .mini-stat-label {
             display: block;
             font-size: 11px;
             color: var(--secondary-text);
             margin-top: 4px;
             font-weight: 500;
         }

         /* 单文件模式统计卡片 */
         .single-file-stats-container {
             margin: 30px 0;
             animation: slideInUp 0.8s ease-out;
         }

         .single-file-stats-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
             gap: 24px;
         }

         .single-stat-card {
             background: linear-gradient(135deg, var(--card-background) 0%, rgba(255, 255, 255, 0.1) 100%);
             border: 1px solid var(--card-border);
             border-radius: 20px;
             padding: 24px;
             display: flex;
             align-items: flex-start;
             gap: 20px;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             position: relative;
             overflow: hidden;
         }

         [data-theme="dark"] .single-stat-card {
             background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(60, 60, 60, 0.3) 100%);
             border: 1px solid rgba(66, 66, 69, 0.8);
         }

         .single-stat-card:hover {
             transform: translateY(-6px);
             box-shadow: 0 12px 40px var(--card-shadow);
         }

         .single-stat-card::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 4px;
             border-radius: 20px 20px 0 0;
         }

         .single-stat-card.primary::before {
             background: linear-gradient(90deg, var(--primary-color), var(--hover-color));
         }

         .single-stat-card.unique::before {
             background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
         }

         .single-stat-card.duplicate::before {
             background: linear-gradient(90deg, #4ecdc4, #44a08d);
         }

         .single-stat-icon {
             width: 56px;
             height: 56px;
             border-radius: 16px;
             display: flex;
             align-items: center;
             justify-content: center;
             flex-shrink: 0;
             box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
         }

         .single-stat-card.primary .single-stat-icon {
             background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
         }

         .single-stat-card.unique .single-stat-icon {
             background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
         }

         .single-stat-card.duplicate .single-stat-icon {
             background: linear-gradient(135deg, #4ecdc4, #44a08d);
         }

         .single-stat-icon i {
             font-size: 28px;
             color: white;
         }

         .single-stat-content {
             flex: 1;
         }

         .single-stat-value {
             display: block;
             font-size: 32px;
             font-weight: 700;
             color: var(--text-color);
             line-height: 1;
             margin-bottom: 8px;
         }

         .single-stat-label {
             display: block;
             font-size: 16px;
             color: var(--text-color);
             font-weight: 600;
             margin-bottom: 4px;
         }

         .single-stat-subtitle {
             font-size: 14px;
             color: var(--secondary-text);
             font-weight: 500;
         }

                 /* 使用记录模态框样式 */
        .history-modal-content {
            width: 90%;
            max-width: 850px;
            max-height: 95vh;
            padding: 0;
            overflow: hidden;
            overscroll-behavior: contain;
            display: flex;
            flex-direction: column;
        }

        /* 防止模态框内滚动时外界也滚动 */
        #history-modal {
            overscroll-behavior: contain;
            touch-action: none; /* 防止移动端滚动穿透 */
        }

        #history-modal .modal-content {
            overscroll-behavior: contain;
            touch-action: auto; /* 允许模态框内容滚动 */
        }

        /* 当模态框显示时锁定body滚动 */
        body.modal-open {
            overflow: hidden;
            height: 100vh;
        }

        /* 模态框内容区域 */
        .history-modal-content .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: 20px 20px 5px 20px;
            overflow: hidden;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--card-background);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }

        .stat-card:nth-child(1) .stat-icon { background: #3498db; }
        .stat-card:nth-child(2) .stat-icon { background: #9b59b6; }
        .stat-card:nth-child(3) .stat-icon { background: #e74c3c; }
        .stat-card:nth-child(4) .stat-icon { background: #27ae60; }

        .stat-number {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 1px;
            line-height: 1;
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1;
        }

        .history-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: var(--secondary-background);
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .filter-group select {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-background);
            color: var(--text-primary);
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
        }

        .refresh-btn, .export-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-background);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .refresh-btn:hover, .export-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .history-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-right: 8px;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: var(--secondary-background);
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .history-list .history-records {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 10px;
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: var(--card-background);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .type-analysis .history-icon { background: #3498db; }
        .type-ai .history-icon { background: #9b59b6; }
        .type-sales .history-icon { background: #e74c3c; }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .history-type {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .history-subtype {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--secondary-background);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .history-details {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .detail-item i {
            font-size: 11px;
            opacity: 0.7;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-完成 {
            background: #d4edda;
            color: #155724;
        }

        .empty-state, .loading-placeholder, .error-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i, .loading-placeholder i, .error-message i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading-placeholder i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-pagination {
            margin-top: 8px;
            padding: 8px 0 0 0;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.015) 100%);
        }

        .pagination-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 2px;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.7);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 3px;
            min-width: 32px;
            height: 32px;
            justify-content: center;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .page-btn i {
            font-size: 14px;
        }

        .page-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .page-btn:disabled:hover {
            background: rgba(255, 255, 255, 0.7);
            color: var(--text-primary);
            border-color: rgba(0, 0, 0, 0.08);
            transform: none;
            box-shadow: none;
        }

        .pagination-info {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.03);
            border-radius: 15px;
            padding: 2px 8px;
            display: inline-block;
            margin: 0 auto 0 auto;
        }

        /* 使用记录模态框响应式样式 */
        @media (max-width: 768px) {
            .history-modal-content {
                width: 98%;
                margin: 5px;
                max-height: 98vh;
            }
            
            .history-modal-content .modal-body {
                padding: 15px 15px 3px 15px;
            }
            
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                margin-bottom: 8px;
            }
            
            .stat-card {
                padding: 6px 8px;
                gap: 6px;
            }
            
            .stat-icon {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
            
            .stat-number {
                font-size: 16px;
            }
            
            .stat-label {
                font-size: 10px;
            }
            
            .history-filters {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .filter-actions {
                justify-content: center;
            }
            
            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            
            .history-time {
                margin-left: 0;
            }
            
            .pagination-buttons {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .page-btn {
                min-width: 28px;
                height: 28px;
                padding: 4px 6px;
                font-size: 11px;
            }
            
            .page-btn i {
                font-size: 12px;
            }
            
            .pagination-buttons {
                gap: 4px;
                margin-bottom: 1px;
            }
            
            .pagination-info {
                font-size: 10px;
                padding: 1px 6px;
            }
            
            .history-pagination {
                padding: 6px 0 0 0;
                margin-top: 6px;
            }
        }

        /* 深色主题下的分页样式 */
        [data-theme="dark"] .history-pagination {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: linear-gradient(180deg, transparent 0%, rgba(255, 255, 255, 0.02) 100%);
        }

        [data-theme="dark"] .page-btn {
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        [data-theme="dark"] .page-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .page-btn:disabled:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .pagination-info {
            background: rgba(255, 255, 255, 0.03);
        }

        /* 响应式设计 */
         @media (max-width: 768px) {
             .chart-stats-grid {
                 grid-template-columns: 1fr;
                 gap: 16px;
             }
             
             .single-file-stats-grid {
                 grid-template-columns: 1fr;
                 gap: 20px;
             }
             
             .mini-stats-grid {
                 grid-template-columns: 1fr;
                 gap: 12px;
             }
             
             .single-stat-card {
                 padding: 20px;
                 flex-direction: column;
                 text-align: center;
                 gap: 16px;
             }
             
             .single-stat-icon {
                 align-self: center;
             }
             
             .single-stat-value {
                 font-size: 28px;
             }
         }

         @media (max-width: 480px) {
             .stat-item {
                 flex-direction: column;
                 text-align: center;
                 gap: 12px;
                 padding: 16px;
             }
             
             .single-stat-card {
                 padding: 16px;
             }
             
             .single-stat-value {
                 font-size: 24px;
             }
        }

        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px var(--card-shadow);
            transform: translateY(0) rotate(0deg);
            margin-right: 60px; /* 添加右边距，放在账户按钮左侧 */
        }

        .settings-btn:hover {
            transform: translateY(-2px) rotate(90deg);
            box-shadow: 0 8px 25px var(--card-shadow);
        }

        .settings-btn .icon {
            width: 24px;
            height: 24px;
            color: var(--text-color);
        }

        .settings-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--card-background);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
        }

        .settings-menu.show {
            opacity: 0.95;
            visibility: visible;
            transform: translateY(0);
        }

        .settings-menu::-webkit-scrollbar {
            width: 8px;
        }

        .settings-menu::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: 4px;
        }

        .settings-menu::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .settings-menu::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-text);
        }

        .settings-menu h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .settings-item {
            margin-bottom: 30px;
            background: var(--card-background);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--card-shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            position: relative;
        }

        .settings-item-title::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 50px;
            height: 2px;
            background: var(--primary-color);
        }

        .settings-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .settings-option {
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: #222;
            color: var(--text-color);
            border: 1px solid #333;
            transform: scale(1);
            text-align: center;
            display: flex;
            flex-direction: row; /* 水平排列 */
            align-items: center;
            justify-content: flex-start; /* 左对齐 */
            position: relative;
            overflow: hidden;
            gap: 10px; /* 增加间距 */
        }

        .settings-option:hover {
            background: #2a2a2a;
            color: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--card-shadow);
        }

        .settings-option.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(var(--primary-rgb), 0.25);
        }

        .settings-option:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(var(--primary-rgb), 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .settings-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            margin-right: 60px; /* 调整位置，放在账户按钮左侧 */
        }

        .settings-menu {
            position: absolute;
            top: 50px;
            right: 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 400px; /* 增加设置菜单宽度 */
            max-width: 90vw;
        }

        .settings-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .shortcut-list {
            margin-top: 8px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .shortcut-key {
            background: var(--background-color);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shortcut-key:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .shortcut-key.recording {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .delete-file {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1;
            padding: 0;
        }

        .delete-file:hover {
            transform: scale(1.1);
            background: #c82333;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .container {
            position: relative;
            z-index: 1;
        }

        /* 添加动画禁用时的样式 */
        [data-animation="off"] * {
            animation: none !important;
            transition: none !important;
            transform: none !important;
        }

        [data-animation="off"] .settings-menu {
            opacity: 0;
            visibility: hidden;
        }

        [data-animation="off"] .settings-menu.show {
            opacity: 1;
            visibility: visible;
        }

        .file-info {
            position: relative;
            min-height: 24px;
        }

        .loading-text {
            display: inline-block;
            margin-left: 10px;
            color: var(--secondary-text);
            font-size: 14px;
            animation: fadeIn 0.3s ease-out;
        }

        .mini-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 113, 227, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* 导航容器 */
        .mode-selection {
  display: flex;
  justify-content: center;
  margin: 20px 0;
        }

        .mode-buttons {
            display: flex;
            justify-content: center;
  gap: 15px;
  padding: 15px;
  background: linear-gradient(135deg, rgba(60, 90, 150, 0.6), rgba(90, 60, 150, 0.6));
  border-radius: 18px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* 适配深色/浅色主题 */
@media (prefers-color-scheme: light) {
  .mode-buttons {
    background: linear-gradient(135deg, rgba(230, 240, 255, 0.8), rgba(240, 230, 255, 0.8));
    box-shadow: 0 8px 32px rgba(100, 100, 150, 0.15);
  }
}

/* 导航按钮 - 使用更丰富的渐变色 */
        .mode-btn {
  position: relative;
  padding: 14px 26px;
  border: none;
  border-radius: 12px;
  color: white;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
  cursor: pointer;
            overflow: hidden;
  z-index: 1;
}

/* 为每个按钮设置不同的渐变色 */
#compare-mode-btn {
  background: linear-gradient(135deg, #0062ff, #0045b5);
  box-shadow: 0 4px 15px rgba(0, 98, 255, 0.35);
}

#single-mode-btn {
  background: linear-gradient(135deg, #3a7bd5, #00d2ff);
  box-shadow: 0 4px 15px rgba(58, 123, 213, 0.35);
}

#ai-mode-btn {
  background: linear-gradient(135deg, #6a3093, #a044ff);
  box-shadow: 0 4px 15px rgba(106, 48, 147, 0.35);
}

#sales-trend-btn {
  background: linear-gradient(135deg, #ff7e5f, #feb47b);
  box-shadow: 0 4px 15px rgba(255, 126, 95, 0.35);
}

/* 激活状态 */
.mode-btn.active {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.mode-btn.active::after {
            content: '';
            position: absolute;
  bottom: -5px;
            left: 50%;
  transform: translateX(-50%);
  width: 40%;
  height: 4px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 4px;
}

/* 鼠标悬停效果 */
.mode-btn:hover {
  transform: translateY(-2px);
  filter: brightness(1.1);
}

/* 添加图标 */
.mode-btn i {
  margin-right: 10px;
  font-size: 20px;
  vertical-align: middle;
}

/* 内部光效 */
.mode-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
  z-index: -1;
        }

        .particle-colors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            padding: 0;
            transition: transform 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--background-color), 0 0 0 4px var(--primary-color);
        }

        .custom-color {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }

        .custom-color input[type="color"] {
            width: 24px;
            height: 24px;
            padding: 0;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            background: none;
        }

        .custom-color input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .custom-color input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .custom-color label {
            font-size: 14px;
            color: var(--text-color);
            cursor: pointer;
        }

        .custom-color:hover input[type="color"] {
            transform: scale(1.1);
        }

        #error.offline {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
            color: var(--error-color);
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(220, 53, 69, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.5;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .container {
            animation: fadeIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .file-section {
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-menu.show {
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .button {
            position: relative;
            overflow: hidden;
        }

        .button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1);
            animation: ripple 1s cubic-bezier(0, 0, 0.2, 1);
        }

        .button:active::after {
            animation: none;
        }

        .selected-column {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #result-section {
            animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-option {
            position: relative;
            overflow: hidden;
        }

        .settings-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1);
            animation: ripple 1s cubic-bezier(0, 0, 0.2, 1);
        }

        .settings-option:active::after {
            animation: none;
        }

        .mode-btn {
            position: relative;
            overflow: hidden;
        }

        .mode-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1);
            animation: ripple 1s cubic-bezier(0, 0, 0.2, 1);
        }

        .mode-btn:active::after {
            animation: none;
        }

        [data-animation="off"] * {
            animation: none !important;
            transition: none !important;
        }

        .color-palette {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px var(--card-shadow);
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .color-palette-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .color-palette-header span {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
        }

        .reset-btn {
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reset-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .color-palette-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .theme-color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-color-picker-wrapper {
            position: relative;
            width: 60px;
            height: 60px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .theme-color-picker-wrapper:hover {
            transform: scale(1.05);
        }

        .theme-color-picker-wrapper input[type="color"] {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 70px;
            height: 70px;
            border: none;
            cursor: pointer;
            padding: 0;
            background: none;
        }

        .theme-color-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .theme-color-label {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-color);
        }

        .theme-color-description {
            font-size: 13px;
            color: var(--secondary-text);
        }

        .theme-color-presets {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .theme-color-preset {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .theme-color-preset:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .theme-color-preset.active {
            border-color: white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        @media screen and (max-width: 768px) {
            .theme-color-presets {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .color-values {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        #theme-color-hex, #color-hex {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: monospace;
            color: var(--text-color);
            background: var(--background-color);
            transition: all 0.2s ease;
        }

        .rgb-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .rgb-inputs input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            background: var(--background-color);
            text-align: center;
            transition: all 0.2s ease;
        }

        .rgb-inputs input::placeholder {
            color: var(--secondary-text);
        }

        .color-values input:focus, 
        .rgb-inputs input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
        }

        /* 添加移动端适配样式 */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
                margin-top: 60px;
            }

            .settings-area {
                width: 100%;
                height: 100%;
                position: fixed;
                top: 0;
                right: -100%;
                background: var(--background-color);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                transition: right 0.3s ease;
                z-index: 1000;
                padding: 20px;
                overflow-y: auto;
            }

            .settings-area.show {
                right: 0;
            }

            .settings-btn {
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 1001;
            }

            .settings-menu {
                position: static;
                transform: none;
                opacity: 1;
                visibility: visible;
                width: 100%;
                max-height: none;
                border: none;
                box-shadow: none;
                margin-top: 40px;
            }

            .settings-options {
                flex-wrap: wrap;
            }

            .settings-option {
                flex: 0 0 calc(50% - 5px);
                margin: 2.5px;
            }

            .color-palette-content {
                flex-direction: column;
            }

            .color-palette-content input[type="color"] {
                width: 100%;
                height: 50px;
            }

            .shortcut-list {
                display: none;  /* 在移动端隐藏快捷键设置 */
            }

            .mode-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .mode-btn {
                width: 100%;
            }

            .file-section {
                padding: 10px;
            }

        .file-header {
                flex-direction: column;
                gap: 10px;
            }

            .column-select {
                width: 100%;
            }

            #result-section {
                overflow-x: auto;
            }

            /* 优化触摸体验 */
            .settings-option, .mode-btn, .color-option, .reset-btn {
                min-height: 44px;  /* 确保触摸目标足够大 */
            }

            .particle-colors {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .color-option {
                width: 100%;
                height: 44px;
            }

            /* 优化输入控件 */
            input[type="text"],
            input[type="number"],
            select {
                font-size: 16px;  /* 防止iOS自动缩放 */
                padding: 10px;
            }

            .rgb-inputs {
                grid-template-columns: repeat(3, 1fr);
            }

            /* 添加关闭按钮 */
            .settings-close {
                position: absolute;
                top: 20px;
                right: 20px;
                cursor: pointer;
                padding: 10px;
            }
        }

        /* 添加退出登录按钮样式 */
        .logout-option {
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, var(--error-color) 0%, #ff6b6b 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(var(--error-color-rgb), 0.2);
            width: 100%;
            text-align: center;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .logout-option i {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .logout-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--error-color-rgb), 0.4);
        }

        .logout-option:hover i {
            transform: translateX(3px);
        }

        .logout-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .logout-option:hover::before {
            width: 300px;
            height: 300px;
        }

        /* 自定义弹窗样式 */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
            border: 1px solid var(--card-border);
            transform: translateY(0);
            transition: transform 0.3s ease;
            animation: modalContentSlideIn 0.4s ease;
        }

        .modal-content:hover {
            transform: translateY(-5px);
        }

        .modal-icon {
            margin-bottom: 20px;
            font-size: 48px;
            color: var(--primary-color);
            display: inline-block;
            animation: iconPulse 2s infinite;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 15px;
        }

        .modal-message {
            font-size: 16px;
            color: var(--secondary-text);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }

        .modal-button-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-button-primary:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 113, 227, 0.3);
        }

        .modal-button-secondary {
            background-color: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .modal-button-secondary:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalContentSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes iconPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        /* 多文件图表容器样式 */
        #plot {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .multi-chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        
        .chart-item {
            flex: 1 1 450px;  /* 增加基础宽度 */
            min-width: 350px; /* 增加最小宽度 */
            max-width: 550px; /* 增加最大宽度 */
            min-height: 420px; /* 增加高度以容纳所有内容 */
            border-radius: 16px;
            padding: 20px 25px 45px 25px; /* 增加左右和底部填充 */
            background-color: var(--card-background);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: visible; /* 改为visible允许内容溢出容器 */
        }
        
        .chart-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .chart-item {
                flex: 1 1 100%;
                max-width: 100%;
            }
        }

        /* 增强多文件图表容器样式 */
        .multi-chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            padding: 10px;
        }

        .chart-item {
            flex: 1 1 400px;
            min-width: 320px;
            max-width: 500px;
            min-height: 400px;
            border-radius: 16px;
            padding: 20px 15px 30px 15px;
            background-color: var(--card-background);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chart-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
            position: relative;
            padding-bottom: 10px;
        }

        .chart-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
        }

        /* 适配深色模式的图表样式 */
        [data-theme="dark"] .g-gtitle {
            fill: #f5f5f7 !important;
        }

        [data-theme="dark"] .gtitle {
            fill: #f5f5f7 !important;
        }

        /* 图表加载动画 */
        @keyframes chartFadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .chart-item {
            animation: chartFadeIn 0.5s ease forwards;
        }

        .chart-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .chart-item:nth-child(3) {
            animation-delay: 0.2s;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .chart-item {
                flex: 1 1 100%;
                max-width: 100%;
                min-height: 350px;
            }
            
            .chart-title {
                font-size: 16px;
            }
        }
        
        .notification-item:hover::after {
            opacity: 0.5;
        }
        
        .notification-item.swiped::after,
        .notification-item.swiping::after {
            opacity: 0;
        }
        
        /* 添加拖动鼠标样式 */
        .notification-item:hover {
            cursor: grab;
        }
        
        .notification-item.swiping {
            cursor: grabbing !important;
            transition: none !important;
            z-index: 10;
            pointer-events: none;
        }
        
        .notification-item.swiped {
            z-index: 5;
        }

        .notification-delete-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(255, 69, 58, 0.1);
            color: #ff453a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer !important;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification-delete-button:hover {
            background-color: rgba(255, 69, 58, 0.2);
        }
        
        .notification-delete-button i {
            font-size: 18px;
        }
        
        /* 确认删除对话框 */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .confirm-dialog.active {
            visibility: visible;
            opacity: 1;
        }
        
        .confirm-dialog-content {
            background-color: var(--background-color);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .confirm-dialog.active .confirm-dialog-content {
            transform: translateY(0);
        }
        
        .confirm-dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .confirm-dialog-message {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .confirm-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .confirm-dialog-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .confirm-dialog-button.cancel {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        
        .confirm-dialog-button.confirm {
            background-color: #ff453a;
            color: white;
        }
        
        .confirm-dialog-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .confirm-dialog-content {
            background-color: #2a2a2c;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="dark"] .confirm-dialog-button.cancel {
            background-color: #3d3d42;
        }

        /* 添加主题指示器样式 */
        .option-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.3);
            margin-right: 6px;
            flex-shrink: 0;
        }

        .option-indicator.light {
            background: linear-gradient(135deg, #ffffff, #f0f2f5);
        }

        .option-indicator.dark {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        }

        .option-indicator.warm {
            background: linear-gradient(135deg, #ffd699, #ffb366);
        }

        .option-indicator.cool {
            background: linear-gradient(135deg, #99ccff, #66b3ff);
        }

        .option-indicator.nature {
            background: linear-gradient(135deg, #99cc99, #66b366);
        }

        .option-indicator.tech {
            background: linear-gradient(135deg, #66cccc, #339999);
        }

        .option-indicator.lavender {
            background: linear-gradient(135deg, #cc99ff, #9966cc);
        }

        .option-indicator.contrast {
            background: linear-gradient(135deg, #000000, #ffffff);
        }

        .option-label {
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        /* 自定义颜色区域 */
        .color-palette {
            display: none;
        }

        .color-palette-header,
        .color-palette-content,
        .color-values,
        .rgb-inputs,
        .theme-color-picker-container,
        .theme-color-presets,
        .theme-color-preset {
            display: none;
        }

        /* 修改主题选项布局 */
        .theme-options {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* 主题选项样式 */
        .theme-options .settings-option {
            background: #000;
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 12px;
            height: 50px;
            margin-bottom: 4px;
            position: relative;
            overflow: hidden;
        }

        .theme-options .settings-option:hover, 
        .theme-options .settings-option.active {
            background: #1E90FF;
            color: white;
            border: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 144, 255, 0.3);
        }

        .theme-options .settings-option.active {
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
        }

        /* 移动端适配 */
        @media screen and (max-width: 768px) {
            .settings-menu {
                width: 100%;
                max-width: 100%;
            }
            
            .theme-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .settings-option {
                padding: 8px;
            }
        }

        /* 添加以下CSS来确保自定义主题下的文字可读性 */
        .settings-option {
            /* 现有样式 */
            color: var(--text-color);
        }

        .theme-options .settings-option {
            /* 现有样式 */
            color: #fff; /* 固定白色文字 */
        }

        .theme-options .settings-option.active {
            /* 固定高对比度 */
            color: white;
        }

        .color-palette-header span {
            color: var(--text-color); /* 确保明确使用文本颜色变量 */
        }

        .theme-color-label {
            color: var(--text-color); /* 确保明确使用文本颜色变量 */
        }

        .theme-color-description {
            color: var(--secondary-text); /* 确保明确使用辅助文本颜色变量 */
        }

        /* 主按钮样式更新，确保可读性 */
        .button, .modal-button-primary {
            background-color: var(--primary-color);
            color: var(--button-text); /* 使用对比色文字 */
        }

        /* 卡片和边框颜色 */
        .card, .settings-item, .color-palette {
            background: var(--card-background);
            border-color: var(--card-border);
        }

        /* 动画效果开关样式 */
        .toggle-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toggle-option-container {
            display: flex;
            gap: 15px;
        }

        .toggle-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: #000;
            color: #fff;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            height: 50px;
        }

        .toggle-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .toggle-option.active {
            background: #1E90FF;
            color: white;
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
        }

        .toggle-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .animation-description {
            font-size: 12px;
            color: var(--secondary-text);
            text-align: center;
            padding: 0 10px;
        }

        /* 粒子效果相关样式 */
        .particle-color-section {
            margin-top: 15px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05));
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* 浅色主题下的粒子颜色区域 */
        [data-theme="light"] .particle-color-section,
        [data-theme="warm"] .particle-color-section,
        [data-theme="cool"] .particle-color-section,
        [data-theme="nature"] .particle-color-section, 
        [data-theme="tech"] .particle-color-section,
        [data-theme="lavender"] .particle-color-section,
        [data-theme="contrast"] .particle-color-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .color-section-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .color-section-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-color);
        }

        .color-section-title i {
            font-size: 18px;
            color: var(--primary-color);
        }

        .color-section-subtitle {
            font-size: 13px;
            color: var(--text-secondary-color);
            opacity: 0.8;
        }

        .color-presets {
            margin-bottom: 20px;
        }

        .color-presets-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary-color);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .particle-color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-option-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        [data-theme="light"] .color-option-new,
        [data-theme="warm"] .color-option-new,
        [data-theme="cool"] .color-option-new,
        [data-theme="nature"] .color-option-new,
        [data-theme="tech"] .color-option-new,
        [data-theme="lavender"] .color-option-new,
        [data-theme="contrast"] .color-option-new {
            background: rgba(255, 255, 255, 0.6);
        }

        .color-option-new:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .color-option-new:hover,
        [data-theme="warm"] .color-option-new:hover,
        [data-theme="cool"] .color-option-new:hover,
        [data-theme="nature"] .color-option-new:hover,
        [data-theme="tech"] .color-option-new:hover,
        [data-theme="lavender"] .color-option-new:hover,
        [data-theme="contrast"] .color-option-new:hover {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .color-option-new.active {
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .color-option-new.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .color-option-new:hover .color-dot {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }

        .color-name {
            font-size: 11px;
            color: var(--text-color);
            font-weight: 500;
            text-align: center;
            opacity: 0.9;
        }

        .custom-color-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        [data-theme="light"] .custom-color-section,
        [data-theme="warm"] .custom-color-section,
        [data-theme="cool"] .custom-color-section,
        [data-theme="nature"] .custom-color-section,
        [data-theme="tech"] .custom-color-section,
        [data-theme="lavender"] .custom-color-section,
        [data-theme="contrast"] .custom-color-section {
            border-top-color: rgba(0, 0, 0, 0.1);
        }

        .custom-color-picker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .custom-color-input {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .color-picker-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .color-picker-wrapper input[type="color"] {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }

        .color-picker-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark, #0056b3));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .color-picker-wrapper:hover .color-picker-overlay {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .custom-color-input label {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 500;
            cursor: pointer;
        }

        .reset-color-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        [data-theme="light"] .reset-color-btn,
        [data-theme="warm"] .reset-color-btn,
        [data-theme="cool"] .reset-color-btn,
        [data-theme="nature"] .reset-color-btn,
        [data-theme="tech"] .reset-color-btn,
        [data-theme="lavender"] .reset-color-btn,
        [data-theme="contrast"] .reset-color-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            border-color: rgba(0, 0, 0, 0.1);
        }

        .reset-color-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .reset-color-btn:hover,
        [data-theme="warm"] .reset-color-btn:hover,
        [data-theme="cool"] .reset-color-btn:hover,
        [data-theme="nature"] .reset-color-btn:hover,
        [data-theme="tech"] .reset-color-btn:hover,
        [data-theme="lavender"] .reset-color-btn:hover,
        [data-theme="contrast"] .reset-color-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.8));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .reset-color-btn i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .reset-color-btn:hover i {
            transform: rotate(180deg);
        }

        /* 移动端适配 */
        @media screen and (max-width: 768px) {
            .particle-color-section {
                padding: 16px;
            }
            
            .particle-color-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .color-option-new {
                padding: 10px 6px;
                gap: 6px;
            }
            
            .color-dot {
                width: 20px;
                height: 20px;
            }
            
            .color-name {
                font-size: 10px;
            }
            
            .custom-color-picker {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .custom-color-input {
                justify-content: center;
            }
            
            .reset-color-btn {
                align-self: center;
                padding: 8px 12px;
            }
        }

        @media screen and (max-width: 480px) {
            .color-section-title {
                font-size: 15px;
            }
            
            .color-section-subtitle {
                font-size: 12px;
            }
            
            .color-presets-label {
                font-size: 12px;
            }
        }

        .shortcut-tip {
            font-size: 14px;
            color: var(--text-secondary-color);
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        /* 关于部分样式 */
        .about-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            background: var(--card-bg-color);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .about-logo {
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .about-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 5px;
            color: var(--primary-color);
        }

        .about-version {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .about-description {
            font-size: 14px;
            color: var(--text-secondary-color);
            margin-bottom: 15px;
            line-height: 1.5;
            max-width: 300px;
        }

        .about-divider {
            height: 1px;
            width: 80%;
            background: var(--border-color);
            margin: 10px 0;
        }

        .about-info {
            width: 100%;
            margin: 10px 0;
        }

        .about-info-item {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
            font-size: 13px;
            color: var(--text-secondary-color);
        }

        .about-info-item i {
            margin-right: 8px;
            font-size: 16px;
            color: var(--primary-color);
        }

        .about-social {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }

        .about-social-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--button-bg-color);
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .about-social-icon:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .about-copyright {
            font-size: 12px;
            color: var(--text-secondary-color);
            margin-top: 10px;
        }

        /* 账户管理模块样式 */
        .account-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px;
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--card-bg-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .account-avatar {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .account-details {
            flex: 1;
        }

        .account-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .account-email {
            font-size: 14px;
            color: var(--text-secondary-color);
        }

        .account-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .account-option-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--card-bg-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
        }

        .account-option-item i {
            font-size: 20px;
            color: var(--primary-color);
        }

        .account-option-item span {
            font-size: 13px;
        }

        .account-option-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        /* 调整退出登录按钮 */
        .logout-option {
            margin-top: 10px;
        }

        /* 账户管理模块样式 */
        .account-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            margin-right: 0; /* 调整位置，放在最右侧 */
        }

        .account-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--card-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid var(--card-border);
            box-shadow: 0 2px 10px var(--card-shadow);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0) rotate(0deg);
            position: relative;
            overflow: hidden;
        }

        .account-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(var(--primary-color-rgb, 0, 113, 227), 0.1) 0%, rgba(var(--primary-color-rgb, 0, 113, 227), 0) 70%);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .account-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px var(--card-shadow);
            border-color: var(--primary-color);
        }

        .account-btn:hover::before {
            opacity: 1;
            transform: scale(1);
            animation: pulse 1.5s infinite;
        }

        .account-btn:hover .icon {
            animation: wave 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: scale(1);
                opacity: 0.5;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.7;
            }
        }

        @keyframes wave {
            0% {
                transform: translateX(0) rotate(0);
            }
            25% {
                transform: translateX(-2px) rotate(-5deg);
            }
            75% {
                transform: translateX(2px) rotate(5deg);
            }
            100% {
                transform: translateX(0) rotate(0);
            }
        }

        .account-btn .icon {
            width: 24px;
            height: 24px;
            color: var(--text-color);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .account-menu {
            position: absolute;
            top: 60px;
            right: 0;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            background: var(--card-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--card-shadow);
            padding: 20px;
            border: 1px solid var(--card-border);
            transform-origin: top right;
            transform: scale(0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .account-menu.show {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        .account-menu h3 {
            margin: 0 0 20px 0;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
        }

        .notification-wrapper {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            margin-right: 120px; /* 调整位置，放在设置按钮左侧 */
        }

        .notification-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--card-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid var(--card-border);
            box-shadow: 0 2px 10px var(--card-shadow);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0) rotate(0deg);
            position: relative;
        }

        .notification-button:hover {
            transform: translateY(-2px) rotate(30deg);
            box-shadow: 0 8px 25px var(--card-shadow);
        }

        .notification-button i {
            font-size: 24px;
            color: var(--text-color);
        }

        .profile-modal-content {
            width: 450px;
            max-width: 90%;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 5px 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }

        .close-button {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .close-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .button {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .button-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            background-color: var(--hover-color);
            transform: translateY(-2px);
        }

        .button-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cancel-button {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .cancel-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .verification-input-group {
            display: flex;
            gap: 10px;
        }

        .verification-input-group input {
            flex: 1;
        }

        .verification-input-group button {
            white-space: nowrap;
            flex-shrink: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
            outline: none;
        }

        .form-group input:read-only {
            background-color: rgba(var(--primary-color-rgb), 0.05);
            cursor: not-allowed;
        }

        .form-text {
            font-size: 12px;
            margin-top: 4px;
            color: var(--secondary-text);
        }

        .button-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-success {
            background-color: #10b981; /* 绿色 */
            color: white;
        }

        .button-success:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .button-success:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cancel-button {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .cancel-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .form-group input:read-only {
            background-color: rgba(var(--primary-color-rgb), 0.05);
            cursor: not-allowed;
        }

        .readonly-confirmed {
            background-color: rgba(var(--primary-color-rgb), 0.12) !important;
            border-color: var(--primary-color) !important;
            color: var(--text-color) !important;
            box-shadow: 0 0 0 1px rgba(var(--primary-color-rgb), 0.2);
            position: relative;
        }

        .readonly-confirmed::after {
            content: "✓";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-weight: bold;
        }

        .form-text {
            font-size: 12px;
            margin-top: 4px;
            color: var(--secondary-text);
        }

        /* 成功提示样式 */
        .success-notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: successFadeIn 0.3s ease;
        }

        .success-content {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
            border: 1px solid var(--card-border);
            animation: successSlideIn 0.4s ease;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .success-icon i {
            font-size: 40px;
            color: var(--primary-color);
            animation: successScaleIn 0.5s ease;
        }

        .success-message h3 {
            font-size: 22px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .success-message p {
            font-size: 16px;
            color: var(--secondary-text);
            margin-bottom: 5px;
        }

        .success-progress {
            height: 4px;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 100%;
            border-radius: 2px;
            animation: successProgressShrink 3s linear forwards;
        }

        /* 使用命名空间前缀避免样式冲突 */
        @keyframes successFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes successSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px); 
            }
            to { 
                opacity: 1;
                transform: translateY(0); 
            }
        }

        @keyframes successScaleIn {
            0% { transform: scale(0); }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes successProgressShrink {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* 用户名修改频率限制提示样式 */
        .form-info {
            margin: 10px 0 15px;
            padding: 10px 15px;
            background-color: rgba(var(--primary-color-rgb), 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }

        .form-info small {
            font-size: 13px;
            line-height: 1.5;
            display: block;
            font-weight: 500;
        }

        /* 账户安全模态框样式 */
        .security-modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
        }
        
        .security-modal-content .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .security-modal-content .modal-body {
            padding: 20px;
        }
        
        .security-modal-content .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }
        
        .security-section {
            margin-bottom: 20px;
        }
        
        .security-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .security-header i {
            font-size: 22px;
            color: var(--primary-color);
            margin-right: 10px;
        }
        
        .security-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }
        
        .password-strength-container {
            background-color: rgba(var(--card-background), 0.5);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-input-container input {
            flex: 1;
            padding-right: 40px;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggle-password:hover {
            color: var(--primary-color);
        }
        
        .strength-meter-container {
            margin: 15px 0;
        }
        
        .strength-meter {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .strength-bar {
            height: 100%;
            width: 0;
            border-radius: 4px;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .strength-text {
            font-size: 14px;
            margin-top: 5px;
            text-align: right;
            font-weight: 500;
        }
        
        .password-tips {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }
        
        .password-tips h5 {
            font-size: 15px;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .password-tips ul {
            padding-left: 20px;
            margin: 0;
        }
        
        .password-tips li {
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--secondary-text);
            transition: color 0.3s;
        }
        
        .password-tips li.valid {
            color: #28a745;
            text-decoration: line-through;
        }
        
        .password-tips li.valid::before {
            content: "✓ ";
            color: #28a745;
        }
        
        .password-tips li.invalid::before {
            content: "○ ";
            color: var(--secondary-text);
        }
        
        /* 强度级别颜色 */
        .strength-very-weak {
            background-color: #dc3545;
            width: 20%;
        }
        
        .strength-weak {
            background-color: #fd7e14;
            width: 40%;
        }
        
        .strength-medium {
            background-color: #ffc107;
            width: 60%;
        }
        
        .strength-strong {
            background-color: #28a745;
            width: 80%;
        }
        
        .strength-very-strong {
            background-color: #20c997;
            width: 100%;
        }

        /* 密码年龄提示样式 */
        .password-age-warning {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--text-color);
            animation: fadeIn 0.5s ease;
        }
        
        .password-age-warning i {
            margin-right: 8px;
            color: #ffc107;
            font-size: 18px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 安全模态框标签切换样式 */
        .security-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-button {
            padding: 10px 15px;
            margin-right: 4px;
            border: none;
            background: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-button:hover:not(.active) {
            color: var(--primary-hover-color);
            border-bottom: 3px solid var(--border-color);
        }
        
        /* 密码修改表单样式 */
        .password-change-container {
            background-color: rgba(var(--card-background), 0.5);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-input-container input {
            flex: 1;
            padding-right: 40px;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 0;
            font-size: 18px;
        }
        
        .toggle-password:hover {
            color: var(--text-color);
        }
        
        .password-match-message {
            margin-top: 5px;
            font-size: 13px;
        }
        
        .form-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .form-message.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border-left: 3px solid #28a745;
            display: block;
        }
        
        .form-message.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border-left: 3px solid #dc3545;
            display: block;
        }
        
        .form-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        /* 密码修改表单样式优化 */
        .password-change-container {
            background-color: rgba(var(--card-background), 0.5);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .security-header {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .security-header i {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .security-header h4 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
            outline: none;
        }
        
        /* 邮箱验证码样式 */
        .verify-code-container {
            display: flex;
            gap: 10px;
        }
        
        .verify-code-container input {
            flex: 1;
        }
        
        .send-code-button {
            white-space: nowrap;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-code-button:hover {
            background-color: var(--primary-hover-color);
        }
        
        .send-code-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .verify-code-tip {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 6px;
        }
        
        /* 改进的强度条样式 */
        .strength-meter {
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .strength-bar {
            height: 100%;
            border-radius: 3px;
            width: 0;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        
        .strength-text {
            font-size: 13px;
            font-weight: 500;
        }
        
        /* 密码匹配消息样式 */
        .password-match-message {
            font-size: 13px;
            font-weight: 500;
            margin-top: 6px;
            height: 18px;
        }
        
        /* 表单消息样式 */
        .form-message {
            margin: 15px 0;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            line-height: 1.5;
        }
        
        /* 保存按钮样式 */
        .form-actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
        }
        
        .primary-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .primary-button:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(var(--primary-color-rgb), 0.25);
        }
        
        .primary-button i {
            font-size: 18px;
        }
        
        .primary-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 关闭按钮样式优化 */
        .close-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-button:hover {
            background-color: rgba(var(--text-color-rgb), 0.1);
            color: var(--primary-color);
        }

        /* 登录历史样式 */
        .login-history-container {
            background-color: rgba(var(--card-background), 0.5);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 25px;
        padding: 16px;
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

        .filter-group {
            display: flex;
            align-items: center;
        }

        .filter-group select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background-color: rgba(255, 255, 255, 0.07);
            color: var(--text-color);
            appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-group select:hover {
            border-color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
        }

        .filter-group label {
            margin-right: 8px;
            font-weight: 500;
            color: var(--text-color);
            display: inline-block;
            min-width: 50px;
        }

        .history-view-toggle {
            display: flex;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 5px;
        }

        .view-btn {
            background: none;
            border: none;
            padding: 10px 16px;
            margin: 0;
            border-radius: 8px;
            color: var(--secondary-text);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            flex: 1;
            justify-content: center;
        }

        .view-btn i {
            margin-right: 8px;
            font-size: 16px;
        }


        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.3);
        }

        .view-btn:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .login-history-table {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .login-history-table table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .login-history-table th {
            text-align: left;
            padding: 16px;
            color: var(--text-color);
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .login-history-table th:first-child {
            border-top-left-radius: 12px;
        }

        .login-history-table th:last-child {
            border-top-right-radius: 12px;
        }

        .login-history-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            transition: background-color 0.2s ease;
        }
        .login-history-table tr:hover td {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .login-history-table tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .login-history-table tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        /* 改进状态标签样式 */
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }

        .status-success {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .status-failed {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .device-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background-color: rgba(var(--primary-color-rgb), 0.15);
            color: var(--primary-color);
            margin-right: 10px;
            transition: all 0.2s ease;
        }

        .device-icon i {
            font-size: 18px;
        }

        .history-detail-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .history-detail-btn:hover {
            background-color: rgba(var(--primary-color-rgb), 0.15);
        }

        .history-detail-btn i {
            font-size: 18px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px;
            border-radius: 6px;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            font-weight: 500;
        }

        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .map-placeholder, .chart-placeholder {
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(var(--bg-color-rgb), 0.5);
            border-radius: 8px;
            color: var(--secondary-text);
        }

        .map-placeholder i, .chart-placeholder i {
            font-size: 48px;
            margin-bottom: 15px;
        }

        #login-map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-container {
            height: 250px;
            margin-bottom: 20px;
        }

        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-box {
            flex: 1;
            min-width: 100px;
            background-color: rgba(var(--bg-color-rgb), 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            color: var(--secondary-text);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-color);
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: var(--secondary-text);
        }

        .refresh-button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .refresh-button:hover {
            background-color: rgba(var(--primary-color-rgb), 0.15);
        }

        .refresh-button i {
            font-size: 18px;
        }

        .refresh-button.refreshing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            padding: 40px 0;
            text-align: center;
            color: var(--secondary-text);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* 注销账号页面样式优化 */
        #deactivate-section {
            padding: 30px;
            max-width: 680px;
            margin: 0 auto;
        }

        /* 注销容器样式 */
        .deactivate-container {
            background-color: rgba(40, 40, 40, 0.5);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        /* 警告框美化 */
        .warning-box {
            background: linear-gradient(to right, rgba(255, 59, 48, 0.15), rgba(255, 59, 48, 0.05));
            border-left: 4px solid #ff3b30;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .warning-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,59,48,0.1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>');
            opacity: 0.2;
        }

        .warning-box i {
            color: #ff3b30;
            font-size: 28px;
            margin-bottom: 10px;
            display: block;
        }

        .warning-box h3 {
            color: #ff3b30;
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .warning-box p {
            margin: 0;
            color: var(--text-color, #e0e0e0);
            font-size: 14px;
            line-height: 1.6;
        }

        /* 表单样式 */
        .deactivate-form {
            margin-top: 25px;
        }

        .deactivate-form .form-group {
            margin-bottom: 20px;
        }

        .deactivate-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-text, #ffffff);
            font-size: 15px;
        }

        .deactivate-form input[type="password"],
        .deactivate-form input[type="text"],
        .deactivate-form textarea {
            width: 100%;
            padding: 12px 16px;
            background-color: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-color, #ffffff);
            font-size: 15px;
            transition: all 0.3s;
        }

        .deactivate-form input[type="password"]:focus,
        .deactivate-form input[type="text"]:focus,
        .deactivate-form textarea:focus {
            outline: none;
            border-color: rgba(var(--primary-color-rgb, 66, 133, 244), 0.5);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 66, 133, 244), 0.15);
        }

        .deactivate-form .password-input-container {
            position: relative;
        }

        .deactivate-form .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 5px;
        }

        .deactivate-form .toggle-password:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .deactivate-form .form-hint {
            margin-top: 6px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* 按钮样式 */
        .deactivate-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .cancel-button {
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color, #ffffff);
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cancel-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .deactivate-button {
            background-color: #ff3b30;
            background-image: linear-gradient(to right, #ff3b30, #ff6b58);
            border: none;
            color: white;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .deactivate-button:hover {
            background-image: linear-gradient(to right, #ff2d20, #ff5b48);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 59, 48, 0.4);
        }

        .deactivate-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        .deactivate-button i {
            font-size: 18px;
        }

        /* 响应式样式 */
        @media (max-width: 768px) {
            #deactivate-section {
                padding: 20px 15px;
            }
            
            .deactivate-container {
                padding: 20px;
            }
            
            .deactivate-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .cancel-button, 
            .deactivate-button {
                width: 100%;
                justify-content: center;
            }
            
            .cancel-button {
                order: 2;
            }
            
            .deactivate-button {
                order: 1;
            }
        }

        /* 浅色主题适配 */
        @media (prefers-color-scheme: light) {
            .deactivate-container {
                background-color: rgba(250, 250, 250, 0.8);
            }
            
            .warning-box p {
                color: #555;
            }
            
            .deactivate-form label {
                color: #333;
            }
            
            .deactivate-form input[type="password"],
            .deactivate-form input[type="text"],
            .deactivate-form textarea {
                background-color: rgba(240, 240, 240, 0.8);
                border-color: rgba(0, 0, 0, 0.1);
                color: #333;
            }
            
            .deactivate-form .toggle-password {
                color: rgba(0, 0, 0, 0.5);
            }
            
            .deactivate-form .toggle-password:hover {
                color: rgba(0, 0, 0, 0.8);
            }
            
            .deactivate-form .form-hint {
                color: rgba(0, 0, 0, 0.5);
            }
            
            .cancel-button {
                border-color: rgba(0, 0, 0, 0.2);
                color: #333;
            }
        }
        /* 验证码输入框相关样式 */
        .verification-code-container {
            display: flex;
            gap: 10px;
        }

        .verification-code-container input {
            flex: 1;
            letter-spacing: 2px;
            font-weight: 500;
            text-align: center;
        }

        .send-code-btn {
            background-color: var(--primary-color, #4285f4);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            min-width: 110px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .send-code-btn:hover {
            background-color: var(--primary-color-dark, #3367d6);
        }

        .send-code-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .send-code-btn.counting {
            background-color: #888;
        }

        #deactivation-code-hint {
            margin-top: 6px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* 适配浅色主题 */
        @media (prefers-color-scheme: light) {
            #deactivation-code-hint {
                color: rgba(0, 0, 0, 0.6);
            }
        }

        .analysis-time-note {
            margin-top: 10px;
            padding: 12px 15px;
            background-color: var(--warning-bg);
            border-left: 3px solid var(--warning-color);
            border-radius: 6px;
        }

        .warning-title {
            color: var(--warning-color);
            display: inline-block;
            margin-bottom: 5px;
        }
    </style>
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker 注册成功');
                    })
                    .catch(err => {
                        console.log('ServiceWorker 注册失败:', err);
                    });
            });
        }
    </script>
</head>

<script>
//在生产环境中禁用console.log
// (function() {
//     const isProduction = true; // 设置为true以禁用所有console.log
    
//     if (isProduction) {
//         const originalConsoleLog = console.log;
//         const originalConsoleWarn = console.warn;
//         const originalConsoleError = console.error;
        
//         console.log = function() {
//             // 在生产环境中不输出任何内容
//         };
        
//         console.warn = function() {
//             // 只保留关键警告，其余不输出
//         };
        
//         console.error = function(message) {
//             // 保留错误日志，但不输出详细信息
//             originalConsoleError("发生错误，请联系管理员");
//         };
        
//         // 可选：保留一个方法来恢复原始行为（用于调试）
//         console.enableLogs = function() {
//             console.log = originalConsoleLog;
//             console.warn = originalConsoleWarn;
//             console.error = originalConsoleError;
//         };
//     }
// })();
</script>

<body>
    <div id="particles-js"></div>
    
    <div class="notification-wrapper">
        <div class="notification-button" id="notification-button">
            <i class="ri-notification-3-line"></i>
            <span class="notification-badge" id="notification-badge">0</span>
        </div>
        
        <div class="notification-panel" id="notification-panel">
            <div class="notification-header">
                <h3>通知</h3>
                <div class="notification-actions">
                    <button id="mark-all-read">全部已读</button>
                    <button id="refresh-notifications">
                        <i class="ri-refresh-line"></i>
                    </button>
                    <button id="close-notification-panel">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            </div>
            <div class="notification-list" id="notification-list">
                <!-- 通知项将由JavaScript动态加载 -->
            </div>
        </div>
    </div>
    
    <div class="settings-area">
        <div class="settings-btn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </div>
        <div class="settings-menu" id="settings-menu">
            <div class="settings-close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
            <h3>设置</h3>
            <div class="settings-item">
                <div class="settings-item-title">主题</div>
                <div class="settings-options theme-options">
                    <div class="settings-option" onclick="setTheme('light')" id="theme-light">
                        <span class="option-indicator light"></span>
                        <span class="option-label">浅色系</span>
                </div>
                    <div class="settings-option" onclick="setTheme('dark')" id="theme-dark">
                        <span class="option-indicator dark"></span>
                        <span class="option-label">深色系</span>
                    </div>
                    <div class="settings-option" onclick="setTheme('warm')" id="theme-warm">
                        <span class="option-indicator warm"></span>
                        <span class="option-label">暖色系</span>
                            </div>
                    <div class="settings-option" onclick="setTheme('cool')" id="theme-cool">
                        <span class="option-indicator cool"></span>
                        <span class="option-label">冷色系</span>
                        </div>
                    <div class="settings-option" onclick="setTheme('nature')" id="theme-nature">
                        <span class="option-indicator nature"></span>
                        <span class="option-label">自然色</span>
                    </div>
                    <div class="settings-option" onclick="setTheme('tech')" id="theme-tech">
                        <span class="option-indicator tech"></span>
                        <span class="option-label">科技色</span>
                    </div>
                    <div class="settings-option" onclick="setTheme('lavender')" id="theme-lavender">
                        <span class="option-indicator lavender"></span>
                        <span class="option-label">紫色系</span>
                    </div>
                    <div class="settings-option" onclick="setTheme('contrast')" id="theme-contrast">
                        <span class="option-indicator contrast"></span>
                        <span class="option-label">高对比</span>
                    </div>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-title">动画效果</div>
                <div class="toggle-container">
                    <div class="toggle-option-container">
                        <div class="settings-option toggle-option" onclick="setAnimation('on')" id="animation-on">
                            <span class="toggle-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"></path>
                                </svg>
                            </span>
                            <span class="option-label">开启</span>
                        </div>
                        <div class="settings-option toggle-option" onclick="setAnimation('off')" id="animation-off">
                            <span class="toggle-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"></path>
                                </svg>
                            </span>
                            <span class="option-label">关闭</span>
                        </div>
                    </div>
                    <div class="animation-description">
                        开启动画效果可增强用户体验，但可能消耗更多系统资源
                    </div>
                </div>
            </div>
            
            <div class="settings-item">
                <div class="settings-item-title">启动动画</div>
                <div class="toggle-container">
                    <div class="toggle-option-container">
                        <div class="settings-option toggle-option" onclick="setLoginAnimation('on')" id="login-animation-on">
                            <span class="toggle-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"></path>
                                </svg>
                            </span>
                            <span class="option-label">开启</span>
                        </div>
                        <div class="settings-option toggle-option" onclick="setLoginAnimation('off')" id="login-animation-off">
                            <span class="toggle-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"></path>
                                </svg>
                            </span>
                            <span class="option-label">关闭</span>
                        </div>
                    </div>
                    <div class="animation-description">
                        开启启动动画会在登录后显示数据流动画效果，关闭则直接进入主界面
                    </div>
                </div>
            </div>
            
            <div class="settings-item">
                <div class="settings-item-title">粒子效果</div>
                <div class="toggle-container">
                    <div class="toggle-option-container">
                        <div class="settings-option toggle-option" onclick="setParticles('on')" id="particles-on">
                            <span class="toggle-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                            <span class="option-label">开启</span>
                </div>
                        <div class="settings-option toggle-option" onclick="setParticles('off')" id="particles-off">
                            <span class="toggle-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M15 9l-6 6M9 9l6 6"></path>
                                </svg>
                            </span>
                            <span class="option-label">关闭</span>
                </div>
                    </div>
                    <div class="animation-description">
                        开启粒子效果可增加视觉体验，但可能影响性能
                            </div>
                        </div>
                
                <div class="particle-color-section">
                    <div class="color-section-header">
                        <div class="color-section-title">
                            <i class="ri-palette-line"></i>
                            粒子颜色
                        </div>
                        <div class="color-section-subtitle">选择你喜欢的粒子效果颜色</div>
                    </div>
                    
                    <div class="color-presets">
                        <div class="color-presets-label">预设颜色</div>
                        <div class="particle-color-grid">
                            <button class="color-option-new" onclick="setParticleColor('#0071e3')" data-color="#0071e3" title="经典蓝">
                                <span class="color-dot" style="background: #0071e3;"></span>
                                <span class="color-name">经典蓝</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#2997ff')" data-color="#2997ff" title="天空蓝">
                                <span class="color-dot" style="background: #2997ff;"></span>
                                <span class="color-name">天空蓝</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#5856d6')" data-color="#5856d6" title="神秘紫">
                                <span class="color-dot" style="background: #5856d6;"></span>
                                <span class="color-name">神秘紫</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#34c759')" data-color="#34c759" title="自然绿">
                                <span class="color-dot" style="background: #34c759;"></span>
                                <span class="color-name">自然绿</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#ff9500')" data-color="#ff9500" title="活力橙">
                                <span class="color-dot" style="background: #ff9500;"></span>
                                <span class="color-name">活力橙</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#ff2d55')" data-color="#ff2d55" title="热情红">
                                <span class="color-dot" style="background: #ff2d55;"></span>
                                <span class="color-name">热情红</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#ff6b6b')" data-color="#ff6b6b" title="珊瑚红">
                                <span class="color-dot" style="background: #ff6b6b;"></span>
                                <span class="color-name">珊瑚红</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#4ecdc4')" data-color="#4ecdc4" title="薄荷绿">
                                <span class="color-dot" style="background: #4ecdc4;"></span>
                                <span class="color-name">薄荷绿</span>
                            </button>
                            <button class="color-option-new" onclick="setParticleColor('#ffd93d')" data-color="#ffd93d" title="阳光黄">
                                <span class="color-dot" style="background: #ffd93d;"></span>
                                <span class="color-name">阳光黄</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="custom-color-section">
                        <div class="color-presets-label">自定义</div>
                        <div class="custom-color-picker">
                            <div class="custom-color-input">
                                <div class="color-picker-wrapper">
                                    <input type="color" id="custom-color-picker" onchange="setParticleColor(this.value)" value="#0071e3">
                                    <div class="color-picker-overlay">
                                        <i class="ri-palette-fill"></i>
                                    </div>
                                </div>
                                <label for="custom-color-picker">选择自定义颜色</label>
                            </div>
                            <button class="reset-color-btn" onclick="resetParticleColor()" title="重置为默认颜色">
                                <i class="ri-refresh-line"></i>
                                <span>重置</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-title">快捷键</div>
                <div class="shortcut-list">
                    <div class="shortcut-item">
                        <span class="shortcut-desc">添加文件框</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'addFile')">Alt + N</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">选择文件</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'selectFile')">Alt + O</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">分析数据</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'analyze')">Alt + Enter</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">导出结果</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'export')">Alt + E</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">切换主题</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'theme')">Alt + T</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">刷新页面</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'refresh')">Alt + R</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">切换分析模式</span>
                        <span class="shortcut-key" onclick="startRecording(this, 'switchMode')">Alt + M</span>
                    </div>
                </div>
                <div class="shortcut-tip">点击快捷键可进行自定义设置</div>
            </div>
            
            <div class="settings-item">
                <div class="settings-item-title">关于</div>
                <div class="settings-content about-section">
                    <div class="about-logo">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                </div>
                    <h4 class="about-title">数据分析系统</h4>
                    <div class="about-version">版本: 2.5.1</div>
                    <div class="about-description">
                        专业的数据比对与分析工具，支持多种文件格式，离线运行，保护数据隐私
            </div>
                    <div class="about-divider"></div>
                    <div class="about-info">
                        <div class="about-info-item">
                            <i class="ri-team-line"></i> 开发团队: 数据科技研发中心
                        </div>
                        <div class="about-info-item">
                            <i class="ri-calendar-line"></i> 更新日期: 2025-1-1
                        </div>
                        <div class="about-info-item">
                            <i class="ri-mail-line"></i> 联系邮箱: support@dataanalyzer.com
                        </div>
                    </div>
                    <div class="about-divider"></div>
                    <div class="about-social">
                        <a href="#" class="about-social-icon" title="官方网站">
                            <i class="ri-global-line"></i>
                        </a>
                        <a href="#" class="about-social-icon" title="技术支持">
                            <i class="ri-customer-service-2-line"></i>
                        </a>
                        <a href="#" class="about-social-icon" title="文档中心">
                            <i class="ri-file-list-3-line"></i>
                        </a>
                    </div>
                    <div class="about-copyright">© 2025 数据分析系统</div>
                </div>
            </div>
            
            <div class="settings-item" id="admin-login-item" style="display: none;">
                <div class="settings-item-title">管理员登录</div>
                <div class="settings-option-container">
                    <a href="/system-management-panel" class="settings-option" style="text-decoration: none;" target="_blank">进入管理界面</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加账户管理独立模块 -->
    <div class="account-area">
        <div class="account-btn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </div>
        <div class="account-menu" id="account-menu">
            <div class="settings-close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
            <h3>账户管理</h3>
            <div class="account-section">
                <div class="account-info">
                    <div class="account-avatar">
                        <i class="ri-user-fill"></i>
                    </div>
                    <div class="account-details">
                        <div class="account-name" id="user-displayname">加载中...</div>
                        <div class="account-email" id="user-email">加载中...</div>
                    </div>
                </div>
                
                <div class="account-options">
                    <button class="account-option-item" onclick="showProfileModal()">
                        <i class="ri-user-settings-line"></i>
                        <span>个人资料</span>
                    </button>
                    <button class="account-option-item" onclick="showSecurityModal()">
                        <i class="ri-shield-keyhole-line"></i>
                        <span>账户安全</span>
                    </button>
                    <button class="account-option-item" onclick="showHistoryModal()">
                        <i class="ri-history-line"></i>
                        <span>使用记录</span>
                    </button>
                </div>
                
                <button class="logout-option" onclick="logout()">
                    <i class="ri-logout-box-r-line"></i>
                    <span>退出登录</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>数据分析系统</h1>
        
        <div class="mode-selection">
            <div class="mode-buttons">
                <button class="mode-btn active" onclick="switchMode('compare')" id="compare-mode-btn">
                    <i class="ri-file-copy-line"></i><span>多文件比较</span>
                </button>
                <button class="mode-btn" onclick="switchMode('single')" id="single-mode-btn">
                    <i class="ri-file-line"></i><span>单文件分析</span>
                </button>
                <button class="mode-btn" onclick="goToAIAnalysis()" id="ai-mode-btn">
                    <i class="ri-bubble-chart-line"></i><span>AI智能分析</span>
                </button>
                <button class="mode-btn" onclick="goToSalesTrend()" id="sales-trend-btn">
                    <i class="ri-line-chart-line"></i><span>销售趋势分析</span>
                </button>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-tips">
                <!-- <strong>使用说明</strong>
                <ul>
                    <li>请上传至少两个Excel文件或同一Excel文件中的两个工作表进行比较</li>
                    <li>支持的文件格式：Excel文件（.xlsx, .xls）</li>
                    <li>每个文件都需要选择要比较的列：
                        <ul>
                            <li>上传文件后会显示该文件的所有列名</li>
                            <li>系统会自动推荐可能的IMEI/串码列</li>
                            <li>您也可以手动选择其他任意列进行比较</li>
                        </ul>
                    </li>
                    <li>文件总大小不要超过10GB</li>
                    <li>分析结果将包含：
                        <ul>
                            <li>每个文件中独特的数据行（在其他文件中未出现的数据对应的完整行）</li>
                            <li>每个文件中重复的数据行（在其他文件中出现的数据对应的完整行）</li>
                            <li>可视化统计图表</li>
                            <li>可导出的Excel文件（包含所有独特数据行，重复数据行）</li>
                        </ul>
                    </li>
                </ul>
                <div class="analysis-time-note" style="color: var(--primary-color); margin-top: 10px;">
                    <strong>注意：</strong>数据分析时间取决于多个因素，包括：
                        <ul>
                            <li>文件大小</li>
                            <li>数据行数</li>
                            <li>工作表数量</li>
                            <li>系统资源占用情况</li>
                        </ul>
                        请耐心等待分析完成。分析过程中请勿关闭或刷新页面。
                </div>
                <ul style="display:none;"> -->
                    <!-- <li class="network-note" style="color: var(--primary-color); margin-top: 10px;">
                        <strong>网络要求：</strong>系统支持完全离线运行，所有功能均可在离线模式下使用：
                        <ul>
                            <li>文件上传和分析</li>
                            <li>工作表和列名识别</li>
                            <li>分析结果导出</li>
                            <li>主题切换、动画设置、快捷键设置等</li>
                        </ul>
                        <p style="margin-top: 5px;">系统会在浏览器本地处理所有文件，不会将数据上传至云端</p>
                    </li> -->
                </ul>
            </div>
            
            <div id="file-container"></div>
            
            <button onclick="addFile()" class="button">添加文件</button>
            <button onclick="uploadFiles()" class="button" id="upload-btn" disabled>分析数据</button>
        </div>

        <div id="loading">
            <div class="loading-spinner"></div>
            正在处理数据，请稍候...
        </div>

        <div id="error" class="error"></div>

        <div id="result-section" style="display: none;">
            <div id="plot"></div>
            <div id="summary"></div>
            <div class="export-section">
                <div class="export-card">
                    <div class="export-icon">
                        <i class="ri-download-2-line"></i>
            </div>
                    <div class="export-content">
                        <h4>导出分析结果</h4>
                        <p>将分析结果保存为Excel文件，便于后续查看和分享</p>
                    </div>
                    <button onclick="downloadResults()" class="export-button">
                        <i class="ri-file-excel-2-line"></i>
                        <span>导出Excel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="offline-status" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--error-color); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1001; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0119 12.55M5 12.55a10.94 10.94 0 015.17-2.39M10.71 5.05A16 16 0 0122.58 9M1.42 9a15.91 15.91 0 014.7-2.88M8.53 16.11a6 6 0 016.95 0M12 20h.01"></path>
        </svg>
        <span>当前处于离线模式，所有功能均可正常使用</span>
    </div>

    <!-- 添加自定义弹窗HTML结构 -->
    <div class="custom-modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="ri-file-excel-line"></i>
            </div>
            <div class="modal-title">未导出的分析结果</div>
            <div class="modal-message">检测到您有未导出的分析结果，是否需要导出？</div>
            <div class="modal-buttons">
                <button class="modal-button modal-button-primary" id="export-confirm-btn">导出结果</button>
                <button class="modal-button modal-button-secondary" id="export-cancel-btn">不导出</button>
            </div>
        </div>
    </div>
    
    <!-- 退出登录确认弹窗 -->
    <div class="custom-modal" id="logout-modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="ri-logout-box-line"></i>
            </div>
            <div class="modal-title">退出登录确认</div>
            <div class="modal-message">确定要退出当前账号吗？</div>
            <div class="modal-buttons">
                <button class="modal-button modal-button-primary" id="logout-confirm-btn">确定</button>
                <button class="modal-button modal-button-secondary" id="logout-cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <!-- 使用记录模态框 -->
    <div class="custom-modal" id="history-modal">
        <div class="modal-content history-modal-content">
            <div class="modal-header">
                <h3>使用记录</h3>
                <button class="close-button" onclick="hideHistoryModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- 统计信息卡片 -->
                <div class="history-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ri-file-copy-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-analysis-count">0</div>
                            <div class="stat-label">数据分析</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ri-bubble-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-ai-count">0</div>
                            <div class="stat-label">AI分析</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ri-line-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-sales-count">0</div>
                            <div class="stat-label">销售分析</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ri-database-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-usage-count">0</div>
                            <div class="stat-label">总计</div>
                        </div>
                    </div>
                </div>
                
                <!-- 筛选和控制面板 -->
                <div class="history-filters">
                    <div class="filter-group">
                        <label>分析类型：</label>
                        <select id="history-type-filter" onchange="loadUsageHistory()">
                            <option value="all">全部</option>
                            <option value="analysis">数据分析</option>
                            <option value="ai">AI分析</option>
                            <option value="sales">销售分析</option>
                        </select>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="refresh-btn" onclick="loadUsageHistory()" title="刷新">
                            <i class="ri-refresh-line"></i>
                        </button>
                        <button class="export-btn" onclick="exportUsageHistory()" title="导出记录">
                            <i class="ri-download-line"></i> 导出
                        </button>
                    </div>
                </div>
                
                <!-- 记录列表 -->
                <div class="history-list-container">
                    <div class="history-list" id="usage-history-list">
                        <div class="loading-placeholder">
                            <i class="ri-loader-line"></i>
                            <span>加载中...</span>
                        </div>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="history-pagination" id="history-pagination">
                        <!-- 分页按钮将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加个人资料模态框 - 放在其他模态框附近，比如logout-modal之后 -->
    <div class="custom-modal" id="profile-modal">
        <div class="modal-content profile-modal-content">
            <div class="modal-header">
                <h3>个人资料</h3>
                <button class="close-button" onclick="hideProfileModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="profile-form">
                    <div class="form-group">
                        <label for="current-username">当前用户名</label>
                        <input type="text" id="current-username" readonly>
                    </div>
                    
                    <!-- 添加用户名修改频率限制提示 -->
                    <div class="form-info">
                        <small id="username-change-info"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-username">新用户名</label>
                        <input type="text" id="new-username" placeholder="输入新的用户名">
                        <small class="form-text" id="username-error"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="user-email-confirm">确认邮箱</label>
                        <input type="email" id="user-email-confirm" readonly>
                    </div>
                    
                    <div class="form-group verification-group" style="display: none;">
                        <label for="email-verification-code">邮箱验证码</label>
                        <div class="verification-input-group">
                            <input type="text" id="email-verification-code" placeholder="输入验证码">
                            <button class="button button-primary" id="send-verification-btn" onclick="sendVerificationCode()">
                                发送验证码
                            </button>
                        </div>
                        <small class="form-text" id="verification-message"></small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" onclick="hideProfileModal()">取消</button>
                <button class="button button-primary" id="check-username-btn" onclick="checkUsername()">下一步</button>
                <button class="button button-success" id="change-username-btn" style="display: none;" onclick="changeUsername()">修改用户名</button>
            </div>
        </div>
    </div>
    
    <!-- 用户名修改成功提示 -->
    <div class="success-notification" id="username-success">
        <div class="success-content">
            <div class="success-icon">
                <i class="ri-check-line"></i>
            </div>
            <div class="success-message">
                <h3>用户名修改成功!</h3>
                <p>您的用户名已成功更新</p>
            </div>
            <div class="success-progress">
                <div class="progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- 账户安全模态框 -->
    <div class="custom-modal" id="security-modal">
        <div class="modal-content security-modal-content">
            <div class="modal-header">
                <h3>账户安全</h3>
                <button class="close-button" onclick="hideSecurityModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 功能切换按钮 -->
                <div class="security-tabs">
                    <button id="strength-tab" class="tab-button active" onclick="switchSecurityTab('strength')">
                        <i class="ri-shield-check-line"></i> 密码强度检测
                    </button>
                    <button id="change-tab" class="tab-button" onclick="switchSecurityTab('change')">
                        <i class="ri-lock-password-line"></i> 修改密码
                    </button>
                    <button id="login-history-tab" class="tab-button" onclick="switchSecurityTab('login-history')">
                        <i class="ri-history-line"></i> 登录活动
                    </button>
                    <button id="deactivate-tab" class="tab-button" onclick="switchSecurityTab('deactivate')">
                        <i class="ri-delete-bin-line"></i> 注销账号
                    </button>
                </div>
                
                <!-- 密码强度检测部分 -->
                <div class="security-section" id="strength-section">
                    <div class="security-header">
                        <i class="ri-lock-line"></i>
                        <h4>当前账户密码强度评估</h4>
                    </div>
                    
                    <div class="password-strength-container">  
                        <div class="strength-meter-container">
                            <label>密码强度</label>
                            <div class="strength-meter">
                                <div class="strength-bar" id="strength-bar"></div>
                            </div>
                            <div class="strength-text" id="strength-text">分析中...</div>
                        </div>
                        
                        <div class="password-tips">
                            <h5>提高密码强度的建议：</h5>
                            <ul id="password-tips-list">
                                <li class="tip" id="tip-length">使用至少8个字符的密码</li>
                                <li class="tip" id="tip-uppercase">包含大写字母</li>
                                <li class="tip" id="tip-lowercase">包含小写字母</li>
                                <li class="tip" id="tip-number">包含数字</li>
                                <li class="tip" id="tip-special">包含特殊字符（如 !@#$%^&*）</li>
                                <li class="tip" id="tip-common">避免使用常见密码</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 密码修改部分 -->
                <div class="security-section" id="change-section" style="display: none;">
                    <div class="security-header">
                        <i class="ri-lock-password-line"></i>
                        <h4>修改密码</h4>
                    </div>
                    
                    <div class="password-change-container">
                        <form id="password-change-form">
                            <div class="form-group">
                                <label for="current-password">当前密码</label>
                                <div class="password-input-container">
                                    <input type="password" id="current-password" class="form-control" required>
                                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('current-password')">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="email-verify-code">邮箱验证码</label>
                                <div class="verify-code-container">
                                    <input type="text" id="email-verify-code" class="form-control" placeholder="6位验证码" maxlength="6" required>
                                    <button type="button" class="send-code-button" id="send-code-btn" onclick="sendPasswordChangeCode()">
                                        发送验证码
                                    </button>
                                </div>
                                <div class="verify-code-tip">验证码将发送至您的注册邮箱</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-password">新密码</label>
                                <div class="password-input-container">
                                    <input type="password" id="new-password" class="form-control" required oninput="checkNewPasswordStrength()">
                                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('new-password')">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                </div>
                                <div class="strength-meter-container">
                                    <div class="strength-meter">
                                        <div class="strength-bar" id="new-strength-bar"></div>
                                    </div>
                                    <div class="strength-text" id="new-strength-text">尚未输入</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm-new-password">确认新密码</label>
                                <div class="password-input-container">
                                    <input type="password" id="confirm-new-password" class="form-control" required oninput="checkPasswordMatch()">
                                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirm-new-password')">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                </div>
                                <div class="password-match-message" id="password-match-message"></div>
                            </div>
                            
                            <div class="form-message" id="password-change-message"></div>
                            
                            <div class="form-actions">
                                <button type="button" class="button primary-button" onclick="changePassword()">
                                    <i class="ri-save-line"></i> 保存修改
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            <!-- 登录活动部分 -->
            <div class="security-section" id="login-history-section" style="display: none;">
                <div class="security-header">
                    <i class="ri-shield-user-line"></i>
                    <h4>登录活动记录</h4>
                </div>
                
                <div class="login-history-container">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label>状态：</label>
                            <select id="status-filter" onchange="loadLoginHistory()">
                                <option value="">全部</option>
                                <option value="登录成功">成功</option>
                                <option value="登录失败">失败</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>设备：</label>
                            <select id="device-filter" onchange="loadLoginHistory()">
                                <option value="">全部</option>
                                <option value="电脑">电脑</option>
                                <option value="手机">手机</option>
                                <option value="平板">平板</option>
                            </select>
                        </div>
                        <button class="refresh-button" onclick="loadLoginHistory()" title="刷新数据">
                            <i class="ri-refresh-line"></i>
                        </button>
                    </div>
                    
                    <div class="history-view-toggle">
                        <button class="view-btn active" data-view="table" onclick="switchHistoryView('table')">
                            <i class="ri-list-check"></i> 列表
                        </button>
                        <button class="view-btn" data-view="map" onclick="switchHistoryView('map')">
                            <i class="ri-map-pin-line"></i> 地图
                        </button>
                        <button class="view-btn" data-view="chart" onclick="switchHistoryView('chart')">
                            <i class="ri-bar-chart-line"></i> 统计
                        </button>
                    </div>
                    
                    <div class="history-view" id="table-view">
                        <div class="login-history-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>状态</th>
                                        <th>位置</th>
                                        <th>设备</th>
                                        <th>详情</th>
                                    </tr>
                                </thead>
                                <tbody id="login-history-list">
                                    <tr>
                                        <td colspan="5" class="loading-message">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="login-history-pagination">
                            <!-- 分页控件将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="history-view" id="map-view" style="display: none;">
                        <div id="login-map-container">
                            <div class="map-placeholder">
                                <i class="ri-map-2-line"></i>
                                <!-- <p>加载登录位置地图...</p> -->
                                <p>此功能开发中，敬请期待😊</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-view" id="chart-view" style="display: none;">
                        <div class="chart-container">
                            <div id="login-daily-chart"></div>
                        </div>
                        <div class="stats-container">
                            <div class="stat-box">
                                <div class="stat-label">成功登录</div>
                                <div class="stat-value" id="success-login-count">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">失败尝试</div>
                                <div class="stat-value" id="failed-login-count">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">登录位置</div>
                                <div class="stat-value" id="login-locations-count">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">常用设备</div>
                                <div class="stat-value" id="most-used-device">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>  
            
            <!-- 注销账号内容区域 -->
            <!-- 注销账号内容区域 -->
            <div class="security-section" id="deactivate-section" style="display: none;">
                <div class="deactivate-container">
                    <div class="warning-box">
                        <i class="ri-alert-line"></i>
                        <h3>警告：账号注销不可恢复</h3>
                        <p>注销账号后，您将无法再登录此账号，且账号关联的所有数据将被标记为已注销状态。此操作不可逆转。</p>
                    </div>
                    
                    <form id="deactivate-form" class="deactivate-form">
                        <div class="form-group">
                            <label for="current-password-deactivate">当前密码</label>
                            <div class="password-input-container">
                                <input type="password" id="current-password-deactivate" placeholder="请输入当前密码以确认身份" required>
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('current-password-deactivate')">
                                    <i class="ri-eye-off-line"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group verification-code-group">
                            <label for="deactivation-code">邮箱验证码</label>
                            <div class="verification-code-container">
                                <input type="text" id="deactivation-code" placeholder="请输入6位验证码" maxlength="6" required>
                                <button type="button" class="send-code-btn" id="send-deactivation-code-btn" onclick="sendDeactivationCode()">
                                    发送验证码
                                </button>
                            </div>
                            <div class="form-hint" id="deactivation-code-hint">验证码将发送至您的注册邮箱</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deactivate-confirmation">确认文字</label>
                            <input type="text" id="deactivate-confirmation" placeholder="请输入"确认注销"以确认操作" required>
                            <div class="form-hint">请输入"确认注销"（不含引号）</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deactivate-reason">注销原因（可选）</label>
                            <textarea id="deactivate-reason" placeholder="请简要说明注销原因，帮助我们改进服务" rows="3"></textarea>
                        </div>
                        
                        <div class="deactivate-actions">
                            <button type="button" class="cancel-button" onclick="switchSecurityTab('strength')">取消</button>
                            <button type="button" class="deactivate-button" onclick="deactivateAccount()">
                                <i class="ri-delete-bin-line"></i> 注销账号
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" onclick="hideSecurityModal()">关闭</button>
            </div>
        </div>
    </div>

    <script src="/static/js/lib/particles.min.js"></script>
    <script>
        // 添加离线模式支持代码
        document.addEventListener('DOMContentLoaded', function() {
            // 检查管理员访问权限
            checkAdminAccess();
                
            // 确保所有功能在离线模式下也能正常工作
            window.addEventListener('offline', function() {
                console.log('已切换到离线模式，系统继续正常工作');
                // 显示离线状态提示但不阻止任何功能
                const offlineStatus = document.getElementById('offline-status');
                if (offlineStatus) {
                    offlineStatus.style.display = 'flex';
                }
            });

            window.addEventListener('online', function() {
                console.log('已恢复在线模式');
                // 隐藏离线状态提示
                const offlineStatus = document.getElementById('offline-status');
                if (offlineStatus) {
                    offlineStatus.style.display = 'none';
                }
            });

            // 初始检查离线状态，但不禁用任何功能
            if (!navigator.onLine) {
                console.log('启动时处于离线模式，系统继续正常工作');
                const offlineStatus = document.getElementById('offline-status');
                if (offlineStatus) {
                    offlineStatus.style.display = 'flex';
                }
            }
        });

        let fileCount = 0;
        let fileData = {};

        // 快捷键配置
        let shortcuts = {
            addFile: { key: 'N', altKey: true },
            selectFile: { key: 'O', altKey: true },
            analyze: { key: 'Enter', altKey: true },
            export: { key: 'E', altKey: true },
            theme: { key: 'T', altKey: true },
            refresh: { key: 'R', altKey: true },
            switchMode: { key: 'M', altKey: true }  // 添加切换模式的快捷键
        };

        // 从本地存储加载快捷键配置
        const savedShortcuts = localStorage.getItem('shortcuts');
        if (savedShortcuts) {
            shortcuts = JSON.parse(savedShortcuts);
            updateShortcutDisplay();
        }

        let isRecording = false;
        let currentRecordingElement = null;
        let currentAction = null;
        let currentKeys = new Set();  // 用于存储当前按下的键

        function startRecording(element, action) {
            if (isRecording) {
                stopRecording();
            }
            isRecording = true;
            currentRecordingElement = element;
            currentAction = action;
            currentKeys.clear();
            element.classList.add('recording');
            element.textContent = '请按下快捷键...';
        }

        function stopRecording() {
            if (currentRecordingElement) {
                isRecording = false;
                currentRecordingElement.classList.remove('recording');
                currentKeys.clear();
                updateShortcutDisplay();
                currentRecordingElement = null;
                currentAction = null;
            }
        }

        // 修改快捷键处理逻辑
        window.addEventListener('keydown', function(e) {
            // 如果正在录制快捷键，不触发其他快捷键功能
            if (isRecording) {
                e.preventDefault();
                
                // 记录按下的键
                if (e.key === 'Alt') currentKeys.add('Alt');
                else if (e.key === 'Control') currentKeys.add('Ctrl');
                else if (e.key === 'Shift') currentKeys.add('Shift');
                else {
                    let key = e.key;
                    if (key === ' ') key = 'Space';
                    else if (key.length === 1) key = key.toUpperCase();
                    currentKeys.add(key);
                }

                // 更新显示
                if (currentRecordingElement) {
                    currentRecordingElement.textContent = Array.from(currentKeys).join(' + ');
                }
                return;
            }

            // 检查是否匹配任何已定义的快捷键
            if (matchShortcut(e, shortcuts.addFile)) {
                e.preventDefault();
                addFile();
            }
            else if (matchShortcut(e, shortcuts.selectFile)) {
                e.preventDefault();
                const fileInputs = document.querySelectorAll('.file-input');
                const lastFileInput = fileInputs[fileInputs.length - 1];
                if (lastFileInput) {
                    lastFileInput.click();
                }
            }
            else if (matchShortcut(e, shortcuts.analyze)) {
                e.preventDefault();
                const uploadBtn = document.getElementById('upload-btn');
                if (!uploadBtn.disabled) {
                    uploadFiles();
                }
            }
            else if (matchShortcut(e, shortcuts.export)) {
                e.preventDefault();
                const resultSection = document.getElementById('result-section');
                if (resultSection.style.display !== 'none') {
                    downloadResults();
                }
            }
            else if (matchShortcut(e, shortcuts.theme)) {
                e.preventDefault();
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                setTheme(currentTheme === 'light' ? 'dark' : 'light');
            }
            else if (matchShortcut(e, shortcuts.refresh)) {
                e.preventDefault();
                // 如果有未导出的结果，先确认
                const resultSection = document.getElementById('result-section');
                if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                    if (confirm('检测到有未导出的分析结果，是否确认刷新页面？')) {
                        window.location.reload();
                    }
                } else {
                    window.location.reload();
                }
            }
            else if (matchShortcut(e, shortcuts.switchMode)) {
                e.preventDefault();
                const currentMode = localStorage.getItem('currentMode') || 'compare';
                switchMode(currentMode === 'compare' ? 'single' : 'compare');
            }
        });

        // 添加快捷键匹配函数
        function matchShortcut(event, shortcut) {
            if (!shortcut) return false;
            
            // 检查修饰键状态
            const modifiersMatch = (
                event.altKey === !!shortcut.altKey &&
                event.ctrlKey === !!shortcut.ctrlKey &&
                event.shiftKey === !!shortcut.shiftKey
            );

            // 检查主键是否匹配（不区分大小写）
            const keyMatch = event.key.toLowerCase() === shortcut.key.toLowerCase();

            return modifiersMatch && keyMatch;
        }

        // 在松开键时保存快捷键
        window.addEventListener('keyup', function(e) {
            if (isRecording && currentKeys.size > 0) {
                const keys = Array.from(currentKeys);
                shortcuts[currentAction] = {
                    key: keys[keys.length - 1],
                    altKey: keys.includes('Alt'),
                    ctrlKey: keys.includes('Ctrl'),
                    shiftKey: keys.includes('Shift')
                };
                localStorage.setItem('shortcuts', JSON.stringify(shortcuts));
                stopRecording();
            }
        });

        function updateShortcutDisplay() {
            Object.entries(shortcuts).forEach(([action, shortcut]) => {
                const element = document.querySelector(`[onclick="startRecording(this, '${action}')"]`);
                if (element) {
                    let text = '';
                    if (shortcut.altKey) text += 'Alt + ';
                    if (shortcut.ctrlKey) text += 'Ctrl + ';
                    if (shortcut.shiftKey) text += 'Shift + ';
                    text += shortcut.key;
                    element.textContent = text;
                }
            });
        }

        // 更新全局快捷键处理
        window.addEventListener('keydown', function(e) {
            console.log('Keydown event:', {
                key: e.key,
                keyCode: e.keyCode,
                altKey: e.altKey
            });
            
            // 添加文件框快捷键 (Alt + N)
            if (e.altKey && e.keyCode === 78) { // N key
                e.preventDefault();
                console.log('Triggering addFile()');
                addFile();
            }

            // 选择文件快捷键 (Alt + O)
            if (e.altKey && e.keyCode === 79) { // O key
                e.preventDefault();
                console.log('Triggering file selection');
                const fileInputs = document.querySelectorAll('.file-input');
                const lastFileInput = fileInputs[fileInputs.length - 1];
                if (lastFileInput) {
                    lastFileInput.click();
                }
            }
            
            // 分析数据快捷键 (Alt + Enter)
            if (e.altKey && e.keyCode === 13) { // Enter key
                e.preventDefault();
                const uploadBtn = document.getElementById('upload-btn');
                if (!uploadBtn.disabled) {
                    console.log('Triggering uploadFiles()');
                    uploadFiles();
                }
            }
            
            // 导出结果快捷键 (Alt + E)
            if (e.altKey && e.keyCode === 69) { // E key
                e.preventDefault();
                const resultSection = document.getElementById('result-section');
                if (resultSection.style.display !== 'none') {
                    console.log('Triggering downloadResults()');
                    downloadResults();
                }
            }
            
            // 切换主题快捷键 (Alt + T)
            if (e.altKey && e.keyCode === 84) { // T key
                e.preventDefault();
                console.log('Triggering theme toggle');
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                setTheme(currentTheme === 'light' ? 'dark' : 'light');
            }
        });

        // 更新快捷键显示
        const shortcutKeys = document.querySelectorAll('.shortcut-key');
        shortcutKeys.forEach(key => {
            key.textContent = key.textContent.replace('⌥', '⌘');
        });

        // 初始化设置相关功能
        function initializeSettings() {
            const settingsArea = document.querySelector('.settings-area');
            const settingsBtn = settingsArea.querySelector('.settings-btn');
            const settingsMenu = document.getElementById('settings-menu');
            let hideTimeout;

            // 添加鼠标悬停事件
            settingsBtn.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
                settingsMenu.classList.add('show');
            });

            settingsMenu.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
            });

            settingsArea.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    settingsMenu.classList.remove('show');
                }, 200);
            });

            // 获取保存的粒子颜色
            const savedColor = localStorage.getItem('particleColor') || '#0071e3';
            setParticleColor(savedColor);
            
            // 初始化主题、动画和粒子状态
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedAnimation = localStorage.getItem('animation') || 'on';
            const savedParticles = localStorage.getItem('particles') || 'on';
            setTheme(savedTheme);
            setAnimation(savedAnimation);
            setParticles(savedParticles);
            updateSettingsUI();
        }

        function setTheme(theme) {
            // 如果切换到预设主题，清除自定义样式
            document.documentElement.style.removeProperty('--primary-color');
            document.documentElement.style.removeProperty('--hover-color');
            document.documentElement.style.removeProperty('--background-color');
            document.documentElement.style.removeProperty('--text-color');
            document.documentElement.style.removeProperty('--secondary-text');
            document.documentElement.style.removeProperty('--border-color');
            document.documentElement.style.removeProperty('--gradient-start');
            document.documentElement.style.removeProperty('--gradient-end');
            
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateSettingsUI();
            updateParticlesTheme(theme);
            
            // 如果结果区域可见并且有图表数据，则重新渲染图表
            const resultSection = document.getElementById('result-section');
            if (resultSection && resultSection.style.display !== 'none') {
                const plotElement = document.getElementById('plot');
                if (plotElement && window.currentPlotData) {
                    renderPlotWithTheme(window.currentPlotData);
                }
            }
        }

        function updateSettingsUI() {
            // 获取当前设置
            const theme = localStorage.getItem('theme') || 'light';
            const animation = localStorage.getItem('animation') || 'on';
            const particles = localStorage.getItem('particles') || 'on';
            const loginAnimation = localStorage.getItem('loginAnimation') || 'on';
            
            // 更新所有设置按钮状态
            document.querySelectorAll('.settings-option').forEach(option => {
                option.classList.remove('active');
            });
            
            document.getElementById(`theme-${theme}`).classList.add('active');
            document.getElementById(`animation-${animation}`).classList.add('active');
            document.getElementById(`particles-${particles}`).classList.add('active');
            document.getElementById(`login-animation-${loginAnimation}`).classList.add('active');
        }

        function setParticles(state) {
            localStorage.setItem('particles', state);
            const particlesContainer = document.getElementById('particles-js');
            
            if (state === 'off') {
                // 停止粒子动画
                if (window.pJSDom && window.pJSDom[0]) {
                    window.pJSDom[0].pJS.particles.move.enable = false;
                    window.pJSDom[0].pJS.fn.particlesRefresh();
                }
                // 隐藏粒子容器
                particlesContainer.style.opacity = '0';
            } else {
                // 恢复粒子动画
                if (window.pJSDom && window.pJSDom[0]) {
                    window.pJSDom[0].pJS.particles.move.enable = true;
                    window.pJSDom[0].pJS.fn.particlesRefresh();
                }
                // 显示粒子容器
                particlesContainer.style.opacity = '1';
            }
            
            updateSettingsUI();
        }
        
        function setLoginAnimation(state) {
            localStorage.setItem('loginAnimation', state);
            updateSettingsUI();
        }

        function setAnimation(state) {
            document.documentElement.setAttribute('data-animation', state);
            localStorage.setItem('animation', state);
            updateSettingsUI();
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载系统设置
            loadSystemSettings();
            
            // 清除导出标记
            localStorage.removeItem('resultExported');
            
            // 添加页面刷新/关闭前的检查
            window.addEventListener('beforeunload', function(e) {
                const resultSection = document.getElementById('result-section');
                if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                    e.preventDefault();
                    e.returnValue = '检测到有未导出的分析结果，是否确认离开？';
                    return e.returnValue;
                }
            });

            // 修改 switchMode 函数
            const originalSwitchMode = window.switchMode;
            window.switchMode = function(mode) {
                const resultSection = document.getElementById('result-section');
                if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                    // 使用自定义弹窗替代confirm
                    const exportModal = document.getElementById('export-modal');
                    const exportConfirmBtn = document.getElementById('export-confirm-btn');
                    const exportCancelBtn = document.getElementById('export-cancel-btn');
                    
                    exportModal.style.display = 'flex';
                    
                    exportConfirmBtn.onclick = function() {
                        exportModal.style.display = 'none';
                        const resultFile = resultSection.getAttribute('data-result-file');
                        if (resultFile) {
                            window.location.href = `/download/${resultFile}`;
                            localStorage.setItem('resultExported', 'true');
                            // 延迟切换模式
                            setTimeout(() => {
                                localStorage.setItem('currentMode', mode);
                                window.location.reload();
                            }, 1000);
                        }
                    };
                    
                    exportCancelBtn.onclick = function() {
                        exportModal.style.display = 'none';
                        // 设置已导出标记，避免系统弹窗再次提示
                        localStorage.setItem('resultExported', 'true');
                        localStorage.setItem('currentMode', mode);
                        window.location.reload();
                    };
                    
                            return;
                }
                
                localStorage.setItem('currentMode', mode);
                window.location.reload();
            };

            // 修改 downloadResults 函数
            const originalDownloadResults = window.downloadResults;
            window.downloadResults = function() {
                originalDownloadResults();
                localStorage.setItem('resultExported', 'true');
            };
            
            // 修改 uploadFiles 函数
            const originalUploadFiles = window.uploadFiles;
            window.uploadFiles = async function() {
                // 重置导出标记
                localStorage.removeItem('resultExported');
                await originalUploadFiles();
            };
            
            // 初始化设置
            initializeSettings();
            
            // 从 localStorage 获取当前模式
            currentMode = localStorage.getItem('currentMode') || 'compare';
            
            // 更新模式按钮状态
            const compareBtn = document.getElementById('compare-mode-btn');
            const singleBtn = document.getElementById('single-mode-btn');
            compareBtn.classList.toggle('active', currentMode === 'compare');
            singleBtn.classList.toggle('active', currentMode === 'single');
            
            // 更新使用说明和按钮文字
            const uploadTips = document.querySelector('.upload-tips');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (currentMode === 'single') {
                uploadTips.innerHTML = `
                    <div style="font-size: 1.1em; color: #333; display: flex; align-items: center; margin-bottom: 15px;">
                        <i class="ri-information-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                    <strong>使用说明</strong>
                    </div>
                    <div style="margin-top: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                        <!-- 步骤1 -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <i class="ri-file-upload-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                                <strong>上传一个Excel文件进行分析</strong>
                            </div>
                            <div style="margin-left: 30px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="ri-file-excel-2-line" style="color: #21a366 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>支持的文件格式：Excel文件（.xlsx, .xls）</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-hard-drive-line" style="color: #f39c12 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>文件总大小不要超过10GB</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步骤2 -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <i class="ri-table-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                                <strong>选择要分析的工作表和列</strong>
                            </div>
                            <div style="margin-left: 30px;">
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-list-check" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>上传文件后会显示该文件的所有列名</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-smartphone-line" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>系统会自动推荐可能的IMEI/串码列</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-cursor-line" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>您也可以手动选择其他任意列进行分析</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步骤3 -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <i class="ri-bar-chart-grouped-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                                <strong>分析结果将包含</strong>
                            </div>
                            <div style="margin-left: 30px;">
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-fingerprint-line" style="color: #2ecc71 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>所选列中的独特数据（不重复的值）</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-repeat-line" style="color: #9b59b6 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>所选列中的重复数据（重复出现的值）</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-pie-chart-line" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>可视化统计图表</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-file-download-line" style="color: #e74c3c !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>可导出的Excel文件（包含独特数据和重复数据的完整行）</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 注意事项 -->
                        <div class="analysis-time-note" style="color: var(--primary-color); margin-top: 15px; background-color: rgba(255, 152, 0, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="display: flex; align-items: center;">
                                <i class="ri-alarm-warning-line" style="color: #ff9800 !important; font-size: 1.2em; margin-right: 8px;"></i>
                                <strong>注意：</strong>
                            </div>
                            <div style="margin-top: 5px;">数据分析时间取决于多个因素，包括：</div>
                            <div style="margin-left: 15px; margin-top: 5px;">
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-hard-drive-line" style="color: #f39c12 !important; margin-right: 5px;"></i>
                                    <span>文件大小</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-database-2-line" style="color: #3498db !important; margin-right: 5px;"></i>
                                    <span>数据行数</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-table-2" style="color: #9b59b6 !important; margin-right: 5px;"></i>
                                    <span>工作表数量</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-cpu-line" style="color: #2ecc71 !important; margin-right: 5px;"></i>
                                    <span>系统资源占用情况</span>
                                </div>
                            </div>
                            <div style="margin-top: 8px; display: flex; align-items: center;">
                                <i class="ri-time-line" style="color: #e74c3c !important; margin-right: 5px;"></i>
                                <span>请耐心等待分析完成。分析过程中请勿关闭或刷新页面。</span>
                            </div>
                        </div>
                    </div>
                `;
                uploadBtn.textContent = '开始分析';
                // 单文件模式只添加一个文件框
                addFile();
            } else {
                uploadTips.innerHTML = `
                    <div style="font-size: 1.1em; color: #333; display: flex; align-items: center; margin-bottom: 15px;">
                        <i class="ri-information-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                    <strong>使用说明</strong>
                    </div>
                    <div style="margin-top: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                        <!-- 步骤1 -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <i class="ri-file-copy-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                                <strong>上传至少两个Excel文件进行比较</strong>
                            </div>
                            <div style="margin-left: 30px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="ri-file-excel-2-line" style="color: #21a366 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>支持的文件格式：Excel文件（.xlsx, .xls）</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-hard-drive-line" style="color: #f39c12 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>文件总大小不要超过10GB</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步骤2 -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <i class="ri-table-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                                <strong>选择要比较的列</strong>
                            </div>
                            <div style="margin-left: 30px;">
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-list-check" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>上传文件后会显示该文件的所有列名</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-smartphone-line" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>系统会自动推荐可能的IMEI/串码列</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-cursor-line" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>您也可以手动选择其他任意列进行比较</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步骤3 -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <i class="ri-bar-chart-grouped-line" style="color: #0071e3 !important; margin-right: 8px; font-size: 1.2em;"></i>
                                <strong>分析结果将包含</strong>
                            </div>
                            <div style="margin-left: 30px;">
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-fingerprint-line" style="color: #2ecc71 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>每个文件中独特的数据行（在其他文件中未出现的数据对应的完整行）</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-repeat-line" style="color: #9b59b6 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>每个文件中重复的数据行（在其他文件中出现的数据对应的完整行）</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-pie-chart-line" style="color: #3498db !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>可视化统计图表</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-file-download-line" style="color: #e74c3c !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>可导出的Excel文件（包含所有独特数据行，重复数据行）</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-information-line" style="color: #f39c12 !important; margin-right: 5px; font-size: 0.9em;"></i>
                                    <span>注：导出的文件中，各共同数据工作表之间的数据行顺序是相同的</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 注意事项 -->
                        <div class="analysis-time-note" style="color: var(--primary-color); margin-top: 15px; background-color: rgba(255, 152, 0, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="display: flex; align-items: center;">
                                <i class="ri-alarm-warning-line" style="color: #ff9800 !important; font-size: 1.2em; margin-right: 8px;"></i>
                                <strong>注意：</strong>
                            </div>
                            <div style="margin-top: 5px;">数据分析时间取决于多个因素，包括：</div>
                            <div style="margin-left: 15px; margin-top: 5px;">
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-hard-drive-line" style="color: #f39c12 !important; margin-right: 5px;"></i>
                                    <span>文件大小</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-database-2-line" style="color: #3498db !important; margin-right: 5px;"></i>
                                    <span>数据行数</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                                    <i class="ri-table-2" style="color: #9b59b6 !important; margin-right: 5px;"></i>
                                    <span>工作表数量</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <i class="ri-cpu-line" style="color: #2ecc71 !important; margin-right: 5px;"></i>
                                    <span>系统资源占用情况</span>
                                </div>
                            </div>
                            <div style="margin-top: 8px; display: flex; align-items: center;">
                                <i class="ri-time-line" style="color: #e74c3c !important; margin-right: 5px;"></i>
                                <span>请耐心等待分析完成。分析过程中请勿关闭或刷新页面。</span>
                            </div>
                        </div>
                    </div>
                `;
                uploadBtn.textContent = '分析数据';
                // 多文件模式默认添加两个文件框
                addFile();
                addFile();
            }
        });

        // 粒子效果配置
        particlesJS('particles-js', {
            particles: {
                number: {
                    value: 100,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: '#0071e3'
                },
                shape: {
                    type: 'circle'
                },
                opacity: {
                    value: 0.4,
                    random: true,
                    anim: {
                        enable: true,
                        speed: 1,
                        opacity_min: 0.2,
                        sync: false
                    }
                },
                size: {
                    value: 4,
                    random: true,
                    anim: {
                        enable: true,
                        speed: 2,
                        size_min: 0.5,
                        sync: false
                    }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#0071e3',
                    opacity: 0.3,
                    width: 1.2
                },
                move: {
                    enable: true,
                    speed: 1.5,
                    direction: 'none',
                    random: true,
                    straight: false,
                    out_mode: 'out',
                    bounce: false,
                    attract: {
                        enable: true,
                        rotateX: 600,
                        rotateY: 1200
                    }
                }
            },
            interactivity: {
                detect_on: 'window',
                events: {
                    onhover: {
                        enable: true,
                        mode: 'grab'
                    },
                    resize: true
                },
                modes: {
                    grab: {
                        distance: 180,
                        line_linked: {
                            opacity: 0.5
                        }
                    }
                }
            },
            retina_detect: true
        });

        // 根据主题更新粒子颜色
        function updateParticlesTheme(theme) {
            const color = localStorage.getItem('particleColor') || '#0071e3';
            const opacity = theme === 'dark' ? 0.35 : 0.3;
            
            if (window.pJSDom && window.pJSDom[0]) {
                const particles = window.pJSDom[0].pJS.particles;
                particles.color.value = color;
                particles.line_linked.color = color;
                particles.line_linked.opacity = opacity;
                particles.move.speed = 1.5;
                
                // 重新加载粒子
                window.pJSDom[0].pJS.fn.particlesRefresh();
            }
        }

        let currentMode = 'compare';

        function goToAIAnalysis() {
            // 检查是否有未导出的分析结果
            const resultSection = document.getElementById('result-section');
            if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                // 使用自定义弹窗替代confirm
                const exportModal = document.getElementById('export-modal');
                const exportConfirmBtn = document.getElementById('export-confirm-btn');
                const exportCancelBtn = document.getElementById('export-cancel-btn');
                
                exportModal.style.display = 'flex';
                
                exportConfirmBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    const resultFile = resultSection.getAttribute('data-result-file');
                    if (resultFile) {
                        window.location.href = `/download/${resultFile}`;
                        localStorage.setItem('resultExported', 'true');
                        // 延迟跳转到AI分析页面
                        setTimeout(() => {
            window.location.href = '/ai_analysis';
                        }, 1000);
                    }
                };
                
                exportCancelBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    // 设置已导出标记，避免系统弹窗再次提示
                    localStorage.setItem('resultExported', 'true');
                    // 直接跳转到AI分析页面
                    window.location.href = '/ai_analysis';
                };
                
                return;
            }
            
            // 如果没有未导出的分析结果，直接跳转
            window.location.href = '/ai_analysis';
        }

        function goToSalesTrend() {
            // 检查是否有未导出的分析结果
            const resultSection = document.getElementById('result-section');
            if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                // 使用自定义弹窗替代confirm
                const exportModal = document.getElementById('export-modal');
                const exportConfirmBtn = document.getElementById('export-confirm-btn');
                const exportCancelBtn = document.getElementById('export-cancel-btn');
                
                exportModal.style.display = 'flex';
                
                exportConfirmBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    const resultFile = resultSection.getAttribute('data-result-file');
                    if (resultFile) {
                        window.location.href = `/download/${resultFile}`;
                        localStorage.setItem('resultExported', 'true');
                        // 延迟跳转到销售趋势分析页面
                        setTimeout(() => {
            window.location.href = '/sales_trend';
                        }, 1000);
                    }
                };
                
                exportCancelBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    // 设置已导出标记，避免系统弹窗再次提示
                    localStorage.setItem('resultExported', 'true');
                    // 直接跳转到销售趋势分析页面
                    window.location.href = '/sales_trend';
                };
                
                return;
            }
            
            // 如果没有未导出的分析结果，直接跳转
            window.location.href = '/sales_trend';
        }

        function switchMode(mode) {
            if (mode === 'ai') {
                goToAIAnalysis();
                return;
            }
            
            const resultSection = document.getElementById('result-section');
            if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                // 使用自定义弹窗替代confirm
                const exportModal = document.getElementById('export-modal');
                const exportConfirmBtn = document.getElementById('export-confirm-btn');
                const exportCancelBtn = document.getElementById('export-cancel-btn');
                
                exportModal.style.display = 'flex';
                
                exportConfirmBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    const resultFile = resultSection.getAttribute('data-result-file');
                    if (resultFile) {
                        window.location.href = `/download/${resultFile}`;
                        localStorage.setItem('resultExported', 'true');
                        // 延迟切换模式
                        setTimeout(() => {
                            localStorage.setItem('currentMode', mode);
                            window.location.reload();
                        }, 1000);
                    }
                };
                
                exportCancelBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    // 设置已导出标记，避免系统弹窗再次提示
                    localStorage.setItem('resultExported', 'true');
                    localStorage.setItem('currentMode', mode);
                    window.location.reload();
                };
                
                        return;
            }
            
            if (mode === 'single' || mode === 'compare') {
                localStorage.setItem('currentMode', mode);
                window.location.reload();
            }
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('upload-btn');
            const errorDiv = document.getElementById('error');
            
            if (currentMode === 'single') {
                // 单文件模式：只需要一个有效的文件
                const validFiles = Object.values(fileData).filter(data => 
                    data.file && data.selectedSheet && data.selectedColumn
                ).length;
                
                uploadBtn.disabled = validFiles !== 1;
                
                if (Object.keys(fileData).length === 0) {
                    errorDiv.textContent = '请上传一个Excel文件';
                    errorDiv.style.display = 'block';
                } else if (validFiles === 0) {
                    errorDiv.textContent = '请选择工作表和要分析的列';
                    errorDiv.style.display = 'block';
                } else if (validFiles > 1) {
                    errorDiv.textContent = '单文件模式下只能分析一个文件';
                    errorDiv.style.display = 'block';
                } else {
                    errorDiv.style.display = 'none';
                }
            } else {
                // 比较模式：需要至少两个有效的数据源（可以是不同文件或同一文件的不同工作表）
                const validSources = Object.values(fileData).filter(data => 
                    data.file && data.selectedSheet && data.selectedColumn
                );
                
                // 检查是否有重复的文件+工作表组合
                const uniqueSources = new Set(
                    validSources.map(data => `${data.file.name}|${data.selectedSheet}`)
                );
                
                uploadBtn.disabled = uniqueSources.size < 2;
                
                if (Object.keys(fileData).length < 2) {
                    errorDiv.textContent = '请至少选择两个数据源（可以是不同文件或同一文件的不同工作表）';
                    errorDiv.style.display = 'block';
                } else if (validSources.length < Object.keys(fileData).length) {
                    errorDiv.textContent = '请为每个数据源选择工作表和要分析的列';
                    errorDiv.style.display = 'block';
                } else if (uniqueSources.size < 2) {
                    errorDiv.textContent = '请至少选择两个不同的数据源（可以是不同文件或同一文件的不同工作表）';
                    errorDiv.style.display = 'block';
                } else {
                    errorDiv.style.display = 'none';
                }
            }
        }

        function addFile() {
            const fileContainer = document.getElementById('file-container');
            const addFileBtn = document.querySelector('.upload-section button:first-of-type');
            
            // 在单文件模式下，如果已经有文件，则不允许添加更多
            if (currentMode === 'single' && fileContainer.children.length > 0) {
                addFileBtn.style.display = 'none';
                return;
            }
            
            const fileSection = document.createElement('div');
            fileSection.className = 'file-section';
            
            const currentFileCount = document.querySelectorAll('.file-section').length;
            // 使用时间戳+随机数确保ID唯一性
            const fileId = 'file-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            
            // 根据模式决定是否显示删除按钮
            const deleteButton = currentMode === 'single' ? '' : 
                `<button class="delete-file" onclick="deleteFile('${fileId}')">×</button>`;
            
            fileSection.innerHTML = `
                <div class="file-header">
                    <span>文件 ${currentFileCount + 1}</span>
                    ${deleteButton}
                </div>
                <input type="file" accept=".xlsx,.xls" class="file-input" 
                       onchange="handleFileSelect(event, '${fileId}')" id="${fileId}">
                <div class="file-info" id="${fileId}-info"></div>
                <div class="sheet-selection" style="display: none;" id="${fileId}-sheet-section">
                    <label class="column-label">选择工作表：</label>
                    <select class="column-select" id="${fileId}-sheet" onchange="handleSheetSelect(event, '${fileId}')">
                        <option value="">请选择工作表</option>
                    </select>
                </div>
                <div class="column-selection" style="display: none;" id="${fileId}-column-section">
                    <label class="column-label">选择要分析的列：</label>
                    <select class="column-select" id="${fileId}-column" 
                            onchange="handleColumnSelect(event, '${fileId}')">
                        <option value="">请选择要分析的列</option>
                    </select>
                    <div class="column-info" id="${fileId}-column-info"></div>
                    <div class="selected-column" id="${fileId}-selected-column"></div>
                </div>
            `;
            
            fileContainer.appendChild(fileSection);
            
            // 在单文件模式下，添加文件后隐藏添加按钮
            if (currentMode === 'single') {
                addFileBtn.style.display = 'none';
            }
            
            updateUploadButton();
        }

        // 初始化导出标记
        localStorage.removeItem('resultExported');

        // 添加页面刷新/关闭前的检查
        window.addEventListener('beforeunload', function(e) {
            const resultSection = document.getElementById('result-section');
            if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                e.preventDefault();
                e.returnValue = '检测到有未导出的分析结果，是否确认离开？';
                return e.returnValue;
            }
        });

        // 修改 switchMode 函数
        const originalSwitchMode = window.switchMode;
        window.switchMode = function(mode) {
            const resultSection = document.getElementById('result-section');
            if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                // 使用自定义弹窗替代confirm
                const exportModal = document.getElementById('export-modal');
                const exportConfirmBtn = document.getElementById('export-confirm-btn');
                const exportCancelBtn = document.getElementById('export-cancel-btn');
                
                exportModal.style.display = 'flex';
                
                exportConfirmBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    const resultFile = resultSection.getAttribute('data-result-file');
                    if (resultFile) {
                        window.location.href = `/download/${resultFile}`;
                        localStorage.setItem('resultExported', 'true');
                        // 延迟切换模式
                        setTimeout(() => {
                            localStorage.setItem('currentMode', mode);
                            window.location.reload();
                        }, 1000);
                    }
                };
                
                exportCancelBtn.onclick = function() {
                    exportModal.style.display = 'none';
                    // 设置已导出标记，避免系统弹窗再次提示
                    localStorage.setItem('resultExported', 'true');
                    localStorage.setItem('currentMode', mode);
                    window.location.reload();
                };
                
                        return;
            }
            
            localStorage.setItem('currentMode', mode);
            window.location.reload();
        };

        // 修改 downloadResults 函数
        const originalDownloadResults = window.downloadResults;
        window.downloadResults = function() {
            originalDownloadResults();
            localStorage.setItem('resultExported', 'true');
        };

        let isAnalyzing = false;  // 添加全局变量跟踪分析状态

        // 定义上传文件函数
        async function uploadFiles() {
            console.log('开始文件上传和分析...'); // 调试日志
            
            const errorDiv = document.getElementById('error');
            const loadingDiv = document.getElementById('loading');
            const uploadBtn = document.getElementById('upload-btn');
            const resultSection = document.getElementById('result-section');
            
            try {
                errorDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                uploadBtn.disabled = true;
                resultSection.style.display = 'none';
                
                const formData = new FormData();
                const selectedColumns = {};
                
                // 获取所有文件输入
                const fileInputs = document.querySelectorAll('.file-input');
                
                // 检查是否有文件被选择
                let fileCount = 0;
                fileInputs.forEach((fileInput) => {
                    if (fileInput.files[0]) {
            fileCount++;
        }
                });
                
                if (fileCount === 0) {
                    throw new Error('请选择要分析的文件');
                }
                
                // 收集所有文件和选择的列
                fileInputs.forEach((fileInput) => {
                    if (fileInput.files[0]) {
                        const fileId = fileInput.id;
                        const sheetSelect = document.getElementById(fileId + '-sheet');
                        const columnSelect = document.getElementById(fileId + '-column');
                        
                        if (!sheetSelect.value || !columnSelect.value) {
                            throw new Error(`请为文件 ${fileInput.files[0].name} 选择工作表和要分析的列`);
                        }
                        
                        formData.append('files[]', fileInput.files[0]);
                        const uniqueKey = `${fileInput.files[0].name}|${sheetSelect.value}`;
                        selectedColumns[uniqueKey] = {
                            sheet: sheetSelect.value,
                            column: columnSelect.value
                        };
                    }
                });
                
                formData.append('selected_columns', JSON.stringify(selectedColumns));
                formData.append('mode', currentMode);
                
                console.log('发送分析请求...'); // 调试日志
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('收到响应...'); // 调试日志
                const data = await response.json();
                console.log('分析响应数据:', data); // 调试日志
                
                if (!data.success) {
                    throw new Error(data.message || '分析失败');
                }
                
                // 获取分析结果
                const results = data.data;
                console.log('分析结果:', results); // 调试日志
                
                // 更新结果显示
                let summaryHtml = '<div class="analysis-results-header"><h3><i class="ri-bar-chart-line"></i> 分析结果</h3></div>';
                
                if (currentMode === 'single') {
                    summaryHtml += `
                        <div class="result-section single-file-analysis">
                            <div class="analysis-mode-badge">
                                <i class="ri-file-line"></i>
                                <span>单文件分析</span>
                            </div>
                            <div class="data-insights-grid">
                                <div class="data-insight-card unique-data">
                                    <div class="insight-icon">
                                        <i class="ri-star-line"></i>
                                    </div>
                                    <div class="insight-content">
                                        <h5>独特数据</h5>
                                <p class="description">在选定列中只出现一次的值</p>
                                        <div class="metric-display">
                                            <span class="metric-number">${results.unique_count.toLocaleString()}</span>
                                            <span class="metric-label">行数据</span>
                            </div>
                                    </div>
                                </div>
                                <div class="data-insight-card duplicate-data">
                                    <div class="insight-icon">
                                        <i class="ri-file-copy-line"></i>
                                    </div>
                                    <div class="insight-content">
                                        <h5>重复数据</h5>
                                <p class="description">在选定列中出现多次的值</p>
                                        <div class="metric-display">
                                            <span class="metric-number">${results.duplicate_count.toLocaleString()}</span>
                                            <span class="metric-label">行数据</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // 处理比较模式的结果
                    const uniqueResults = results.unique_results || {};
                    summaryHtml += '<div class="multi-file-analysis">';
                    summaryHtml += `
                        <div class="analysis-mode-badge multi-file">
                            <i class="ri-file-compare-line"></i>
                            <span>多文件对比分析</span>
                        </div>
                    `;
                    
                    for (const [filename, info] of Object.entries(uniqueResults)) {
                        summaryHtml += `
                            <div class="result-section file-comparison-section">
                                <div class="file-header">
                                    <div class="file-name">
                                        <i class="ri-file-excel-2-line"></i>
                                        <span>${filename}</span>
                                    </div>
                                </div>
                                <div class="data-insights-grid">
                                    <div class="data-insight-card unique-data">
                                        <div class="insight-icon">
                                            <i class="ri-star-line"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h5>独特数据</h5>
                                    <p class="description">${info.description || '在其他文件中未出现的值'}</p>
                                            <div class="metric-display">
                                                <span class="metric-number">${info.unique_count.toLocaleString()}</span>
                                                <span class="metric-label">行数据</span>
                                </div>
                                        </div>
                                    </div>
                                    <div class="data-insight-card common-data">
                                        <div class="insight-icon">
                                            <i class="ri-group-line"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h5>共同数据</h5>
                                    <p class="description">${info.common_description || '在其他文件中也出现的值'}</p>
                                            <div class="metric-display">
                                                <span class="metric-number">${info.common_count.toLocaleString()}</span>
                                                <span class="metric-label">行数据</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    summaryHtml += '</div>';
                }
                
                document.getElementById('summary').innerHTML = summaryHtml;
                
                // 如果有图表数据，显示图表
                if (results.plot) {
                    const plotData = JSON.parse(results.plot);
                    // 存储当前图表数据，以便主题切换时使用
                    window.currentPlotData = plotData;
                    // 使用新函数渲染图表
                    renderPlotWithTheme(plotData);
                }
                
                // 如果有结果文件，保存文件名
                if (results.result_file) {
                    resultSection.setAttribute('data-result-file', results.result_file);
                }
                
                // 显示结果区域
                resultSection.style.display = 'block';
                
            } catch (error) {
                console.error('分析错误:', error);
                errorDiv.textContent = error.message || '分析失败，请稍后重试';
                errorDiv.style.display = 'block';
                resultSection.style.display = 'none';
            } finally {
                loadingDiv.style.display = 'none';
                uploadBtn.disabled = false;
            }
        }

        // 添加页面切换/关闭前的检查
        window.addEventListener('beforeunload', function(e) {
            if (isAnalyzing) {
                e.preventDefault();
                e.returnValue = '数据正在分析中，确定要离开吗？';
                return e.returnValue;
            }
            
            const resultSection = document.getElementById('result-section');
            if (resultSection.style.display !== 'none' && !localStorage.getItem('resultExported')) {
                e.preventDefault();
                e.returnValue = '检测到有未导出的分析结果，是否确认离开？';
                return e.returnValue;
            }
        });

        // 添加visibilitychange事件监听
        document.addEventListener('visibilitychange', function() {
            if (isAnalyzing && document.visibilityState === 'hidden') {
                alert('数据正在分析中，切换程序可能会影响分析结果！');
            }
        });

        async function handleFileSelect(event, fileId) {
            const file = event.target.files[0];
            const addFileBtn = document.querySelector('.upload-section button:first-of-type');
            const fileContainer = document.getElementById('file-container');
            
            if (!file) {
                const fileSection = document.getElementById(fileId).closest('.file-section');
                if (fileSection) {
                    fileSection.remove();
                }
                delete fileData[fileId];
                // 在单文件模式下，如果没有文件了，显示添加按钮
                if (currentMode === 'single' && fileContainer.children.length === 0) {
                    addFileBtn.style.display = 'inline-block';
                }
                updateUploadButton();
                return;
            }
            
            const fileInfo = document.getElementById(fileId + '-info');
            const sheetSection = document.getElementById(fileId + '-sheet-section');
            const sheetSelect = document.getElementById(fileId + '-sheet');
            const columnSection = document.getElementById(fileId + '-column-section');
            const columnSelect = document.getElementById(fileId + '-column');
            const columnInfo = document.getElementById(fileId + '-column-info');
            const selectedColumn = document.getElementById(fileId + '-selected-column');
            const errorDiv = document.getElementById('error');
            
            fileInfo.innerHTML = `
                <span>文件名：${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                <div class="loading-text">
                    <span class="mini-loading"></span>
                    <span>正在识别工作表...</span>
                </div>
            `;
            
            errorDiv.style.display = 'none';
            sheetSection.style.display = 'none';
            columnSection.style.display = 'none';
            columnInfo.textContent = '';
            selectedColumn.style.display = 'none';
            
            if (!['xlsx', 'xls'].includes(file.name.split('.').pop().toLowerCase())) {
                errorDiv.textContent = `错误：${file.name} 不是有效的Excel文件`;
                errorDiv.style.display = 'block';
                const fileSection = document.getElementById(fileId).closest('.file-section');
                if (fileSection) {
                    fileSection.remove();
                }
                delete fileData[fileId];
                // 在单文件模式下，如果没有文件了，显示添加按钮
                if (currentMode === 'single' && fileContainer.children.length === 0) {
                    addFileBtn.style.display = 'inline-block';
                }
                updateUploadButton();
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/get_sheets', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // 移除加载提示
                fileInfo.innerHTML = `文件名：${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                
                // 检查是否有其他文件选择了相同的工作表
                const usedSheets = new Set();
                
                // 修改: 只检查同一文件中的其他文件框，避免跨文件工作表检查
                Object.entries(fileData).forEach(([id, data]) => {
                    if (id !== fileId && data.file && data.file.name === file.name && data.selectedSheet) {
                        usedSheets.add(data.selectedSheet);
                    }
                });
                
                // 过滤掉已经被选择的工作表
                const availableSheets = data.sheets.filter(sheet => !usedSheets.has(sheet));
                
                if (availableSheets.length === 0) {
                    throw new Error('此文件的所有工作表都已被选择，请选择其他文件');
                }
                
                sheetSelect.innerHTML = '<option value="">请选择工作表</option>' +
                    availableSheets.map(sheet => `<option value="${sheet}">${sheet}</option>`).join('');
                sheetSection.style.display = 'block';
                
                // 确保每个文件有唯一标识
                fileData[fileId] = {
                    file: file,
                    sheets: data.sheets,
                    uniqueKey: `${file.name}|${fileId}|${Date.now()}` // 添加时间戳确保唯一性
                };
                
                // 如果只有一个工作表，自动选择它
                if (availableSheets.length === 1) {
                    const singleSheet = availableSheets[0];
                    sheetSelect.value = singleSheet;
                    
                    // 显示自动选择提示，持续显示不消失
                    const autoSelectInfo = document.createElement('div');
                    autoSelectInfo.className = 'auto-select-info';
                    autoSelectInfo.innerHTML = `
                        <i class="ri-check-line"></i>
                        <span>已自动选择唯一工作表"${singleSheet}"</span>
                    `;
                    sheetSection.appendChild(autoSelectInfo);
                    
                    // 自动触发工作表选择处理
                    handleSheetSelect({ target: sheetSelect }, fileId);
                }
                
                updateUploadButton();
                
            } catch (error) {
                console.error('获取工作表失败:', error);
                fileInfo.innerHTML = `文件名：${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                errorDiv.textContent = error.message || '处理文件失败，请稍后重试';
                errorDiv.style.display = 'block';
                
                delete fileData[fileId];
                updateUploadButton();
            }
        }

        async function handleSheetSelect(event, fileId) {
            const sheetName = event.target.value;
            if (!fileData[fileId] || !fileData[fileId].file) {
                return;
            }
            
            const file = fileData[fileId].file;
            const columnSection = document.getElementById(fileId + '-column-section');
            const columnSelect = document.getElementById(fileId + '-column');
            const columnInfo = document.getElementById(fileId + '-column-info');
            const selectedColumn = document.getElementById(fileId + '-selected-column');
            const errorDiv = document.getElementById('error');
            
            if (!sheetName) {
                columnSection.style.display = 'none';
                if (fileData[fileId]) {
                    delete fileData[fileId].selectedSheet;
                    delete fileData[fileId].columns;
                }
                updateUploadButton();
                return;
            }

            // 添加加载提示
            columnInfo.innerHTML = `
                <div class="loading-text">
                    <span class="mini-loading"></span>
                    <span>正在识别列名...</span>
                </div>
            `;
            columnSection.style.display = 'block';
            columnSelect.style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('sheet_name', sheetName);
                
                const response = await fetch('/get_columns', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                fileData[fileId].columns = data.columns;
                fileData[fileId].selectedSheet = sheetName;
                
                columnInfo.textContent = `工作表包含 ${data.columns.length} 个列`;
                columnSelect.innerHTML = '<option value="">请选择要分析的列</option>' +
                    data.columns.map(col => `<option value="${col}">${col}</option>`).join('');
                columnSelect.style.display = 'block';
                
                if (data.suggested_column) {
                    columnSelect.value = data.suggested_column;
                    handleColumnSelect({ target: columnSelect }, fileId);
                }
                
                updateUploadButton();
                
            } catch (error) {
                errorDiv.textContent = '错误：' + error.message;
                errorDiv.style.display = 'block';
                if (fileData[fileId]) {
                    delete fileData[fileId].selectedSheet;
                    delete fileData[fileId].columns;
                }
                updateUploadButton();
            }
        }

        function handleColumnSelect(event, fileId) {
            const selectedColumn = document.getElementById(fileId + '-selected-column');
            const selectedValue = event.target.value;
            
            if (!fileData[fileId]) {
                return;
            }
            
            const sheetName = fileData[fileId].selectedSheet;
            
            if (selectedValue) {
                fileData[fileId].selectedColumn = selectedValue;
                
                // 使用与自动选择工作表相同的样式
                selectedColumn.className = 'auto-select-info';
                selectedColumn.innerHTML = `
                    <i class="ri-check-line"></i>
                    <span>已自动选择工作表"${sheetName}"中的列"${selectedValue}"，如需更改请重新选择</span>
                `;
                selectedColumn.style.display = 'block';
            } else {
                delete fileData[fileId].selectedColumn;
                selectedColumn.style.display = 'none';
            }
            
            updateUploadButton();
        }

        function deleteFile(fileId) {
            const fileSection = document.getElementById(fileId).closest('.file-section');
            const addFileBtn = document.querySelector('.upload-section button:first-of-type');
            const fileContainer = document.getElementById('file-container');
            
            if (fileSection) {
                fileSection.remove();
                delete fileData[fileId];
                
                // 重新编号剩余的文件
                const fileSections = document.querySelectorAll('.file-section');
                fileSections.forEach((section, index) => {
                    const fileHeader = section.querySelector('.file-header span');
                    fileHeader.textContent = `文件 ${index + 1}`;
                });

                // 检查文件容器中是否还有文件节点
                if (currentMode === 'single' && fileContainer.children.length === 0) {
                    addFileBtn.style.display = 'inline-block';
                }

                updateUploadButton();
            }
        }

        function downloadResults(callback) {
            const resultSection = document.getElementById('result-section');
            const errorDiv = document.getElementById('error');
            
            try {
                const resultFile = resultSection.getAttribute('data-result-file');
                if (!resultFile) {
                    throw new Error('找不到结果文件');
                }
                window.location.href = `/download/${resultFile}`;
                localStorage.setItem('resultExported', 'true');
                
                // 如果有回调函数，延迟执行
                if (callback) {
                    setTimeout(callback, 1000);
                }
            } catch (error) {
                errorDiv.textContent = '错误：' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // 添加粒子颜色设置函数
        function setParticleColor(color) {
            // 验证颜色格式
            if (!color.startsWith('#') || !/^#[0-9A-Fa-f]{6}$/.test(color)) {
                console.error('无效的颜色格式:', color);
                return;
            }
            
            // 保存到本地存储
            localStorage.setItem('particleColor', color);
            
            // 设置粒子颜色
            if (window.pJSDom && window.pJSDom[0]) {
                const particles = window.pJSDom[0].pJS.particles;
                particles.color.value = color;
                particles.line_linked.color = color;  // 同时设置连线颜色
                
                // 更新粒子系统
                window.pJSDom[0].pJS.fn.particlesRefresh();
            }
            
            // 更新颜色选择器的值
            const colorPicker = document.getElementById('custom-color-picker');
            if (colorPicker) {
                colorPicker.value = color;
            }
            
            // 更新自定义颜色选择器的显示颜色
            const colorPickerOverlay = document.querySelector('.color-picker-overlay');
            if (colorPickerOverlay) {
                colorPickerOverlay.style.background = `linear-gradient(135deg, ${color}, ${adjustBrightness(color, -20)})`;
            }
            
            // 更新颜色选择按钮的激活状态
            document.querySelectorAll('.color-option-new').forEach(btn => {
                const btnColor = btn.getAttribute('data-color');
                btn.classList.toggle('active', btnColor === color);
                
                // 更新颜色点的颜色（如果需要动态更新）
                const colorDot = btn.querySelector('.color-dot');
                if (colorDot && btnColor === color) {
                    colorDot.style.borderColor = 'rgba(255, 255, 255, 0.8)';
                    colorDot.style.boxShadow = `0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px ${color}, inset 0 1px 2px rgba(255, 255, 255, 0.4)`;
                } else if (colorDot) {
                    colorDot.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    colorDot.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 2px rgba(255, 255, 255, 0.3)';
                }
            });
            
            // 添加选择反馈动画
            const activeBtn = document.querySelector(`.color-option-new[data-color="${color}"]`);
            if (activeBtn) {
                activeBtn.style.transform = 'translateY(-2px) scale(1.05)';
                setTimeout(() => {
                    activeBtn.style.transform = '';
                }, 200);
            }
        }

        function resetParticleColor() {
            const defaultColor = '#0071e3';
            setParticleColor(defaultColor);
        }

        // 初始化粒子颜色设置
        function initializeParticleColors() {
            // 获取保存的粒子颜色
            const savedColor = localStorage.getItem('particleColor') || '#0071e3';
            
            // 延迟设置颜色，确保DOM完全加载
            setTimeout(() => {
                setParticleColor(savedColor);
            }, 100);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeParticleColors();
        });

        function updateColorInputs(color) {
            // 更新十六进制输入
            document.getElementById('color-hex').value = color;
            
            // 更新RGB输入
            const r = parseInt(color.slice(1,3), 16);
            const g = parseInt(color.slice(3,5), 16);
            const b = parseInt(color.slice(5,7), 16);
            
            document.getElementById('color-r').value = r;
            document.getElementById('color-g').value = g;
            document.getElementById('color-b').value = b;
        }

        function updateColorFromHex(hex) {
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                setParticleColor(hex);
            }
        }

        function updateColorFromRGB() {
            const r = document.getElementById('color-r').value;
            const g = document.getElementById('color-g').value;
            const b = document.getElementById('color-b').value;
            
            if (r >= 0 && r <= 255 && g >= 0 && g <= 255 && b >= 0 && b <= 255) {
                const hex = '#' + [r, g, b].map(x => {
                    const hex = parseInt(x).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
                setParticleColor(hex);
            }
        }

        // 页面加载时初始化颜色输入
        document.addEventListener('DOMContentLoaded', function() {
            const savedColor = localStorage.getItem('particleColor') || '#0071e3';
            setParticleColor(savedColor);
        });

        // 监听在线/离线状态
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            const offlineStatus = document.getElementById('offline-status');
            const uploadBtn = document.getElementById('upload-btn');
            const errorDiv = document.getElementById('error');
            
            if (!navigator.onLine) {
                // 显示离线状态提示
                offlineStatus.style.display = 'flex';
                
                // 不再禁用需要网络的功能
                // uploadBtn.disabled = true;
                // uploadBtn.title = '离线模式下无法使用此功能';
                
                // 如果正在进行文件操作，显示提示但不阻止操作
                if (Object.keys(fileData).length > 0) {
                    errorDiv.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0119 12.55M5 12.55a10.94 10.94 0 015.17-2.39M10.71 5.05A16 16 0 0122.58 9M1.42 9a15.91 15.91 0 014.7-2.88M8.53 16.11a6 6 0 016.95 0M12 20h.01"></path>
                        </svg>
                        <span>网络连接已断开，但可以继续进行本地操作</span>
                    `;
                    errorDiv.style.display = 'flex';
                    errorDiv.classList.add('offline');
                }
                
                // 不再禁用文件输入
                // document.querySelectorAll('.file-input').forEach(input => {
                //     input.disabled = true;
                //     input.title = '离线模式下无法上传文件';
                // });
                
                // 不再禁用下拉选择
                // document.querySelectorAll('.column-select').forEach(select => {
                //     select.disabled = true;
                //     select.title = '离线模式下无法获取文件信息';
                // });
            } else {
                // 恢复在线状态
                offlineStatus.style.display = 'none';
                errorDiv.classList.remove('offline');
                
                // 启用文件输入
                document.querySelectorAll('.file-input').forEach(input => {
                    input.disabled = false;
                    input.title = '';
                });
                
                // 启用下拉选择
                document.querySelectorAll('.column-select').forEach(select => {
                    select.disabled = false;
                    select.title = '';
                });
                
                // 重新检查上传按钮状态
                updateUploadButton();
            }
        }

        // 页面加载时检查在线状态
        document.addEventListener('DOMContentLoaded', function() {
            updateOnlineStatus();
            // ... existing DOMContentLoaded code ...
        });

        function adjustBrightness(color, percent) {
            const num = parseInt(color.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? (R < 0 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 0 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 0 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }
        // ... existing code ...

        // 创建工作表选择的HTML
        function createSheetSelectionHtml(sheets, groupId) {
            return `
                <div class="mt-2">
                    <label class="form-label">选择工作表：</label>
                    <div class="sheet-options">
                        ${sheets.map((sheet, index) => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sheet-${groupId}" 
                                       value="${sheet}" id="sheet-${groupId}-${index}">
                                <label class="form-check-label" for="sheet-${groupId}-${index}">
                                    ${sheet}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 创建列选择的HTML
        function createColumnSelectionHtml(columns, groupId) {
            return `
                <div class="mt-2">
                    <label class="form-label">选择要分析的列：</label>
                    <div class="column-options">
                        ${columns.map((column, index) => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="column-${groupId}" 
                                       value="${column}" id="column-${groupId}-${index}">
                                <label class="form-check-label" for="column-${groupId}-${index}">
                                    ${column}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ... existing code ...
        function initializeCompareMode() {
            const fileContainer = document.getElementById('file-container');
            fileContainer.innerHTML = ''; // 清空容器
            addFile(); // 只添加一个文件选择框
        }
        // ... existing code ...

        // 加载系统设置
        async function loadSystemSettings() {
            try {
                const response = await fetch('/api/public-settings');
                if (response.ok) {
                    const settings = await response.json();
                    
                    // 设置系统名称
                    if (settings.systemName) {
                        document.getElementById('page-title').textContent = settings.systemName;
                        // 如果页面上有其他地方显示系统名称，也可以更新
                        const systemNameElements = document.querySelectorAll('.system-name');
                        systemNameElements.forEach(el => {
                            el.textContent = settings.systemName;
                        });
                    }
                    
                    // 应用主题设置
                    if (settings.defaultTheme && !localStorage.getItem('theme')) {
                        setTheme(settings.defaultTheme);
                    }
                    
                    // 应用动画设置
                    if (settings.animation === false && !localStorage.getItem('animation')) {
                        setAnimation('off');
                    }
                    
                    // 应用粒子效果设置
                    if (settings.animation === false && !localStorage.getItem('particles')) {
                        setParticles('off');
                    }
                } else {
                    console.warn('无法加载系统设置');
                }
            } catch (error) {
                console.error('加载系统设置失败:', error);
            }
        }

        // 美化的配色方案
        const chartColorSchemes = {
            light: {
                primary: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'],
                secondary: ['#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3', '#d299c2', '#fef9d7'],
                gradient: [
                    { start: '#667eea', end: '#764ba2' },
                    { start: '#f093fb', end: '#f5576c' },
                    { start: '#4facfe', end: '#00f2fe' },
                    { start: '#43e97b', end: '#38f9d7' }
                ]
            },
            dark: {
                primary: ['#bb86fc', '#03dac6', '#cf6679', '#018786', '#3700b3', '#6200ea', '#00b4d8', '#0077b6'],
                secondary: ['#e1bee7', '#a8e6cf', '#ffb3ba', '#bae1ff', '#ffffba', '#ffdfba', '#c7ceea', '#ffd1dc'],
                gradient: [
                    { start: '#bb86fc', end: '#6200ea' },
                    { start: '#03dac6', end: '#018786' },
                    { start: '#cf6679', end: '#b00020' },
                    { start: '#00b4d8', end: '#0077b6' }
                ]
            }
        };

        // 定义一个独立的函数来渲染图表，以便在主题更改时重新调用
        function renderPlotWithTheme(plotData) {
            // 检测当前主题模式
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            const currentTheme = isDarkMode ? 'dark' : 'light';
            const colors = chartColorSchemes[currentTheme];
            
            // 克隆plotData以避免修改原始数据
            const themeAdjustedData = JSON.parse(JSON.stringify(plotData));
            
            // 根据主题模式调整图表样式
            if (themeAdjustedData.layout) {
                // 设置标题颜色
                if (typeof themeAdjustedData.layout.title === 'object') {
                    themeAdjustedData.layout.title.font = themeAdjustedData.layout.title.font || {};
                    themeAdjustedData.layout.title.font.color = isDarkMode ? '#f5f5f7' : '#1d1d1f';
                } else if (typeof themeAdjustedData.layout.title === 'string') {
                    themeAdjustedData.layout.title = {
                        text: themeAdjustedData.layout.title,
                        font: {
                            color: isDarkMode ? '#f5f5f7' : '#1d1d1f'
                        }
                    };
                }
                
                // 设置图例字体颜色
                themeAdjustedData.layout.legend = themeAdjustedData.layout.legend || {};
                themeAdjustedData.layout.legend.font = themeAdjustedData.layout.legend.font || {};
                themeAdjustedData.layout.legend.font.color = isDarkMode ? '#f5f5f7' : '#1d1d1f';
            }
            
            // 美化数据点样式
            for (let i = 0; i < themeAdjustedData.data.length; i++) {
                // 设置美化的文本字体
                themeAdjustedData.data[i].textfont = {
                    family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif',
                    size: 14,
                    color: isDarkMode ? '#ffffff' : '#1d1d1f',
                    weight: 600
                };
                
                // 设置美化的颜色
                themeAdjustedData.data[i].marker = themeAdjustedData.data[i].marker || {};
                themeAdjustedData.data[i].marker.colors = colors.primary;
                themeAdjustedData.data[i].marker.line = {
                    color: isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)',
                    width: 2
                };
                
                // 设置渐变效果（如果是饼图）
                if (themeAdjustedData.data[i].type === 'pie') {
                    themeAdjustedData.data[i].marker.gradient = {
                        type: 'radial',
                        color: colors.secondary
                    };
                }
                
                // 美化悬停效果
                themeAdjustedData.data[i].hovertemplate = 
                    '<b>%{label}</b><br>' +
                    '数量: <b>%{value:,}</b><br>' +
                    '占比: <b>%{percent}</b><br>' +
                    '<extra></extra>';
                
                // 设置文本显示
                themeAdjustedData.data[i].textinfo = 'label+percent';
                themeAdjustedData.data[i].textposition = 'auto';
                
                // 调整标题文字颜色（如果有）
                if (themeAdjustedData.data[i].title && themeAdjustedData.data[i].title.font) {
                    themeAdjustedData.data[i].title.font.color = isDarkMode ? '#f5f5f7' : '#1d1d1f';
                }
                
                // 添加动画效果
                themeAdjustedData.data[i].sort = false;
                themeAdjustedData.data[i].direction = 'clockwise';
                themeAdjustedData.data[i].rotation = 90;
            }
            
            const plotElement = document.getElementById('plot');
            
            // 检查是否是多文件比较模式（通过判断数据长度和特定属性）
            const isMultiFileMode = currentMode === 'compare' && themeAdjustedData.data.length > 1;
            
            if (isMultiFileMode) {
                // 清空原有内容
                plotElement.innerHTML = '';
                
                // 创建图表区域标题和统计信息
                const chartHeader = document.createElement('div');
                chartHeader.className = 'chart-section-header';
                chartHeader.innerHTML = '<h4><i class="ri-pie-chart-2-line"></i> 数据可视化对比</h4>';
                plotElement.appendChild(chartHeader);
                
                // 添加总体统计信息
                const statsContainer = document.createElement('div');
                statsContainer.className = 'chart-stats-container';
                
                let totalDataPoints = 0;
                let fileCount = themeAdjustedData.data.length;
                
                themeAdjustedData.data.forEach(chart => {
                    if (chart.values) {
                        totalDataPoints += chart.values.reduce((sum, val) => sum + val, 0);
                    }
                });
                
                statsContainer.innerHTML = `
                    <div class="chart-stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="ri-file-list-3-line"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">${fileCount}</span>
                                <span class="stat-label">对比文件</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="ri-database-2-line"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">${totalDataPoints.toLocaleString()}</span>
                                <span class="stat-label">总数据量</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="ri-pie-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">${fileCount * 2}</span>
                                <span class="stat-label">数据类型</span>
                            </div>
                        </div>
                    </div>
                `;
                plotElement.appendChild(statsContainer);
                
                // 创建图表容器
                const chartContainer = document.createElement('div');
                chartContainer.className = 'multi-chart-container';
                plotElement.appendChild(chartContainer);
                
                // 为每个文件创建一个独立的图表
                themeAdjustedData.data.forEach((chartData, index) => {
                    // 创建单个图表容器
                    const chartItem = document.createElement('div');
                    chartItem.className = 'chart-item';
                    chartItem.id = `chart-item-${index}`;
                    
                    // 添加图表卡片包装
                    const chartCard = document.createElement('div');
                    chartCard.className = 'chart-card';
                    chartItem.appendChild(chartCard);
                    
                    // 添加标题
                    const chartTitle = document.createElement('div');
                    chartTitle.className = 'chart-title';
                    chartTitle.innerHTML = `<i class="ri-file-excel-2-line"></i><span>${chartData.name || `文件 ${index + 1}`}</span>`;
                    chartCard.appendChild(chartTitle);
                    
                    // 添加单个图表的统计信息
                    const chartStatsDiv = document.createElement('div');
                    chartStatsDiv.className = 'single-chart-stats';
                    
                    let chartTotal = 0;
                    let uniqueCount = 0;
                    let duplicateCount = 0;
                    
                    if (chartData.values) {
                        chartTotal = chartData.values.reduce((sum, val) => sum + val, 0);
                        if (chartData.labels && chartData.labels.length >= 2) {
                            uniqueCount = chartData.values[0] || 0;
                            duplicateCount = chartData.values[1] || 0;
                        }
                    }
                    
                    chartStatsDiv.innerHTML = `
                        <div class="mini-stats-grid">
                            <div class="mini-stat">
                                <span class="mini-stat-value">${chartTotal.toLocaleString()}</span>
                                <span class="mini-stat-label">总计</span>
                            </div>
                            <div class="mini-stat unique">
                                <span class="mini-stat-value">${uniqueCount.toLocaleString()}</span>
                                <span class="mini-stat-label">独特</span>
                            </div>
                            <div class="mini-stat duplicate">
                                <span class="mini-stat-value">${duplicateCount.toLocaleString()}</span>
                                <span class="mini-stat-label">重复</span>
                            </div>
                        </div>
                    `;
                    chartCard.appendChild(chartStatsDiv);
                    
                    // 创建图表区域
                    const chartDiv = document.createElement('div');
                    chartDiv.id = `chart-${index}`;
                    chartDiv.className = 'chart-plot-area';
                    chartCard.appendChild(chartDiv);
                    
                    // 添加到容器
                    chartContainer.appendChild(chartItem);
                    
                    // 强制设置文本位置和样式，确保可见性
                    if (chartData.textposition === undefined) {
                        chartData.textposition = 'inside';
                    }
                    
                    if (chartData.insidetextorientation === undefined) {
                        chartData.insidetextorientation = 'radial';
                    }
                    
                    // 创建此文件的布局
                    const singleLayout = {
                        showlegend: true,
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        margin: {
                            l: 10,
                            r: 60, /* 增加右边距 */
                            t: 20,
                            b: 80  /* 增加底部边距 */
                        },
                        legend: {
                            font: {
                                color: isDarkMode ? '#f5f5f7' : '#1d1d1f',
                                size: 12
                            },
                            orientation: 'h',     // 水平图例
                            xanchor: 'center',    // 水平居中
                            yanchor: 'bottom',    // 底部对齐
                            y: -0.25,             // 降低图例位置
                            x: 0.5,               // 水平居中
                            traceorder: 'normal', // 保持原始顺序
                            bgcolor: 'rgba(0,0,0,0.01)',
                            bordercolor: 'rgba(0,0,0,0)'
                        },
                        width: 320,  /* 设置固定宽度 */
                        height: 320  /* 设置固定高度 */
                    };
                    
                    // 增强图表中文本的可见性
                    const enhancedChartData = {
                        ...chartData,
                        textfont: {
                            ...chartData.textfont,
                            size: 14,
                            color: isDarkMode ? '#ffffff' : '#000000'
                        },
                        // 确保使用固定的颜色
                        marker: {
                            ...chartData.marker,
                            colors: chartData.marker?.colors || ['#4e79a7', '#f28e2c']
                        }
                    };
                    
                    // 创建该图表（只包含当前文件的数据）
                    Plotly.newPlot(`chart-${index}`, [enhancedChartData], singleLayout, {
                        responsive: true,
                        displaylogo: false,
                        displayModeBar: false,
                        scrollZoom: false,
                        doubleClick: false,
                        showTips: false,
                        staticPlot: false
                    }).then(function() {
                        // 添加图表入场动画
                        Plotly.animate(`chart-${index}`, {
                            data: [{
                                ...enhancedChartData,
                                rotation: 0
                            }]
                        }, {
                            transition: {
                                duration: 1000,
                                easing: 'cubic-in-out'
                            }
                        });
            });
                    });
            } else {
                // 单文件模式，创建美化的图表区域
                plotElement.innerHTML = '';
                
                // 创建图表区域标题
                const chartHeader = document.createElement('div');
                chartHeader.className = 'chart-section-header single-file';
                chartHeader.innerHTML = '<h4><i class="ri-pie-chart-line"></i> 数据可视化分析</h4>';
                plotElement.appendChild(chartHeader);
                
                // 添加单文件模式的统计信息
                const singleStatsContainer = document.createElement('div');
                singleStatsContainer.className = 'single-file-stats-container';
                
                let singleTotal = 0;
                let singleUnique = 0;
                let singleDuplicate = 0;
                
                if (themeAdjustedData.data[0] && themeAdjustedData.data[0].values) {
                    const values = themeAdjustedData.data[0].values;
                    singleTotal = values.reduce((sum, val) => sum + val, 0);
                    singleUnique = values[0] || 0;
                    singleDuplicate = values[1] || 0;
                }
                
                const uniquePercentage = singleTotal > 0 ? ((singleUnique / singleTotal) * 100).toFixed(1) : 0;
                const duplicatePercentage = singleTotal > 0 ? ((singleDuplicate / singleTotal) * 100).toFixed(1) : 0;
                
                singleStatsContainer.innerHTML = `
                    <div class="single-file-stats-grid">
                        <div class="single-stat-card primary">
                            <div class="single-stat-icon">
                                <i class="ri-database-2-line"></i>
                            </div>
                            <div class="single-stat-content">
                                <span class="single-stat-value">${singleTotal.toLocaleString()}</span>
                                <span class="single-stat-label">总数据量</span>
                                <div class="single-stat-subtitle">完整数据集</div>
                            </div>
                        </div>
                        <div class="single-stat-card unique">
                            <div class="single-stat-icon">
                                <i class="ri-star-line"></i>
                            </div>
                            <div class="single-stat-content">
                                <span class="single-stat-value">${singleUnique.toLocaleString()}</span>
                                <span class="single-stat-label">独特数据</span>
                                <div class="single-stat-subtitle">${uniquePercentage}% 占比</div>
                            </div>
                        </div>
                        <div class="single-stat-card duplicate">
                            <div class="single-stat-icon">
                                <i class="ri-file-copy-line"></i>
                            </div>
                            <div class="single-stat-content">
                                <span class="single-stat-value">${singleDuplicate.toLocaleString()}</span>
                                <span class="single-stat-label">重复数据</span>
                                <div class="single-stat-subtitle">${duplicatePercentage}% 占比</div>
                            </div>
                        </div>
                    </div>
                `;
                plotElement.appendChild(singleStatsContainer);
                
                // 创建图表卡片
                const chartCard = document.createElement('div');
                chartCard.className = 'chart-card single-chart';
                
                // 创建图表区域
                const chartDiv = document.createElement('div');
                chartDiv.id = 'single-chart-plot';
                chartDiv.className = 'chart-plot-area single-plot';
                chartCard.appendChild(chartDiv);
                
                plotElement.appendChild(chartCard);
                
                // 增强图表布局
                if (themeAdjustedData.layout) {
                    // 调整图例位置
                    themeAdjustedData.layout.legend = {
                        ...(themeAdjustedData.layout.legend || {}),
                        orientation: 'h',     // 水平图例
                        xanchor: 'center',    // 水平居中
                        yanchor: 'bottom',    // 底部对齐
                        y: -0.15,             // 位置在图表下方
                        x: 0.5,               // 水平居中
                        font: {
                            color: isDarkMode ? '#f5f5f7' : '#1d1d1f',
                            size: 12
                        }
                    };
                    
                    // 调整边距
                    themeAdjustedData.layout.margin = {
                        l: 20,
                        r: 20,
                        t: 40,
                        b: 80  // 为底部图例留出足够空间
                    };
                    
                    // 设置透明背景
                    themeAdjustedData.layout.paper_bgcolor = 'rgba(0,0,0,0)';
                    themeAdjustedData.layout.plot_bgcolor = 'rgba(0,0,0,0)';
                }
                
                // 使用美化的图表渲染
                Plotly.newPlot('single-chart-plot', themeAdjustedData.data, themeAdjustedData.layout, {
                    responsive: true,
                    displaylogo: false,
                    displayModeBar: false,
                    scrollZoom: false,
                    doubleClick: false,
                    showTips: false,
                    staticPlot: false
                }).then(function() {
                    // 添加图表入场动画
                    Plotly.animate('single-chart-plot', {
                        data: themeAdjustedData.data.map(trace => ({
                            ...trace,
                            rotation: 0
                        }))
                    }, {
                        transition: {
                            duration: 1200,
                            easing: 'cubic-in-out'
                        }
                    });
                });
            }
        }

        // 添加初始化代码在页面加载时，确保fileData是一个空对象

        document.addEventListener('DOMContentLoaded', function() {
            // 确保fileData被正确初始化为空对象
            window.fileData = {}; 
            
            // 其他初始化代码...
        });

        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户是否是管理员，并显示/隐藏管理员登录入口
            checkAdminAccess();

        // ... existing code ...
        });


        // 原来的检查用户管理员状态的代码需要替换为使用新的API endpoint
        function checkAdminAccess() {
            fetch('/api/check-admin-access')
            .then(response => response.json())
                .then(data => {
                    if (data.success && data.has_access) {
                        // 只有当同时满足管理员权限和IP白名单条件时才显示管理员登录入口
                        document.getElementById('admin-login-item').style.display = 'block';
                    } else {
                        document.getElementById('admin-login-item').style.display = 'none';
                }
            })
            .catch(error => {
                    console.error('检查管理员访问权限失败:', error);
                    document.getElementById('admin-login-item').style.display = 'none';
                });
        }

        // 页面加载时调用此函数
        document.addEventListener('DOMContentLoaded', function() {
            // ... 其他初始化代码 ...
            
            // 检查管理员访问权限
            checkAdminAccess();
            
            // ... 其他初始化代码 ...
        });

        // 获取用户偏好设置
        // function getUserPreferences() {
        //     fetch('/api/preferences')
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 const mode = data.data.analysis_mode || 'basic';
        //                 document.querySelector(`input[name="analysis-mode"][value="${mode}"]`).checked = true;
        //                 initializeFileInputs();
        //             }
        //         })
        //         .catch(error => {
        //             console.error('获取偏好设置失败:', error);
        //             initializeFileInputs();
        //         });
        // }

        // 页面加载时获取用户偏好设置
        // document.addEventListener('DOMContentLoaded', function() {
        //     getUserPreferences();
        // });

        // 加载用户信息到账户管理部分
        function loadUserInfo() {
            // 获取用户信息
            fetch('/api/current-user')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('user-displayname').textContent = data.user.username || '用户';
                        document.getElementById('user-email').textContent = data.user.email || '未设置邮箱';
                    } else {
                        document.getElementById('user-displayname').textContent = '游客';
                        document.getElementById('user-email').textContent = '未登录';
                    }
                })
                .catch(error => {
                    console.error('获取用户信息失败:', error);
                    document.getElementById('user-displayname').textContent = '获取失败';
                    document.getElementById('user-email').textContent = '请检查网络连接';
                });
        }

        // 初始化时加载用户信息
        document.addEventListener('DOMContentLoaded', function() {
            // 已有的DOMContentLoaded代码...
            loadUserInfo();
        });

        // 显示个人资料模态框
        function showProfileModal() {
            // 首先检查用户是否可以修改用户名
            fetch('/api/can-change-username')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const canChange = data.can_change;
                        
                        // 获取当前用户信息
                        fetch('/api/user-info')
                            .then(response => response.json())
                            .then(userData => {
                                if (userData.success) {
                                    // 填充表单
                                    document.getElementById('current-username').value = userData.username;
                                    document.getElementById('user-email-confirm').value = userData.email;
                                    
                                    // 显示修改频率限制信息
                                    const usernameChangeInfo = document.getElementById('username-change-info');
                                    if (usernameChangeInfo) {
                                        if (canChange) {
                                            usernameChangeInfo.textContent = '注：您可以修改用户名（每次修改后需等待15天才能再次修改）';
                                            usernameChangeInfo.style.color = 'green';
                                            
                                            // 启用修改功能
                                            document.getElementById('new-username').disabled = false;
                                            document.getElementById('check-username-btn').disabled = false;
                                        } else {
                                            // 显示剩余天数和下次可用日期
                                            usernameChangeInfo.textContent = `注：近期已修改过用户名，请等待${data.days_remaining}天后再试（下次可用日期: ${data.next_available_date}）`;
                                            usernameChangeInfo.style.color = 'red';
                                            
                                            // 禁用修改功能
                                            document.getElementById('new-username').disabled = true;
                                            document.getElementById('check-username-btn').disabled = true;
                                        }
                                    }
                                    
                                    // 显示模态框并启用flex布局以居中显示
                                    const profileModal = document.getElementById('profile-modal');
                                    profileModal.style.display = 'flex';
                                    
                                    // 禁止主界面滚动
                                    document.body.style.overflow = 'hidden';
                                } else {
                                    alert('获取用户信息失败: ' + userData.message);
                                }
                            })
                            .catch(error => {
                                console.error('获取用户信息失败:', error);
                                alert('网络错误，请稍后再试');
                            });
                    } else {
                        alert('检查用户名修改权限失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('检查用户名修改权限失败:', error);
                    alert('网络错误，请稍后再试');
                });
        }

        // 隐藏个人资料模态框
        function hideProfileModal() {
            const profileModal = document.getElementById('profile-modal');
            profileModal.style.display = 'none';
            
            // 恢复主界面滚动
            document.body.style.overflow = 'auto';
            
            // 重置表单状态
            const errorElement = document.getElementById('username-error');
            const verificationMessage = document.getElementById('verification-message');
            
            if (errorElement) errorElement.textContent = '';
            if (verificationMessage) verificationMessage.textContent = '';
            
            // 重置输入框
            const newUsernameInput = document.getElementById('new-username');
            const verificationCodeInput = document.getElementById('email-verification-code');
            
            if (newUsernameInput) {
                newUsernameInput.value = '';
                newUsernameInput.readOnly = false;  // 移除只读状态
                newUsernameInput.classList.remove('readonly-confirmed');  // 移除确认样式
            }
            
            if (verificationCodeInput) verificationCodeInput.value = '';
            
            // 重置按钮和显示状态
            const checkUsernameBtn = document.getElementById('check-username-btn');
            const changeUsernameBtn = document.getElementById('change-username-btn');
            const verificationGroup = document.querySelector('.verification-group');
            const sendVerificationBtn = document.getElementById('send-verification-btn');
            
            if (checkUsernameBtn) {
                checkUsernameBtn.style.display = 'block';
                checkUsernameBtn.disabled = false;
            }
            
            if (changeUsernameBtn) {
                changeUsernameBtn.style.display = 'none';
                changeUsernameBtn.disabled = false;
            }
            
            if (verificationGroup) {
                verificationGroup.style.display = 'none';
            }
            
            if (sendVerificationBtn) {
                sendVerificationBtn.disabled = false;
                sendVerificationBtn.textContent = '发送验证码';
            }
        }

        // 检查用户名是否可用
        function checkUsername() {
            const newUsername = document.getElementById('new-username').value.trim();
            const currentUsername = document.getElementById('current-username').value;
            const errorElement = document.getElementById('username-error');
            
            // 重置错误消息
            errorElement.textContent = '';
            errorElement.style.color = 'red';
            
            // 验证用户名不为空
            if (!newUsername) {
                errorElement.textContent = '请输入新的用户名';
                return;
            }
            
            // 验证用户名长度
            if (newUsername.length < 3 || newUsername.length > 20) {
                errorElement.textContent = '用户名长度必须在3-20个字符之间';
                return;
            }
            
            // 验证用户名格式
            if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(newUsername)) {
                errorElement.textContent = '用户名只能包含字母、数字、下划线和中文';
                return;
            }
            
            // 如果新用户名与当前用户名相同
            if (newUsername === currentUsername) {
                errorElement.textContent = '新用户名不能与当前用户名相同';
                return;
            }
            
            // 检查用户名是否已被使用
            fetch('/api/check-username', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: newUsername }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        // 用户名可用，显示验证码输入区域
                        document.querySelector('.verification-group').style.display = 'block';
                        document.getElementById('check-username-btn').style.display = 'none';
                        document.getElementById('change-username-btn').style.display = 'block';
                        
                        // 将新用户名输入框设为只读，防止修改
                        document.getElementById('new-username').readOnly = true;
                        document.getElementById('new-username').classList.add('readonly-confirmed');
                        
                        errorElement.textContent = '用户名可用，请获取邮箱验证码进行验证';
                        errorElement.style.color = 'green';
                    } else {
                        errorElement.textContent = '该用户名已被使用，请选择其他用户名';
                    }
                })
                .catch(error => {
                    console.error('检查用户名失败:', error);
                    errorElement.textContent = '网络错误，请稍后再试';
                });
        }

        // 发送验证码
        function sendVerificationCode() {
            const email = document.getElementById('user-email-confirm').value;
            const verificationMessage = document.getElementById('verification-message');
            const sendButton = document.getElementById('send-verification-btn');
            
            // 禁用按钮，防止重复点击
            sendButton.disabled = true;
            sendButton.textContent = '发送中...';
            
            // 发送请求
            fetch('/api/send-verification-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email, action: 'change_username' }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 显示倒计时
                        verificationMessage.textContent = '验证码已发送，请查收邮件';
                        verificationMessage.style.color = 'green';
                        
                        let countdown = 60;
                        sendButton.textContent = `重新发送(${countdown}s)`;
                        
                        const timer = setInterval(() => {
                            countdown--;
                            sendButton.textContent = `重新发送(${countdown}s)`;
                            
                            if (countdown <= 0) {
                                clearInterval(timer);
                                sendButton.disabled = false;
                                sendButton.textContent = '重新发送';
                            }
                        }, 1000);
                    } else {
                        verificationMessage.textContent = data.message || '发送验证码失败，请稍后再试';
                        verificationMessage.style.color = 'red';
                        sendButton.disabled = false;
                        sendButton.textContent = '发送验证码';
                    }
                })
                .catch(error => {
                    console.error('发送验证码失败:', error);
                    verificationMessage.textContent = '网络错误，请稍后再试';
                    verificationMessage.style.color = 'red';
                    sendButton.disabled = false;
                    sendButton.textContent = '发送验证码';
                });
        }

        // 修改用户名
        function changeUsername() {
            const newUsername = document.getElementById('new-username').value.trim();
            const verificationCode = document.getElementById('email-verification-code').value.trim();
            const verificationMessage = document.getElementById('verification-message');
            
            // 验证验证码不为空
            if (!verificationCode) {
                verificationMessage.textContent = '请输入验证码';
                verificationMessage.style.color = 'red';
                return;
            }
            
            // 禁用按钮，防止重复提交
            document.getElementById('change-username-btn').disabled = true;
            
            // 发送请求
            fetch('/api/change-username', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_username: newUsername,
                    verification_code: verificationCode
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新显示的用户名
                        document.getElementById('user-displayname').textContent = newUsername;
                        document.getElementById('current-username').value = newUsername;
                        
                        // 关闭资料修改模态框
                        hideProfileModal();
                        
                        // 修改成功消息，添加下次可修改日期
                        const successMessage = document.querySelector('.success-message');
                        if (successMessage) {
                            const messageText = successMessage.querySelector('p');
                            if (messageText && data.next_available_date) {
                                messageText.innerHTML = `您的用户名已成功更新<br><span style="font-size: 12px; opacity: 0.8; margin-top: 5px; display: block;">下次可修改日期: ${data.next_available_date}</span>`;
                            }
                        }
                        
                        // 显示自定义成功提示
                        const successNotification = document.getElementById('username-success');
                        successNotification.style.display = 'flex';
                        
                        // 重置动画，确保每次都能正常播放
                        const progressBar = successNotification.querySelector('.progress-bar');
                        progressBar.style.animation = 'none';
                        void progressBar.offsetWidth; // 触发重排
                        progressBar.style.animation = 'successProgressShrink 3s linear forwards';
                        
                        // 3秒后自动关闭成功提示
                        setTimeout(() => {
                            successNotification.style.display = 'none';
                        }, 3000);
                    } else {
                        verificationMessage.textContent = data.message || '验证码错误或已过期';
                        verificationMessage.style.color = 'red';
                        document.getElementById('change-username-btn').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('修改用户名失败:', error);
                    verificationMessage.textContent = '网络错误，请稍后再试';
                    verificationMessage.style.color = 'red';
                    document.getElementById('change-username-btn').disabled = false;
                });
        }

        // 点击模态框外部关闭模态框
        window.addEventListener('click', function(event) {
            const profileModal = document.getElementById('profile-modal');
            if (event.target === profileModal) {
                hideProfileModal();
            }
            
            const logoutModal = document.getElementById('logout-modal');
            if (event.target === logoutModal) {
                logoutModal.style.display = 'none';
            }
            
            const securityModal = document.getElementById('security-modal');
            if (event.target === securityModal) {
                hideSecurityModal();
            }
        });

        // ... existing code ...

        // 更新未读通知计数
        function updateUnreadCount() {
            // 计算未读通知数量
            const unreadItems = notificationList.querySelectorAll('.notification-item.unread').length;
            const badge = document.getElementById('notification-badge');
            
            if (badge) {
                badge.textContent = unreadItems;
                badge.style.display = unreadItems > 0 ? 'flex' : 'none';
            }
        }

        // 菜单交互初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置菜单切换
            const settingsBtn = document.querySelector('.settings-btn');
            const settingsMenu = document.getElementById('settings-menu');
            const settingsClose = settingsMenu.querySelector('.settings-close');
            
            // 账户菜单切换
            const accountBtn = document.querySelector('.account-btn');
            const accountMenu = document.getElementById('account-menu');
            const accountClose = accountMenu.querySelector('.settings-close');
            const accountArea = accountBtn.closest('.account-area');
            let accountHideTimeout;
            
            // 添加账户按钮的鼠标悬停事件
            accountBtn.addEventListener('mouseenter', () => {
                clearTimeout(accountHideTimeout);
                accountMenu.classList.add('show');
            });
            
            accountMenu.addEventListener('mouseenter', () => {
                clearTimeout(accountHideTimeout);
            });
            
            accountArea.addEventListener('mouseleave', () => {
                accountHideTimeout = setTimeout(() => {
                    accountMenu.classList.remove('show');
                }, 200);
            });
            
            // 通知面板切换
            const notificationButton = document.getElementById('notification-button');
            const notificationPanel = document.getElementById('notification-panel');
            const closeNotificationPanel = document.getElementById('close-notification-panel');
            const notificationArea = notificationButton.closest('.notification-wrapper');
            let notificationHideTimeout;
            
            // 添加通知按钮的鼠标悬停事件
            notificationButton.addEventListener('mouseenter', () => {
                clearTimeout(notificationHideTimeout);
                notificationPanel.classList.add('show');
            });
            
            notificationPanel.addEventListener('mouseenter', () => {
                clearTimeout(notificationHideTimeout);
            });
            
            notificationArea.addEventListener('mouseleave', () => {
                notificationHideTimeout = setTimeout(() => {
                    notificationPanel.classList.remove('show');
                }, 200);
            });
            
            // 设置菜单事件
            settingsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                settingsMenu.classList.toggle('show');
                notificationPanel.classList.remove('show');
                accountMenu.classList.remove('show');
            });
            
            settingsClose.addEventListener('click', function() {
                settingsMenu.classList.remove('show');
            });
            
            // 账户菜单事件
            accountBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                accountMenu.classList.toggle('show');
                settingsMenu.classList.remove('show');
                notificationPanel.classList.remove('show');
            });
            
            accountClose.addEventListener('click', function() {
                accountMenu.classList.remove('show');
            });
            
            // 通知面板事件
            notificationButton.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationPanel.classList.toggle('show');
                settingsMenu.classList.remove('show');
                accountMenu.classList.remove('show');
            });
            
            closeNotificationPanel.addEventListener('click', function() {
                notificationPanel.classList.remove('show');
            });
            
            // 点击其他区域关闭菜单
            document.addEventListener('click', function(event) {
                if (!settingsBtn.contains(event.target) && !settingsMenu.contains(event.target)) {
                    settingsMenu.classList.remove('show');
                }
                
                if (!accountBtn.contains(event.target) && !accountMenu.contains(event.target)) {
                    accountMenu.classList.remove('show');
                }
                
                if (!notificationButton.contains(event.target) && !notificationPanel.contains(event.target)) {
                    notificationPanel.classList.remove('show');
                }
            });
        });

        // 显示账户安全模态框
        function showSecurityModal() {
            const securityModal = document.getElementById('security-modal');
            securityModal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // 防止背景滚动
            
            // 自动评估当前账户密码强度
            checkCurrentPasswordStrength();
        }
        
        // 检查当前账户密码强度
        function checkCurrentPasswordStrength() {
            // 初始化UI显示为"分析中"状态
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            strengthBar.className = 'strength-bar';
            strengthText.textContent = '分析中...';
            strengthText.style.color = '';
            
            // 重置提示列表
            const tips = document.querySelectorAll('.password-tips li');
            tips.forEach(tip => {
                tip.className = 'tip';
                tip.classList.add('invalid');
            });
            
            // 从服务器获取密码强度分析
            fetch('/api/password-strength')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取密码强度信息失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 更新UI显示
                        updateStrengthUI(data.analysis.score);
                        
                        // 更新提示列表
                        updatePasswordTipsFromAnalysis(data.analysis);
                        
                        // 如果密码过期或较弱，可以添加额外提示
                        if (data.analysis.passwordAge > 90) {
                            // 添加密码年龄提示
                            const securitySection = document.querySelector('.security-section');
                            const ageWarning = document.createElement('div');
                            ageWarning.className = 'password-age-warning';
                            ageWarning.innerHTML = `
                                <i class="ri-time-line"></i>
                                <span>您的密码已使用${data.analysis.passwordAge}天，建议定期更换密码</span>
                            `;
                            securitySection.appendChild(ageWarning);
                        }
                    } else {
                        // 显示错误信息
                        strengthText.textContent = '无法获取密码强度';
                        strengthText.style.color = '#dc3545';
                    }
                })
                .catch(error => {
                    console.error('获取密码强度失败:', error);
                    strengthText.textContent = '获取密码强度失败';
                    strengthText.style.color = '#dc3545';
                });
        }
        
        // 隐藏账户安全模态框
        function hideSecurityModal() {
            const securityModal = document.getElementById('security-modal');
            securityModal.style.display = 'none';
            document.body.style.overflow = 'auto'; // 恢复背景滚动
            
            // 清除密码年龄提示
            const passwordAgeWarning = document.querySelector('.password-age-warning');
            if (passwordAgeWarning) {
                passwordAgeWarning.remove();
            }
            
            // 停止自动刷新
            stopAutoRefresh();
        }
        
        // 检查密码强度
        function checkPasswordStrength() {
            const password = document.getElementById('current-password').value;
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            // 如果密码为空，则重置
            if (!password) {
                resetPasswordStrength();
                return;
            }
            
            // 计算密码强度分数（0-100）
            const score = calculatePasswordScore(password);
            
            // 设置强度条样式和文本
            updateStrengthUI(score);
            
            // 更新提示列表
            updatePasswordTips(password);
        }
        
        // 计算密码强度分数
        function calculatePasswordScore(password) {
            let score = 0;
            
            // 基础分数：密码长度
            if (password.length >= 8) {
                score += 20;
            } else if (password.length >= 6) {
                score += 10;
            }
            
            // 加分：字符多样性
            if (/[A-Z]/.test(password)) score += 15; // 大写字母
            if (/[a-z]/.test(password)) score += 10; // 小写字母
            if (/[0-9]/.test(password)) score += 15; // 数字
            if (/[^A-Za-z0-9]/.test(password)) score += 20; // 特殊字符
            
            // 加分：字符类型组合
            const charTypes = [/[A-Z]/, /[a-z]/, /[0-9]/, /[^A-Za-z0-9]/];
            const typesCount = charTypes.filter(type => type.test(password)).length;
            score += (typesCount - 1) * 5;
            
            // 加分：长度奖励（超过8个字符）
            if (password.length > 8) {
                score += Math.min((password.length - 8) * 2, 10);
            }
            
            // 减分：常见密码模式
            if (/^123/.test(password) || /^abc/i.test(password) || /password/i.test(password) || /admin/i.test(password)) {
                score -= 15;
            }
            
            // 减分：只有字母或只有数字
            if (/^[A-Za-z]+$/.test(password) || /^[0-9]+$/.test(password)) {
                score -= 10;
            }
            
            // 确保分数在0-100范围内
            return Math.max(0, Math.min(100, score));
        }
        
        // 更新强度UI显示
        function updateStrengthUI(score) {
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            console.log('更新密码强度UI，分数:', score);
            
            // 清除之前的所有类
            strengthBar.className = 'strength-bar';
            console.log('重置后类名:', strengthBar.className);
            
            // 根据分数设置强度级别
            if (score < 20) {
                console.log('分数 < 20，应设置为非常弱');
                strengthBar.classList.add('strength-very-weak');
                strengthBar.style.backgroundColor = '#dc3545'; // 直接设置红色背景
                strengthBar.style.width = '20%';
                console.log('添加类后:', strengthBar.className, strengthBar.style.backgroundColor, strengthBar.style.width);
                strengthText.textContent = '非常弱';
                strengthText.style.color = '#dc3545';
            } else if (score < 40) {
                console.log('分数 < 40，应设置为弱');
                strengthBar.classList.add('strength-weak');
                strengthBar.style.backgroundColor = '#fd7e14'; // 直接设置橙色背景
                strengthBar.style.width = '40%';
                console.log('添加类后:', strengthBar.className, strengthBar.style.backgroundColor, strengthBar.style.width);
                strengthText.textContent = '弱';
                strengthText.style.color = '#fd7e14';
            } else if (score < 60) {
                console.log('分数 < 60，应设置为中等');
                strengthBar.classList.add('strength-medium');
                strengthBar.style.backgroundColor = '#ffc107'; // 直接设置黄色背景
                strengthBar.style.width = '60%';
                console.log('添加类后:', strengthBar.className, strengthBar.style.backgroundColor, strengthBar.style.width);
                strengthText.textContent = '中等';
                strengthText.style.color = '#ffc107';
            } else if (score < 80) {
                console.log('分数 < 80，应设置为强');
                strengthBar.classList.add('strength-strong');
                strengthBar.style.backgroundColor = '#28a745'; // 直接设置绿色背景
                strengthBar.style.width = '80%';
                console.log('添加类后:', strengthBar.className, strengthBar.style.backgroundColor, strengthBar.style.width);
                strengthText.textContent = '强';
                strengthText.style.color = '#28a745';
            } else {
                console.log('分数 >= 80，应设置为非常强');
                strengthBar.classList.add('strength-very-strong');
                strengthBar.style.backgroundColor = '#20c997'; // 直接设置青绿色背景
                strengthBar.style.width = '100%';
                console.log('添加类后:', strengthBar.className, strengthBar.style.backgroundColor, strengthBar.style.width);
                strengthText.textContent = '非常强';
                strengthText.style.color = '#20c997';
            }
            
            // 输出DOM元素及其样式
            console.log('更新后的DOM元素:', strengthBar);
            console.log('CSS类名:', strengthBar.className);
            console.log('直接样式:', strengthBar.style.cssText);
            
            // 检查计算后的样式
            const computedStyle = window.getComputedStyle(strengthBar);
            console.log('计算样式-宽度:', computedStyle.width);
            console.log('计算样式-背景色:', computedStyle.backgroundColor);
        }
        
        // 更新密码提示列表
        function updatePasswordTips(password) {
            // 获取所有提示元素
            const tipLength = document.getElementById('tip-length');
            const tipUppercase = document.getElementById('tip-uppercase');
            const tipLowercase = document.getElementById('tip-lowercase');
            const tipNumber = document.getElementById('tip-number');
            const tipSpecial = document.getElementById('tip-special');
            const tipCommon = document.getElementById('tip-common');
            
            // 重置所有提示为invalid状态
            [tipLength, tipUppercase, tipLowercase, tipNumber, tipSpecial, tipCommon].forEach(tip => {
                tip.className = 'tip invalid';
            });
            
            // 根据密码特性更新提示状态
            if (password.length >= 8) {
                tipLength.classList.remove('invalid');
                tipLength.classList.add('valid');
            }
            
            if (/[A-Z]/.test(password)) {
                tipUppercase.classList.remove('invalid');
                tipUppercase.classList.add('valid');
            }
            
            if (/[a-z]/.test(password)) {
                tipLowercase.classList.remove('invalid');
                tipLowercase.classList.add('valid');
            }
            
            if (/[0-9]/.test(password)) {
                tipNumber.classList.remove('invalid');
                tipNumber.classList.add('valid');
            }
            
            if (/[^A-Za-z0-9]/.test(password)) {
                tipSpecial.classList.remove('invalid');
                tipSpecial.classList.add('valid');
            }
            
            // 检查是否是常见密码（简化版检查）
            const commonPasswords = ['123456', 'password', 'admin', '111111', '12345678', 'qwerty', 'abc123'];
            if (!commonPasswords.includes(password.toLowerCase())) {
                tipCommon.classList.remove('invalid');
                tipCommon.classList.add('valid');
            }
        }

        // 显示历史记录模态框
        function showHistoryModal() {
            const historyModal = document.getElementById('history-modal');
            historyModal.style.display = 'flex';
            
            // 防止body滚动
            document.body.classList.add('modal-open');
            
            // 加载统计数据（不受筛选影响）
            loadUsageStats();
            
            // 加载使用记录数据
            loadUsageHistory();
        }

        // 隐藏历史记录模态框
        function hideHistoryModal() {
            const historyModal = document.getElementById('history-modal');
            historyModal.style.display = 'none';
            
            // 恢复body滚动
            document.body.classList.remove('modal-open');
        }

        // 加载统计数据（总数据，不受筛选影响）
        async function loadUsageStats() {
            try {
                const response = await fetch('/api/user/usage-history?type=all&per_page=1');
                const data = await response.json();
                
                if (data.success) {
                    // 更新统计信息
                    document.getElementById('total-analysis-count').textContent = data.stats.total_analysis;
                    document.getElementById('total-ai-count').textContent = data.stats.total_ai;
                    document.getElementById('total-sales-count').textContent = data.stats.total_sales;
                    document.getElementById('total-usage-count').textContent = data.stats.total_records;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载使用记录数据
        let currentHistoryPage = 1;
        const historyPerPage = 15;

        async function loadUsageHistory(page = 1) {
            try {
                const typeFilter = document.getElementById('history-type-filter').value;
                const response = await fetch(`/api/user/usage-history?page=${page}&per_page=${historyPerPage}&type=${typeFilter}`);
                const data = await response.json();
                
                if (data.success) {
                    // 更新记录列表
                    displayUsageHistory(data.records);
                    
                    // 更新分页
                    updateHistoryPagination(data.pagination);
                    
                    currentHistoryPage = page;
                }
            } catch (error) {
                console.error('加载使用记录失败:', error);
                document.getElementById('usage-history-list').innerHTML = 
                    '<div class="error-message"><i class="ri-error-warning-line"></i> 加载失败，请重试</div>';
            }
        }

        // 显示使用记录列表
        function displayUsageHistory(records) {
            const historyList = document.getElementById('usage-history-list');
            
            if (records.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-history-line"></i>
                        <p>暂无使用记录</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="history-records">';
            records.forEach(record => {
                const typeIcon = getTypeIcon(record.type);
                const typeClass = `type-${record.type}`;
                const processingTime = record.processing_time > 0 ? 
                    (record.type === 'ai' ? 
                        `${record.processing_time.toFixed(1)}s` :
                        (record.type === 'sales' ? 
                            // 销售分析的处理时间存储为秒，需要转换为毫秒显示
                            (record.processing_time < 1 ? 
                                `${(record.processing_time * 1000).toFixed(0)}ms` : 
                                `${record.processing_time.toFixed(1)}s`) :
                            // 数据分析的处理时间存储为毫秒
                            (record.processing_time < 1000 ? 
                                `${record.processing_time.toFixed(0)}ms` : 
                                `${(record.processing_time / 1000).toFixed(1)}s`))) : 
                    '--';
                
                html += `
                    <div class="history-item ${typeClass}">
                        <div class="history-icon">
                            <i class="${typeIcon}"></i>
                        </div>
                        <div class="history-content">
                            <div class="history-header">
                                <span class="history-type">${record.type_name}</span>
                                <span class="history-subtype">${record.subtype}</span>
                                <span class="history-time">${formatDateTime(record.created_at)}</span>
                            </div>
                            <div class="history-details">
                                ${record.file_name ? `<span class="detail-item"><i class="ri-file-line"></i> ${record.file_name}</span>` : ''}
                                ${record.file_count > 0 ? `<span class="detail-item"><i class="ri-folder-line"></i> ${record.file_count}个文件</span>` : ''}
                                <span class="detail-item"><i class="ri-time-line"></i> ${processingTime}</span>
                                ${record.analysis_detail ? `<span class="detail-item"><i class="ri-settings-line"></i> ${getTimeGranularityText(record.analysis_detail)}</span>` : ''}
                                <span class="status-badge status-${record.status.toLowerCase()}">${record.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            historyList.innerHTML = html;
        }

        // 获取类型图标
        function getTypeIcon(type) {
            const icons = {
                'analysis': 'ri-file-copy-line',
                'ai': 'ri-bubble-chart-line',
                'sales': 'ri-line-chart-line'
            };
            return icons[type] || 'ri-database-line';
        }

        // 获取时间粒度中文显示
        function getTimeGranularityText(granularity) {
            const granularityMap = {
                'day': '按天分析',
                'week': '按周分析', 
                'month': '按月分析',
                'quarter': '按季度分析',
                'year': '按年分析'
            };
            return granularityMap[granularity] || granularity;
        }

        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            if (diffDays < 7) return `${diffDays}天前`;
            
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 更新分页控件
        function updateHistoryPagination(pagination) {
            const paginationEl = document.getElementById('history-pagination');
            
            if (pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination-buttons">';
            
            // 上一页
            if (pagination.page > 1) {
                html += `<button class="page-btn" onclick="loadUsageHistory(${pagination.page - 1})">
                    <i class="ri-arrow-left-line"></i>
                </button>`;
            }
            
            // 页码
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === pagination.page ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="loadUsageHistory(${i})">${i}</button>`;
            }
            
            // 下一页
            if (pagination.page < pagination.pages) {
                html += `<button class="page-btn" onclick="loadUsageHistory(${pagination.page + 1})">
                    <i class="ri-arrow-right-line"></i>
                </button>`;
            }
            
            html += '</div>';
            html += `<div class="pagination-info">第 ${pagination.page} 页，共 ${pagination.pages} 页（${pagination.total} 条记录）</div>`;
            
            paginationEl.innerHTML = html;
        }

        // 导出使用记录
        async function exportUsageHistory() {
            try {
                const typeFilter = document.getElementById('history-type-filter').value;
                const response = await fetch(`/api/user/usage-history?type=${typeFilter}&per_page=1000`);
                const data = await response.json();
                
                if (data.success && data.records.length > 0) {
                    // 生成CSV内容
                    const csvContent = generateHistoryCSV(data.records);
                    
                    // 下载文件
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `使用记录_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('暂无可导出的记录');
                }
            } catch (error) {
                console.error('导出使用记录失败:', error);
                alert('导出失败，请重试');
            }
        }

        // 生成CSV内容
        function generateHistoryCSV(records) {
            const headers = ['时间', '分析类型', '具体类型', '文件名', '文件数量', '处理时间', '状态', '详细信息'];
            let csv = headers.join(',') + '\n';
            
            records.forEach(record => {
                const row = [
                    `"${record.created_at}"`,
                    `"${record.type_name}"`,
                    `"${record.subtype}"`,
                    `"${record.file_name || ''}"`,
                    record.file_count,
                    record.processing_time,
                    `"${record.status}"`,
                    `"${record.analysis_detail || ''}"`
                ];
                csv += row.join(',') + '\n';
            });
            
            return '\ufeff' + csv; // 添加BOM以支持中文
        }

        // 退出登录函数
        function logout() {
            // 显示退出确认弹窗
            const logoutModal = document.getElementById('logout-modal');
            logoutModal.style.display = 'flex';
            
            // 设置确认和取消按钮事件
            document.getElementById('logout-confirm-btn').onclick = function() {
                // 隐藏弹窗
                logoutModal.style.display = 'none';
                // 跳转到登出页面
                window.location.href = '/user/logout';
            };
            
            document.getElementById('logout-cancel-btn').onclick = function() {
                // 隐藏弹窗
                logoutModal.style.display = 'none';
            };
        }

        // 点击模态框外部关闭模态框
        window.addEventListener('click', function(event) {
            const profileModal = document.getElementById('profile-modal');
            if (event.target === profileModal) {
                hideProfileModal();
            }
            
            const logoutModal = document.getElementById('logout-modal');
            if (event.target === logoutModal) {
                logoutModal.style.display = 'none';
            }
            
            const securityModal = document.getElementById('security-modal');
            if (event.target === securityModal) {
                hideSecurityModal();
            }
            
            const historyModal = document.getElementById('history-modal');
            if (event.target === historyModal) {
                hideHistoryModal();
            }
        });

        // 从分析结果更新密码提示列表
        function updatePasswordTipsFromAnalysis(analysis) {
            // 获取所有提示元素
            const tipLength = document.getElementById('tip-length');
            const tipUppercase = document.getElementById('tip-uppercase');
            const tipLowercase = document.getElementById('tip-lowercase');
            const tipNumber = document.getElementById('tip-number');
            const tipSpecial = document.getElementById('tip-special');
            const tipCommon = document.getElementById('tip-common');
            
            // 重置所有提示为invalid状态
            [tipLength, tipUppercase, tipLowercase, tipNumber, tipSpecial, tipCommon].forEach(tip => {
                tip.className = 'tip invalid';
            });
            
            // 根据分析结果更新提示状态
            if (analysis.length >= 8) {
                tipLength.classList.remove('invalid');
                tipLength.classList.add('valid');
            }
            
            if (analysis.hasUppercase) {
                tipUppercase.classList.remove('invalid');
                tipUppercase.classList.add('valid');
            }
            
            if (analysis.hasLowercase) {
                tipLowercase.classList.remove('invalid');
                tipLowercase.classList.add('valid');
            }
            
            if (analysis.hasNumber) {
                tipNumber.classList.remove('invalid');
                tipNumber.classList.add('valid');
            }
            
            if (analysis.hasSpecial) {
                tipSpecial.classList.remove('invalid');
                tipSpecial.classList.add('valid');
            }
            
            if (!analysis.isCommon) {
                tipCommon.classList.remove('invalid');
                tipCommon.classList.add('valid');
            }
        }

        // 检查密码强度
        function checkPasswordStrength() {
            const password = document.getElementById('current-password').value;
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            // 如果密码为空，则重置
            if (!password) {
                resetPasswordStrength();
                return;
            }
            
            // 计算密码强度分数（0-100）
            const score = calculatePasswordScore(password);
            
            // 设置强度条样式和文本
            updateStrengthUI(score);
            
            // 更新提示列表
            updatePasswordTips(password);
        }
        
        // 重置密码修改表单
        function resetPasswordChangeForm() {
            document.getElementById('password-change-form').reset();
            document.getElementById('new-strength-bar').className = 'strength-bar';
            document.getElementById('new-strength-text').textContent = '尚未输入';
            document.getElementById('password-match-message').textContent = '';
            document.getElementById('password-change-message').className = 'form-message';
            document.getElementById('password-change-message').style.display = 'none';
        }
        
        // 检查新密码强度
        function checkNewPasswordStrength() {
            const password = document.getElementById('new-password').value;
            const strengthBar = document.getElementById('new-strength-bar');
            const strengthText = document.getElementById('new-strength-text');
            
            // 如果密码为空，则重置
            if (!password) {
                strengthBar.className = 'strength-bar';
                strengthText.textContent = '尚未输入';
                return;
            }
            
            // 计算密码强度分数（0-100）
            const score = calculatePasswordScore(password);
            
            // 重置类名
            strengthBar.className = 'strength-bar';
            
            // 根据分数设置强度级别
            if (score < 20) {
                strengthBar.classList.add('strength-very-weak');
                strengthText.textContent = '非常弱';
                strengthText.style.color = '#dc3545';
            } else if (score < 40) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = '弱';
                strengthText.style.color = '#fd7e14';
            } else if (score < 60) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = '中等';
                strengthText.style.color = '#ffc107';
            } else if (score < 80) {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = '强';
                strengthText.style.color = '#28a745';
            } else {
                strengthBar.classList.add('strength-very-strong');
                strengthText.textContent = '非常强';
                strengthText.style.color = '#20c997';
            }
            
            // 同时检查两个密码是否匹配
            checkPasswordMatch();
        }
        
        // 检查密码匹配
        function checkPasswordMatch() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const matchMessage = document.getElementById('password-match-message');
            
            if (!confirmPassword) {
                matchMessage.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchMessage.textContent = '密码匹配';
                matchMessage.style.color = '#28a745';
            } else {
                matchMessage.textContent = '密码不匹配';
                matchMessage.style.color = '#dc3545';
            }
        }
        
        // 切换密码可见性
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'ri-eye-line';
            } else {
                input.type = 'password';
                icon.className = 'ri-eye-off-line';
            }
        }
        
        // 修改密码
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const messageElement = document.getElementById('password-change-message');
            
            // 验证表单
            if (!currentPassword || !newPassword || !confirmPassword) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '请填写所有字段';
                messageElement.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '两次输入的新密码不一致';
                messageElement.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 6) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '新密码长度不能小于6个字符';
                messageElement.style.display = 'block';
                return;
            }
            
            // 准备请求数据
            const data = {
                current_password: currentPassword,
                new_password: newPassword
            };
            
            // 显示加载状态
            const saveButton = document.querySelector('#change-section .primary-button');
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="ri-loader-4-line"></i> 正在处理...';
            saveButton.disabled = true;
            
            // 发送修改密码请求
            fetch('/api/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageElement.className = 'form-message success';
                    messageElement.textContent = '密码修改成功！';
                    messageElement.style.display = 'block';
                    
                    // 重置表单
                    document.getElementById('password-change-form').reset();
                    document.getElementById('new-strength-bar').className = 'strength-bar';
                    document.getElementById('new-strength-text').textContent = '尚未输入';
                    document.getElementById('password-match-message').textContent = '';
                    
                    // 3秒后切换回密码强度检测标签，并重新检查密码强度
                    setTimeout(() => {
                        switchSecurityTab('strength');
                        checkCurrentPasswordStrength();
                    }, 3000);
                } else {
                    messageElement.className = 'form-message error';
                    messageElement.textContent = data.message || '密码修改失败，请重试';
                    messageElement.style.display = 'block';
                }
            })
            .catch(error => {
                messageElement.className = 'form-message error';
                messageElement.textContent = '网络错误，请重试';
                messageElement.style.display = 'block';
                console.error('修改密码失败:', error);
            })
            .finally(() => {
                // 恢复按钮状态
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
            });
        }
        
        // 显示账户安全模态框
        function showSecurityModal() {
            const securityModal = document.getElementById('security-modal');
            securityModal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // 防止背景滚动
            
            // 默认显示密码强度检测标签
            switchSecurityTab('strength');
            
            // 自动评估当前账户密码强度
            checkCurrentPasswordStrength();
        }

        // 发送修改密码验证码
        function sendPasswordChangeCode() {
            const button = document.getElementById('send-code-btn');
            // 检查按钮是否已经被禁用，防止重复点击
            if (button.disabled) return;
            
            const currentPassword = document.getElementById('current-password').value;
            if (!currentPassword) {
                const messageElement = document.getElementById('password-change-message');
                messageElement.className = 'form-message error';
                messageElement.textContent = '请先输入当前密码';
                messageElement.style.display = 'block';
                return;
            }
            
            // 禁用按钮，防止重复发送
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = '发送中...';
            
            // 发送获取验证码的请求
            fetch('/api/send-password-change-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                const messageElement = document.getElementById('password-change-message');
                
                if (data.success) {
                    messageElement.className = 'form-message success';
                    messageElement.textContent = '验证码已发送至您的注册邮箱，请查收';
                    messageElement.style.display = 'block';
                    
                    // 启动倒计时
                    let countdown = 60;
                    button.textContent = `重新发送(${countdown}s)`;
                    
                    const timer = setInterval(() => {
                        countdown--;
                        button.textContent = `重新发送(${countdown}s)`;
                        
                        if (countdown <= 0) {
                            clearInterval(timer);
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    }, 1000);
                } else {
                    messageElement.className = 'form-message error';
                    messageElement.textContent = data.message || '验证码发送失败，请重试';
                    messageElement.style.display = 'block';
                    
                    // 恢复按钮状态
                    button.disabled = false;
                    button.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('发送验证码失败:', error);
                const messageElement = document.getElementById('password-change-message');
                messageElement.className = 'form-message error';
                messageElement.textContent = '网络错误，请重试';
                messageElement.style.display = 'block';
                
                // 恢复按钮状态
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // 修改密码
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const verifyCode = document.getElementById('email-verify-code').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const messageElement = document.getElementById('password-change-message');
            
            // 验证表单
            if (!currentPassword || !verifyCode || !newPassword || !confirmPassword) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '请填写所有字段';
                messageElement.style.display = 'block';
                return;
            }
            
            if (verifyCode.length !== 6) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '请输入6位验证码';
                messageElement.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '两次输入的新密码不一致';
                messageElement.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 6) {
                messageElement.className = 'form-message error';
                messageElement.textContent = '新密码长度不能小于6个字符';
                messageElement.style.display = 'block';
                return;
            }
            
            // 准备请求数据
            const data = {
                current_password: currentPassword,
                verify_code: verifyCode,
                new_password: newPassword
            };
            
            // 显示加载状态
            const saveButton = document.querySelector('#change-section .primary-button');
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="ri-loader-4-line"></i> 正在处理...';
            saveButton.disabled = true;
            
            // 发送修改密码请求
            fetch('/api/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageElement.className = 'form-message success';
                    messageElement.textContent = '密码修改成功！';
                    messageElement.style.display = 'block';
                    
                    // 重置表单
                    document.getElementById('password-change-form').reset();
                    document.getElementById('new-strength-bar').className = 'strength-bar';
                    document.getElementById('new-strength-text').textContent = '尚未输入';
                    document.getElementById('password-match-message').textContent = '';
                    
                    // 添加动画效果
                    messageElement.style.animation = 'fadeInUp 0.5s ease';
                    
                    // 3秒后切换回密码强度检测标签，并重新检查密码强度
                    setTimeout(() => {
                        switchSecurityTab('strength');
                        checkCurrentPasswordStrength();
                    }, 3000);
                } else {
                    messageElement.className = 'form-message error';
                    messageElement.textContent = data.message || '密码修改失败，请重试';
                    messageElement.style.display = 'block';
                }
            })
            .catch(error => {
                messageElement.className = 'form-message error';
                messageElement.textContent = '网络错误，请重试';
                messageElement.style.display = 'block';
                console.error('修改密码失败:', error);
            })
            .finally(() => {
                // 恢复按钮状态
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
            });
        }

        // 当前登录历史分页
        let currentLoginPage = 1;
        let totalLoginPages = 1;
        let currentLoginView = 'table';

        // 安全中心标签页切换函数
        function switchSecurityTab(tabName) {
            // 更新标签按钮状态
            document.getElementById('strength-tab').classList.toggle('active', tabName === 'strength');
            document.getElementById('change-tab').classList.toggle('active', tabName === 'change');
            document.getElementById('login-history-tab').classList.toggle('active', tabName === 'login-history');
            document.getElementById('deactivate-tab').classList.toggle('active', tabName === 'deactivate');
            
            // 更新内容显示
            document.getElementById('strength-section').style.display = tabName === 'strength' ? 'block' : 'none';
            document.getElementById('change-section').style.display = tabName === 'change' ? 'block' : 'none';
            document.getElementById('login-history-section').style.display = tabName === 'login-history' ? 'block' : 'none';
            document.getElementById('deactivate-section').style.display = tabName === 'deactivate' ? 'block' : 'none';
            
            // 如果切换到登录历史，加载历史数据
            if (tabName === 'login-history') {
                loadLoginHistory();
            }
        }

        // 加载登录历史数据
        function loadLoginHistory() {
            const statusFilter = document.getElementById('status-filter').value;
            const deviceFilter = document.getElementById('device-filter').value;
            const historyList = document.getElementById('login-history-list');
            
            // 显示加载中状态
            historyList.innerHTML = '<tr><td colspan="5" class="loading-message">加载中...</td></tr>';
            
            // 构建查询参数
            const params = new URLSearchParams({
                page: currentLoginPage,
                page_size: 10
            });
            
            if (statusFilter) {
                params.append('status', statusFilter);
            }
            
            if (deviceFilter) {
                params.append('device', deviceFilter);
            }
            
            // 发起API请求
            fetch(`/api/user/login-history?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取登录历史失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 更新表格
                        updateLoginHistoryTable(data.data.history);
                        
                        // 更新分页
                        totalLoginPages = data.data.pages;
                        updateLoginPagination();
                        
                        // 更新图表和统计数据
                        if (currentLoginView === 'chart') {
                            updateLoginCharts(data.data);
                        }
                        
                        // 如果有地图数据且在地图视图，更新地图
                        if (currentLoginView === 'map' && data.data.locations.length > 0) {
                            updateLoginMap(data.data.locations);
                        }
                        
                        // 更新过滤器选项
                        updateFilterOptions(data.data);
                    } else {
                        historyList.innerHTML = '<tr><td colspan="5" class="loading-message">加载失败</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('获取登录历史错误:', error);
                    historyList.innerHTML = '<tr><td colspan="5" class="loading-message">加载出错</td></tr>';
                });
        }

        // 更新登录历史表格
        function updateLoginHistoryTable(historyData) {
            const historyList = document.getElementById('login-history-list');
            
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-icon"><i class="ri-history-line"></i></div><p>暂无登录记录</p></td></tr>';
                return;
            }
            
            let html = '';
            
            historyData.forEach(item => {
                // 解析原始时间并添加8小时
                const originalDate = new Date(item.login_time);
                const adjustedDate = new Date(originalDate.getTime() + 8 * 60 * 60 * 1000);
                
                // 格式化调整后的时间
                const year = adjustedDate.getFullYear();
                const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
                const day = String(adjustedDate.getDate()).padStart(2, '0');
                const hours = String(adjustedDate.getHours()).padStart(2, '0');
                const minutes = String(adjustedDate.getMinutes()).padStart(2, '0');
                
                const formattedTime = `${year}-${month}-${day}<br>${hours}:${minutes}`;
                
                // 设置状态样式
                const statusClass = item.status === '登录成功' ? 'status-success' : 'status-failed';
                
                // 设置设备图标
                let deviceIcon = '<i class="ri-computer-line"></i>';
                if (item.device_type === '手机') {
                    deviceIcon = '<i class="ri-smartphone-line"></i>';
                } else if (item.device_type === '平板') {
                    deviceIcon = '<i class="ri-tablet-line"></i>';
                }
                
                html += `
                <tr>
                    <td>${formattedTime}</td>
                    <td><span class="status-badge ${statusClass}">${item.status}</span></td>
                    <td>${item.location || '未知'}</td>
                    <td><span class="device-icon">${deviceIcon}</span>${item.device_type || '未知'}</td>
                    <td><button class="history-detail-btn" onclick="viewLoginDetail(${item.id})"><i class="ri-information-line"></i></button></td>
                </tr>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // 更新分页控件
        function updateLoginPagination() {
            const pagination = document.getElementById('login-history-pagination');
            let html = '';
            
            // 上一页按钮
            const prevDisabled = currentLoginPage === 1 ? 'disabled' : '';
            html += `<button class="page-btn ${prevDisabled}" onclick="changePage(${currentLoginPage-1})" ${prevDisabled}><i class="ri-arrow-left-s-line"></i></button>`;
            
            // 页码按钮
            const maxPages = Math.min(totalLoginPages, 5);
            let startPage = Math.max(1, currentLoginPage - 2);
            let endPage = Math.min(totalLoginPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentLoginPage ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="changePage(${i})">${i}</button>`;
            }
            
            // 下一页按钮
            const nextDisabled = currentLoginPage === totalLoginPages ? 'disabled' : '';
            html += `<button class="page-btn ${nextDisabled}" onclick="changePage(${currentLoginPage+1})" ${nextDisabled}><i class="ri-arrow-right-s-line"></i></button>`;
            
            pagination.innerHTML = html;
        }

        // 切换页码
        function changePage(page) {
            if (page < 1 || page > totalLoginPages) {
                return;
            }
            
            currentLoginPage = page;
            loadLoginHistory();
        }

        // 切换视图（表格/地图/图表）
        function switchHistoryView(view) {
            currentLoginView = view;
            
            // 更新按钮状态
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            // 更新视图显示
            document.getElementById('table-view').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('map-view').style.display = view === 'map' ? 'block' : 'none';
            document.getElementById('chart-view').style.display = view === 'chart' ? 'block' : 'none';
            
            // 如果切换到图表视图，更新图表
            if (view === 'chart') {
                loadLoginHistory();
            }
            
            // 如果切换到地图视图，更新地图
            if (view === 'map') {
                loadLoginHistory();
            }
        }

        // 显示登录详情
        function showLoginDetail(loginId) {
            alert('登录详情功能开发中');
            // 这里可以实现显示登录详情的模态框
        }

        // 更新过滤器选项
        function updateFilterOptions(data) {
            if (!data.device_options || !data.status_options) {
                return;
            }
            
            const deviceFilter = document.getElementById('device-filter');
            const statusFilter = document.getElementById('status-filter');
            
            // 保存当前选择
            const selectedDevice = deviceFilter.value;
            const selectedStatus = statusFilter.value;
            
            // 更新设备选项
            let deviceOptions = '<option value="">全部</option>';
            data.device_options.forEach(device => {
                deviceOptions += `<option value="${device}" ${selectedDevice === device ? 'selected' : ''}>${device}</option>`;
            });
            deviceFilter.innerHTML = deviceOptions;
            
            // 更新状态选项
            let statusOptions = '<option value="">全部</option>';
            data.status_options.forEach(status => {
                statusOptions += `<option value="${status}" ${selectedStatus === status ? 'selected' : ''}>${status}</option>`;
            });
            statusFilter.innerHTML = statusOptions;
        }

        // 更新登录图表和统计数据
        function updateLoginCharts(data) {
            // 更新统计数据
            let successCount = 0;
            let failedCount = 0;
            
            // 计算成功和失败次数
            data.history.forEach(item => {
                if (item.status === '登录成功') {
                    successCount++;
                } else {
                    failedCount++;
                }
            });
            
            document.getElementById('success-login-count').textContent = successCount;
            document.getElementById('failed-login-count').textContent = failedCount;
            document.getElementById('login-locations-count').textContent = data.locations.length;
            
            // 确定最常用设备
            const deviceCounts = {};
            data.history.forEach(item => {
                if (item.device_type) {
                    deviceCounts[item.device_type] = (deviceCounts[item.device_type] || 0) + 1;
                }
            });
            
            let mostUsedDevice = '未知';
            let maxCount = 0;
            for (const device in deviceCounts) {
                if (deviceCounts[device] > maxCount) {
                    maxCount = deviceCounts[device];
                    mostUsedDevice = device;
                }
            }
            
            document.getElementById('most-used-device').textContent = mostUsedDevice;
            
            // 使用Plotly创建图表（如果已加载）
            if (window.Plotly && data.daily_stats) {
                const dates = data.daily_stats.map(item => item.date);
                const counts = data.daily_stats.map(item => item.count);
                
                const graphData = [{
                    x: dates,
                    y: counts,
                    type: 'bar',
                    marker: {
                        color: 'rgba(0, 123, 255, 0.7)'
                    }
                }];
                
                const layout = {
                    title: '最近7天登录活动',
                    xaxis: {
                        title: '日期'
                    },
                    yaxis: {
                        title: '登录次数'
                    },
                    margin: {
                        l: 50,
                        r: 30,
                        b: 50,
                        t: 50,
                        pad: 4
                    }
                };
                
                Plotly.newPlot('login-daily-chart', graphData, layout);
            }
        }

        // 更新登录地图（需要引入地图库）
        function updateLoginMap(locations) {
            // 此处需要引入地图库实现
            // 如使用高德地图、百度地图或OpenStreetMap
            
            // 临时显示位置列表
            const mapContainer = document.getElementById('login-map-container');
            let html = '<div class="location-list">';
            html += '<h5>登录位置列表</h5>';
            html += '<ul>';
            
            locations.forEach(loc => {
                html += `<li>${loc.location} (${loc.count}次)</li>`;
            });
            
            html += '</ul></div>';
            mapContainer.innerHTML = html;
            
            // TODO: 实现地图显示
        }

        // 自动刷新定时器
        let loginHistoryRefreshTimer = null;

        // 启动自动刷新
        function startAutoRefresh() {
            // 每60秒刷新一次
            loginHistoryRefreshTimer = setInterval(() => {
                if (document.getElementById('login-history-section').style.display !== 'none') {
                    loadLoginHistory();
                }
            }, 60000);
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (loginHistoryRefreshTimer) {
                clearInterval(loginHistoryRefreshTimer);
                loginHistoryRefreshTimer = null;
            }
        }

        // 页面加载完成后自动加载登录历史
        document.addEventListener('DOMContentLoaded', function() {
            loadLoginHistory();
            startAutoRefresh();
        });

        // 发送注销验证码
        function sendDeactivationCode() {
            const password = document.getElementById('current-password-deactivate').value;
            const sendButton = document.getElementById('send-deactivation-code-btn');
            const hintElement = document.getElementById('deactivation-code-hint');
            
            if (!password) {
                showToast('请先输入当前密码', 'error');
                document.getElementById('current-password-deactivate').focus();
                return;
            }
            
            // 禁用按钮并显示加载状态
            sendButton.disabled = true;
            sendButton.innerHTML = '发送中...';
            
            // 发送验证码请求
            fetch('/api/send-deactivation-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示成功消息
                    showToast('验证码已发送', 'success');
                    hintElement.textContent = `验证码已发送至 ${data.email}，有效期10分钟`;
                    
                    // 设置倒计时
                    let countdown = 60;
                    sendButton.classList.add('counting');
                    sendButton.innerHTML = `${countdown}秒后重发`;
                    
                    const timer = setInterval(() => {
                        countdown--;
                        if (countdown <= 0) {
                            clearInterval(timer);
                            sendButton.disabled = false;
                            sendButton.innerHTML = '重新发送';
                            sendButton.classList.remove('counting');
                        } else {
                            sendButton.innerHTML = `${countdown}秒后重发`;
                        }
                    }, 1000);
                } else {
                    // 显示错误消息
                    showToast(data.message || '发送验证码失败', 'error');
                    sendButton.disabled = false;
                    sendButton.innerHTML = '发送验证码';
                }
            })
            .catch(error => {
                console.error('发送验证码出错:', error);
                showToast('系统错误，请稍后再试', 'error');
                sendButton.disabled = false;
                sendButton.innerHTML = '发送验证码';
            });
        }

        // 注销账号函数（修改版）
        function deactivateAccount() {
            const password = document.getElementById('current-password-deactivate').value;
            const verificationCode = document.getElementById('deactivation-code').value;
            const confirmation = document.getElementById('deactivate-confirmation').value;
            const reason = document.getElementById('deactivate-reason').value;
            
            // 验证输入
            if (!password) {
                showToast('请输入当前密码', 'error');
                return;
            }
            
            if (!verificationCode) {
                showToast('请输入邮箱验证码', 'error');
                return;
            }
            
            if (confirmation !== '确认注销') {
                showToast('请正确输入确认文字："确认注销"', 'error');
                return;
            }
            
            // 二次确认
            if (!confirm('您确定要注销此账号吗？此操作不可恢复！')) {
                return;
            }
            
            // 设置按钮加载状态
            const deactivateButton = document.querySelector('.deactivate-button');
            const originalButtonText = deactivateButton.innerHTML;
            deactivateButton.disabled = true;
            deactivateButton.innerHTML = '<i class="ri-loader-line ri-spin"></i> 处理中...';
            
            // 提交注销请求
            fetch('/api/user/deactivate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    password: password,
                    verification_code: verificationCode,
                    confirmation: confirmation,
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 注销成功，显示成功消息并跳转到登录页
                    showToast('账号已成功注销', 'success');
                    
                    // 显示成功画面
                    document.querySelector('.deactivate-container').innerHTML = `
                        <div class="deactivation-success">
                            <div class="success-icon">
                                <i class="ri-check-line"></i>
                            </div>
                            <h3>账号已成功注销</h3>
                            <p>感谢您使用我们的服务，您的账号已被注销。</p>
                            <p>系统将在<span id="redirect-countdown">5</span>秒后自动跳转到登录页...</p>
                        </div>
                    `;
                    
                    // 倒计时跳转
                    let redirectCountdown = 5;
                    const redirectTimer = setInterval(() => {
                        redirectCountdown--;
                        document.getElementById('redirect-countdown').textContent = redirectCountdown;
                        if (redirectCountdown <= 0) {
                            clearInterval(redirectTimer);
                            window.location.href = '/login';
                        }
                    }, 1000);
                } else {
                    // 注销失败，显示错误消息
                    showToast(data.message || '注销账号失败', 'error');
                    deactivateButton.disabled = false;
                    deactivateButton.innerHTML = originalButtonText;
                }
            })
            .catch(error => {
                showToast('系统错误，请稍后再试', 'error');
                console.error('注销账号出错:', error);
                deactivateButton.disabled = false;
                deactivateButton.innerHTML = originalButtonText;
            });
        }

        // 额外添加成功显示样式
        const additionalStyles = `
        .deactivation-success {
            text-align: center;
            padding: 30px 20px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background-color: rgba(76, 175, 80, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .success-icon i {
            font-size: 40px;
            color: #4CAF50;
        }

        .deactivation-success h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #fff;
        }

        .deactivation-success p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
        }

        @media (prefers-color-scheme: light) {
            .deactivation-success h3 {
                color: #333;
            }
            
            .deactivation-success p {
                color: rgba(0, 0, 0, 0.7);
            }
        }
        `;

        // 添加样式到页面
        const styleElement = document.createElement('style');
        styleElement.textContent = additionalStyles;
        document.head.appendChild(styleElement);
    </script>

    <script>
        // 在DOMContentLoaded函数中初始化登录动画
        document.addEventListener('DOMContentLoaded', function() {
            // 已有的DOMContentLoaded代码...
            loadUserInfo();
            
            // 初始化登录动画
            initLoginAnimation();
            
            // 其他已有的代码...
        });
        
        // 初始化并显示登录动画
        function initLoginAnimation() {
            // 检查是否是由登录页面跳转而来
            const isFromLogin = sessionStorage.getItem('isLoggedIn');
            
            // 检查是否启用了动画效果
            const animationDisabled = document.documentElement.getAttribute('data-animation') === 'off';
            
            // 检查用户是否开启了登录动画
            const loginAnimationDisabled = localStorage.getItem('loginAnimation') === 'off';
            
            if (isFromLogin && !animationDisabled && !loginAnimationDisabled) {
                // 获取当前用户名
                fetch('/api/current-user')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 初始化动画
                            const loginAnimation = new LoginAnimation();
                            loginAnimation.init(data.user.username || '用户');
                            
                            // 清除登录状态标记，防止刷新页面再次显示动画
                            sessionStorage.removeItem('isLoggedIn');
                        }
                    })
                    .catch(error => {
                        console.error('获取用户信息失败:', error);
                        sessionStorage.removeItem('isLoggedIn');
                    });
            }
        }
        
        // ... existing code ...
    </script>
</body>
</html> 